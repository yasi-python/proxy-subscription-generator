"use strict";let{nanoid:nanoid}=require("nanoid/non-secure"),{isAbsolute:isAbsolute,resolve:resolve}=require("path"),{SourceMapConsumer:SourceMapConsumer,SourceMapGenerator:SourceMapGenerator}=require("source-map-js"),{fileURLToPath:fileURLToPath,pathToFileURL:pathToFileURL}=require("url"),CssSyntaxError=require("./css-syntax-error"),PreviousMap=require("./previous-map"),terminalHighlight=require("./terminal-highlight"),lineToIndexCache=Symbol("lineToIndexCache"),sourceMapAvailable=Boolean(SourceMapConsumer&&SourceMapGenerator),pathAvailable=Boolean(resolve&&isAbsolute);function getLineToIndex(e){if(e[lineToIndexCache])return e[lineToIndexCache];let i=e.css.split("\n"),t=new Array(i.length),o=0;for(let e=0,n=i.length;e<n;e++)t[e]=o,o+=i[e].length+1;return e[lineToIndexCache]=t,t}class Input{get from(){return this.file||this.id}constructor(e,i={}){if(null==e||"object"==typeof e&&!e.toString)throw new Error(`PostCSS received ${e} instead of CSS string`);if(this.css=e.toString(),"\ufeff"===this.css[0]||"ï¿¾"===this.css[0]?(this.hasBOM=!0,this.css=this.css.slice(1)):this.hasBOM=!1,this.document=this.css,i.document&&(this.document=i.document.toString()),i.from&&(!pathAvailable||/^\w+:\/\//.test(i.from)||isAbsolute(i.from)?this.file=i.from:this.file=resolve(i.from)),pathAvailable&&sourceMapAvailable){let e=new PreviousMap(this.css,i);if(e.text){this.map=e;let i=e.consumer().file;!this.file&&i&&(this.file=this.mapResolve(i))}}this.file||(this.id="<input css "+nanoid(6)+">"),this.map&&(this.map.file=this.from)}error(e,i,t,o={}){let n,s,l,r,u;if(i&&"object"==typeof i){let e=i,o=t;if("number"==typeof e.offset){r=e.offset;let o=this.fromOffset(r);i=o.line,t=o.col}else i=e.line,t=e.column,r=this.fromLineAndColumn(i,t);if("number"==typeof o.offset){l=o.offset;let e=this.fromOffset(l);s=e.line,n=e.col}else s=o.line,n=o.column,l=this.fromLineAndColumn(o.line,o.column)}else if(t)r=this.fromLineAndColumn(i,t);else{r=i;let e=this.fromOffset(r);i=e.line,t=e.col}let h=this.origin(i,t,s,n);return u=h?new CssSyntaxError(e,void 0===h.endLine?h.line:{column:h.column,line:h.line},void 0===h.endLine?h.column:{column:h.endColumn,line:h.endLine},h.source,h.file,o.plugin):new CssSyntaxError(e,void 0===s?i:{column:t,line:i},void 0===s?t:{column:n,line:s},this.css,this.file,o.plugin),u.input={column:t,endColumn:n,endLine:s,endOffset:l,line:i,offset:r,source:this.css},this.file&&(pathToFileURL&&(u.input.url=pathToFileURL(this.file).toString()),u.input.file=this.file),u}fromLineAndColumn(e,i){return getLineToIndex(this)[e-1]+i-1}fromOffset(e){let i=getLineToIndex(this),t=0;if(e>=i[i.length-1])t=i.length-1;else{let o,n=i.length-2;for(;t<n;)if(o=t+(n-t>>1),e<i[o])n=o-1;else{if(!(e>=i[o+1])){t=o;break}t=o+1}}return{col:e-i[t]+1,line:t+1}}mapResolve(e){return/^\w+:\/\//.test(e)?e:resolve(this.map.consumer().sourceRoot||this.map.root||".",e)}origin(e,i,t,o){if(!this.map)return!1;let n,s,l=this.map.consumer(),r=l.originalPositionFor({column:i,line:e});if(!r.source)return!1;"number"==typeof t&&(n=l.originalPositionFor({column:o,line:t})),s=isAbsolute(r.source)?pathToFileURL(r.source):new URL(r.source,this.map.consumer().sourceRoot||pathToFileURL(this.map.mapFile));let u={column:r.column,endColumn:n&&n.column,endLine:n&&n.line,line:r.line,url:s.toString()};if("file:"===s.protocol){if(!fileURLToPath)throw new Error("file: protocol is not available in this PostCSS build");u.file=fileURLToPath(s)}let h=l.sourceContentFor(r.source);return h&&(u.source=h),u}toJSON(){let e={};for(let i of["hasBOM","css","file","id"])null!=this[i]&&(e[i]=this[i]);return this.map&&(e.map={...this.map},e.map.consumerCache&&(e.map.consumerCache=void 0)),e}}module.exports=Input,Input.default=Input,terminalHighlight&&terminalHighlight.registerInput&&terminalHighlight.registerInput(Input);