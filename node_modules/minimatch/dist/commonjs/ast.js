"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.AST=void 0;const brace_expressions_js_1=require("./brace-expressions.js"),unescape_js_1=require("./unescape.js"),types=new Set(["!","?","+","*","@"]),isExtglobType=t=>types.has(t),startNoTraversal="(?!(?:^|/)\\.\\.?(?:$|/))",startNoDot="(?!\\.)",addPatternStart=new Set(["[","."]),justDots=new Set(["..","."]),reSpecials=new Set("().*{}+?[]^$\\!"),regExpEscape=t=>t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),qmark="[^/]",star="[^/]*?",starNoEmpty="[^/]+?";class AST{type;#t;#s;#i=!1;#e=[];#r;#n;#h;#o=!1;#a;#p;#c=!1;constructor(t,s,i={}){this.type=t,t&&(this.#s=!0),this.#r=s,this.#t=this.#r?this.#r.#t:this,this.#a=this.#t===this?i:this.#t.#a,this.#h=this.#t===this?[]:this.#t.#h,"!"!==t||this.#t.#o||this.#h.push(this),this.#n=this.#r?this.#r.#e.length:0}get hasMagic(){if(void 0!==this.#s)return this.#s;for(const t of this.#e)if("string"!=typeof t&&(t.type||t.hasMagic))return this.#s=!0;return this.#s}toString(){return void 0!==this.#p?this.#p:this.type?this.#p=this.type+"("+this.#e.map(t=>String(t)).join("|")+")":this.#p=this.#e.map(t=>String(t)).join("")}#l(){if(this!==this.#t)throw new Error("should only call on root");if(this.#o)return this;let t;for(this.toString(),this.#o=!0;t=this.#h.pop();){if("!"!==t.type)continue;let s=t,i=s.#r;for(;i;){for(let e=s.#n+1;!i.type&&e<i.#e.length;e++)for(const s of t.#e){if("string"==typeof s)throw new Error("string part in extglob AST??");s.copyIn(i.#e[e])}s=i,i=s.#r}}return this}push(...t){for(const s of t)if(""!==s){if("string"!=typeof s&&!(s instanceof AST&&s.#r===this))throw new Error("invalid part: "+s);this.#e.push(s)}}toJSON(){const t=null===this.type?this.#e.slice().map(t=>"string"==typeof t?t:t.toJSON()):[this.type,...this.#e.map(t=>t.toJSON())];return this.isStart()&&!this.type&&t.unshift([]),this.isEnd()&&(this===this.#t||this.#t.#o&&"!"===this.#r?.type)&&t.push({}),t}isStart(){if(this.#t===this)return!0;if(!this.#r?.isStart())return!1;if(0===this.#n)return!0;const t=this.#r;for(let s=0;s<this.#n;s++){const i=t.#e[s];if(!(i instanceof AST&&"!"===i.type))return!1}return!0}isEnd(){if(this.#t===this)return!0;if("!"===this.#r?.type)return!0;if(!this.#r?.isEnd())return!1;if(!this.type)return this.#r?.isEnd();const t=this.#r?this.#r.#e.length:0;return this.#n===t-1}copyIn(t){"string"==typeof t?this.push(t):this.push(t.clone(this))}clone(t){const s=new AST(this.type,t);for(const t of this.#e)s.copyIn(t);return s}static#u(t,s,i,e){let r=!1,n=!1,h=-1,o=!1;if(null===s.type){let a=i,p="";for(;a<t.length;){const i=t.charAt(a++);if(r||"\\"===i)r=!r,p+=i;else if(n)a===h+1?"^"!==i&&"!"!==i||(o=!0):"]"!==i||a===h+2&&o||(n=!1),p+=i;else if("["!==i){if(!e.noext&&isExtglobType(i)&&"("===t.charAt(a)){s.push(p),p="";const r=new AST(i,s);a=AST.#u(t,r,a,e),s.push(r);continue}p+=i}else n=!0,h=a,o=!1,p+=i}return s.push(p),a}let a=i+1,p=new AST(null,s);const c=[];let l="";for(;a<t.length;){const i=t.charAt(a++);if(r||"\\"===i)r=!r,l+=i;else if(n)a===h+1?"^"!==i&&"!"!==i||(o=!0):"]"!==i||a===h+2&&o||(n=!1),l+=i;else if("["!==i){if(isExtglobType(i)&&"("===t.charAt(a)){p.push(l),l="";const s=new AST(i,p);p.push(s),a=AST.#u(t,s,a,e);continue}if("|"!==i){if(")"===i)return""===l&&0===s.#e.length&&(s.#c=!0),p.push(l),l="",s.push(...c,p),a;l+=i}else p.push(l),l="",c.push(p),p=new AST(null,s)}else n=!0,h=a,o=!1,l+=i}return s.type=null,s.#s=void 0,s.#e=[t.substring(i-1)],a}static fromGlob(t,s={}){const i=new AST(null,void 0,s);return AST.#u(t,i,0,s),i}toMMPattern(){if(this!==this.#t)return this.#t.toMMPattern();const t=this.toString(),[s,i,e,r]=this.toRegExpSource();if(!(e||this.#s||this.#a.nocase&&!this.#a.nocaseMagicOnly&&t.toUpperCase()!==t.toLowerCase()))return i;const n=(this.#a.nocase?"i":"")+(r?"u":"");return Object.assign(new RegExp(`^${s}$`,n),{_src:s,_glob:t})}get options(){return this.#a}toRegExpSource(t){const s=t??!!this.#a.dot;if(this.#t===this&&this.#l(),!this.type){const i=this.isStart()&&this.isEnd(),e=this.#e.map(s=>{const[e,r,n,h]="string"==typeof s?AST.#g(s,this.#s,i):s.toRegExpSource(t);return this.#s=this.#s||n,this.#i=this.#i||h,e}).join("");let r="";if(this.isStart()&&"string"==typeof this.#e[0]){if(!(1===this.#e.length&&justDots.has(this.#e[0]))){const i=addPatternStart,n=s&&i.has(e.charAt(0))||e.startsWith("\\.")&&i.has(e.charAt(2))||e.startsWith("\\.\\.")&&i.has(e.charAt(4)),h=!s&&!t&&i.has(e.charAt(0));r=n?startNoTraversal:h?"(?!\\.)":""}}let n="";this.isEnd()&&this.#t.#o&&"!"===this.#r?.type&&(n="(?:$|\\/)");return[r+e+n,(0,unescape_js_1.unescape)(e),this.#s=!!this.#s,this.#i]}const i="*"===this.type||"+"===this.type,e="!"===this.type?"(?:(?!(?:":"(?:";let r=this.#f(s);if(this.isStart()&&this.isEnd()&&!r&&"!"!==this.type){const t=this.toString();return this.#e=[t],this.type=null,this.#s=void 0,[t,(0,unescape_js_1.unescape)(this.toString()),!1,!1]}let n=!i||t||s?"":this.#f(!0);n===r&&(n=""),n&&(r=`(?:${r})(?:${n})*?`);let h="";if("!"===this.type&&this.#c)h=(this.isStart()&&!s?"(?!\\.)":"")+"[^/]+?";else{h=e+r+("!"===this.type?"))"+(!this.isStart()||s||t?"":"(?!\\.)")+star+")":"@"===this.type?")":"?"===this.type?")?":"+"===this.type&&n?")":"*"===this.type&&n?")?":`)${this.type}`)}return[h,(0,unescape_js_1.unescape)(r),this.#s=!!this.#s,this.#i]}#f(t){return this.#e.map(s=>{if("string"==typeof s)throw new Error("string type in extglob ast??");const[i,e,r,n]=s.toRegExpSource(t);return this.#i=this.#i||n,i}).filter(t=>!(this.isStart()&&this.isEnd()&&!t)).join("|")}static#g(t,s,i=!1){let e=!1,r="",n=!1;for(let h=0;h<t.length;h++){const o=t.charAt(h);if(e)e=!1,r+=(reSpecials.has(o)?"\\":"")+o;else if("\\"!==o){if("["===o){const[i,e,o,a]=(0,brace_expressions_js_1.parseClass)(t,h);if(o){r+=i,n=n||e,h+=o-1,s=s||a;continue}}"*"!==o?"?"!==o?r+=regExpEscape(o):(r+=qmark,s=!0):(r+=i&&"*"===t?"[^/]+?":star,s=!0)}else h===t.length-1?r+="\\\\":e=!0}return[r,(0,unescape_js_1.unescape)(t),!!s,n]}}exports.AST=AST;