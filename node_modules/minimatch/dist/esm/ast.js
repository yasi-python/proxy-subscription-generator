import{parseClass}from"./brace-expressions.js";import{unescape}from"./unescape.js";const types=new Set(["!","?","+","*","@"]),isExtglobType=t=>types.has(t),startNoTraversal="(?!(?:^|/)\\.\\.?(?:$|/))",startNoDot="(?!\\.)",addPatternStart=new Set(["[","."]),justDots=new Set(["..","."]),reSpecials=new Set("().*{}+?[]^$\\!"),regExpEscape=t=>t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"),qmark="[^/]",star="[^/]*?",starNoEmpty="[^/]+?";export class AST{type;#t;#s;#i=!1;#e=[];#r;#h;#n;#o=!1;#p;#a;#c=!1;constructor(t,s,i={}){this.type=t,t&&(this.#s=!0),this.#r=s,this.#t=this.#r?this.#r.#t:this,this.#p=this.#t===this?i:this.#t.#p,this.#n=this.#t===this?[]:this.#t.#n,"!"!==t||this.#t.#o||this.#n.push(this),this.#h=this.#r?this.#r.#e.length:0}get hasMagic(){if(void 0!==this.#s)return this.#s;for(const t of this.#e)if("string"!=typeof t&&(t.type||t.hasMagic))return this.#s=!0;return this.#s}toString(){return void 0!==this.#a?this.#a:this.type?this.#a=this.type+"("+this.#e.map(t=>String(t)).join("|")+")":this.#a=this.#e.map(t=>String(t)).join("")}#u(){if(this!==this.#t)throw new Error("should only call on root");if(this.#o)return this;let t;for(this.toString(),this.#o=!0;t=this.#n.pop();){if("!"!==t.type)continue;let s=t,i=s.#r;for(;i;){for(let e=s.#h+1;!i.type&&e<i.#e.length;e++)for(const s of t.#e){if("string"==typeof s)throw new Error("string part in extglob AST??");s.copyIn(i.#e[e])}s=i,i=s.#r}}return this}push(...t){for(const s of t)if(""!==s){if("string"!=typeof s&&!(s instanceof AST&&s.#r===this))throw new Error("invalid part: "+s);this.#e.push(s)}}toJSON(){const t=null===this.type?this.#e.slice().map(t=>"string"==typeof t?t:t.toJSON()):[this.type,...this.#e.map(t=>t.toJSON())];return this.isStart()&&!this.type&&t.unshift([]),this.isEnd()&&(this===this.#t||this.#t.#o&&"!"===this.#r?.type)&&t.push({}),t}isStart(){if(this.#t===this)return!0;if(!this.#r?.isStart())return!1;if(0===this.#h)return!0;const t=this.#r;for(let s=0;s<this.#h;s++){const i=t.#e[s];if(!(i instanceof AST&&"!"===i.type))return!1}return!0}isEnd(){if(this.#t===this)return!0;if("!"===this.#r?.type)return!0;if(!this.#r?.isEnd())return!1;if(!this.type)return this.#r?.isEnd();const t=this.#r?this.#r.#e.length:0;return this.#h===t-1}copyIn(t){"string"==typeof t?this.push(t):this.push(t.clone(this))}clone(t){const s=new AST(this.type,t);for(const t of this.#e)s.copyIn(t);return s}static#l(t,s,i,e){let r=!1,h=!1,n=-1,o=!1;if(null===s.type){let p=i,a="";for(;p<t.length;){const i=t.charAt(p++);if(r||"\\"===i)r=!r,a+=i;else if(h)p===n+1?"^"!==i&&"!"!==i||(o=!0):"]"!==i||p===n+2&&o||(h=!1),a+=i;else if("["!==i){if(!e.noext&&isExtglobType(i)&&"("===t.charAt(p)){s.push(a),a="";const r=new AST(i,s);p=AST.#l(t,r,p,e),s.push(r);continue}a+=i}else h=!0,n=p,o=!1,a+=i}return s.push(a),p}let p=i+1,a=new AST(null,s);const c=[];let u="";for(;p<t.length;){const i=t.charAt(p++);if(r||"\\"===i)r=!r,u+=i;else if(h)p===n+1?"^"!==i&&"!"!==i||(o=!0):"]"!==i||p===n+2&&o||(h=!1),u+=i;else if("["!==i){if(isExtglobType(i)&&"("===t.charAt(p)){a.push(u),u="";const s=new AST(i,a);a.push(s),p=AST.#l(t,s,p,e);continue}if("|"!==i){if(")"===i)return""===u&&0===s.#e.length&&(s.#c=!0),a.push(u),u="",s.push(...c,a),p;u+=i}else a.push(u),u="",c.push(a),a=new AST(null,s)}else h=!0,n=p,o=!1,u+=i}return s.type=null,s.#s=void 0,s.#e=[t.substring(i-1)],p}static fromGlob(t,s={}){const i=new AST(null,void 0,s);return AST.#l(t,i,0,s),i}toMMPattern(){if(this!==this.#t)return this.#t.toMMPattern();const t=this.toString(),[s,i,e,r]=this.toRegExpSource();if(!(e||this.#s||this.#p.nocase&&!this.#p.nocaseMagicOnly&&t.toUpperCase()!==t.toLowerCase()))return i;const h=(this.#p.nocase?"i":"")+(r?"u":"");return Object.assign(new RegExp(`^${s}$`,h),{_src:s,_glob:t})}get options(){return this.#p}toRegExpSource(t){const s=t??!!this.#p.dot;if(this.#t===this&&this.#u(),!this.type){const i=this.isStart()&&this.isEnd(),e=this.#e.map(s=>{const[e,r,h,n]="string"==typeof s?AST.#f(s,this.#s,i):s.toRegExpSource(t);return this.#s=this.#s||h,this.#i=this.#i||n,e}).join("");let r="";if(this.isStart()&&"string"==typeof this.#e[0]&&(1!==this.#e.length||!justDots.has(this.#e[0]))){const i=addPatternStart,h=s&&i.has(e.charAt(0))||e.startsWith("\\.")&&i.has(e.charAt(2))||e.startsWith("\\.\\.")&&i.has(e.charAt(4)),n=!s&&!t&&i.has(e.charAt(0));r=h?startNoTraversal:n?"(?!\\.)":""}let h="";return this.isEnd()&&this.#t.#o&&"!"===this.#r?.type&&(h="(?:$|\\/)"),[r+e+h,unescape(e),this.#s=!!this.#s,this.#i]}const i="*"===this.type||"+"===this.type,e="!"===this.type?"(?:(?!(?:":"(?:";let r=this.#g(s);if(this.isStart()&&this.isEnd()&&!r&&"!"!==this.type){const t=this.toString();return this.#e=[t],this.type=null,this.#s=void 0,[t,unescape(this.toString()),!1,!1]}let h=!i||t||s?"":this.#g(!0);h===r&&(h=""),h&&(r=`(?:${r})(?:${h})*?`);let n="";return n="!"===this.type&&this.#c?(this.isStart()&&!s?"(?!\\.)":"")+"[^/]+?":e+r+("!"===this.type?"))"+(!this.isStart()||s||t?"":"(?!\\.)")+star+")":"@"===this.type?")":"?"===this.type?")?":"+"===this.type&&h?")":"*"===this.type&&h?")?":`)${this.type}`),[n,unescape(r),this.#s=!!this.#s,this.#i]}#g(t){return this.#e.map(s=>{if("string"==typeof s)throw new Error("string type in extglob ast??");const[i,e,r,h]=s.toRegExpSource(t);return this.#i=this.#i||h,i}).filter(t=>!(this.isStart()&&this.isEnd()&&!t)).join("|")}static#f(t,s,i=!1){let e=!1,r="",h=!1;for(let n=0;n<t.length;n++){const o=t.charAt(n);if(e)e=!1,r+=(reSpecials.has(o)?"\\":"")+o;else if("\\"!==o){if("["===o){const[i,e,o,p]=parseClass(t,n);if(o){r+=i,h=h||e,n+=o-1,s=s||p;continue}}"*"!==o?"?"!==o?r+=regExpEscape(o):(r+=qmark,s=!0):(r+=i&&"*"===t?"[^/]+?":star,s=!0)}else n===t.length-1?r+="\\\\":e=!0}return[r,unescape(t),!!s,h]}}