import expand from"brace-expansion";import{assertValidPattern}from"./assert-valid-pattern.js";import{AST}from"./ast.js";import{escape}from"./escape.js";import{unescape}from"./unescape.js";export const minimatch=(t,e,s={})=>(assertValidPattern(e),!(!s.nocomment&&"#"===e.charAt(0))&&new Minimatch(e,s).match(t));const starDotExtRE=/^\*+([^+@!?\*\[\(]*)$/,starDotExtTest=t=>e=>!e.startsWith(".")&&e.endsWith(t),starDotExtTestDot=t=>e=>e.endsWith(t),starDotExtTestNocase=t=>(t=t.toLowerCase(),e=>!e.startsWith(".")&&e.toLowerCase().endsWith(t)),starDotExtTestNocaseDot=t=>(t=t.toLowerCase(),e=>e.toLowerCase().endsWith(t)),starDotStarRE=/^\*+\.\*+$/,starDotStarTest=t=>!t.startsWith(".")&&t.includes("."),starDotStarTestDot=t=>"."!==t&&".."!==t&&t.includes("."),dotStarRE=/^\.\*+$/,dotStarTest=t=>"."!==t&&".."!==t&&t.startsWith("."),starRE=/^\*+$/,starTest=t=>0!==t.length&&!t.startsWith("."),starTestDot=t=>0!==t.length&&"."!==t&&".."!==t,qmarksRE=/^\?+([^+@!?\*\[\(]*)?$/,qmarksTestNocase=([t,e=""])=>{const s=qmarksTestNoExt([t]);return e?(e=e.toLowerCase(),t=>s(t)&&t.toLowerCase().endsWith(e)):s},qmarksTestNocaseDot=([t,e=""])=>{const s=qmarksTestNoExtDot([t]);return e?(e=e.toLowerCase(),t=>s(t)&&t.toLowerCase().endsWith(e)):s},qmarksTestDot=([t,e=""])=>{const s=qmarksTestNoExtDot([t]);return e?t=>s(t)&&t.endsWith(e):s},qmarksTest=([t,e=""])=>{const s=qmarksTestNoExt([t]);return e?t=>s(t)&&t.endsWith(e):s},qmarksTestNoExt=([t])=>{const e=t.length;return t=>t.length===e&&!t.startsWith(".")},qmarksTestNoExtDot=([t])=>{const e=t.length;return t=>t.length===e&&"."!==t&&".."!==t},defaultPlatform="object"==typeof process&&process?"object"==typeof process.env&&process.env&&process.env.__MINIMATCH_TESTING_PLATFORM__||process.platform:"posix",path={win32:{sep:"\\"},posix:{sep:"/"}};export const sep="win32"===defaultPlatform?path.win32.sep:path.posix.sep;minimatch.sep=sep;export const GLOBSTAR=Symbol("globstar **");minimatch.GLOBSTAR=GLOBSTAR;const qmark="[^/]",star="[^/]*?",twoStarDot="(?:(?!(?:\\/|^)(?:\\.{1,2})($|\\/)).)*?",twoStarNoDot="(?:(?!(?:\\/|^)\\.).)*?";export const filter=(t,e={})=>s=>minimatch(s,t,e);minimatch.filter=filter;const ext=(t,e={})=>Object.assign({},t,e);export const defaults=t=>{if(!t||"object"!=typeof t||!Object.keys(t).length)return minimatch;const e=minimatch;return Object.assign((s,i,r={})=>e(s,i,ext(t,r)),{Minimatch:class extends e.Minimatch{constructor(e,s={}){super(e,ext(t,s))}static defaults(s){return e.defaults(ext(t,s)).Minimatch}},AST:class extends e.AST{constructor(e,s,i={}){super(e,s,ext(t,i))}static fromGlob(s,i={}){return e.AST.fromGlob(s,ext(t,i))}},unescape:(s,i={})=>e.unescape(s,ext(t,i)),escape:(s,i={})=>e.escape(s,ext(t,i)),filter:(s,i={})=>e.filter(s,ext(t,i)),defaults:s=>e.defaults(ext(t,s)),makeRe:(s,i={})=>e.makeRe(s,ext(t,i)),braceExpand:(s,i={})=>e.braceExpand(s,ext(t,i)),match:(s,i,r={})=>e.match(s,i,ext(t,r)),sep:e.sep,GLOBSTAR:GLOBSTAR})};minimatch.defaults=defaults;export const braceExpand=(t,e={})=>(assertValidPattern(t),e.nobrace||!/\{(?:(?!\{).)*\}/.test(t)?[t]:expand(t));minimatch.braceExpand=braceExpand;export const makeRe=(t,e={})=>new Minimatch(t,e).makeRe();minimatch.makeRe=makeRe;export const match=(t,e,s={})=>{const i=new Minimatch(e,s);return t=t.filter(t=>i.match(t)),i.options.nonull&&!t.length&&t.push(e),t};minimatch.match=match;const globMagic=/[?*]|[+@!]\(.*?\)|\[|\]/,regExpEscape=t=>t.replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&");export class Minimatch{options;set;pattern;windowsPathsNoEscape;nonegate;negate;comment;empty;preserveMultipleSlashes;partial;globSet;globParts;nocase;isWindows;platform;windowsNoMagicRoot;regexp;constructor(t,e={}){assertValidPattern(t),e=e||{},this.options=e,this.pattern=t,this.platform=e.platform||defaultPlatform,this.isWindows="win32"===this.platform,this.windowsPathsNoEscape=!!e.windowsPathsNoEscape||!1===e.allowWindowsEscape,this.windowsPathsNoEscape&&(this.pattern=this.pattern.replace(/\\/g,"/")),this.preserveMultipleSlashes=!!e.preserveMultipleSlashes,this.regexp=null,this.negate=!1,this.nonegate=!!e.nonegate,this.comment=!1,this.empty=!1,this.partial=!!e.partial,this.nocase=!!this.options.nocase,this.windowsNoMagicRoot=void 0!==e.windowsNoMagicRoot?e.windowsNoMagicRoot:!(!this.isWindows||!this.nocase),this.globSet=[],this.globParts=[],this.set=[],this.make()}hasMagic(){if(this.options.magicalBraces&&this.set.length>1)return!0;for(const t of this.set)for(const e of t)if("string"!=typeof e)return!0;return!1}debug(...t){}make(){const t=this.pattern,e=this.options;if(!e.nocomment&&"#"===t.charAt(0))return void(this.comment=!0);if(!t)return void(this.empty=!0);this.parseNegate(),this.globSet=[...new Set(this.braceExpand())],e.debug&&(this.debug=(...t)=>console.error(...t)),this.debug(this.pattern,this.globSet);const s=this.globSet.map(t=>this.slashSplit(t));this.globParts=this.preprocess(s),this.debug(this.pattern,this.globParts);let i=this.globParts.map((t,e,s)=>{if(this.isWindows&&this.windowsNoMagicRoot){const e=!(""!==t[0]||""!==t[1]||"?"!==t[2]&&globMagic.test(t[2])||globMagic.test(t[3])),s=/^[a-z]:/i.test(t[0]);if(e)return[...t.slice(0,4),...t.slice(4).map(t=>this.parse(t))];if(s)return[t[0],...t.slice(1).map(t=>this.parse(t))]}return t.map(t=>this.parse(t))});if(this.debug(this.pattern,i),this.set=i.filter(t=>-1===t.indexOf(!1)),this.isWindows)for(let t=0;t<this.set.length;t++){const e=this.set[t];""===e[0]&&""===e[1]&&"?"===this.globParts[t][2]&&"string"==typeof e[3]&&/^[a-z]:$/i.test(e[3])&&(e[2]="?")}this.debug(this.pattern,this.set)}preprocess(t){if(this.options.noglobstar)for(let e=0;e<t.length;e++)for(let s=0;s<t[e].length;s++)"**"===t[e][s]&&(t[e][s]="*");const{optimizationLevel:e=1}=this.options;return e>=2?(t=this.firstPhasePreProcess(t),t=this.secondPhasePreProcess(t)):t=e>=1?this.levelOneOptimize(t):this.adjascentGlobstarOptimize(t),t}adjascentGlobstarOptimize(t){return t.map(t=>{let e=-1;for(;-1!==(e=t.indexOf("**",e+1));){let s=e;for(;"**"===t[s+1];)s++;s!==e&&t.splice(e,s-e)}return t})}levelOneOptimize(t){return t.map(t=>0===(t=t.reduce((t,e)=>{const s=t[t.length-1];return"**"===e&&"**"===s?t:".."===e&&s&&".."!==s&&"."!==s&&"**"!==s?(t.pop(),t):(t.push(e),t)},[])).length?[""]:t)}levelTwoFileOptimize(t){Array.isArray(t)||(t=this.slashSplit(t));let e=!1;do{if(e=!1,!this.preserveMultipleSlashes){for(let s=1;s<t.length-1;s++){const i=t[s];1===s&&""===i&&""===t[0]||("."!==i&&""!==i||(e=!0,t.splice(s,1),s--))}"."!==t[0]||2!==t.length||"."!==t[1]&&""!==t[1]||(e=!0,t.pop())}let s=0;for(;-1!==(s=t.indexOf("..",s+1));){const i=t[s-1];i&&"."!==i&&".."!==i&&"**"!==i&&(e=!0,t.splice(s-1,2),s-=2)}}while(e);return 0===t.length?[""]:t}firstPhasePreProcess(t){let e=!1;do{e=!1;for(let s of t){let i=-1;for(;-1!==(i=s.indexOf("**",i+1));){let r=i;for(;"**"===s[r+1];)r++;r>i&&s.splice(i+1,r-i);let o=s[i+1];const a=s[i+2],n=s[i+3];if(".."!==o)continue;if(!a||"."===a||".."===a||!n||"."===n||".."===n)continue;e=!0,s.splice(i,1);const h=s.slice(0);h[i]="**",t.push(h),i--}if(!this.preserveMultipleSlashes){for(let t=1;t<s.length-1;t++){const i=s[t];1===t&&""===i&&""===s[0]||("."!==i&&""!==i||(e=!0,s.splice(t,1),t--))}"."!==s[0]||2!==s.length||"."!==s[1]&&""!==s[1]||(e=!0,s.pop())}let r=0;for(;-1!==(r=s.indexOf("..",r+1));){const t=s[r-1];if(t&&"."!==t&&".."!==t&&"**"!==t){e=!0;const t=1===r&&"**"===s[r+1]?["."]:[];s.splice(r-1,2,...t),0===s.length&&s.push(""),r-=2}}}}while(e);return t}secondPhasePreProcess(t){for(let e=0;e<t.length-1;e++)for(let s=e+1;s<t.length;s++){const i=this.partsMatch(t[e],t[s],!this.preserveMultipleSlashes);if(i){t[e]=[],t[s]=i;break}}return t.filter(t=>t.length)}partsMatch(t,e,s=!1){let i=0,r=0,o=[],a="";for(;i<t.length&&r<e.length;)if(t[i]===e[r])o.push("b"===a?e[r]:t[i]),i++,r++;else if(s&&"**"===t[i]&&e[r]===t[i+1])o.push(t[i]),i++;else if(s&&"**"===e[r]&&t[i]===e[r+1])o.push(e[r]),r++;else if("*"!==t[i]||!e[r]||!this.options.dot&&e[r].startsWith(".")||"**"===e[r]){if("*"!==e[r]||!t[i]||!this.options.dot&&t[i].startsWith(".")||"**"===t[i])return!1;if("a"===a)return!1;a="b",o.push(e[r]),i++,r++}else{if("b"===a)return!1;a="a",o.push(t[i]),i++,r++}return t.length===e.length&&o}parseNegate(){if(this.nonegate)return;const t=this.pattern;let e=!1,s=0;for(let i=0;i<t.length&&"!"===t.charAt(i);i++)e=!e,s++;s&&(this.pattern=t.slice(s)),this.negate=e}matchOne(t,e,s=!1){const i=this.options;if(this.isWindows){const s="string"==typeof t[0]&&/^[a-z]:$/i.test(t[0]),i=!s&&""===t[0]&&""===t[1]&&"?"===t[2]&&/^[a-z]:$/i.test(t[3]),r="string"==typeof e[0]&&/^[a-z]:$/i.test(e[0]),o=i?3:s?0:void 0,a=!r&&""===e[0]&&""===e[1]&&"?"===e[2]&&"string"==typeof e[3]&&/^[a-z]:$/i.test(e[3])?3:r?0:void 0;if("number"==typeof o&&"number"==typeof a){const[s,i]=[t[o],e[a]];s.toLowerCase()===i.toLowerCase()&&(e[a]=s,a>o?e=e.slice(a):o>a&&(t=t.slice(o)))}}const{optimizationLevel:r=1}=this.options;r>=2&&(t=this.levelTwoFileOptimize(t)),this.debug("matchOne",this,{file:t,pattern:e}),this.debug("matchOne",t.length,e.length);for(var o=0,a=0,n=t.length,h=e.length;o<n&&a<h;o++,a++){this.debug("matchOne loop");var c=e[a],p=t[o];if(this.debug(e,c,p),!1===c)return!1;if(c===GLOBSTAR){this.debug("GLOBSTAR",[e,c,p]);var l=o,m=a+1;if(m===h){for(this.debug("** at the end");o<n;o++)if("."===t[o]||".."===t[o]||!i.dot&&"."===t[o].charAt(0))return!1;return!0}for(;l<n;){var f=t[l];if(this.debug("\nglobstar while",t,l,e,m,f),this.matchOne(t.slice(l),e.slice(m),s))return this.debug("globstar found match!",l,n,f),!0;if("."===f||".."===f||!i.dot&&"."===f.charAt(0)){this.debug("dot detected!",t,l,e,m);break}this.debug("globstar swallow a segment, and continue"),l++}return!(!s||(this.debug("\n>>> no match, partial?",t,l,e,m),l!==n))}let r;if("string"==typeof c?(r=p===c,this.debug("string match",c,p,r)):(r=c.test(p),this.debug("pattern match",c,p,r)),!r)return!1}if(o===n&&a===h)return!0;if(o===n)return s;if(a===h)return o===n-1&&""===t[o];throw new Error("wtf?")}braceExpand(){return braceExpand(this.pattern,this.options)}parse(t){assertValidPattern(t);const e=this.options;if("**"===t)return GLOBSTAR;if(""===t)return"";let s,i=null;(s=t.match(starRE))?i=e.dot?starTestDot:starTest:(s=t.match(starDotExtRE))?i=(e.nocase?e.dot?starDotExtTestNocaseDot:starDotExtTestNocase:e.dot?starDotExtTestDot:starDotExtTest)(s[1]):(s=t.match(qmarksRE))?i=(e.nocase?e.dot?qmarksTestNocaseDot:qmarksTestNocase:e.dot?qmarksTestDot:qmarksTest)(s):(s=t.match(starDotStarRE))?i=e.dot?starDotStarTestDot:starDotStarTest:(s=t.match(dotStarRE))&&(i=dotStarTest);const r=AST.fromGlob(t,this.options).toMMPattern();return i&&"object"==typeof r&&Reflect.defineProperty(r,"test",{value:i}),r}makeRe(){if(this.regexp||!1===this.regexp)return this.regexp;const t=this.set;if(!t.length)return this.regexp=!1,this.regexp;const e=this.options,s=e.noglobstar?star:e.dot?twoStarDot:twoStarNoDot,i=new Set(e.nocase?["i"]:[]);let r=t.map(t=>{const e=t.map(t=>{if(t instanceof RegExp)for(const e of t.flags.split(""))i.add(e);return"string"==typeof t?regExpEscape(t):t===GLOBSTAR?GLOBSTAR:t._src});return e.forEach((t,i)=>{const r=e[i+1],o=e[i-1];t===GLOBSTAR&&o!==GLOBSTAR&&(void 0===o?void 0!==r&&r!==GLOBSTAR?e[i+1]="(?:\\/|"+s+"\\/)?"+r:e[i]=s:void 0===r?e[i-1]=o+"(?:\\/|"+s+")?":r!==GLOBSTAR&&(e[i-1]=o+"(?:\\/|\\/"+s+"\\/)"+r,e[i+1]=GLOBSTAR))}),e.filter(t=>t!==GLOBSTAR).join("/")}).join("|");const[o,a]=t.length>1?["(?:",")"]:["",""];r="^"+o+r+a+"$",this.negate&&(r="^(?!"+r+").+$");try{this.regexp=new RegExp(r,[...i].join(""))}catch(t){this.regexp=!1}return this.regexp}slashSplit(t){return this.preserveMultipleSlashes?t.split("/"):this.isWindows&&/^\/\/[^\/]+/.test(t)?["",...t.split(/\/+/)]:t.split(/\/+/)}match(t,e=this.partial){if(this.debug("match",t,this.pattern),this.comment)return!1;if(this.empty)return""===t;if("/"===t&&e)return!0;const s=this.options;this.isWindows&&(t=t.split("\\").join("/"));const i=this.slashSplit(t);this.debug(this.pattern,"split",i);const r=this.set;this.debug(this.pattern,"set",r);let o=i[i.length-1];if(!o)for(let t=i.length-2;!o&&t>=0;t--)o=i[t];for(let t=0;t<r.length;t++){const a=r[t];let n=i;s.matchBase&&1===a.length&&(n=[o]);if(this.matchOne(n,a,e))return!!s.flipNegate||!this.negate}return!s.flipNegate&&this.negate}static defaults(t){return minimatch.defaults(t).Minimatch}}export{AST}from"./ast.js";export{escape}from"./escape.js";export{unescape}from"./unescape.js";minimatch.AST=AST,minimatch.Minimatch=Minimatch,minimatch.escape=escape,minimatch.unescape=unescape;