"use strict";var __importDefault=this&&this.__importDefault||function(s){return s&&s.__esModule?s:{default:s}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.normalizeFgArgs=void 0,exports.foregroundChild=foregroundChild;const child_process_1=require("child_process"),cross_spawn_1=__importDefault(require("cross-spawn")),signal_exit_1=require("signal-exit"),proxy_signals_js_1=require("./proxy-signals.js"),watchdog_js_1=require("./watchdog.js"),spawn="win32"===process?.platform?cross_spawn_1.default:child_process_1.spawn,normalizeFgArgs=s=>{let[e,o=[],r={},t=()=>{}]=s;if("function"==typeof o?(t=o,r={},o=[]):o&&"object"==typeof o&&!Array.isArray(o)?("function"==typeof r&&(t=r),r=o,o=[]):"function"==typeof r&&(t=r,r={}),Array.isArray(e)){const[s,...r]=e;e=s,o=r}return[e,o,{...r},t]};function foregroundChild(...s){const[e,o,r,t]=(0,exports.normalizeFgArgs)(s);r.stdio=[0,1,2],process.send&&r.stdio.push("ipc");const i=spawn(e,o,r),n=(0,signal_exit_1.onExit)(()=>{try{i.kill("SIGHUP")}catch(s){i.kill("SIGTERM")}});(0,proxy_signals_js_1.proxySignals)(i);const c=(0,watchdog_js_1.watchdog)(i);let p=!1;return i.on("close",async(s,e)=>{if(p)return;p=!0;const o=t(s,e,{watchdogPid:c.pid}),r=isPromise(o)?await o:o;if(n(),!1!==r)if("string"==typeof r?(e=r,s=null):"number"==typeof r&&(s=r,e=null),e){setTimeout(()=>{},2e3);try{process.kill(process.pid,e)}catch(s){process.kill(process.pid,"SIGTERM")}}else process.exit(s||0)}),process.send&&(process.removeAllListeners("message"),i.on("message",(s,e)=>{process.send?.(s,e)}),process.on("message",(s,e)=>{i.send(s,e)})),i}exports.normalizeFgArgs=normalizeFgArgs;const isPromise=s=>!!s&&"object"==typeof s&&"function"==typeof s.then;