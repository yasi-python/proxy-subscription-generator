import{spawn as nodeSpawn}from"child_process";import crossSpawn from"cross-spawn";import{onExit}from"signal-exit";import{proxySignals}from"./proxy-signals.js";import{watchdog}from"./watchdog.js";const spawn="win32"===process?.platform?crossSpawn:nodeSpawn;export const normalizeFgArgs=s=>{let[o,e=[],r={},t=()=>{}]=s;if("function"==typeof e?(t=e,r={},e=[]):e&&"object"==typeof e&&!Array.isArray(e)?("function"==typeof r&&(t=r),r=e,e=[]):"function"==typeof r&&(t=r,r={}),Array.isArray(o)){const[s,...r]=o;o=s,e=r}return[o,e,{...r},t]};export function foregroundChild(...s){const[o,e,r,t]=normalizeFgArgs(s);r.stdio=[0,1,2],process.send&&r.stdio.push("ipc");const n=spawn(o,e,r),i=onExit(()=>{try{n.kill("SIGHUP")}catch(s){n.kill("SIGTERM")}});proxySignals(n);const p=watchdog(n);let c=!1;return n.on("close",async(s,o)=>{if(c)return;c=!0;const e=t(s,o,{watchdogPid:p.pid}),r=isPromise(e)?await e:e;if(i(),!1!==r)if("string"==typeof r?(o=r,s=null):"number"==typeof r&&(s=r,o=null),o){setTimeout(()=>{},2e3);try{process.kill(process.pid,o)}catch(s){process.kill(process.pid,"SIGTERM")}}else process.exit(s||0)}),process.send&&(process.removeAllListeners("message"),n.on("message",(s,o)=>{process.send?.(s,o)}),process.on("message",(s,o)=>{n.send(s,o)})),n}const isPromise=s=>!!s&&"object"==typeof s&&"function"==typeof s.then;