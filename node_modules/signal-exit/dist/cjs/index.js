"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.onExit=exports.signals=void 0;const signals_js_1=require("./signals.js");Object.defineProperty(exports,"signals",{enumerable:!0,get:function(){return signals_js_1.signals}});const processOk=t=>!!t&&"object"==typeof t&&"function"==typeof t.removeListener&&"function"==typeof t.emit&&"function"==typeof t.reallyExit&&"function"==typeof t.listeners&&"function"==typeof t.kill&&"number"==typeof t.pid&&"function"==typeof t.on,kExitEmitter=Symbol.for("signal-exit emitter"),global=globalThis,ObjectDefineProperty=Object.defineProperty.bind(Object);class Emitter{emitted={afterExit:!1,exit:!1};listeners={afterExit:[],exit:[]};count=0;id=Math.random();constructor(){if(global[kExitEmitter])return global[kExitEmitter];ObjectDefineProperty(global,kExitEmitter,{value:this,writable:!1,enumerable:!1,configurable:!1})}on(t,e){this.listeners[t].push(e)}removeListener(t,e){const s=this.listeners[t],i=s.indexOf(e);-1!==i&&(0===i&&1===s.length?s.length=0:s.splice(i,1))}emit(t,e,s){if(this.emitted[t])return!1;this.emitted[t]=!0;let i=!1;for(const o of this.listeners[t])i=!0===o(e,s)||i;return"exit"===t&&(i=this.emit("afterExit",e,s)||i),i}}class SignalExitBase{}const signalExitWrap=t=>({onExit:(e,s)=>t.onExit(e,s),load:()=>t.load(),unload:()=>t.unload()});class SignalExitFallback extends SignalExitBase{onExit(){return()=>{}}load(){}unload(){}}class SignalExit extends SignalExitBase{#t="win32"===process.platform?"SIGINT":"SIGHUP";#e=new Emitter;#s;#i;#o;#r={};#n=!1;constructor(t){super(),this.#s=t,this.#r={};for(const e of signals_js_1.signals)this.#r[e]=()=>{const s=this.#s.listeners(e);let{count:i}=this.#e;const o=t;if("object"==typeof o.__signal_exit_emitter__&&"number"==typeof o.__signal_exit_emitter__.count&&(i+=o.__signal_exit_emitter__.count),s.length===i){this.unload();const s=this.#e.emit("exit",null,e),i="SIGHUP"===e?this.#t:e;s||t.kill(t.pid,i)}};this.#o=t.reallyExit,this.#i=t.emit}onExit(t,e){if(!processOk(this.#s))return()=>{};!1===this.#n&&this.load();const s=e?.alwaysLast?"afterExit":"exit";return this.#e.on(s,t),()=>{this.#e.removeListener(s,t),0===this.#e.listeners.exit.length&&0===this.#e.listeners.afterExit.length&&this.unload()}}load(){if(!this.#n){this.#n=!0,this.#e.count+=1;for(const t of signals_js_1.signals)try{const e=this.#r[t];e&&this.#s.on(t,e)}catch(t){}this.#s.emit=(t,...e)=>this.#l(t,...e),this.#s.reallyExit=t=>this.#a(t)}}unload(){this.#n&&(this.#n=!1,signals_js_1.signals.forEach(t=>{const e=this.#r[t];if(!e)throw new Error("Listener not defined for signal: "+t);try{this.#s.removeListener(t,e)}catch(t){}}),this.#s.emit=this.#i,this.#s.reallyExit=this.#o,this.#e.count-=1)}#a(t){return processOk(this.#s)?(this.#s.exitCode=t||0,this.#e.emit("exit",this.#s.exitCode,null),this.#o.call(this.#s,this.#s.exitCode)):0}#l(t,...e){const s=this.#i;if("exit"===t&&processOk(this.#s)){"number"==typeof e[0]&&(this.#s.exitCode=e[0]);const i=s.call(this.#s,t,...e);return this.#e.emit("exit",this.#s.exitCode,null),i}return s.call(this.#s,t,...e)}}const process=globalThis.process;_a=signalExitWrap(processOk(process)?new SignalExit(process):new SignalExitFallback),exports.onExit=_a.onExit,exports.load=_a.load,exports.unload=_a.unload;