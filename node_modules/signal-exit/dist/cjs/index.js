"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.onExit=exports.signals=void 0;const signals_js_1=require("./signals.js");Object.defineProperty(exports,"signals",{enumerable:!0,get:function(){return signals_js_1.signals}});const processOk=t=>!!t&&"object"==typeof t&&"function"==typeof t.removeListener&&"function"==typeof t.emit&&"function"==typeof t.reallyExit&&"function"==typeof t.listeners&&"function"==typeof t.kill&&"number"==typeof t.pid&&"function"==typeof t.on,kExitEmitter=Symbol.for("signal-exit emitter"),global=globalThis,ObjectDefineProperty=Object.defineProperty.bind(Object);class Emitter{emitted={afterExit:!1,exit:!1};listeners={afterExit:[],exit:[]};count=0;id=Math.random();constructor(){if(global[kExitEmitter])return global[kExitEmitter];ObjectDefineProperty(global,kExitEmitter,{value:this,writable:!1,enumerable:!1,configurable:!1})}on(t,e){this.listeners[t].push(e)}removeListener(t,e){const i=this.listeners[t],s=i.indexOf(e);-1!==s&&(0===s&&1===i.length?i.length=0:i.splice(s,1))}emit(t,e,i){if(this.emitted[t])return!1;this.emitted[t]=!0;let s=!1;for(const n of this.listeners[t])s=!0===n(e,i)||s;return"exit"===t&&(s=this.emit("afterExit",e,i)||s),s}}class SignalExitBase{}const signalExitWrap=t=>({onExit:(e,i)=>t.onExit(e,i),load:()=>t.load(),unload:()=>t.unload()});class SignalExitFallback extends SignalExitBase{onExit(){return()=>{}}load(){}unload(){}}class SignalExit extends SignalExitBase{#t="win32"===process.platform?"SIGINT":"SIGHUP";#e=new Emitter;#i;#s;#n;#o={};#r=!1;constructor(t){super(),this.#i=t,this.#o={};for(const e of signals_js_1.signals)this.#o[e]=()=>{const i=this.#i.listeners(e);let{count:s}=this.#e;const n=t;if("object"==typeof n.__signal_exit_emitter__&&"number"==typeof n.__signal_exit_emitter__.count&&(s+=n.__signal_exit_emitter__.count),i.length===s){this.unload();const i=this.#e.emit("exit",null,e),s="SIGHUP"===e?this.#t:e;i||t.kill(t.pid,s)}};this.#n=t.reallyExit,this.#s=t.emit}onExit(t,e){if(!processOk(this.#i))return()=>{};!1===this.#r&&this.load();const i=e?.alwaysLast?"afterExit":"exit";return this.#e.on(i,t),()=>{this.#e.removeListener(i,t),0===this.#e.listeners.exit.length&&0===this.#e.listeners.afterExit.length&&this.unload()}}load(){if(!this.#r){this.#r=!0,this.#e.count+=1;for(const t of signals_js_1.signals)try{const e=this.#o[t];e&&this.#i.on(t,e)}catch(t){}this.#i.emit=(t,...e)=>this.#l(t,...e),this.#i.reallyExit=t=>this.#a(t)}}unload(){this.#r&&(this.#r=!1,signals_js_1.signals.forEach(t=>{const e=this.#o[t];if(!e)throw new Error("Listener not defined for signal: "+t);try{this.#i.removeListener(t,e)}catch(t){}}),this.#i.emit=this.#s,this.#i.reallyExit=this.#n,this.#e.count-=1)}#a(t){return processOk(this.#i)?(this.#i.exitCode=t||0,this.#e.emit("exit",this.#i.exitCode,null),this.#n.call(this.#i,this.#i.exitCode)):0}#l(t,...e){const i=this.#s;if("exit"===t&&processOk(this.#i)){"number"==typeof e[0]&&(this.#i.exitCode=e[0]);const s=i.call(this.#i,t,...e);return this.#e.emit("exit",this.#i.exitCode,null),s}return i.call(this.#i,t,...e)}}const process=globalThis.process;_a=signalExitWrap(processOk(process)?new SignalExit(process):new SignalExitFallback),exports.onExit=_a.onExit,exports.load=_a.load,exports.unload=_a.unload;