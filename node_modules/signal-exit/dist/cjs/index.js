"use strict";var _a;Object.defineProperty(exports,"__esModule",{value:!0}),exports.unload=exports.load=exports.onExit=exports.signals=void 0;const signals_js_1=require("./signals.js");Object.defineProperty(exports,"signals",{enumerable:!0,get:function(){return signals_js_1.signals}});const processOk=t=>!!t&&"object"==typeof t&&"function"==typeof t.removeListener&&"function"==typeof t.emit&&"function"==typeof t.reallyExit&&"function"==typeof t.listeners&&"function"==typeof t.kill&&"number"==typeof t.pid&&"function"==typeof t.on,kExitEmitter=Symbol.for("signal-exit emitter"),global=globalThis,ObjectDefineProperty=Object.defineProperty.bind(Object);class Emitter{emitted={afterExit:!1,exit:!1};listeners={afterExit:[],exit:[]};count=0;id=Math.random();constructor(){if(global[kExitEmitter])return global[kExitEmitter];ObjectDefineProperty(global,kExitEmitter,{value:this,writable:!1,enumerable:!1,configurable:!1})}on(t,i){this.listeners[t].push(i)}removeListener(t,i){const e=this.listeners[t],s=e.indexOf(i);-1!==s&&(0===s&&1===e.length?e.length=0:e.splice(s,1))}emit(t,i,e){if(this.emitted[t])return!1;this.emitted[t]=!0;let s=!1;for(const n of this.listeners[t])s=!0===n(i,e)||s;return"exit"===t&&(s=this.emit("afterExit",i,e)||s),s}}class SignalExitBase{}const signalExitWrap=t=>({onExit:(i,e)=>t.onExit(i,e),load:()=>t.load(),unload:()=>t.unload()});class SignalExitFallback extends SignalExitBase{onExit(){return()=>{}}load(){}unload(){}}class SignalExit extends SignalExitBase{#t="win32"===process.platform?"SIGINT":"SIGHUP";#i=new Emitter;#e;#s;#n;#o={};#r=!1;constructor(t){super(),this.#e=t,this.#o={};for(const i of signals_js_1.signals)this.#o[i]=()=>{const e=this.#e.listeners(i);let{count:s}=this.#i;const n=t;if("object"==typeof n.__signal_exit_emitter__&&"number"==typeof n.__signal_exit_emitter__.count&&(s+=n.__signal_exit_emitter__.count),e.length===s){this.unload();const e=this.#i.emit("exit",null,i),s="SIGHUP"===i?this.#t:i;e||t.kill(t.pid,s)}};this.#n=t.reallyExit,this.#s=t.emit}onExit(t,i){if(!processOk(this.#e))return()=>{};!1===this.#r&&this.load();const e=i?.alwaysLast?"afterExit":"exit";return this.#i.on(e,t),()=>{this.#i.removeListener(e,t),0===this.#i.listeners.exit.length&&0===this.#i.listeners.afterExit.length&&this.unload()}}load(){if(!this.#r){this.#r=!0,this.#i.count+=1;for(const t of signals_js_1.signals)try{const i=this.#o[t];i&&this.#e.on(t,i)}catch(t){}this.#e.emit=(t,...i)=>this.#l(t,...i),this.#e.reallyExit=t=>this.#a(t)}}unload(){this.#r&&(this.#r=!1,signals_js_1.signals.forEach(t=>{const i=this.#o[t];if(!i)throw new Error("Listener not defined for signal: "+t);try{this.#e.removeListener(t,i)}catch(t){}}),this.#e.emit=this.#s,this.#e.reallyExit=this.#n,this.#i.count-=1)}#a(t){return processOk(this.#e)?(this.#e.exitCode=t||0,this.#i.emit("exit",this.#e.exitCode,null),this.#n.call(this.#e,this.#e.exitCode)):0}#l(t,...i){const e=this.#s;if("exit"===t&&processOk(this.#e)){"number"==typeof i[0]&&(this.#e.exitCode=i[0]);const s=e.call(this.#e,t,...i);return this.#i.emit("exit",this.#e.exitCode,null),s}return e.call(this.#e,t,...i)}}const process=globalThis.process;_a=signalExitWrap(processOk(process)?new SignalExit(process):new SignalExitFallback),exports.onExit=_a.onExit,exports.load=_a.load,exports.unload=_a.unload;