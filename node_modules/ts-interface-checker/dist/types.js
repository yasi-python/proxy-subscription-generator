"use strict";var __extends=this&&this.__extends||function(){var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)t.hasOwnProperty(n)&&(e[n]=t[n])},e(t,n)};return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}}();Object.defineProperty(exports,"__esModule",{value:!0}),exports.basicTypes=exports.BasicType=exports.TParamList=exports.TParam=exports.param=exports.TFunc=exports.func=exports.TProp=exports.TOptional=exports.opt=exports.TIface=exports.iface=exports.TEnumLiteral=exports.enumlit=exports.TEnumType=exports.enumtype=exports.TIntersection=exports.intersection=exports.TUnion=exports.union=exports.TTuple=exports.tuple=exports.TArray=exports.array=exports.TLiteral=exports.lit=exports.TName=exports.name=exports.TType=void 0;var util_1=require("./util"),TType=function(){};function parseSpec(e){return"string"==typeof e?name(e):e}function getNamedType(e,t){var n=e[t];if(!n)throw new Error("Unknown type "+t);return n}function name(e){return new TName(e)}exports.TType=TType,exports.name=name;var TName=function(e){function t(t){var n=e.call(this)||this;return n.name=t,n._failMsg="is not a "+t,n}return __extends(t,e),t.prototype.getChecker=function(e,n,r){var i=this,o=getNamedType(e,this.name),a=o.getChecker(e,n,r);return o instanceof BasicType||o instanceof t?a:function(e,t){return!!a(e,t)||t.fail(null,i._failMsg,0)}},t}(TType);function lit(e){return new TLiteral(e)}exports.TName=TName,exports.lit=lit;var TLiteral=function(e){function t(t){var n=e.call(this)||this;return n.value=t,n.name=JSON.stringify(t),n._failMsg="is not "+n.name,n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this;return function(e,t){return e===n.value||t.fail(null,n._failMsg,-1)}},t}(TType);function array(e){return new TArray(parseSpec(e))}exports.TLiteral=TLiteral,exports.array=array;var TArray=function(e){function t(t){var n=e.call(this)||this;return n.ttype=t,n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this.ttype.getChecker(e,t);return function(e,t){if(!Array.isArray(e))return t.fail(null,"is not an array",0);for(var r=0;r<e.length;r++)if(!n(e[r],t))return t.fail(r,null,1);return!0}},t}(TType);function tuple(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new TTuple(e.map(function(e){return parseSpec(e)}))}exports.TArray=TArray,exports.tuple=tuple;var TTuple=function(e){function t(t){var n=e.call(this)||this;return n.ttypes=t,n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this.ttypes.map(function(n){return n.getChecker(e,t)}),r=function(e,t){if(!Array.isArray(e))return t.fail(null,"is not an array",0);for(var r=0;r<n.length;r++)if(!n[r](e[r],t))return t.fail(r,null,1);return!0};return t?function(e,t){return!!r(e,t)&&(e.length<=n.length||t.fail(n.length,"is extraneous",2))}:r},t}(TType);function union(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new TUnion(e.map(function(e){return parseSpec(e)}))}exports.TTuple=TTuple,exports.union=union;var TUnion=function(e){function t(t){var n=e.call(this)||this;n.ttypes=t;var r=t.map(function(e){return e instanceof TName||e instanceof TLiteral?e.name:null}).filter(function(e){return e}),i=t.length-r.length;return r.length?(i>0&&r.push(i+" more"),n._failMsg="is none of "+r.join(", ")):n._failMsg="is none of "+i+" types",n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this,r=this.ttypes.map(function(n){return n.getChecker(e,t)});return function(e,t){for(var i=t.unionResolver(),o=0;o<r.length;o++)if(r[o](e,i.createContext()))return!0;return t.resolveUnion(i),t.fail(null,n._failMsg,0)}},t}(TType);function intersection(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return new TIntersection(e.map(function(e){return parseSpec(e)}))}exports.TUnion=TUnion,exports.intersection=intersection;var TIntersection=function(e){function t(t){var n=e.call(this)||this;return n.ttypes=t,n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=new Set,r=this.ttypes.map(function(r){return r.getChecker(e,t,n)});return function(e,t){return!!r.every(function(n){return n(e,t)})||t.fail(null,null,0)}},t}(TType);function enumtype(e){return new TEnumType(e)}exports.TIntersection=TIntersection,exports.enumtype=enumtype;var TEnumType=function(e){function t(t){var n=e.call(this)||this;return n.members=t,n.validValues=new Set,n._failMsg="is not a valid enum value",n.validValues=new Set(Object.keys(t).map(function(e){return t[e]})),n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this;return function(e,t){return!!n.validValues.has(e)||t.fail(null,n._failMsg,0)}},t}(TType);function enumlit(e,t){return new TEnumLiteral(e,t)}exports.TEnumType=TEnumType,exports.enumlit=enumlit;var TEnumLiteral=function(e){function t(t,n){var r=e.call(this)||this;return r.enumName=t,r.prop=n,r._failMsg="is not "+t+"."+n,r}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this,r=getNamedType(e,this.enumName);if(!(r instanceof TEnumType))throw new Error("Type "+this.enumName+" used in enumlit is not an enum type");var i=r.members[this.prop];if(!r.members.hasOwnProperty(this.prop))throw new Error("Unknown value "+this.enumName+"."+this.prop+" used in enumlit");return function(e,t){return e===i||t.fail(null,n._failMsg,-1)}},t}(TType);function makeIfaceProps(e){return Object.keys(e).map(function(t){return makeIfaceProp(t,e[t])})}function makeIfaceProp(e,t){return t instanceof TOptional?new TProp(e,t.ttype,!0):new TProp(e,parseSpec(t),!1)}function iface(e,t){return new TIface(e,makeIfaceProps(t))}exports.TEnumLiteral=TEnumLiteral,exports.iface=iface;var TIface=function(e){function t(t,n){var r=e.call(this)||this;return r.bases=t,r.props=n,r.propSet=new Set(n.map(function(e){return e.name})),r}return __extends(t,e),t.prototype.getChecker=function(e,t,n){var r=this,i=this.bases.map(function(n){return getNamedType(e,n).getChecker(e,t)}),o=this.props.map(function(n){return n.ttype.getChecker(e,t)}),a=new util_1.NoopContext,u=this.props.map(function(e,t){return!e.isOpt&&!o[t](void 0,a)}),s=function(e,t){if("object"!=typeof e||null===e)return t.fail(null,"is not an object",0);for(var n=0;n<i.length;n++)if(!i[n](e,t))return!1;for(n=0;n<o.length;n++){var a=r.props[n].name,s=e[a];if(void 0===s){if(u[n])return t.fail(a,"is missing",1)}else if(!o[n](s,t))return t.fail(a,null,1)}return!0};if(!t)return s;var p=this.propSet;return n&&(this.propSet.forEach(function(e){return n.add(e)}),p=n),function(e,t){if(!s(e,t))return!1;for(var n in e)if(!p.has(n))return t.fail(n,"is extraneous",2);return!0}},t}(TType);function opt(e){return new TOptional(parseSpec(e))}exports.TIface=TIface,exports.opt=opt;var TOptional=function(e){function t(t){var n=e.call(this)||this;return n.ttype=t,n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this.ttype.getChecker(e,t);return function(e,t){return void 0===e||n(e,t)}},t}(TType);exports.TOptional=TOptional;var TProp=function(e,t,n){this.name=e,this.ttype=t,this.isOpt=n};function func(e){for(var t=[],n=1;n<arguments.length;n++)t[n-1]=arguments[n];return new TFunc(new TParamList(t),parseSpec(e))}exports.TProp=TProp,exports.func=func;var TFunc=function(e){function t(t,n){var r=e.call(this)||this;return r.paramList=t,r.result=n,r}return __extends(t,e),t.prototype.getChecker=function(e,t){return function(e,t){return"function"==typeof e||t.fail(null,"is not a function",0)}},t}(TType);function param(e,t,n){return new TParam(e,parseSpec(t),Boolean(n))}exports.TFunc=TFunc,exports.param=param;var TParam=function(e,t,n){this.name=e,this.ttype=t,this.isOpt=n};exports.TParam=TParam;var TParamList=function(e){function t(t){var n=e.call(this)||this;return n.params=t,n}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this,r=this.params.map(function(n){return n.ttype.getChecker(e,t)}),i=new util_1.NoopContext,o=this.params.map(function(e,t){return!e.isOpt&&!r[t](void 0,i)}),a=function(e,t){if(!Array.isArray(e))return t.fail(null,"is not an array",0);for(var i=0;i<r.length;i++){var a=n.params[i];if(void 0===e[i]){if(o[i])return t.fail(a.name,"is missing",1)}else if(!r[i](e[i],t))return t.fail(a.name,null,1)}return!0};return t?function(e,t){return!!a(e,t)&&(e.length<=r.length||t.fail(r.length,"is extraneous",2))}:a},t}(TType);exports.TParamList=TParamList;var BasicType=function(e){function t(t,n){var r=e.call(this)||this;return r.validator=t,r.message=n,r}return __extends(t,e),t.prototype.getChecker=function(e,t){var n=this;return function(e,t){return!!n.validator(e)||t.fail(null,n.message,0)}},t}(TType);exports.BasicType=BasicType,exports.basicTypes={any:new BasicType(function(e){return!0},"is invalid"),number:new BasicType(function(e){return"number"==typeof e},"is not a number"),object:new BasicType(function(e){return"object"==typeof e&&e},"is not an object"),boolean:new BasicType(function(e){return"boolean"==typeof e},"is not a boolean"),string:new BasicType(function(e){return"string"==typeof e},"is not a string"),symbol:new BasicType(function(e){return"symbol"==typeof e},"is not a symbol"),void:new BasicType(function(e){return null==e},"is not void"),undefined:new BasicType(function(e){return void 0===e},"is not undefined"),null:new BasicType(function(e){return null===e},"is not null"),never:new BasicType(function(e){return!1},"is unexpected"),Date:new BasicType(getIsNativeChecker("[object Date]"),"is not a Date"),RegExp:new BasicType(getIsNativeChecker("[object RegExp]"),"is not a RegExp")};var nativeToString=Object.prototype.toString;function getIsNativeChecker(e){return function(t){return"object"==typeof t&&t&&nativeToString.call(t)===e}}"undefined"!=typeof Buffer&&(exports.basicTypes.Buffer=new BasicType(function(e){return Buffer.isBuffer(e)},"is not a Buffer"));for(var _loop_1=function(e){exports.basicTypes[e.name]=new BasicType(function(t){return t instanceof e},"is not a "+e.name)},_i=0,_a=[Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array,ArrayBuffer];_i<_a.length;_i++){var array_1=_a[_i];_loop_1(array_1)}