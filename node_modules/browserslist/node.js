var feature=require("caniuse-lite/dist/unpacker/feature").default,region=require("caniuse-lite/dist/unpacker/region").default,fs=require("fs"),path=require("path"),BrowserslistError=require("./error"),IS_SECTION=/^\s*\[(.+)]\s*$/,CONFIG_PATTERN=/^browserslist-config-/,SCOPED_CONFIG__PATTERN=/@[^/]+(?:\/[^/]+)?\/browserslist-config(?:-|$|\/)/,FORMAT="Browserslist config should be a string or an array of strings with browser queries",dataTimeChecked=!1,statCache={},configPathCache={},parseConfigCache={};function checkExtend(r){var e=" Use `dangerousExtend` option to disable.";if(!CONFIG_PATTERN.test(r)&&!SCOPED_CONFIG__PATTERN.test(r))throw new BrowserslistError("Browserslist config needs `browserslist-config-` prefix. "+e);if(-1!==r.replace(/^@[^/]+\//,"").indexOf("."))throw new BrowserslistError("`.` not allowed in Browserslist config name. "+e);if(-1!==r.indexOf("node_modules"))throw new BrowserslistError("`node_modules` not allowed in Browserslist config."+e)}function isFile(r){return fs.existsSync(r)&&fs.statSync(r).isFile()}function isDirectory(r){return fs.existsSync(r)&&fs.statSync(r).isDirectory()}function eachParent(r,e,s){var t,n=path.resolve(r),o=[];do{if(!pathInRoot(n))break;if(s&&n in s){t=s[n];break}if(o.push(n),isDirectory(n)){var i=e(n);if(void 0!==i){t=i;break}}}while(n!==(n=path.dirname(n)));return s&&!process.env.BROWSERSLIST_DISABLE_CACHE&&o.forEach(function(r){s[r]=t}),t}function pathInRoot(r){if(!process.env.BROWSERSLIST_ROOT_PATH)return!0;var e=path.resolve(process.env.BROWSERSLIST_ROOT_PATH);return".."!==path.relative(e,r).substring(0,2)}function check(r){if(Array.isArray(r)){for(var e=0;e<r.length;e++)if("string"!=typeof r[e])throw new BrowserslistError(FORMAT)}else if("string"!=typeof r)throw new BrowserslistError(FORMAT)}function pickEnv(r,e){if("object"!=typeof r)return r;var s;if(s="string"==typeof e.env?e.env:process.env.BROWSERSLIST_ENV?process.env.BROWSERSLIST_ENV:process.env.NODE_ENV?process.env.NODE_ENV:"production",e.throwOnMissing&&s&&"defaults"!==s&&!r[s])throw new BrowserslistError("Missing config for Browserslist environment `"+s+"`");return r[s]||r.defaults}function parsePackage(r){var e,s=fs.readFileSync(r).toString().replace(/^\uFEFF/m,"");if(s.indexOf('"browserslist"')>=0)e=JSON.parse(s).browserslist;else if(s.indexOf('"browserlist"')>=0){var t=JSON.parse(s);if(t.browserlist&&!t.browserslist)throw new BrowserslistError("`browserlist` key instead of `browserslist` in "+r)}for(var n in(Array.isArray(e)||"string"==typeof e)&&(e={defaults:e}),e)check(e[n]);return e}function parsePackageOrReadConfig(r){if(r in parseConfigCache)return parseConfigCache[r];var e="package.json"===path.basename(r)?parsePackage(r):module.exports.readConfig(r);return process.env.BROWSERSLIST_DISABLE_CACHE||(parseConfigCache[r]=e),e}function latestReleaseTime(r){var e=0;for(var s in r){var t=r[s].releaseDate||{};for(var n in t)e<t[n]&&(e=t[n])}return 1e3*e}function getMonthsPassed(r){var e=new Date,s=new Date(r);return 12*(e.getFullYear()-s.getFullYear())+(e.getMonth()-s.getMonth())}function normalizeStats(r,e){if(r||(r={}),e&&"dataByBrowser"in e&&(e=e.dataByBrowser),"object"==typeof e){var s={};for(var t in e){var n=Object.keys(e[t]);if(1===n.length&&r[t]&&1===r[t].versions.length){var o=r[t].versions[0];s[t]={},s[t][o]=e[t][n[0]]}else s[t]=e[t]}return s}}function normalizeUsageData(r,e){for(var s in r){var t=r[s];if("0"in t){var n=e[s].versions;t[n[n.length-1]]=t[0],delete t[0]}}}module.exports={loadQueries:function(r,e){r.dangerousExtend||process.env.BROWSERSLIST_DANGEROUS_EXTEND||checkExtend(e);var s=require(require.resolve(e,{paths:[".",r.path]}));if("object"==typeof s&&null!==s&&s.__esModule&&(s=s.default),s){if(Array.isArray(s))return s;if("object"==typeof s)return s.defaults||(s.defaults=[]),pickEnv(s,r,e)}throw new BrowserslistError("`"+e+"` config exports not an array of queries or an object of envs")},loadStat:function(r,e,s){return r.dangerousExtend||process.env.BROWSERSLIST_DANGEROUS_EXTEND||checkExtend(e),normalizeStats(s,require(require.resolve(path.join(e,"browserslist-stats.json"),{paths:["."]})))},getStat:function(r,e){var s;if(r.stats?s=r.stats:process.env.BROWSERSLIST_STATS?s=process.env.BROWSERSLIST_STATS:r.path&&path.resolve&&fs.existsSync&&(s=eachParent(r.path,function(r){var e=path.join(r,"browserslist-stats.json");return isFile(e)?e:void 0},statCache)),"string"==typeof s)try{s=JSON.parse(fs.readFileSync(s))}catch(r){throw new BrowserslistError("Can't read "+s)}return normalizeStats(e,s)},loadConfig:function(r){return process.env.BROWSERSLIST?process.env.BROWSERSLIST:r.config||process.env.BROWSERSLIST_CONFIG?pickEnv(parsePackageOrReadConfig(r.config||process.env.BROWSERSLIST_CONFIG),r):r.path?pickEnv(module.exports.findConfig(r.path),r):void 0},loadCountry:function(r,e,s){var t=e.replace(/[^\w-]/g,"");if(!r[t]){var n;try{n=require("caniuse-lite/data/regions/"+t+".js")}catch(r){throw new BrowserslistError("Unknown region name `"+t+"`.")}var o=region(n);for(var i in normalizeUsageData(o,s),r[e]={},o)for(var a in o[i])r[e][i+" "+a]=o[i][a]}},loadFeature:function(r,e){if(!r[e=e.replace(/[^\w-]/g,"")]){var s;try{s=require("caniuse-lite/data/features/"+e+".js")}catch(r){throw new BrowserslistError("Unknown feature name `"+e+"`.")}var t=feature(s).stats;for(var n in r[e]={},t)for(var o in r[e][n]={},t[n])r[e][n][o]=t[n][o]}},parseConfig:function(r){var e={defaults:[]},s=["defaults"];return r.toString().replace(/#[^\n]*/g,"").split(/\n|,/).map(function(r){return r.trim()}).filter(function(r){return""!==r}).forEach(function(r){IS_SECTION.test(r)?(s=r.match(IS_SECTION)[1].trim().split(" ")).forEach(function(r){if(e[r])throw new BrowserslistError("Duplicate section "+r+" in Browserslist config");e[r]=[]}):s.forEach(function(s){e[s].push(r)})}),e},readConfig:function(r){if(!isFile(r))throw new BrowserslistError("Can't read "+r+" config");return module.exports.parseConfig(fs.readFileSync(r))},findConfigFile:function(r){return eachParent(r,function(r){var e,s=path.join(r,"browserslist"),t=path.join(r,"package.json"),n=path.join(r,".browserslistrc");if(isFile(t))try{e=parsePackage(t)}catch(r){if("BrowserslistError"===r.name)throw r;console.warn("[Browserslist] Could not parse "+t+". Ignoring it.")}if(isFile(s)&&e)throw new BrowserslistError(r+" contains both browserslist and package.json with browsers");if(isFile(n)&&e)throw new BrowserslistError(r+" contains both .browserslistrc and package.json with browsers");if(isFile(s)&&isFile(n))throw new BrowserslistError(r+" contains both .browserslistrc and browserslist");return isFile(s)?s:isFile(n)?n:e?t:void 0},configPathCache)},findConfig:function(r){var e=this.findConfigFile(r);return e?parsePackageOrReadConfig(e):void 0},clearCaches:function(){dataTimeChecked=!1,statCache={},configPathCache={},parseConfigCache={},this.cache={}},oldDataWarning:function(r){if(!dataTimeChecked&&(dataTimeChecked=!0,!process.env.BROWSERSLIST_IGNORE_OLD_DATA)){var e=latestReleaseTime(r),s=getMonthsPassed(e);if(0!==e&&s>=6){var t=s+" "+(s>1?"months":"month");console.warn("Browserslist: browsers data (caniuse-lite) is "+t+" old. Please run:\n  npx update-browserslist-db@latest\n  Why you should do it regularly: https://github.com/browserslist/update-db#readme")}}},currentNode:function(){return"node "+process.versions.node},env:process.env};