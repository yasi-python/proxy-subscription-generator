var AND_REGEXP=/^\s+and\s+(.*)/i,OR_REGEXP=/^(?:,\s*|\s+or\s+)(.*)/i;function flatten(r){return Array.isArray(r)?r.reduce(function(r,t){return r.concat(flatten(t))},[]):[r]}function find(r,t){for(var n=r.length,e=1;e<=n;e++){if(t(r.substr(-e,e),e,n))return r.slice(0,-e)}return""}function matchQuery(r,t){var n={query:t};for(var e in 0===t.indexOf("not ")&&(n.not=!0,t=t.slice(4)),r){var a=r[e],u=t.match(a.regexp);if(u){n.type=e;for(var c=0;c<a.matches.length;c++)n[a.matches[c]]=u[c+1];return n}}return n.type="unknown",n}function matchBlock(r,t,n){var e;return find(t,function(t,a,u){return AND_REGEXP.test(t)?((e=matchQuery(r,t.match(AND_REGEXP)[1])).compose="and",n.unshift(e),!0):OR_REGEXP.test(t)?((e=matchQuery(r,t.match(OR_REGEXP)[1])).compose="or",n.unshift(e),!0):a===u&&((e=matchQuery(r,t.trim())).compose="or",n.unshift(e),!0)})}module.exports=function(r,t){return Array.isArray(t)||(t=[t]),flatten(t.map(function(t){var n=[];do{t=matchBlock(r,t,n)}while(t);return n}))};