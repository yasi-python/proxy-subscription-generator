var jsReleases=require("node-releases/data/processed/envs.json"),agents=require("caniuse-lite/dist/unpacker/agents").agents,e2c=require("electron-to-chromium/versions"),jsEOL=require("node-releases/data/release-schedule/release-schedule.json"),path=require("path"),BrowserslistError=require("./error"),env=require("./node"),parseWithoutCache=require("./parse"),YEAR=31558432982.4,ANDROID_EVERGREEN_FIRST="37",OP_MOB_BLINK_FIRST=14;function isVersionsMatch(e,r){return 0===(e+".").indexOf(r+".")}function isEolReleased(e){var r=e.slice(1);return browserslist.nodeVersions.some(function(e){return isVersionsMatch(e,r)})}function normalize(e){return e.filter(function(e){return"string"==typeof e})}function normalizeElectron(e){var r=e;return 3===e.split(".").length&&(r=e.split(".").slice(0,-1).join(".")),r}function nameMapper(e){return function(r){return e+" "+r}}function getMajor(e){return parseInt(e.split(".")[0])}function getMajorVersions(e,r){if(0===e.length)return[];var s=uniq(e.map(getMajor)),n=s[s.length-r];if(!n)return e;for(var t=[],o=e.length-1;o>=0&&!(n>getMajor(e[o]));o--)t.unshift(e[o]);return t}function uniq(e){for(var r=[],s=0;s<e.length;s++)-1===r.indexOf(e[s])&&r.push(e[s]);return r}function fillUsage(e,r,s){for(var n in s)e[r+" "+n]=s[n]}function generateFilter(e,r){return r=parseFloat(r),">"===e?function(e){return s(e)>r}:">="===e?function(e){return s(e)>=r}:"<"===e?function(e){return parseFloat(e)<r}:function(e){return parseFloat(e)<=r};function s(e){return parseFloat(e.split("-")[1]||e)}}function generateSemverFilter(e,r){return(r=r.split(".").map(parseSimpleInt))[1]=r[1]||0,r[2]=r[2]||0,">"===e?function(e){return compareSemver(e=e.split(".").map(parseSimpleInt),r)>0}:">="===e?function(e){return compareSemver(e=e.split(".").map(parseSimpleInt),r)>=0}:"<"===e?function(e){return e=e.split(".").map(parseSimpleInt),compareSemver(r,e)>0}:function(e){return e=e.split(".").map(parseSimpleInt),compareSemver(r,e)>=0}}function parseSimpleInt(e){return parseInt(e)}function compare(e,r){return e<r?-1:e>r?1:0}function compareSemver(e,r){return compare(parseInt(e[0]),parseInt(r[0]))||compare(parseInt(e[1]||"0"),parseInt(r[1]||"0"))||compare(parseInt(e[2]||"0"),parseInt(r[2]||"0"))}function semverFilterLoose(e,r){return void 0===(r=r.split(".").map(parseSimpleInt))[1]&&(r[1]="x"),"<="===e?function(e){return compareSemverLoose(e=e.split(".").map(parseSimpleInt),r)<=0}:function(e){return compareSemverLoose(e=e.split(".").map(parseSimpleInt),r)>=0}}function compareSemverLoose(e,r){return e[0]!==r[0]?e[0]<r[0]?-1:1:"x"===r[1]?0:e[1]!==r[1]?e[1]<r[1]?-1:1:0}function resolveVersion(e,r){return-1!==e.versions.indexOf(r)?r:!!browserslist.versionAliases[e.name][r]&&browserslist.versionAliases[e.name][r]}function normalizeVersion(e,r){return resolveVersion(e,r)||1===e.versions.length&&e.versions[0]}function filterByYear(e,r){return e/=1e3,Object.keys(agents).reduce(function(s,n){var t=byName(n,r);if(!t)return s;var o=Object.keys(t.releaseDate).filter(function(r){var s=t.releaseDate[r];return null!==s&&s>=e});return s.concat(o.map(nameMapper(t.name)))},[])}function cloneData(e){return{name:e.name,versions:e.versions,released:e.released,releaseDate:e.releaseDate}}function byName(e,r){if(e=e.toLowerCase(),e=browserslist.aliases[e]||e,r.mobileToDesktop&&browserslist.desktopNames[e]){var s=browserslist.data[browserslist.desktopNames[e]];if("android"===e)return normalizeAndroidData(cloneData(browserslist.data[e]),s);var n=cloneData(s);return n.name=e,n}return browserslist.data[e]}function normalizeAndroidVersions(e,r){var s=r.indexOf(ANDROID_EVERGREEN_FIRST);return e.filter(function(e){return/^(?:[2-4]\.|[34]$)/.test(e)}).concat(r.slice(s))}function copyObject(e){var r={};for(var s in e)r[s]=e[s];return r}function normalizeAndroidData(e,r){return e.released=normalizeAndroidVersions(e.released,r.released),e.versions=normalizeAndroidVersions(e.versions,r.versions),e.releaseDate=copyObject(e.releaseDate),e.released.forEach(function(s){void 0===e.releaseDate[s]&&(e.releaseDate[s]=r.releaseDate[s])}),e}function checkName(e,r){var s=byName(e,r);if(!s)throw new BrowserslistError("Unknown browser "+e);return s}function unknownQuery(e){return new BrowserslistError("Unknown browser query `"+e+"`. Maybe you are using old Browserslist or made typo in query.")}function filterJumps(e,r,s,n){var t=1;switch(r){case"android":if(n.mobileToDesktop)return e;var o=browserslist.data.chrome.released;t=o.length-o.indexOf(ANDROID_EVERGREEN_FIRST);break;case"op_mob":t=getMajor(browserslist.data.op_mob.released.slice(-1)[0])-OP_MOB_BLINK_FIRST+1;break;default:return e}return s<=t?e.slice(-1):e.slice(t-1-s)}function isSupported(e,r){return"string"==typeof e&&(e.indexOf("y")>=0||r&&e.indexOf("a")>=0)}function resolve(e,r){return parseQueries(e).reduce(function(e,s,n){if(s.not&&0===n)throw new BrowserslistError("Write any browsers query (for instance, `defaults`) before `"+s.query+"`");var t=QUERIES[s.type].select.call(browserslist,r,s).map(function(e){var s=e.split(" ");return"0"===s[1]?s[0]+" "+byName(s[0],r).versions[0]:e});if("and"===s.compose)return s.not?e.filter(function(e){return-1===t.indexOf(e)}):e.filter(function(e){return-1!==t.indexOf(e)});if(s.not){var o={};return t.forEach(function(e){o[e]=!0}),e.filter(function(e){return!o[e]})}return e.concat(t)},[])}function prepareOpts(e){return void 0===e&&(e={}),void 0===e.path&&(e.path=path.resolve?path.resolve("."):"."),e}function prepareQueries(e,r){null==e&&(e=browserslist.loadConfig(r)||browserslist.defaults);return e}function checkQueries(e){if("string"!=typeof e&&!Array.isArray(e))throw new BrowserslistError("Browser queries must be an array or string. Got "+typeof e+".")}var cache={},parseCache={};function browserslist(e,r){checkQueries(e=prepareQueries(e,r=prepareOpts(r)));var s=parseQueries(e).some(function(e){return QUERIES[e.type].needsPath}),n={ignoreUnknownVersions:r.ignoreUnknownVersions,dangerousExtend:r.dangerousExtend,mobileToDesktop:r.mobileToDesktop,env:r.env};s&&(n.path=r.path),env.oldDataWarning(browserslist.data);var t=env.getStat(r,browserslist.data);if(t)for(var o in n.customUsage={},t)fillUsage(n.customUsage,o,t[o]);var i=JSON.stringify([e,n]);if(cache[i])return cache[i];var a=uniq(resolve(e,n)).sort(function(e,r){if(e=e.split(" "),r=r.split(" "),e[0]===r[0]){var s=e[1].split("-")[0];return compareSemver(r[1].split("-")[0].split("."),s.split("."))}return compare(e[0],r[0])});return env.env.BROWSERSLIST_DISABLE_CACHE||(cache[i]=a),a}function parseQueries(e){var r=JSON.stringify(e);if(r in parseCache)return parseCache[r];var s=parseWithoutCache(QUERIES,e);return env.env.BROWSERSLIST_DISABLE_CACHE||(parseCache[r]=s),s}function loadCustomUsage(e,r){var s=env.loadStat(e,r,browserslist.data);if(s)for(var n in e.customUsage={},s)fillUsage(e.customUsage,n,s[n]);if(!e.customUsage)throw new BrowserslistError("Custom usage statistics was not provided");return e.customUsage}function nodeQuery(e,r){var s=browserslist.nodeVersions.filter(function(e){return isVersionsMatch(e,r.version)});if(0===s.length){if(e.ignoreUnknownVersions)return[];throw new BrowserslistError("Unknown version "+r.version+" of Node.js")}return["node "+s[s.length-1]]}function sinceQuery(e,r){var s=parseInt(r.year),n=parseInt(r.month||"01")-1,t=parseInt(r.day||"01");return filterByYear(Date.UTC(s,n,t,0,0,0),e)}function coverQuery(e,r){var s=parseFloat(r.coverage),n=browserslist.usage.global;if(r.place)if(r.place.match(/^my\s+stats$/i)){if(!e.customUsage)throw new BrowserslistError("Custom usage statistics was not provided");n=e.customUsage}else{var t;t=2===r.place.length?r.place.toUpperCase():r.place.toLowerCase(),env.loadCountry(browserslist.usage,t,browserslist.data),n=browserslist.usage[t]}else r.config&&(n=loadCustomUsage(e,r.config));for(var o,i=Object.keys(n).sort(function(e,r){return n[r]-n[e]}),a=0,l=[],c=0;c<i.length&&(o=i[c],0!==n[o])&&(a+=n[o],l.push(o),!(a>=s));c++);return l}browserslist.parse=function(e,r){return checkQueries(e=prepareQueries(e,r=prepareOpts(r))),parseQueries(e)},browserslist.cache={},browserslist.data={},browserslist.usage={global:{},custom:null},browserslist.defaults=["> 0.5%","last 2 versions","Firefox ESR","not dead"],browserslist.aliases={fx:"firefox",ff:"firefox",ios:"ios_saf",explorer:"ie",blackberry:"bb",explorermobile:"ie_mob",operamini:"op_mini",operamobile:"op_mob",chromeandroid:"and_chr",firefoxandroid:"and_ff",ucandroid:"and_uc",qqandroid:"and_qq"},browserslist.desktopNames={and_chr:"chrome",and_ff:"firefox",ie_mob:"ie",android:"chrome"},browserslist.versionAliases={},browserslist.clearCaches=env.clearCaches,browserslist.parseConfig=env.parseConfig,browserslist.readConfig=env.readConfig,browserslist.findConfigFile=env.findConfigFile,browserslist.findConfig=env.findConfig,browserslist.loadConfig=env.loadConfig,browserslist.coverage=function(e,r){var s;if(void 0===r)s=browserslist.usage.global;else if("my stats"===r){var n={};n.path=path.resolve?path.resolve("."):".";var t=env.getStat(n);if(!t)throw new BrowserslistError("Custom usage statistics was not provided");for(var o in s={},t)fillUsage(s,o,t[o])}else if("string"==typeof r)r=r.length>2?r.toLowerCase():r.toUpperCase(),env.loadCountry(browserslist.usage,r,browserslist.data),s=browserslist.usage[r];else for(var i in"dataByBrowser"in r&&(r=r.dataByBrowser),s={},r)for(var a in r[i])s[i+" "+a]=r[i][a];return e.reduce(function(e,r){var n=s[r];return void 0===n&&(n=s[r.replace(/ \S+$/," 0")]),e+(n||0)},0)};var QUERIES={last_major_versions:{matches:["versions"],regexp:/^last\s+(\d+)\s+major\s+versions?$/i,select:function(e,r){return Object.keys(agents).reduce(function(s,n){var t=byName(n,e);if(!t)return s;var o=getMajorVersions(t.released,r.versions);return o=filterJumps(o=o.map(nameMapper(t.name)),t.name,r.versions,e),s.concat(o)},[])}},last_versions:{matches:["versions"],regexp:/^last\s+(\d+)\s+versions?$/i,select:function(e,r){return Object.keys(agents).reduce(function(s,n){var t=byName(n,e);if(!t)return s;var o=t.released.slice(-r.versions);return o=filterJumps(o=o.map(nameMapper(t.name)),t.name,r.versions,e),s.concat(o)},[])}},last_electron_major_versions:{matches:["versions"],regexp:/^last\s+(\d+)\s+electron\s+major\s+versions?$/i,select:function(e,r){return getMajorVersions(Object.keys(e2c),r.versions).map(function(e){return"chrome "+e2c[e]})}},last_node_major_versions:{matches:["versions"],regexp:/^last\s+(\d+)\s+node\s+major\s+versions?$/i,select:function(e,r){return getMajorVersions(browserslist.nodeVersions,r.versions).map(function(e){return"node "+e})}},last_browser_major_versions:{matches:["versions","browser"],regexp:/^last\s+(\d+)\s+(\w+)\s+major\s+versions?$/i,select:function(e,r){var s=checkName(r.browser,e),n=getMajorVersions(s.released,r.versions).map(nameMapper(s.name));return filterJumps(n,s.name,r.versions,e)}},last_electron_versions:{matches:["versions"],regexp:/^last\s+(\d+)\s+electron\s+versions?$/i,select:function(e,r){return Object.keys(e2c).slice(-r.versions).map(function(e){return"chrome "+e2c[e]})}},last_node_versions:{matches:["versions"],regexp:/^last\s+(\d+)\s+node\s+versions?$/i,select:function(e,r){return browserslist.nodeVersions.slice(-r.versions).map(function(e){return"node "+e})}},last_browser_versions:{matches:["versions","browser"],regexp:/^last\s+(\d+)\s+(\w+)\s+versions?$/i,select:function(e,r){var s=checkName(r.browser,e),n=s.released.slice(-r.versions).map(nameMapper(s.name));return filterJumps(n,s.name,r.versions,e)}},unreleased_versions:{matches:[],regexp:/^unreleased\s+versions$/i,select:function(e){return Object.keys(agents).reduce(function(r,s){var n=byName(s,e);if(!n)return r;var t=n.versions.filter(function(e){return-1===n.released.indexOf(e)});return t=t.map(nameMapper(n.name)),r.concat(t)},[])}},unreleased_electron_versions:{matches:[],regexp:/^unreleased\s+electron\s+versions?$/i,select:function(){return[]}},unreleased_browser_versions:{matches:["browser"],regexp:/^unreleased\s+(\w+)\s+versions?$/i,select:function(e,r){var s=checkName(r.browser,e);return s.versions.filter(function(e){return-1===s.released.indexOf(e)}).map(nameMapper(s.name))}},last_years:{matches:["years"],regexp:/^last\s+(\d*.?\d+)\s+years?$/i,select:function(e,r){return filterByYear(Date.now()-YEAR*r.years,e)}},since_y:{matches:["year"],regexp:/^since (\d+)$/i,select:sinceQuery},since_y_m:{matches:["year","month"],regexp:/^since (\d+)-(\d+)$/i,select:sinceQuery},since_y_m_d:{matches:["year","month","day"],regexp:/^since (\d+)-(\d+)-(\d+)$/i,select:sinceQuery},popularity:{matches:["sign","popularity"],regexp:/^(>=?|<=?)\s*(\d+|\d+\.\d+|\.\d+)%$/,select:function(e,r){var s=parseFloat(r.popularity),n=browserslist.usage.global;return Object.keys(n).reduce(function(e,t){return">"===r.sign?n[t]>s&&e.push(t):"<"===r.sign?n[t]<s&&e.push(t):"<="===r.sign?n[t]<=s&&e.push(t):n[t]>=s&&e.push(t),e},[])}},popularity_in_my_stats:{matches:["sign","popularity"],regexp:/^(>=?|<=?)\s*(\d+|\d+\.\d+|\.\d+)%\s+in\s+my\s+stats$/,select:function(e,r){var s=parseFloat(r.popularity);if(!e.customUsage)throw new BrowserslistError("Custom usage statistics was not provided");var n=e.customUsage;return Object.keys(n).reduce(function(e,t){var o=n[t];return null==o||(">"===r.sign?o>s&&e.push(t):"<"===r.sign?o<s&&e.push(t):"<="===r.sign?o<=s&&e.push(t):o>=s&&e.push(t)),e},[])}},popularity_in_config_stats:{matches:["sign","popularity","config"],regexp:/^(>=?|<=?)\s*(\d+|\d+\.\d+|\.\d+)%\s+in\s+(\S+)\s+stats$/,select:function(e,r){var s=parseFloat(r.popularity),n=loadCustomUsage(e,r.config);return Object.keys(n).reduce(function(e,t){var o=n[t];return null==o||(">"===r.sign?o>s&&e.push(t):"<"===r.sign?o<s&&e.push(t):"<="===r.sign?o<=s&&e.push(t):o>=s&&e.push(t)),e},[])}},popularity_in_place:{matches:["sign","popularity","place"],regexp:/^(>=?|<=?)\s*(\d+|\d+\.\d+|\.\d+)%\s+in\s+((alt-)?\w\w)$/,select:function(e,r){var s=parseFloat(r.popularity),n=r.place;n=2===n.length?n.toUpperCase():n.toLowerCase(),env.loadCountry(browserslist.usage,n,browserslist.data);var t=browserslist.usage[n];return Object.keys(t).reduce(function(e,n){var o=t[n];return null==o||(">"===r.sign?o>s&&e.push(n):"<"===r.sign?o<s&&e.push(n):"<="===r.sign?o<=s&&e.push(n):o>=s&&e.push(n)),e},[])}},cover:{matches:["coverage"],regexp:/^cover\s+(\d+|\d+\.\d+|\.\d+)%$/i,select:coverQuery},cover_in:{matches:["coverage","place"],regexp:/^cover\s+(\d+|\d+\.\d+|\.\d+)%\s+in\s+(my\s+stats|(alt-)?\w\w)$/i,select:coverQuery},cover_config:{matches:["coverage","config"],regexp:/^cover\s+(\d+|\d+\.\d+|\.\d+)%\s+in\s+(\S+)\s+stats$/i,select:coverQuery},supports:{matches:["supportType","feature"],regexp:/^(?:(fully|partially)\s+)?supports\s+([\w-]+)$/,select:function(e,r){env.loadFeature(browserslist.cache,r.feature);var s="fully"!==r.supportType,n=browserslist.cache[r.feature],t=[];for(var o in n){for(var i=byName(o,e),a=i.released.length-1;a>=0&&!(i.released[a]in n[o]);)a--;var l=e.mobileToDesktop&&o in browserslist.desktopNames&&isSupported(n[o][i.released[a]],s);i.versions.forEach(function(e){var r=n[o][e];void 0===r&&l&&(r=n[browserslist.desktopNames[o]][e]),isSupported(r,s)&&t.push(o+" "+e)})}return t}},electron_range:{matches:["from","to"],regexp:/^electron\s+([\d.]+)\s*-\s*([\d.]+)$/i,select:function(e,r){var s=normalizeElectron(r.from),n=normalizeElectron(r.to),t=parseFloat(r.from),o=parseFloat(r.to);if(!e2c[s])throw new BrowserslistError("Unknown version "+t+" of electron");if(!e2c[n])throw new BrowserslistError("Unknown version "+o+" of electron");return Object.keys(e2c).filter(function(e){var r=parseFloat(e);return r>=t&&r<=o}).map(function(e){return"chrome "+e2c[e]})}},node_range:{matches:["from","to"],regexp:/^node\s+([\d.]+)\s*-\s*([\d.]+)$/i,select:function(e,r){return browserslist.nodeVersions.filter(semverFilterLoose(">=",r.from)).filter(semverFilterLoose("<=",r.to)).map(function(e){return"node "+e})}},browser_range:{matches:["browser","from","to"],regexp:/^(\w+)\s+([\d.]+)\s*-\s*([\d.]+)$/i,select:function(e,r){var s=checkName(r.browser,e),n=parseFloat(normalizeVersion(s,r.from)||r.from),t=parseFloat(normalizeVersion(s,r.to)||r.to);return s.released.filter(function(e){var r=parseFloat(e);return r>=n&&r<=t}).map(nameMapper(s.name))}},electron_ray:{matches:["sign","version"],regexp:/^electron\s*(>=?|<=?)\s*([\d.]+)$/i,select:function(e,r){var s=normalizeElectron(r.version);return Object.keys(e2c).filter(generateFilter(r.sign,s)).map(function(e){return"chrome "+e2c[e]})}},node_ray:{matches:["sign","version"],regexp:/^node\s*(>=?|<=?)\s*([\d.]+)$/i,select:function(e,r){return browserslist.nodeVersions.filter(generateSemverFilter(r.sign,r.version)).map(function(e){return"node "+e})}},browser_ray:{matches:["browser","sign","version"],regexp:/^(\w+)\s*(>=?|<=?)\s*([\d.]+)$/,select:function(e,r){var s=r.version,n=checkName(r.browser,e),t=browserslist.versionAliases[n.name][s];return t&&(s=t),n.released.filter(generateFilter(r.sign,s)).map(function(e){return n.name+" "+e})}},firefox_esr:{matches:[],regexp:/^(firefox|ff|fx)\s+esr$/i,select:function(){return["firefox 128","firefox 140"]}},opera_mini_all:{matches:[],regexp:/(operamini|op_mini)\s+all/i,select:function(){return["op_mini all"]}},electron_version:{matches:["version"],regexp:/^electron\s+([\d.]+)$/i,select:function(e,r){var s=normalizeElectron(r.version),n=e2c[s];if(!n)throw new BrowserslistError("Unknown version "+r.version+" of electron");return["chrome "+n]}},node_major_version:{matches:["version"],regexp:/^node\s+(\d+)$/i,select:nodeQuery},node_minor_version:{matches:["version"],regexp:/^node\s+(\d+\.\d+)$/i,select:nodeQuery},node_patch_version:{matches:["version"],regexp:/^node\s+(\d+\.\d+\.\d+)$/i,select:nodeQuery},current_node:{matches:[],regexp:/^current\s+node$/i,select:function(e){return[env.currentNode(resolve,e)]}},maintained_node:{matches:[],regexp:/^maintained\s+node\s+versions$/i,select:function(e){var r=Date.now();return resolve(Object.keys(jsEOL).filter(function(e){return r<Date.parse(jsEOL[e].end)&&r>Date.parse(jsEOL[e].start)&&isEolReleased(e)}).map(function(e){return"node "+e.slice(1)}),e)}},phantomjs_1_9:{matches:[],regexp:/^phantomjs\s+1.9$/i,select:function(){return["safari 5"]}},phantomjs_2_1:{matches:[],regexp:/^phantomjs\s+2.1$/i,select:function(){return["safari 6"]}},browser_version:{matches:["browser","version"],regexp:/^(\w+)\s+(tp|[\d.]+)$/i,select:function(e,r){var s=r.version;/^tp$/i.test(s)&&(s="TP");var n=checkName(r.browser,e),t=normalizeVersion(n,s);if(t)s=t;else{if(!(t=normalizeVersion(n,t=-1===s.indexOf(".")?s+".0":s.replace(/\.0$/,"")))){if(e.ignoreUnknownVersions)return[];throw new BrowserslistError("Unknown version "+s+" of "+r.browser)}s=t}return[n.name+" "+s]}},browserslist_config:{matches:[],regexp:/^browserslist config$/i,needsPath:!0,select:function(e){return browserslist(void 0,e)}},extends:{matches:["config"],regexp:/^extends (.+)$/i,needsPath:!0,select:function(e,r){return resolve(env.loadQueries(e,r.config),e)}},defaults:{matches:[],regexp:/^defaults$/i,select:function(e){return resolve(browserslist.defaults,e)}},dead:{matches:[],regexp:/^dead$/i,select:function(e){return resolve(["Baidu >= 0","ie <= 11","ie_mob <= 11","bb <= 10","op_mob <= 12.1","samsung 4"],e)}},unknown:{matches:[],regexp:/^(\w+)$/i,select:function(e,r){throw byName(r.query,e)?new BrowserslistError("Specify versions in Browserslist query for browser "+r.query):unknownQuery(r.query)}}};!function(){for(var e in agents){var r=agents[e];browserslist.data[e]={name:e,versions:normalize(agents[e].versions),released:normalize(agents[e].versions.slice(0,-3)),releaseDate:agents[e].release_date},fillUsage(browserslist.usage.global,e,r.usage_global),browserslist.versionAliases[e]={};for(var s=0;s<r.versions.length;s++){var n=r.versions[s];if(n&&-1!==n.indexOf("-"))for(var t=n.split("-"),o=0;o<t.length;o++)browserslist.versionAliases[e][t[o]]=n}}browserslist.nodeVersions=jsReleases.map(function(e){return e.version})}(),module.exports=browserslist;