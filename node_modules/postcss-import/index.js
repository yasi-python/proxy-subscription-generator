"use strict";const path=require("path"),joinMedia=require("./lib/join-media"),joinLayer=require("./lib/join-layer"),resolveId=require("./lib/resolve-id"),loadContent=require("./lib/load-content"),processContent=require("./lib/process-content"),parseStatements=require("./lib/parse-statements"),assignLayerNames=require("./lib/assign-layer-names"),dataURL=require("./lib/data-url");function AtImport(e){return(e={root:process.cwd(),path:[],skipDuplicates:!0,resolve:resolveId,load:loadContent,plugins:[],addModulesDirectories:[],nameLayer:null,...e}).root=path.resolve(e.root),"string"==typeof e.path&&(e.path=[e.path]),Array.isArray(e.path)||(e.path=[]),e.path=e.path.map(r=>path.resolve(e.root,r)),{postcssPlugin:"postcss-import",Once(r,{result:o,atRule:s,postcss:n}){const t={importedFiles:{},hashFiles:{},rootFilename:null,anonymousLayerCounter:0};if(r.source?.input?.file&&(t.rootFilename=r.source.input.file,t.importedFiles[r.source.input.file]={}),e.plugins&&!Array.isArray(e.plugins))throw new Error("plugins option must be an array");if(e.nameLayer&&"function"!=typeof e.nameLayer)throw new Error("nameLayer option must be a function");return a(o,r,e,t,[],[]).then(o=>{!function(e){e.forEach((e,r)=>{if(0!==r)if(e.parent){const{before:r}=e.parent.node.raws;"nodes"===e.type?e.nodes[0].raws.before=r:e.node.raws.before=r}else"nodes"===e.type&&(e.nodes[0].raws.before=e.nodes[0].raws.before||"\n")})}(o),function(r){r.forEach(r=>{if((r.media.length||r.layer.length)&&"charset"!==r.type)if(r.layer.length>1&&assignLayerNames(r.layer,r.node,t,e),"import"===r.type){const e=[r.fullUri],o=r.media.join(", ");if(r.layer.length){const o=r.layer.join(".");let s="layer";o&&(s=`layer(${o})`),e.push(s)}o&&e.push(o),r.node.params=e.join(" ")}else if("media"===r.type)if(r.layer.length){const e=s({name:"layer",params:r.layer.join("."),source:r.node.source});if(r.parentMedia?.length){const o=s({name:"media",params:r.parentMedia.join(", "),source:r.node.source});o.append(e),e.append(r.node),r.node=o}else e.append(r.node),r.node=e}else r.node.params=r.media.join(", ");else{const{nodes:e}=r,{parent:o}=e[0];let n,t;if(r.media.length&&r.layer.length){const e=s({name:"media",params:r.media.join(", "),source:o.source}),a=s({name:"layer",params:r.layer.join("."),source:o.source});e.append(a),t=a,n=e}else if(r.media.length){const e=s({name:"media",params:r.media.join(", "),source:o.source});t=e,n=e}else if(r.layer.length){const e=s({name:"layer",params:r.layer.join("."),source:o.source});t=e,n=e}o.insertBefore(e[0],n),e.forEach(e=>{e.parent=void 0}),e[0].raws.before=e[0].raws.before||"\n",t.append(e),r.type="media",r.node=n,delete r.nodes}})}(o),function(e,r){r.nodes=[],e.forEach(e=>{["charset","import","media"].includes(e.type)?(e.node.parent=void 0,r.append(e.node)):"nodes"===e.type&&e.nodes.forEach(e=>{e.parent=void 0,r.append(e)})})}(o,r)});function a(e,r,o,s,n,t){const a=parseStatements(e,r);return Promise.resolve(a).then(r=>r.reduce((r,a)=>r.then(()=>{if(a.media=joinMedia(n,a.media||[]),a.parentMedia=n,a.layer=joinLayer(t,a.layer||[]),"import"===a.type&&!/^(?:[a-z]+:)?\/\//i.test(a.uri)&&(!o.filter||o.filter(a.uri)))return function(e,r,o,s){if(dataURL.isValid(r.uri))return i(e,r,r.uri,o,s).then(e=>{r.children=e});const n=r.node;let t;n.source?.input?.file&&(t=n.source.input.file);const a=t?path.dirname(n.source.input.file):o.root;return Promise.resolve(o.resolve(r.uri,a,o)).then(e=>(Array.isArray(e)||(e=[e]),Promise.all(e.map(e=>path.isAbsolute(e)?e:resolveId(e,a,o))))).then(n=>(n.forEach(r=>{e.messages.push({type:"dependency",plugin:"postcss-import",file:r,parent:t})}),Promise.all(n.map(n=>i(e,r,n,o,s))))).then(e=>{r.children=e.reduce((e,r)=>r?e.concat(r):e,[])})}(e,a,o,s)}),Promise.resolve())).then(()=>{let e;const r=[],o=[];function s(r){if(e){if(r.node.params.toLowerCase()!==e.node.params.toLowerCase())throw new Error(`Incompatable @charset statements:\n  ${r.node.params} specified in ${r.node.source.input.file}\n  ${e.node.params} specified in ${e.node.source.input.file}`)}else e=r}return a.forEach(e=>{"charset"===e.type?s(e):"import"===e.type?e.children?e.children.forEach((n,t)=>{"import"===n.type?r.push(n):"charset"===n.type?s(n):o.push(n),0===t&&(n.parent=e)}):r.push(e):"media"!==e.type&&"nodes"!==e.type||o.push(e)}),e?[e,...r.concat(o)]:r.concat(o)})}function i(e,r,o,s,t){const i=r.node,{media:p,layer:l}=r;if(assignLayerNames(l,i,t,s),s.skipDuplicates){if(t.importedFiles[o]?.[p]?.[l])return;t.importedFiles[o]||(t.importedFiles[o]={}),t.importedFiles[o][p]||(t.importedFiles[o][p]={}),t.importedFiles[o][p][l]=!0}return Promise.resolve(s.load(o,s)).then(r=>{if(""!==r.trim()){if(!t.hashFiles[r]?.[p]?.[l])return processContent(e,r,o,s,n).then(o=>{const n=o.root;return e.messages=e.messages.concat(o.messages),s.skipDuplicates&&(n.some(e=>"atrule"===e.type&&"import"===e.name)||(t.hashFiles[r]||(t.hashFiles[r]={}),t.hashFiles[r][p]||(t.hashFiles[r][p]={}),t.hashFiles[r][p][l]=!0)),a(e,n,s,t,p,l)})}else e.warn(`${o} is empty`,{node:i})})}}}}AtImport.postcss=!0,module.exports=AtImport;