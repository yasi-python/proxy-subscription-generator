"use strict";var reusify=require("reusify");function fastqueue(n,e,r){if("function"==typeof n&&(r=e,e=n,n=null),!(r>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");var u=reusify(Task),t=null,o=null,l=0,a=null,i={push:function(s,f){var d=u.get();d.context=n,d.release=c,d.value=s,d.callback=f||noop,d.errorHandler=a,l>=r||i.paused?o?(o.next=d,o=d):(t=d,o=d,i.saturated()):(l++,e.call(n,d.value,d.worked))},drain:noop,saturated:noop,pause:function(){i.paused=!0},paused:!1,get concurrency(){return r},set concurrency(n){if(!(n>=1))throw new Error("fastqueue concurrency must be equal to or greater than 1");if(r=n,!i.paused)for(;t&&l<r;)l++,c()},running:function(){return l},resume:function(){if(i.paused){if(i.paused=!1,null===t)return l++,void c();for(;t&&l<r;)l++,c()}},idle:function(){return 0===l&&0===i.length()},length:function(){for(var n=t,e=0;n;)n=n.next,e++;return e},getQueue:function(){for(var n=t,e=[];n;)e.push(n.value),n=n.next;return e},unshift:function(s,f){var d=u.get();d.context=n,d.release=c,d.value=s,d.callback=f||noop,d.errorHandler=a,l>=r||i.paused?t?(d.next=t,t=d):(t=d,o=d,i.saturated()):(l++,e.call(n,d.value,d.worked))},empty:noop,kill:function(){t=null,o=null,i.drain=noop},killAndDrain:function(){t=null,o=null,i.drain(),i.drain=noop},error:function(n){a=n}};return i;function c(a){a&&u.release(a);var c=t;c&&l<=r?i.paused?l--:(o===t&&(o=null),t=c.next,c.next=null,e.call(n,c.value,c.worked),null===o&&i.empty()):0===--l&&i.drain()}}function noop(){}function Task(){this.value=null,this.callback=noop,this.next=null,this.release=noop,this.context=null,this.errorHandler=null;var n=this;this.worked=function(e,r){var u=n.callback,t=n.errorHandler,o=n.value;n.value=null,n.callback=noop,n.errorHandler&&t(e,o),u.call(n.context,e,r),n.release(n)}}function queueAsPromised(n,e,r){"function"==typeof n&&(r=e,e=n,n=null);var u=fastqueue(n,function(n,r){e.call(this,n).then(function(n){r(null,n)},r)},r),t=u.push,o=u.unshift;return u.push=function(n){var e=new Promise(function(e,r){t(n,function(n,u){n?r(n):e(u)})});return e.catch(noop),e},u.unshift=function(n){var e=new Promise(function(e,r){o(n,function(n,u){n?r(n):e(u)})});return e.catch(noop),e},u.drained=function(){return new Promise(function(n){process.nextTick(function(){if(u.idle())n();else{var e=u.drain;u.drain=function(){"function"==typeof e&&e(),n(),u.drain=e}}})})},u}module.exports=fastqueue,module.exports.promise=queueAsPromised;