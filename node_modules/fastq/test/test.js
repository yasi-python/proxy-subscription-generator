"use strict";var test=require("tape"),buildQueue=require("../");test("concurrency",function(e){e.plan(6),e.throws(buildQueue.bind(null,n,0)),e.throws(buildQueue.bind(null,n,NaN)),e.doesNotThrow(buildQueue.bind(null,n,1));var u=buildQueue(n,1);function n(e,u){u(null,!0)}e.throws(function(){u.concurrency=0}),e.throws(function(){u.concurrency=NaN}),e.doesNotThrow(function(){u.concurrency=2})}),test("worker execution",function(e){e.plan(3),buildQueue(function(u,n){e.equal(u,42),n(null,!0)},1).push(42,function(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")})}),test("limit",function(e){e.plan(4);var u=[10,0],n=buildQueue(function(e,u){setTimeout(u,e,null,e)},1);function t(n,t){e.error(n,"no error"),e.equal(t,u.shift(),"the result matches")}n.push(10,t),n.push(0,t)}),test("multiple executions",function(e){e.plan(15);var u=buildQueue(function(u,r){e.equal(u,n[t],"arg matches"),t++,setImmediate(r,null,u)},1),n=[1,2,3,4,5],t=0;function r(u,r){e.error(u,"no error"),e.equal(r,n[t-1],"the result matches")}n.forEach(function(e){u.push(e,r)})}),test("multiple executions, one after another",function(e){e.plan(15);var u=buildQueue(function(u,r){e.equal(u,n[t],"arg matches"),t++,setImmediate(r,null,u)},1),n=[1,2,3,4,5],t=0;u.push(n[0],function r(o,s){e.error(o,"no error"),e.equal(s,n[t-1],"the result matches"),t<n.length&&u.push(n[t],r)})}),test("set this",function(e){e.plan(3);var u={};buildQueue(u,function(n,t){e.equal(this,u,"this matches"),t(null,!0)},1).push(42,function(n,t){e.error(n,"no error"),e.equal(this,u,"this matches")})}),test("drain",function(e){e.plan(4);var u=buildQueue(function(u,t){e.equal(u,42),n=!0,setImmediate(t,null,!0)},1),n=!1;u.push(42,function(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")}),u.drain=function(){e.equal(!0,n,"drained")}}),test("pause && resume",function(e){e.plan(13);var u=buildQueue(function(r,o){e.notOk(u.paused,"it should not be paused"),e.ok(u.running()<=u.concurrency,"should respect the concurrency"),e.equal(r,t.shift()),n=!0,process.nextTick(function(){o(null,!0)})},1),n=!1,t=[42,24];e.notOk(u.paused,"it should not be paused"),u.pause(),u.push(42,function(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")}),u.push(24,function(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")}),e.notOk(n,"it should be paused"),e.ok(u.paused,"it should be paused"),u.resume(),u.pause(),u.resume(),u.resume()}),test("pause in flight && resume",function(e){e.plan(16);var u=buildQueue(function(t,r){e.ok(u.running()<=u.concurrency,"should respect the concurrency"),e.equal(t,n.shift()),process.nextTick(function(){r(null,!0)})},1),n=[42,24,12];e.notOk(u.paused,"it should not be paused"),u.push(42,function(n,t){e.error(n,"no error"),e.equal(t,!0,"result matches"),e.ok(u.paused,"it should be paused"),process.nextTick(function(){u.resume(),u.pause(),u.resume()})}),u.push(24,function(n,t){e.error(n,"no error"),e.equal(t,!0,"result matches"),e.notOk(u.paused,"it should not be paused")}),u.push(12,function(n,t){e.error(n,"no error"),e.equal(t,!0,"result matches"),e.notOk(u.paused,"it should not be paused")}),u.pause()}),test("altering concurrency",function(e){e.plan(24);var u=buildQueue(function(n,t){e.ok(u.running()<=u.concurrency,"should respect the concurrency"),setImmediate(function(){t(null,!0)})},1);function n(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")}u.push(24,n),u.push(24,n),u.push(24,n),u.pause(),u.concurrency=3,u.concurrency=2,u.resume(),e.equal(u.running(),2,"2 jobs running"),u.concurrency=3,e.equal(u.running(),3,"3 jobs running"),u.concurrency=1,e.equal(u.running(),3,"3 jobs running"),u.push(24,n),u.push(24,n),u.push(24,n),u.push(24,n)}),test("idle()",function(e){e.plan(12);var u=buildQueue(function(n,t){e.notOk(u.idle(),"queue is not idle"),e.equal(n,42),setImmediate(t,null,!0)},1);e.ok(u.idle(),"queue is idle"),u.push(42,function(n,t){e.error(n,"no error"),e.equal(t,!0,"result matches"),e.notOk(u.idle(),"queue is not idle")}),u.push(42,function(n,t){e.error(n,"no error"),e.equal(t,!0,"result matches"),setImmediate(function(){e.ok(u.idle(),"queue is now idle")})}),e.notOk(u.idle(),"queue is not idle")}),test("saturated",function(e){e.plan(9);var u=buildQueue(function(u,r){e.equal(u,42),n++,setImmediate(function(){t++,r(null,!0)})},1),n=0,t=0;function r(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")}u.saturated=function(){e.pass("saturated"),e.equal(n,1,"started 1 task"),e.equal(t,0,"worked zero task")},u.push(42,r),u.push(42,r)}),test("length",function(e){e.plan(7);var u=buildQueue(function(e,u){setImmediate(function(){u(null,!0)})},1);function n(u,n){e.error(u,"no error")}e.equal(u.length(),0,"nothing waiting"),u.push(42,n),e.equal(u.length(),0,"nothing waiting"),u.push(42,n),e.equal(u.length(),1,"one task waiting"),u.push(42,n),e.equal(u.length(),2,"two tasks waiting")}),test("getQueue",function(e){e.plan(10);var u=buildQueue(function(e,u){setImmediate(function(){u(null,!0)})},1);function n(u,n){e.error(u,"no error")}e.equal(u.getQueue().length,0,"nothing waiting"),u.push(42,n),e.equal(u.getQueue().length,0,"nothing waiting"),u.push(42,n),e.equal(u.getQueue().length,1,"one task waiting"),e.equal(u.getQueue()[0],42,"should be equal"),u.push(43,n),e.equal(u.getQueue().length,2,"two tasks waiting"),e.equal(u.getQueue()[0],42,"should be equal"),e.equal(u.getQueue()[1],43,"should be equal")}),test("unshift",function(e){e.plan(8);var u=buildQueue(function(u,t){e.equal(n.shift(),u,"tasks come in order"),setImmediate(function(){t(null,!0)})},1),n=[1,2,3,4];function t(u,n){e.error(u,"no error")}u.push(1,t),u.push(4,t),u.unshift(3,t),u.unshift(2,t)}),test("unshift && empty",function(e){e.plan(2);var u=buildQueue(function(e,u){setImmediate(function(){u(null,!0)})},1),n=!1;u.pause(),u.empty=function(){e.notOk(n,"the task has not completed yet")},u.unshift(1,function(u,t){n=!0,e.error(u,"no error")}),u.resume()}),test("push && empty",function(e){e.plan(2);var u=buildQueue(function(e,u){setImmediate(function(){u(null,!0)})},1),n=!1;u.pause(),u.empty=function(){e.notOk(n,"the task has not completed yet")},u.push(1,function(u,t){n=!0,e.error(u,"no error")}),u.resume()}),test("kill",function(e){e.plan(5);var u=buildQueue(function(u,t){e.equal(n.shift(),u,"tasks come in order"),setImmediate(function(){t(null,!0)})},1),n=[1],t=u.drain;function r(n,r){e.error(n,"no error"),setImmediate(function(){e.equal(u.length(),0,"no queued tasks"),e.equal(u.running(),0,"no running tasks"),e.equal(u.drain,t,"drain is back to default")})}u.drain=function(){e.fail("drain should never be called")},u.push(1,r),u.push(4,r),u.unshift(3,r),u.unshift(2,r),u.kill()}),test("killAndDrain",function(e){e.plan(6);var u=buildQueue(function(u,t){e.equal(n.shift(),u,"tasks come in order"),setImmediate(function(){t(null,!0)})},1),n=[1],t=u.drain;function r(n,r){e.error(n,"no error"),setImmediate(function(){e.equal(u.length(),0,"no queued tasks"),e.equal(u.running(),0,"no running tasks"),e.equal(u.drain,t,"drain is back to default")})}u.drain=function(){e.pass("drain has been called")},u.push(1,r),u.push(4,r),u.unshift(3,r),u.unshift(2,r),u.killAndDrain()}),test("pause && idle",function(e){e.plan(11);var u=buildQueue(function(t,r){e.equal(t,42),n=!0,process.nextTick(r.bind(null,null,!0)),process.nextTick(function(){e.ok(u.idle(),"is should be idle")})},1),n=!1;e.notOk(u.paused,"it should not be paused"),e.ok(u.idle(),"should be idle"),u.pause(),u.push(42,function(u,n){e.error(u,"no error"),e.equal(n,!0,"result matches")}),e.notOk(n,"it should be paused"),e.ok(u.paused,"it should be paused"),e.notOk(u.idle(),"should not be idle"),u.resume(),e.notOk(u.paused,"it should not be paused"),e.notOk(u.idle(),"it should not be idle")}),test("push without cb",function(e){e.plan(1),buildQueue(function(u,n){e.equal(u,42),n()},1).push(42)}),test("unshift without cb",function(e){e.plan(1),buildQueue(function(u,n){e.equal(u,42),n()},1).unshift(42)}),test("push with worker throwing error",function(e){e.plan(5);var u=buildQueue(function(e,u){u(new Error("test error"),null)},1);u.error(function(u,n){e.ok(u instanceof Error,"global error handler should catch the error"),e.match(u.message,/test error/,'error message should be "test error"'),e.equal(n,42,"The task executed should be passed")}),u.push(42,function(u){e.ok(u instanceof Error,"push callback should catch the error"),e.match(u.message,/test error/,'error message should be "test error"')})}),test("unshift with worker throwing error",function(e){e.plan(5);var u=buildQueue(function(e,u){u(new Error("test error"),null)},1);u.error(function(u,n){e.ok(u instanceof Error,"global error handler should catch the error"),e.match(u.message,/test error/,'error message should be "test error"'),e.equal(n,42,"The task executed should be passed")}),u.unshift(42,function(u){e.ok(u instanceof Error,"unshift callback should catch the error"),e.match(u.message,/test error/,'error message should be "test error"')})}),test("pause/resume should trigger drain event",function(e){e.plan(1);var u=buildQueue(function(e,u){u(null,!0)},1);u.pause(),u.drain=function(){e.pass("drain should be called")},u.resume()}),test("paused flag",function(e){e.plan(2);var u=buildQueue(function(e,u){u(null)},1);e.equal(u.paused,!1),u.pause(),e.equal(u.paused,!0)});