let parser=require("postcss-value-parser"),Value=require("./value"),insertAreas=require("./hacks/grid-utils").insertAreas;const OLD_LINEAR=/(^|[^-])linear-gradient\(\s*(top|left|right|bottom)/i,OLD_RADIAL=/(^|[^-])radial-gradient\(\s*\d+(\w*|%)\s+\d+(\w*|%)\s*,/i,IGNORE_NEXT=/(!\s*)?autoprefixer:\s*ignore\s+next/i,GRID_REGEX=/(!\s*)?autoprefixer\s*grid:\s*(on|off|(no-)?autoplace)/i,SIZES=["width","height","min-width","max-width","min-height","max-height","inline-size","min-inline-size","max-inline-size","block-size","min-block-size","max-block-size"];function hasGridTemplate(e){return e.parent.some(e=>"grid-template"===e.prop||"grid-template-areas"===e.prop)}function hasRowsAndColumns(e){let i=e.parent.some(e=>"grid-template-rows"===e.prop),t=e.parent.some(e=>"grid-template-columns"===e.prop);return i&&t}class Processor{constructor(e){this.prefixes=e}add(e,i){let t=this.prefixes.add["@resolution"],r=this.prefixes.add["@keyframes"],s=this.prefixes.add["@viewport"],o=this.prefixes.add["@supports"];function a(e){return e.parent.nodes.some(e=>{if("decl"!==e.type)return!1;let i="display"===e.prop&&/(inline-)?grid/.test(e.value),t=e.prop.startsWith("grid-template"),r=/^grid-([A-z]+-)?gap/.test(e.prop);return i||t||r})}e.walkAtRules(e=>{if("keyframes"===e.name){if(!this.disabled(e,i))return r&&r.process(e)}else if("viewport"===e.name){if(!this.disabled(e,i))return s&&s.process(e)}else if("supports"===e.name){if(!1!==this.prefixes.options.supports&&!this.disabled(e,i))return o.process(e)}else if("media"===e.name&&e.params.includes("-resolution")&&!this.disabled(e,i))return t&&t.process(e)}),e.walkRules(e=>{if(!this.disabled(e,i))return this.prefixes.add.selectors.map(t=>t.process(e,i))});let n=this.gridStatus(e,i)&&this.prefixes.add["grid-area"]&&this.prefixes.add["grid-area"].prefixes;return e.walkDecls(e=>{if(this.disabledDecl(e,i))return;let t,r=e.parent,s=e.prop,o=e.value;if("color-adjust"===s)r.every(e=>"print-color-adjust"!==e.prop)&&i.warn("Replace color-adjust to print-color-adjust. The color-adjust shorthand is currently deprecated.",{node:e});else{if("grid-row-span"===s)return void i.warn("grid-row-span is not part of final Grid Layout. Use grid-row.",{node:e});if("grid-column-span"===s)return void i.warn("grid-column-span is not part of final Grid Layout. Use grid-column.",{node:e});if("display"===s&&"box"===o)return void i.warn("You should write display: flex by final spec instead of display: box",{node:e});if("text-emphasis-position"===s)"under"!==o&&"over"!==o||i.warn("You should use 2 values for text-emphasis-position For example, `under left` instead of just `under`.",{node:e});else if("text-decoration-skip"===s&&"ink"===o)i.warn("Replace text-decoration-skip: ink to text-decoration-skip-ink: auto, because spec had been changed",{node:e});else{if(n&&this.gridStatus(e,i))if("subgrid"===e.value&&i.warn("IE does not support subgrid",{node:e}),/^(align|justify|place)-items$/.test(s)&&a(e)){let t=s.replace("-items","-self");i.warn(`IE does not support ${s} on grid containers. Try using ${t} on child elements instead: ${e.parent.selector} > * { ${t}: ${e.value} }`,{node:e})}else if(/^(align|justify|place)-content$/.test(s)&&a(e))i.warn(`IE does not support ${e.prop} on grid containers`,{node:e});else{if("display"===s&&"contents"===e.value)return void i.warn("Please do not use display: contents; if you have grid setting enabled",{node:e});if("grid-gap"===e.prop){let t=this.gridStatus(e,i);"autoplace"!==t||hasRowsAndColumns(e)||hasGridTemplate(e)?!0!==t&&"no-autoplace"!==t||hasGridTemplate(e)||i.warn("grid-gap only works if grid-template(-areas) is being used",{node:e}):i.warn("grid-gap only works if grid-template(-areas) is being used or both rows and columns have been declared and cells have not been manually placed inside the explicit grid",{node:e})}else{if("grid-auto-columns"===s)return void i.warn("grid-auto-columns is not supported by IE",{node:e});if("grid-auto-rows"===s)return void i.warn("grid-auto-rows is not supported by IE",{node:e});if("grid-auto-flow"===s){let t=r.some(e=>"grid-template-rows"===e.prop),s=r.some(e=>"grid-template-columns"===e.prop);return void(hasGridTemplate(e)?i.warn("grid-auto-flow is not supported by IE",{node:e}):o.includes("dense")?i.warn("grid-auto-flow: dense is not supported by IE",{node:e}):t||s||i.warn("grid-auto-flow works only if grid-template-rows and grid-template-columns are present in the same rule",{node:e}))}if(o.includes("auto-fit"))return void i.warn("auto-fit value is not supported by IE",{node:e,word:"auto-fit"});if(o.includes("auto-fill"))return void i.warn("auto-fill value is not supported by IE",{node:e,word:"auto-fill"});s.startsWith("grid-template")&&o.includes("[")&&i.warn("Autoprefixer currently does not support line names. Try using grid-template-areas instead.",{node:e,word:"["})}}if(o.includes("radial-gradient"))if(OLD_RADIAL.test(e.value))i.warn("Gradient has outdated direction syntax. New syntax is like `closest-side at 0 0` instead of `0 0, closest-side`.",{node:e});else{let t=parser(o);for(let r of t.nodes)if("function"===r.type&&"radial-gradient"===r.value)for(let t of r.nodes)"word"===t.type&&("cover"===t.value?i.warn("Gradient has outdated direction syntax. Replace `cover` to `farthest-corner`.",{node:e}):"contain"===t.value&&i.warn("Gradient has outdated direction syntax. Replace `contain` to `closest-side`.",{node:e}))}o.includes("linear-gradient")&&OLD_LINEAR.test(o)&&i.warn("Gradient has outdated direction syntax. New syntax is like `to left` instead of `right`.",{node:e})}}if(SIZES.includes(e.prop)&&!e.value.includes("-fill-available"))if(e.value.includes("fill-available"))i.warn("Replace fill-available to stretch, because spec had been changed",{node:e});else if(e.value.includes("fill")){parser(o).nodes.some(e=>"word"===e.type&&"fill"===e.value)&&i.warn("Replace fill to stretch, because spec had been changed",{node:e})}if("transition"===e.prop||"transition-property"===e.prop)return this.prefixes.transition.add(e,i);if("align-self"===e.prop){if("grid"!==this.displayType(e)&&!1!==this.prefixes.options.flexbox&&(t=this.prefixes.add["align-self"],t&&t.prefixes&&t.process(e)),!1!==this.gridStatus(e,i)&&(t=this.prefixes.add["grid-row-align"],t&&t.prefixes))return t.process(e,i)}else if("justify-self"===e.prop){if(!1!==this.gridStatus(e,i)&&(t=this.prefixes.add["grid-column-align"],t&&t.prefixes))return t.process(e,i)}else if("place-self"===e.prop){if(t=this.prefixes.add["place-self"],t&&t.prefixes&&!1!==this.gridStatus(e,i))return t.process(e,i)}else if(t=this.prefixes.add[e.prop],t&&t.prefixes)return t.process(e,i)}),this.gridStatus(e,i)&&insertAreas(e,this.disabled),e.walkDecls(e=>{if(this.disabledValue(e,i))return;let t=this.prefixes.unprefixed(e.prop),r=this.prefixes.values("add",t);if(Array.isArray(r))for(let t of r)t.process&&t.process(e,i);Value.save(this.prefixes,e)})}disabled(e,i){if(!e)return!1;if(void 0!==e._autoprefixerDisabled)return e._autoprefixerDisabled;if(e.parent){let i=e.prev();if(i&&"comment"===i.type&&IGNORE_NEXT.test(i.text))return e._autoprefixerDisabled=!0,e._autoprefixerSelfDisabled=!0,!0}let t=null;if(e.nodes){let r;e.each(e=>{"comment"===e.type&&/(!\s*)?autoprefixer:\s*(off|on)/i.test(e.text)&&(void 0!==r?i.warn("Second Autoprefixer control comment was ignored. Autoprefixer applies control comment to whole block, not to next rules.",{node:e}):r=/on/i.test(e.text))}),void 0!==r&&(t=!r)}if(!e.nodes||null===t)if(e.parent){let r=this.disabled(e.parent,i);t=!0!==e.parent._autoprefixerSelfDisabled&&r}else t=!1;return e._autoprefixerDisabled=t,t}disabledDecl(e,i){if("decl"===e.type&&!1===this.gridStatus(e,i)&&(e.prop.includes("grid")||"justify-items"===e.prop))return!0;if("decl"===e.type&&!1===this.prefixes.options.flexbox){let i=["order","justify-content","align-items","align-content"];if(e.prop.includes("flex")||i.includes(e.prop))return!0}return this.disabled(e,i)}disabledValue(e,i){return!(!1!==this.gridStatus(e,i)||"decl"!==e.type||"display"!==e.prop||!e.value.includes("grid"))||(!(!1!==this.prefixes.options.flexbox||"decl"!==e.type||"display"!==e.prop||!e.value.includes("flex"))||("decl"===e.type&&"content"===e.prop||this.disabled(e,i)))}displayType(e){for(let i of e.parent.nodes)if("display"===i.prop){if(i.value.includes("flex"))return"flex";if(i.value.includes("grid"))return"grid"}return!1}gridStatus(e,i){if(!e)return!1;if(void 0!==e._autoprefixerGridStatus)return e._autoprefixerGridStatus;let t=null;if(e.nodes){let r;e.each(e=>{if("comment"===e.type&&GRID_REGEX.test(e.text)){let t=/:\s*autoplace/i.test(e.text),s=/no-autoplace/i.test(e.text);void 0!==r?i.warn("Second Autoprefixer grid control comment was ignored. Autoprefixer applies control comments to the whole block, not to the next rules.",{node:e}):r=t?"autoplace":!!s||/on/i.test(e.text)}}),void 0!==r&&(t=r)}if("atrule"===e.type&&"supports"===e.name){let i=e.params;i.includes("grid")&&i.includes("auto")&&(t=!1)}if(!e.nodes||null===t)if(e.parent){let r=this.gridStatus(e.parent,i);t=!0!==e.parent._autoprefixerSelfDisabled&&r}else t=void 0!==this.prefixes.options.grid?this.prefixes.options.grid:void 0!==process.env.AUTOPREFIXER_GRID&&("autoplace"!==process.env.AUTOPREFIXER_GRID||"autoplace");return e._autoprefixerGridStatus=t,t}reduceSpaces(e){let i=!1;if(this.prefixes.group(e).up(()=>(i=!0,!0)),i)return;let t=e.raw("before").split("\n"),r=t[t.length-1].length,s=!1;this.prefixes.group(e).down(e=>{t=e.raw("before").split("\n");let i=t.length-1;t[i].length>r&&(!1===s&&(s=t[i].length-r),t[i]=t[i].slice(0,-s),e.raws.before=t.join("\n"))})}remove(e,i){let t=this.prefixes.remove["@resolution"];return e.walkAtRules((e,r)=>{this.prefixes.remove[`@${e.name}`]?this.disabled(e,i)||e.parent.removeChild(r):"media"===e.name&&e.params.includes("-resolution")&&t&&t.clean(e)}),e.walkRules((e,t)=>{if(!this.disabled(e,i))for(let i of this.prefixes.remove.selectors)if(i.check(e))return void e.parent.removeChild(t)}),e.walkDecls((e,t)=>{if(this.disabled(e,i))return;let r=e.parent,s=this.prefixes.unprefixed(e.prop);if("transition"!==e.prop&&"transition-property"!==e.prop||this.prefixes.transition.remove(e),this.prefixes.remove[e.prop]&&this.prefixes.remove[e.prop].remove){let i=this.prefixes.group(e).down(e=>this.prefixes.normalize(e.prop)===s);if("flex-flow"===s&&(i=!0),"-webkit-box-orient"===e.prop){let i={"flex-direction":!0,"flex-flow":!0};if(!e.parent.some(e=>i[e.prop]))return}if(i&&!this.withHackValue(e))return e.raw("before").includes("\n")&&this.reduceSpaces(e),void r.removeChild(t)}for(let i of this.prefixes.values("remove",s)){if(!i.check)continue;if(!i.check(e.value))continue;if(s=i.unprefixed,this.prefixes.group(e).down(e=>e.value.includes(s)))return void r.removeChild(t)}})}withHackValue(e){return"-webkit-background-clip"===e.prop&&"text"===e.value||"-webkit-box-orient"===e.prop&&e.parent.some(e=>"-webkit-line-clamp"===e.prop)}}module.exports=Processor;