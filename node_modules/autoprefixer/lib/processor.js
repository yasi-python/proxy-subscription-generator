let parser=require("postcss-value-parser"),Value=require("./value"),insertAreas=require("./hacks/grid-utils").insertAreas;const OLD_LINEAR=/(^|[^-])linear-gradient\(\s*(top|left|right|bottom)/i,OLD_RADIAL=/(^|[^-])radial-gradient\(\s*\d+(\w*|%)\s+\d+(\w*|%)\s*,/i,IGNORE_NEXT=/(!\s*)?autoprefixer:\s*ignore\s+next/i,GRID_REGEX=/(!\s*)?autoprefixer\s*grid:\s*(on|off|(no-)?autoplace)/i,SIZES=["width","height","min-width","max-width","min-height","max-height","inline-size","min-inline-size","max-inline-size","block-size","min-block-size","max-block-size"];function hasGridTemplate(e){return e.parent.some(e=>"grid-template"===e.prop||"grid-template-areas"===e.prop)}function hasRowsAndColumns(e){let t=e.parent.some(e=>"grid-template-rows"===e.prop),i=e.parent.some(e=>"grid-template-columns"===e.prop);return t&&i}class Processor{constructor(e){this.prefixes=e}add(e,t){let i=this.prefixes.add["@resolution"],r=this.prefixes.add["@keyframes"],s=this.prefixes.add["@viewport"],o=this.prefixes.add["@supports"];function a(e){return e.parent.nodes.some(e=>{if("decl"!==e.type)return!1;let t="display"===e.prop&&/(inline-)?grid/.test(e.value),i=e.prop.startsWith("grid-template"),r=/^grid-([A-z]+-)?gap/.test(e.prop);return t||i||r})}e.walkAtRules(e=>{if("keyframes"===e.name){if(!this.disabled(e,t))return r&&r.process(e)}else if("viewport"===e.name){if(!this.disabled(e,t))return s&&s.process(e)}else if("supports"===e.name){if(!1!==this.prefixes.options.supports&&!this.disabled(e,t))return o.process(e)}else if("media"===e.name&&e.params.includes("-resolution")&&!this.disabled(e,t))return i&&i.process(e)}),e.walkRules(e=>{if(!this.disabled(e,t))return this.prefixes.add.selectors.map(i=>i.process(e,t))});let n=this.gridStatus(e,t)&&this.prefixes.add["grid-area"]&&this.prefixes.add["grid-area"].prefixes;return e.walkDecls(e=>{if(this.disabledDecl(e,t))return;let i,r=e.parent,s=e.prop,o=e.value;if("color-adjust"===s)r.every(e=>"print-color-adjust"!==e.prop)&&t.warn("Replace color-adjust to print-color-adjust. The color-adjust shorthand is currently deprecated.",{node:e});else{if("grid-row-span"===s)return void t.warn("grid-row-span is not part of final Grid Layout. Use grid-row.",{node:e});if("grid-column-span"===s)return void t.warn("grid-column-span is not part of final Grid Layout. Use grid-column.",{node:e});if("display"===s&&"box"===o)return void t.warn("You should write display: flex by final spec instead of display: box",{node:e});if("text-emphasis-position"===s)"under"!==o&&"over"!==o||t.warn("You should use 2 values for text-emphasis-position For example, `under left` instead of just `under`.",{node:e});else if("text-decoration-skip"===s&&"ink"===o)t.warn("Replace text-decoration-skip: ink to text-decoration-skip-ink: auto, because spec had been changed",{node:e});else{if(n&&this.gridStatus(e,t))if("subgrid"===e.value&&t.warn("IE does not support subgrid",{node:e}),/^(align|justify|place)-items$/.test(s)&&a(e)){let i=s.replace("-items","-self");t.warn(`IE does not support ${s} on grid containers. Try using ${i} on child elements instead: ${e.parent.selector} > * { ${i}: ${e.value} }`,{node:e})}else if(/^(align|justify|place)-content$/.test(s)&&a(e))t.warn(`IE does not support ${e.prop} on grid containers`,{node:e});else{if("display"===s&&"contents"===e.value)return void t.warn("Please do not use display: contents; if you have grid setting enabled",{node:e});if("grid-gap"===e.prop){let i=this.gridStatus(e,t);"autoplace"!==i||hasRowsAndColumns(e)||hasGridTemplate(e)?!0!==i&&"no-autoplace"!==i||hasGridTemplate(e)||t.warn("grid-gap only works if grid-template(-areas) is being used",{node:e}):t.warn("grid-gap only works if grid-template(-areas) is being used or both rows and columns have been declared and cells have not been manually placed inside the explicit grid",{node:e})}else{if("grid-auto-columns"===s)return void t.warn("grid-auto-columns is not supported by IE",{node:e});if("grid-auto-rows"===s)return void t.warn("grid-auto-rows is not supported by IE",{node:e});if("grid-auto-flow"===s){let i=r.some(e=>"grid-template-rows"===e.prop),s=r.some(e=>"grid-template-columns"===e.prop);return void(hasGridTemplate(e)?t.warn("grid-auto-flow is not supported by IE",{node:e}):o.includes("dense")?t.warn("grid-auto-flow: dense is not supported by IE",{node:e}):i||s||t.warn("grid-auto-flow works only if grid-template-rows and grid-template-columns are present in the same rule",{node:e}))}if(o.includes("auto-fit"))return void t.warn("auto-fit value is not supported by IE",{node:e,word:"auto-fit"});if(o.includes("auto-fill"))return void t.warn("auto-fill value is not supported by IE",{node:e,word:"auto-fill"});s.startsWith("grid-template")&&o.includes("[")&&t.warn("Autoprefixer currently does not support line names. Try using grid-template-areas instead.",{node:e,word:"["})}}if(o.includes("radial-gradient"))if(OLD_RADIAL.test(e.value))t.warn("Gradient has outdated direction syntax. New syntax is like `closest-side at 0 0` instead of `0 0, closest-side`.",{node:e});else{let i=parser(o);for(let r of i.nodes)if("function"===r.type&&"radial-gradient"===r.value)for(let i of r.nodes)"word"===i.type&&("cover"===i.value?t.warn("Gradient has outdated direction syntax. Replace `cover` to `farthest-corner`.",{node:e}):"contain"===i.value&&t.warn("Gradient has outdated direction syntax. Replace `contain` to `closest-side`.",{node:e}))}o.includes("linear-gradient")&&OLD_LINEAR.test(o)&&t.warn("Gradient has outdated direction syntax. New syntax is like `to left` instead of `right`.",{node:e})}}if(SIZES.includes(e.prop)&&!e.value.includes("-fill-available")&&(e.value.includes("fill-available")?t.warn("Replace fill-available to stretch, because spec had been changed",{node:e}):e.value.includes("fill")&&parser(o).nodes.some(e=>"word"===e.type&&"fill"===e.value)&&t.warn("Replace fill to stretch, because spec had been changed",{node:e})),"transition"===e.prop||"transition-property"===e.prop)return this.prefixes.transition.add(e,t);if("align-self"===e.prop){if("grid"!==this.displayType(e)&&!1!==this.prefixes.options.flexbox&&(i=this.prefixes.add["align-self"],i&&i.prefixes&&i.process(e)),!1!==this.gridStatus(e,t)&&(i=this.prefixes.add["grid-row-align"],i&&i.prefixes))return i.process(e,t)}else if("justify-self"===e.prop){if(!1!==this.gridStatus(e,t)&&(i=this.prefixes.add["grid-column-align"],i&&i.prefixes))return i.process(e,t)}else if("place-self"===e.prop){if(i=this.prefixes.add["place-self"],i&&i.prefixes&&!1!==this.gridStatus(e,t))return i.process(e,t)}else if(i=this.prefixes.add[e.prop],i&&i.prefixes)return i.process(e,t)}),this.gridStatus(e,t)&&insertAreas(e,this.disabled),e.walkDecls(e=>{if(this.disabledValue(e,t))return;let i=this.prefixes.unprefixed(e.prop),r=this.prefixes.values("add",i);if(Array.isArray(r))for(let i of r)i.process&&i.process(e,t);Value.save(this.prefixes,e)})}disabled(e,t){if(!e)return!1;if(void 0!==e._autoprefixerDisabled)return e._autoprefixerDisabled;if(e.parent){let t=e.prev();if(t&&"comment"===t.type&&IGNORE_NEXT.test(t.text))return e._autoprefixerDisabled=!0,e._autoprefixerSelfDisabled=!0,!0}let i=null;if(e.nodes){let r;e.each(e=>{"comment"===e.type&&/(!\s*)?autoprefixer:\s*(off|on)/i.test(e.text)&&(void 0!==r?t.warn("Second Autoprefixer control comment was ignored. Autoprefixer applies control comment to whole block, not to next rules.",{node:e}):r=/on/i.test(e.text))}),void 0!==r&&(i=!r)}if(!e.nodes||null===i)if(e.parent){let r=this.disabled(e.parent,t);i=!0!==e.parent._autoprefixerSelfDisabled&&r}else i=!1;return e._autoprefixerDisabled=i,i}disabledDecl(e,t){if("decl"===e.type&&!1===this.gridStatus(e,t)&&(e.prop.includes("grid")||"justify-items"===e.prop))return!0;if("decl"===e.type&&!1===this.prefixes.options.flexbox){let t=["order","justify-content","align-items","align-content"];if(e.prop.includes("flex")||t.includes(e.prop))return!0}return this.disabled(e,t)}disabledValue(e,t){return!(!1!==this.gridStatus(e,t)||"decl"!==e.type||"display"!==e.prop||!e.value.includes("grid"))||!(!1!==this.prefixes.options.flexbox||"decl"!==e.type||"display"!==e.prop||!e.value.includes("flex"))||"decl"===e.type&&"content"===e.prop||this.disabled(e,t)}displayType(e){for(let t of e.parent.nodes)if("display"===t.prop){if(t.value.includes("flex"))return"flex";if(t.value.includes("grid"))return"grid"}return!1}gridStatus(e,t){if(!e)return!1;if(void 0!==e._autoprefixerGridStatus)return e._autoprefixerGridStatus;let i=null;if(e.nodes){let r;e.each(e=>{if("comment"===e.type&&GRID_REGEX.test(e.text)){let i=/:\s*autoplace/i.test(e.text),s=/no-autoplace/i.test(e.text);void 0!==r?t.warn("Second Autoprefixer grid control comment was ignored. Autoprefixer applies control comments to the whole block, not to the next rules.",{node:e}):r=i?"autoplace":!!s||/on/i.test(e.text)}}),void 0!==r&&(i=r)}if("atrule"===e.type&&"supports"===e.name){let t=e.params;t.includes("grid")&&t.includes("auto")&&(i=!1)}if(!e.nodes||null===i)if(e.parent){let r=this.gridStatus(e.parent,t);i=!0!==e.parent._autoprefixerSelfDisabled&&r}else i=void 0!==this.prefixes.options.grid?this.prefixes.options.grid:void 0!==process.env.AUTOPREFIXER_GRID&&("autoplace"!==process.env.AUTOPREFIXER_GRID||"autoplace");return e._autoprefixerGridStatus=i,i}reduceSpaces(e){let t=!1;if(this.prefixes.group(e).up(()=>(t=!0,!0)),t)return;let i=e.raw("before").split("\n"),r=i[i.length-1].length,s=!1;this.prefixes.group(e).down(e=>{i=e.raw("before").split("\n");let t=i.length-1;i[t].length>r&&(!1===s&&(s=i[t].length-r),i[t]=i[t].slice(0,-s),e.raws.before=i.join("\n"))})}remove(e,t){let i=this.prefixes.remove["@resolution"];return e.walkAtRules((e,r)=>{this.prefixes.remove[`@${e.name}`]?this.disabled(e,t)||e.parent.removeChild(r):"media"===e.name&&e.params.includes("-resolution")&&i&&i.clean(e)}),e.walkRules((e,i)=>{if(!this.disabled(e,t))for(let t of this.prefixes.remove.selectors)if(t.check(e))return void e.parent.removeChild(i)}),e.walkDecls((e,i)=>{if(this.disabled(e,t))return;let r=e.parent,s=this.prefixes.unprefixed(e.prop);if("transition"!==e.prop&&"transition-property"!==e.prop||this.prefixes.transition.remove(e),this.prefixes.remove[e.prop]&&this.prefixes.remove[e.prop].remove){let t=this.prefixes.group(e).down(e=>this.prefixes.normalize(e.prop)===s);if("flex-flow"===s&&(t=!0),"-webkit-box-orient"===e.prop){let t={"flex-direction":!0,"flex-flow":!0};if(!e.parent.some(e=>t[e.prop]))return}if(t&&!this.withHackValue(e))return e.raw("before").includes("\n")&&this.reduceSpaces(e),void r.removeChild(i)}for(let t of this.prefixes.values("remove",s))if(t.check&&t.check(e.value)&&(s=t.unprefixed,this.prefixes.group(e).down(e=>e.value.includes(s))))return void r.removeChild(i)})}withHackValue(e){return"-webkit-background-clip"===e.prop&&"text"===e.value||"-webkit-box-orient"===e.prop&&e.parent.some(e=>"-webkit-line-clamp"===e.prop)}}module.exports=Processor;