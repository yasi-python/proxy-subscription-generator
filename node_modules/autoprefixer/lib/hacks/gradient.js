let range=require("normalize-range"),parser=require("postcss-value-parser"),OldValue=require("../old-value"),utils=require("../utils"),Value=require("../value"),IS_DIRECTION=/top|left|right|bottom/gi;class Gradient extends Value{add(e,t){let r=e.prop;if(r.includes("mask")){if("-webkit-"===t||"-webkit- old"===t)return super.add(e,t)}else{if("list-style"!==r&&"list-style-image"!==r&&"content"!==r)return super.add(e,t);if("-webkit-"===t||"-webkit- old"===t)return super.add(e,t)}}cloneDiv(e){for(let t of e)if("div"===t.type&&","===t.value)return t;return{after:" ",type:"div",value:","}}colorStops(e){let t=[];for(let r=0;r<e.length;r++){let i,l,o=e[r];if(0===r)continue;let a,n=parser.stringify(o[0]);o[1]&&"word"===o[1].type?i=o[1].value:o[2]&&"word"===o[2].type&&(i=o[2].value),a=1!==r||i&&"0%"!==i?r!==e.length-1||i&&"100%"!==i?i?`color-stop(${i}, ${n})`:`color-stop(${n})`:`to(${n})`:`from(${n})`;let s=o[o.length-1];e[r]=[{type:"word",value:a}],"div"===s.type&&","===s.value&&(l=e[r].push(s)),t.push(l)}return t}convertDirection(e){return e.length>0&&("to"===e[0].value?this.fixDirection(e):e[0].value.includes("deg")?this.fixAngle(e):this.isRadial(e)&&this.fixRadial(e)),e}fixAngle(e){let t=e[0].value;t=parseFloat(t),t=Math.abs(450-t)%360,t=this.roundFloat(t,3),e[0].value=`${t}deg`}fixDirection(e){e.splice(0,2);for(let t of e){if("div"===t.type)break;"word"===t.type&&(t.value=this.revertDirection(t.value))}}fixRadial(e){let t,r,i,l,o,a,n=[],s=[];for(l=0;l<e.length-2;l++){if(t=e[l],r=e[l+1],i=e[l+2],"space"===t.type&&"at"===r.value&&"space"===i.type){o=l+3;break}n.push(t)}for(l=o;l<e.length;l++){if("div"===e[l].type){a=e[l];break}s.push(e[l])}e.splice(0,l,...s,a,...n)}isRadial(e){let t="before";for(let r of e)if("before"===t&&"space"===r.type)t="at";else if("at"===t&&"at"===r.value)t="after";else{if("after"===t&&"space"===r.type)return!0;if("div"===r.type)break;t="before"}return!1}newDirection(e){if("to"===e[0].value)return e;if(IS_DIRECTION.lastIndex=0,!IS_DIRECTION.test(e[0].value))return e;e.unshift({type:"word",value:"to"},{type:"space",value:" "});for(let t=2;t<e.length&&"div"!==e[t].type;t++)"word"===e[t].type&&(e[t].value=this.revertDirection(e[t].value));return e}normalize(e,t){if(!e[0])return e;if(/-?\d+(.\d+)?grad/.test(e[0].value))e[0].value=this.normalizeUnit(e[0].value,400);else if(/-?\d+(.\d+)?rad/.test(e[0].value))e[0].value=this.normalizeUnit(e[0].value,2*Math.PI);else if(/-?\d+(.\d+)?turn/.test(e[0].value))e[0].value=this.normalizeUnit(e[0].value,1);else if(e[0].value.includes("deg")){let t=parseFloat(e[0].value);t=range.wrap(0,360,t),e[0].value=`${t}deg`}if("linear-gradient"===t||"repeating-linear-gradient"===t){let t=e[0].value;"0deg"===t||"0"===t?e=this.replaceFirst(e,"to"," ","top"):"90deg"===t?e=this.replaceFirst(e,"to"," ","right"):"180deg"===t?e=this.replaceFirst(e,"to"," ","bottom"):"270deg"===t&&(e=this.replaceFirst(e,"to"," ","left"))}return e}normalizeUnit(e,t){return`${parseFloat(e)/t*360}deg`}old(e){if("-webkit-"===e){let t;t="linear-gradient"===this.name?"linear":"repeating-linear-gradient"===this.name?"repeating-linear":"repeating-radial-gradient"===this.name?"repeating-radial":"radial";let r="-gradient",i=utils.regexp(`-webkit-(${t}-gradient|gradient\\(\\s*${t})`,!1);return new OldValue(this.name,e+this.name,r,i)}return super.old(e)}oldDirection(e){let t=this.cloneDiv(e[0]);if("to"!==e[0][0].value)return e.unshift([{type:"word",value:Gradient.oldDirections.bottom},t]);{let r=[];for(let t of e[0].slice(2))"word"===t.type&&r.push(t.value.toLowerCase());r=r.join(" ");let i=Gradient.oldDirections[r]||r;return e[0]=[{type:"word",value:i},t],e[0]}}oldWebkit(e){let{nodes:t}=e,r=parser.stringify(e.nodes);if("linear-gradient"!==this.name)return!1;if(t[0]&&t[0].value.includes("deg"))return!1;if(r.includes("px")||r.includes("-corner")||r.includes("-side"))return!1;let i=[[]];for(let e of t)i[i.length-1].push(e),"div"===e.type&&","===e.value&&i.push([]);this.oldDirection(i),this.colorStops(i),e.nodes=[];for(let t of i)e.nodes=e.nodes.concat(t);return e.nodes.unshift({type:"word",value:"linear"},this.cloneDiv(e.nodes)),e.value="-webkit-gradient",!0}replace(e,t){let r=parser(e);for(let e of r.nodes){let r=this.name;if("function"===e.type&&e.value===r)if(e.nodes=this.newDirection(e.nodes),e.nodes=this.normalize(e.nodes,r),"-webkit- old"===t){if(!this.oldWebkit(e))return!1}else e.nodes=this.convertDirection(e.nodes),e.value=t+e.value}return r.toString()}replaceFirst(e,...t){return t.map(e=>" "===e?{type:"space",value:e}:{type:"word",value:e}).concat(e.slice(1))}revertDirection(e){return Gradient.directions[e.toLowerCase()]||e}roundFloat(e,t){return parseFloat(e.toFixed(t))}}Gradient.names=["linear-gradient","repeating-linear-gradient","radial-gradient","repeating-radial-gradient"],Gradient.directions={bottom:"top",left:"right",right:"left",top:"bottom"},Gradient.oldDirections={bottom:"left top, left bottom","bottom left":"right top, left bottom","bottom right":"left top, right bottom",left:"right top, left top","left bottom":"right top, left bottom","left top":"right bottom, left top",right:"left top, right top","right bottom":"left top, right bottom","right top":"left bottom, right top",top:"left bottom, left top","top left":"right bottom, left top","top right":"left bottom, right top"},module.exports=Gradient;