let parser=require("postcss-value-parser"),list=require("postcss").list,uniq=require("../utils").uniq,escapeRegexp=require("../utils").escapeRegexp,splitSelector=require("../utils").splitSelector;function convert(e){return e&&2===e.length&&"span"===e[0]&&parseInt(e[1],10)>0?[!1,parseInt(e[1],10)]:e&&1===e.length&&parseInt(e[0],10)>0?[parseInt(e[0],10),!1]:[!1,!1]}function translate(e,r,t){let a=e[r],s=e[t];if(!a)return[!1,!1];let[n,l]=convert(a),[o,p]=convert(s);return n&&!s?[n,!1]:l&&o?[o-l,l]:n&&p?[n,p]:n&&o?[n,o-n]:[!1,!1]}function parse(e){let r=parser(e.value),t=[],a=0;t[a]=[];for(let e of r.nodes)"div"===e.type?(a+=1,t[a]=[]):"word"===e.type&&t[a].push(e.value);return t}function insertDecl(e,r,t){t&&!e.parent.some(e=>e.prop===`-ms-${r}`)&&e.cloneBefore({prop:`-ms-${r}`,value:t.toString()})}function prefixTrackProp({prefix:e,prop:r}){return e+r.replace("template-","")}function transformRepeat({nodes:e},{gap:r}){let{count:t,size:a}=e.reduce((e,r)=>("div"===r.type&&","===r.value?e.key="size":e[e.key].push(parser.stringify(r)),e),{count:[],key:"count",size:[]});if(r){a=a.filter(e=>e.trim());let e=[];for(let s=1;s<=t;s++)a.forEach((t,a)=>{(a>0||s>1)&&e.push(r),e.push(t)});return e.join(" ")}return`(${a.join("")})[${t.join("")}]`}function prefixTrackValue({gap:e,value:r}){let t=parser(r).nodes.reduce((r,t)=>"function"===t.type&&"repeat"===t.value?r.concat({type:"word",value:transformRepeat(t,{gap:e})}):e&&"space"===t.type?r.concat({type:"space",value:" "},{type:"word",value:e},t):r.concat(t),[]);return parser.stringify(t)}exports.translate=translate,exports.parse=parse,exports.insertDecl=insertDecl,exports.prefixTrackProp=prefixTrackProp,exports.prefixTrackValue=prefixTrackValue;let DOTS=/^\.+$/;function track(e,r){return{end:r,span:r-e,start:e}}function getColumns(e){return e.trim().split(/\s+/g)}function parseGridAreas({gap:e,rows:r}){return r.reduce((r,t,a)=>(e.row&&(a*=2),""===t.trim()||getColumns(t).forEach((t,s)=>{if(!DOTS.test(t))if(e.column&&(s*=2),void 0===r[t])r[t]={column:track(s+1,s+2),row:track(a+1,a+2)};else{let{column:e,row:n}=r[t];e.start=Math.min(e.start,s+1),e.end=Math.max(e.end,s+2),e.span=e.end-e.start,n.start=Math.min(n.start,a+1),n.end=Math.max(n.end,a+2),n.span=n.end-n.start}}),r),{})}function testTrack(e){return"word"===e.type&&/^\[.+]$/.test(e.value)}function verifyRowSize(e){return e.areas.length>e.rows.length&&e.rows.push("auto"),e}function parseTemplate({decl:e,gap:r}){let t=parser(e.value).nodes.reduce((e,r)=>{let{type:t,value:a}=r;return testTrack(r)||"space"===t||("string"===t&&(e=verifyRowSize(e)).areas.push(a),"word"!==t&&"function"!==t||e[e.key].push(parser.stringify(r)),"div"===t&&"/"===a&&(e.key="columns",e=verifyRowSize(e))),e},{areas:[],columns:[],key:"rows",rows:[]});return{areas:parseGridAreas({gap:r,rows:t.areas}),columns:prefixTrackValue({gap:r.column,value:t.columns.join(" ")}),rows:prefixTrackValue({gap:r.row,value:t.rows.join(" ")})}}function getMSDecls(e,r=!1,t=!1){let a=[{prop:"-ms-grid-row",value:String(e.row.start)}];return(e.row.span>1||r)&&a.push({prop:"-ms-grid-row-span",value:String(e.row.span)}),a.push({prop:"-ms-grid-column",value:String(e.column.start)}),(e.column.span>1||t)&&a.push({prop:"-ms-grid-column-span",value:String(e.column.span)}),a}function getParentMedia(e){return"atrule"===e.type&&"media"===e.name?e:!!e.parent&&getParentMedia(e.parent)}function changeDuplicateAreaSelectors(e,r){return(e=e.map(e=>{let r=list.space(e),t=list.comma(e);return r.length>t.length&&(e=r.slice(-1).join("")),e})).map(e=>r.map((r,t)=>`${0===t?"":" "}${r} > ${e}`))}function selectorsEqual(e,r){return e.selectors.some(e=>r.selectors.includes(e))}function parseGridTemplatesData(e){let r=[];return e.walkDecls(/grid-template(-areas)?$/,e=>{let t=e.parent,a=getParentMedia(t),s=getGridGap(e),n=inheritGridGap(e,s),{areas:l}=parseTemplate({decl:e,gap:n||s}),o=Object.keys(l);if(0===o.length)return!0;let p=r.reduce((e,{allAreas:r},t)=>r&&o.some(e=>r.includes(e))?t:e,null);if(null!==p){let{allAreas:e,rules:s}=r[p],n=s.some(e=>!1===e.hasDuplicates&&selectorsEqual(e,t)),i=!1,u=s.reduce((e,r)=>!r.params&&selectorsEqual(r,t)?(i=!0,r.duplicateAreaNames):(i||o.forEach(t=>{r.areas[t]&&e.push(t)}),uniq(e)),[]);s.forEach(e=>{o.forEach(r=>{let t=e.areas[r];t&&t.row.span!==l[r].row.span&&(l[r].row.updateSpan=!0),t&&t.column.span!==l[r].column.span&&(l[r].column.updateSpan=!0)})}),r[p].allAreas=uniq([...e,...o]),r[p].rules.push({areas:l,duplicateAreaNames:u,hasDuplicates:!n,node:t,params:a.params,selectors:t.selectors})}else r.push({allAreas:o,areasCount:0,rules:[{areas:l,duplicateAreaNames:[],duplicateRules:[],hasDuplicates:!1,node:t,params:a.params,selectors:t.selectors}]})}),r}function insertAreas(e,r){let t=parseGridTemplatesData(e);if(0===t.length)return;let a={};e.walkDecls("grid-area",s=>{let n=s.parent,l="-ms-grid-row"===n.first.prop,o=getParentMedia(n);if(r(s))return;let p=e.index(o||n),i=s.value,u=t.filter(e=>e.allAreas.includes(i))[0];if(!u)return!0;let c=u.allAreas[u.allAreas.length-1],d=list.space(n.selector),m=list.comma(n.selector),g=d.length>1&&d.length>m.length;if(l)return!1;a[c]||(a[c]={});let f=!1;for(let r of u.rules){let t=r.areas[i],l=r.duplicateAreaNames.includes(i);if(!t){let r,t=a[c].lastRule;r=t?e.index(t):-1,p>r&&(a[c].lastRule=o||n);continue}if(r.params&&!a[c][r.params]&&(a[c][r.params]=[]),r.hasDuplicates&&l||r.params)if(!r.hasDuplicates||r.params||g){if(r.hasDuplicates&&!r.params&&g&&n.selector.includes(r.selectors[0]))n.walkDecls(/-ms-grid-(row|column)/,e=>e.remove()),getMSDecls(t,t.row.updateSpan,t.column.updateSpan).reverse().forEach(e=>n.prepend(Object.assign(e,{raws:{between:s.raws.between}})));else if(r.params){let i=n.clone();i.removeAll(),getMSDecls(t,t.row.updateSpan,t.column.updateSpan).reverse().forEach(e=>i.prepend(Object.assign(e,{raws:{between:s.raws.between}}))),r.hasDuplicates&&l&&(i.selectors=changeDuplicateAreaSelectors(i.selectors,r.selectors)),i.raws=r.node.raws,e.index(r.node.parent)>p?r.node.parent.append(i):a[c][r.params].push(i),f||(a[c].lastRule=o||n)}}else{let e=n.clone();e.removeAll(),getMSDecls(t,t.row.updateSpan,t.column.updateSpan).reverse().forEach(r=>e.prepend(Object.assign(r,{raws:{between:s.raws.between}}))),e.selectors=changeDuplicateAreaSelectors(e.selectors,r.selectors),a[c].lastRule&&a[c].lastRule.after(e),a[c].lastRule=e,f=!0}else getMSDecls(t,!1,!1).reverse().forEach(e=>n.prepend(Object.assign(e,{raws:{between:s.raws.between}}))),a[c].lastRule=n,f=!0}}),Object.keys(a).forEach(e=>{let r=a[e],t=r.lastRule;Object.keys(r).reverse().filter(e=>"lastRule"!==e).forEach(e=>{r[e].length>0&&t&&(t.after({name:"media",params:e}),t.next().append(r[e]))})})}function warnMissedAreas(e,r,t){let a=Object.keys(e);r.root().walkDecls("grid-area",e=>{a=a.filter(r=>r!==e.value)}),a.length>0&&r.warn(t,"Can not find grid areas: "+a.join(", "))}function warnTemplateSelectorNotFound(e,r){let t=e.parent,a=e.root(),s=!1,n=list.space(t.selector).filter(e=>">"!==e).slice(0,-1);if(n.length>0){let t=!1,l=null;a.walkDecls(/grid-template(-areas)?$/,r=>{let a=r.parent,o=a.selectors,{areas:p}=parseTemplate({decl:r,gap:getGridGap(r)}),i=p[e.value];for(let e of o){if(t)break;let r=list.space(e).filter(e=>">"!==e);t=r.every((e,r)=>e===n[r])}if(t||!i)return!0;l||(l=a.selector),l&&l!==a.selector&&(s=!0)}),!t&&s&&e.warn(r,`Autoprefixer cannot find a grid-template containing the duplicate grid-area "${e.value}" with full selector matching: ${n.join(" ")}`)}}function warnIfGridRowColumnExists(e,r){let t=e.parent,a=[];t.walkDecls(/^grid-(row|column)/,e=>{e.prop.endsWith("-end")||e.value.startsWith("span")||e.prop.endsWith("-gap")||a.push(e)}),a.length>0&&a.forEach(e=>{e.warn(r,`You already have a grid-area declaration present in the rule. You should use either grid-area or ${e.prop}, not both`)})}function getGridGap(e){let r={};return e.parent.walkDecls(/^(grid-)?((row|column)-)?gap$/,({prop:e,value:t})=>{if(/^(grid-)?gap$/.test(e)){let[e,,a]=parser(t).nodes;r.row=e&&parser.stringify(e),r.column=a?parser.stringify(a):r.row}/^(grid-)?row-gap$/.test(e)&&(r.row=t),/^(grid-)?column-gap$/.test(e)&&(r.column=t)}),r}function parseMediaParams(e){if(!e)return[];let r,t;return parser(e).walk(e=>{"word"===e.type&&/min|max/g.test(e.value)?r=e.value:e.value.includes("px")&&(t=parseInt(e.value.replace(/\D/g,"")))}),[r,t]}function shouldInheritGap(e,r){let t,a=splitSelector(e),s=splitSelector(r);if(a[0].length<s[0].length)return!1;if(a[0].length>s[0].length){let e=a[0].reduce((e,[r],t)=>r===s[0][0][0]&&t,!1);e&&(t=s[0].every((r,t)=>r.every((r,s)=>a[0].slice(e)[t][s]===r)))}else t=s.some(e=>e.every((e,r)=>e.every((e,t)=>a[0][r][t]===e)));return t}function inheritGridGap(e,r){let t=e.parent,a=getParentMedia(t),s=t.root(),n=splitSelector(t.selector);if(Object.keys(r).length>0)return!1;let l,[o]=parseMediaParams(a.params),p=n[0],i=escapeRegexp(p[p.length-1][0]),u=new RegExp(`(${i}$)|(${i}[,.])`);return s.walkRules(u,e=>{let r;if(t.toString()===e.toString())return!1;if(e.walkDecls("grid-gap",e=>r=getGridGap(e)),!r||0===Object.keys(r).length)return!0;if(!shouldInheritGap(t.selector,e.selector))return!0;let a=getParentMedia(e);return a?parseMediaParams(a.params)[0]===o?(l=r,!0):void 0:(l=r,!0)}),!!(l&&Object.keys(l).length>0)&&l}function warnGridGap({decl:e,gap:r,hasColumns:t,result:a}){let s=r.row&&r.column;!t&&(s||r.column&&!r.row)&&(delete r.column,e.warn(a,"Can not implement grid-gap without grid-template-columns"))}function normalizeRowColumn(e){return parser(e).nodes.reduce((e,r)=>{if("function"===r.type&&"repeat"===r.value){let t="count",[a,s]=r.nodes.reduce((e,r)=>"word"===r.type&&"count"===t?(e[0]=Math.abs(parseInt(r.value)),e):"div"===r.type&&","===r.value?(t="value",e):("value"===t&&(e[1]+=parser.stringify(r)),e),[0,""]);if(a)for(let r=0;r<a;r++)e.push(s);return e}return"space"===r.type?e:e.concat(parser.stringify(r))},[])}function autoplaceGridItems(e,r,t,a="row"){let{parent:s}=e,n=normalizeRowColumn(s.nodes.find(e=>"grid-template-rows"===e.prop).value),l=normalizeRowColumn(e.value),o=parseGridAreas({gap:t,rows:n.map((e,r)=>Array.from({length:l.length},(e,t)=>t+r*l.length+1).join(" "))}),p=Object.keys(o),i=p.map(e=>o[e]);a.includes("column")&&(i=i.sort((e,r)=>e.column.start-r.column.start)),i.reverse().forEach((e,r)=>{let{column:t,row:a}=e,n=s.selectors.map(e=>e+` > *:nth-child(${p.length-r})`).join(", "),l=s.clone().removeAll();l.selector=n,l.append({prop:"-ms-grid-row",value:a.start}),l.append({prop:"-ms-grid-column",value:t.start}),s.after(l)})}exports.parseGridAreas=parseGridAreas,exports.parseTemplate=parseTemplate,exports.insertAreas=insertAreas,exports.warnMissedAreas=warnMissedAreas,exports.warnTemplateSelectorNotFound=warnTemplateSelectorNotFound,exports.warnIfGridRowColumnExists=warnIfGridRowColumnExists,exports.getGridGap=getGridGap,exports.inheritGridGap=inheritGridGap,exports.warnGridGap=warnGridGap,exports.autoplaceGridItems=autoplaceGridItems;