let featureQueries=require("caniuse-lite/data/features/css-featurequeries.js"),feature=require("caniuse-lite/dist/unpacker/feature"),{parse:parse}=require("postcss"),brackets=require("./brackets"),Browsers=require("./browsers"),utils=require("./utils"),Value=require("./value"),data=feature(featureQueries),supported=[];for(let e in data.stats){let r=data.stats[e];for(let t in r){let s=r[t];/y/.test(s)&&supported.push(e+" "+t)}}class Supports{constructor(e,r){this.Prefixes=e,this.all=r}add(e,r){return e.map(e=>{if(this.isProp(e)){let r=this.prefixed(e[0]);return r.length>1?this.convert(r):e}return"object"==typeof e?this.add(e,r):e})}cleanBrackets(e){return e.map(e=>"object"!=typeof e?e:1===e.length&&"object"==typeof e[0]?this.cleanBrackets(e[0]):this.cleanBrackets(e))}convert(e){let r=[""];for(let t of e)r.push([`${t.prop}: ${t.value}`]),r.push(" or ");return r[r.length-1]="",r}disabled(e){if(!this.all.options.grid){if("display"===e.prop&&e.value.includes("grid"))return!0;if(e.prop.includes("grid")||"justify-items"===e.prop)return!0}if(!1===this.all.options.flexbox){if("display"===e.prop&&e.value.includes("flex"))return!0;let r=["order","justify-content","align-items","align-content"];if(e.prop.includes("flex")||r.includes(e.prop))return!0}return!1}isHack(e,r){return!new RegExp(`(\\(|\\s)${utils.escapeRegexp(r)}:`).test(e)}isNot(e){return"string"==typeof e&&/not\s*/i.test(e)}isOr(e){return"string"==typeof e&&/\s*or\s*/i.test(e)}isProp(e){return"object"==typeof e&&1===e.length&&"string"==typeof e[0]}normalize(e){if("object"!=typeof e)return e;if("string"==typeof(e=e.filter(e=>""!==e))[0]){let r=e[0].trim();if(r.includes(":")||"selector"===r||"not selector"===r)return[brackets.stringify(e)]}return e.map(e=>this.normalize(e))}parse(e){let r=e.split(":"),t=r[0],s=r[1];return s||(s=""),[t.trim(),s.trim()]}prefixed(e){let r=this.virtual(e);if(this.disabled(r.first))return r.nodes;let t=this.prefixer().add[r.first.prop];t&&t.process&&t.process(r.first,{warn:()=>null});for(let e of r.nodes){for(let t of this.prefixer().values("add",r.first.prop))t.process(e);Value.save(this.all,e)}return r.nodes}prefixer(){if(this.prefixerCache)return this.prefixerCache;let e=this.all.browsers.selected.filter(e=>supported.includes(e)),r=new Browsers(this.all.browsers.data,e,this.all.options);return this.prefixerCache=new this.Prefixes(this.all.data,r,this.all.options),this.prefixerCache}process(e){let r=brackets.parse(e.params);r=this.normalize(r),r=this.remove(r,e.params),r=this.add(r,e.params),r=this.cleanBrackets(r),e.params=brackets.stringify(r)}remove(e,r){let t=0;for(;t<e.length;)if(!this.isNot(e[t-1])&&this.isProp(e[t])&&this.isOr(e[t+1])){if(this.toRemove(e[t][0],r)){e.splice(t,2);continue}t+=2}else"object"==typeof e[t]&&(e[t]=this.remove(e[t],r)),t+=1;return e}toRemove(e,r){let[t,s]=this.parse(e),i=this.all.unprefixed(t),a=this.all.cleaner();if(a.remove[t]&&a.remove[t].remove&&!this.isHack(r,i))return!0;for(let e of a.values("remove",i))if(e.check(s))return!0;return!1}virtual(e){let[r,t]=this.parse(e),s=parse("a{}").first;return s.append({prop:r,raws:{before:""},value:t}),s}}module.exports=Supports;