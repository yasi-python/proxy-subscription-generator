let{list:list}=require("postcss"),parser=require("postcss-value-parser"),Browsers=require("./browsers"),vendor=require("./vendor");class Transition{constructor(e){this.props=["transition","transition-property"],this.prefixes=e}add(e,r){let t,i,s=this.prefixes.add[e.prop],o=this.ruleVendorPrefixes(e),n=o||s&&s.prefixes||[],l=this.parse(e.value),p=l.map(e=>this.findProp(e)),f=[];if(p.some(e=>"-"===e[0]))return;for(let e of l){if(i=this.findProp(e),"-"===i[0])continue;let r=this.prefixes.add[i];if(r&&r.prefixes)for(t of r.prefixes){if(o&&!o.some(e=>t.includes(e)))continue;let r=this.prefixes.prefixed(i,t);"-ms-transform"===r||p.includes(r)||this.disabled(i,t)||f.push(this.clone(i,r,e))}}l=l.concat(f);let a=this.stringify(l),u=this.stringify(this.cleanFromUnprefixed(l,"-webkit-"));if(n.includes("-webkit-")&&this.cloneBefore(e,`-webkit-${e.prop}`,u),this.cloneBefore(e,e.prop,u),n.includes("-o-")){let r=this.stringify(this.cleanFromUnprefixed(l,"-o-"));this.cloneBefore(e,`-o-${e.prop}`,r)}for(t of n)if("-webkit-"!==t&&"-o-"!==t){let r=this.stringify(this.cleanOtherPrefixes(l,t));this.cloneBefore(e,t+e.prop,r)}a===e.value||this.already(e,e.prop,a)||(this.checkForWarning(r,e),e.cloneBefore(),e.value=a)}already(e,r,t){return e.parent.some(e=>e.prop===r&&e.value===t)}checkForWarning(e,r){if("transition-property"!==r.prop)return;let t=!1,i=!1;r.parent.each(e=>{if("decl"!==e.type)return;if(0!==e.prop.indexOf("transition-"))return;let r=list.comma(e.value);if("transition-property"!==e.prop)return i=i||r.length>1,!1;r.forEach(e=>{let r=this.prefixes.add[e];r&&r.prefixes&&r.prefixes.length>0&&(t=!0)})}),t&&i&&r.warn(e,"Replace transition-property to transition, because Autoprefixer could not support any cases of transition-property and other transition-*")}cleanFromUnprefixed(e,r){let t=e.map(e=>this.findProp(e)).filter(e=>e.slice(0,r.length)===r).map(e=>this.prefixes.unprefixed(e)),i=[];for(let s of e){let e=this.findProp(s),o=vendor.prefix(e);t.includes(e)||o!==r&&""!==o||i.push(s)}return i}cleanOtherPrefixes(e,r){return e.filter(e=>{let t=vendor.prefix(this.findProp(e));return""===t||t===r})}clone(e,r,t){let i=[],s=!1;for(let o of t)s||"word"!==o.type||o.value!==e?i.push(o):(i.push({type:"word",value:r}),s=!0);return i}cloneBefore(e,r,t){this.already(e,r,t)||e.cloneBefore({prop:r,value:t})}disabled(e,r){if(e.includes("flex")||["order","justify-content","align-self","align-content"].includes(e)){if(!1===this.prefixes.options.flexbox)return!0;if("no-2009"===this.prefixes.options.flexbox)return r.includes("2009")}}div(e){for(let r of e)for(let e of r)if("div"===e.type&&","===e.value)return e;return{after:" ",type:"div",value:","}}findProp(e){let r=e[0].value;if(/^\d/.test(r))for(let[r,t]of e.entries())if(0!==r&&"word"===t.type)return t.value;return r}parse(e){let r=parser(e),t=[],i=[];for(let e of r.nodes)i.push(e),"div"===e.type&&","===e.value&&(t.push(i),i=[]);return t.push(i),t.filter(e=>e.length>0)}remove(e){let r=this.parse(e.value);r=r.filter(e=>{let r=this.prefixes.remove[this.findProp(e)];return!r||!r.remove});let t=this.stringify(r);if(e.value===t)return;if(0===r.length)return void e.remove();let i=e.parent.some(r=>r.prop===e.prop&&r.value===t),s=e.parent.some(r=>r!==e&&r.prop===e.prop&&r.value.length>t.length);i||s?e.remove():e.value=t}ruleVendorPrefixes(e){let{parent:r}=e;if("rule"!==r.type)return!1;if(!r.selector.includes(":-"))return!1;let t=Browsers.prefixes().filter(e=>r.selector.includes(":"+e));return t.length>0&&t}stringify(e){if(0===e.length)return"";let r=[];for(let t of e)"div"!==t[t.length-1].type&&t.push(this.div(e)),r=r.concat(t);return"div"===r[0].type&&(r=r.slice(1)),"div"===r[r.length-1].type&&(r=r.slice(0,-1)),parser.stringify({nodes:r})}}module.exports=Transition;