let AtRule=require("./at-rule"),Browsers=require("./browsers"),Declaration=require("./declaration"),hackAlignContent=require("./hacks/align-content"),hackAlignItems=require("./hacks/align-items"),hackAlignSelf=require("./hacks/align-self"),hackAnimation=require("./hacks/animation"),hackAppearance=require("./hacks/appearance"),hackAutofill=require("./hacks/autofill"),hackBackdropFilter=require("./hacks/backdrop-filter"),hackBackgroundClip=require("./hacks/background-clip"),hackBackgroundSize=require("./hacks/background-size"),hackBlockLogical=require("./hacks/block-logical"),hackBorderImage=require("./hacks/border-image"),hackBorderRadius=require("./hacks/border-radius"),hackBreakProps=require("./hacks/break-props"),hackCrossFade=require("./hacks/cross-fade"),hackDisplayFlex=require("./hacks/display-flex"),hackDisplayGrid=require("./hacks/display-grid"),hackFileSelectorButton=require("./hacks/file-selector-button"),hackFilter=require("./hacks/filter"),hackFilterValue=require("./hacks/filter-value"),hackFlex=require("./hacks/flex"),hackFlexBasis=require("./hacks/flex-basis"),hackFlexDirection=require("./hacks/flex-direction"),hackFlexFlow=require("./hacks/flex-flow"),hackFlexGrow=require("./hacks/flex-grow"),hackFlexShrink=require("./hacks/flex-shrink"),hackFlexWrap=require("./hacks/flex-wrap"),hackFullscreen=require("./hacks/fullscreen"),hackGradient=require("./hacks/gradient"),hackGridArea=require("./hacks/grid-area"),hackGridColumnAlign=require("./hacks/grid-column-align"),hackGridEnd=require("./hacks/grid-end"),hackGridRowAlign=require("./hacks/grid-row-align"),hackGridRowColumn=require("./hacks/grid-row-column"),hackGridRowsColumns=require("./hacks/grid-rows-columns"),hackGridStart=require("./hacks/grid-start"),hackGridTemplate=require("./hacks/grid-template"),hackGridTemplateAreas=require("./hacks/grid-template-areas"),hackImageRendering=require("./hacks/image-rendering"),hackImageSet=require("./hacks/image-set"),hackInlineLogical=require("./hacks/inline-logical"),hackIntrinsic=require("./hacks/intrinsic"),hackJustifyContent=require("./hacks/justify-content"),hackMaskBorder=require("./hacks/mask-border"),hackMaskComposite=require("./hacks/mask-composite"),hackOrder=require("./hacks/order"),hackOverscrollBehavior=require("./hacks/overscroll-behavior"),hackPixelated=require("./hacks/pixelated"),hackPlaceSelf=require("./hacks/place-self"),hackPlaceholder=require("./hacks/placeholder"),hackPlaceholderShown=require("./hacks/placeholder-shown"),hackPrintColorAdjust=require("./hacks/print-color-adjust"),hackTextDecoration=require("./hacks/text-decoration"),hackTextDecorationSkipInk=require("./hacks/text-decoration-skip-ink"),hackTextEmphasisPosition=require("./hacks/text-emphasis-position"),hackTransformDecl=require("./hacks/transform-decl"),hackUserSelect=require("./hacks/user-select"),hackWritingMode=require("./hacks/writing-mode"),Processor=require("./processor"),Resolution=require("./resolution"),Selector=require("./selector"),Supports=require("./supports"),Transition=require("./transition"),utils=require("./utils"),Value=require("./value"),vendor=require("./vendor");Selector.hack(hackAutofill),Selector.hack(hackFullscreen),Selector.hack(hackPlaceholder),Selector.hack(hackPlaceholderShown),Selector.hack(hackFileSelectorButton),Declaration.hack(hackFlex),Declaration.hack(hackOrder),Declaration.hack(hackFilter),Declaration.hack(hackGridEnd),Declaration.hack(hackAnimation),Declaration.hack(hackFlexFlow),Declaration.hack(hackFlexGrow),Declaration.hack(hackFlexWrap),Declaration.hack(hackGridArea),Declaration.hack(hackPlaceSelf),Declaration.hack(hackGridStart),Declaration.hack(hackAlignSelf),Declaration.hack(hackAppearance),Declaration.hack(hackFlexBasis),Declaration.hack(hackMaskBorder),Declaration.hack(hackMaskComposite),Declaration.hack(hackAlignItems),Declaration.hack(hackUserSelect),Declaration.hack(hackFlexShrink),Declaration.hack(hackBreakProps),Declaration.hack(hackWritingMode),Declaration.hack(hackBorderImage),Declaration.hack(hackAlignContent),Declaration.hack(hackBorderRadius),Declaration.hack(hackBlockLogical),Declaration.hack(hackGridTemplate),Declaration.hack(hackInlineLogical),Declaration.hack(hackGridRowAlign),Declaration.hack(hackTransformDecl),Declaration.hack(hackFlexDirection),Declaration.hack(hackImageRendering),Declaration.hack(hackBackdropFilter),Declaration.hack(hackBackgroundClip),Declaration.hack(hackTextDecoration),Declaration.hack(hackJustifyContent),Declaration.hack(hackBackgroundSize),Declaration.hack(hackGridRowColumn),Declaration.hack(hackGridRowsColumns),Declaration.hack(hackGridColumnAlign),Declaration.hack(hackOverscrollBehavior),Declaration.hack(hackGridTemplateAreas),Declaration.hack(hackPrintColorAdjust),Declaration.hack(hackTextEmphasisPosition),Declaration.hack(hackTextDecorationSkipInk),Value.hack(hackGradient),Value.hack(hackIntrinsic),Value.hack(hackPixelated),Value.hack(hackImageSet),Value.hack(hackCrossFade),Value.hack(hackDisplayFlex),Value.hack(hackDisplayGrid),Value.hack(hackFilterValue);let declsCache=new Map;class Prefixes{constructor(e,a,r={}){this.data=e,this.browsers=a,this.options=r,[this.add,this.remove]=this.preprocess(this.select(this.data)),this.transition=new Transition(this),this.processor=new Processor(this)}cleaner(){if(this.cleanerCache)return this.cleanerCache;if(!this.browsers.selected.length)return this;{let e=new Browsers(this.browsers.data,[]);this.cleanerCache=new Prefixes(this.data,e,this.options)}return this.cleanerCache}decl(e){return declsCache.has(e)||declsCache.set(e,Declaration.load(e)),declsCache.get(e)}group(e){let a=e.parent,r=a.index(e),{length:i}=a.nodes,c=this.unprefixed(e.prop),t=(e,t)=>{for(r+=e;r>=0&&r<i;){let i=a.nodes[r];if("decl"===i.type){if(-1===e&&i.prop===c&&!Browsers.withPrefix(i.value))break;if(this.unprefixed(i.prop)!==c)break;if(!0===t(i))return!0;if(1===e&&i.prop===c&&!Browsers.withPrefix(i.value))break}r+=e}return!1};return{down:e=>t(1,e),up:e=>t(-1,e)}}normalize(e){return this.decl(e).normalize(e)}prefixed(e,a){return e=vendor.unprefixed(e),this.decl(e).prefixed(e,a)}preprocess(e){let a={"@supports":new Supports(Prefixes,this),selectors:[]};for(let r in e.add){let i=e.add[r];if("@keyframes"===r||"@viewport"===r)a[r]=new AtRule(r,i,this);else if("@resolution"===r)a[r]=new Resolution(r,i,this);else if(this.data[r].selector)a.selectors.push(Selector.load(r,i,this));else{let e=this.data[r].props;if(e){let c=Value.load(r,i,this);for(let r of e)a[r]||(a[r]={values:[]}),a[r].values.push(c)}else{let e=a[r]&&a[r].values||[];a[r]=Declaration.load(r,i,this),a[r].values=e}}}let r={selectors:[]};for(let i in e.remove){let c=e.remove[i];if(this.data[i].selector){let e=Selector.load(i,c);for(let a of c)r.selectors.push(e.old(a))}else if("@keyframes"===i||"@viewport"===i)for(let e of c)r[`@${e}${i.slice(1)}`]={remove:!0};else if("@resolution"===i)r[i]=new Resolution(i,c,this);else{let e=this.data[i].props;if(e){let a=Value.load(i,[],this);for(let i of c){let c=a.old(i);if(c)for(let a of e)r[a]||(r[a]={}),r[a].values||(r[a].values=[]),r[a].values.push(c)}}else for(let e of c){let c=this.decl(i).old(i,e);if("align-self"===i){let r=a[i]&&a[i].prefixes;if(r){if("-webkit- 2009"===e&&r.includes("-webkit-"))continue;if("-webkit-"===e&&r.includes("-webkit- 2009"))continue}}for(let e of c)r[e]||(r[e]={}),r[e].remove=!0}}}return[a,r]}select(e){let a={add:{},remove:{}};for(let r in e){let i=e[r],c=i.browsers.map(e=>{let a=e.split(" ");return{browser:`${a[0]} ${a[1]}`,note:a[2]}}),t=c.filter(e=>e.note).map(e=>`${this.browsers.prefix(e.browser)} ${e.note}`);t=utils.uniq(t),c=c.filter(e=>this.browsers.isSelected(e.browser)).map(e=>{let a=this.browsers.prefix(e.browser);return e.note?`${a} ${e.note}`:a}),c=this.sort(utils.uniq(c)),"no-2009"===this.options.flexbox&&(c=c.filter(e=>!e.includes("2009")));let l=i.browsers.map(e=>this.browsers.prefix(e));i.mistakes&&(l=l.concat(i.mistakes)),l=l.concat(t),l=utils.uniq(l),c.length?(a.add[r]=c,c.length<l.length&&(a.remove[r]=l.filter(e=>!c.includes(e)))):a.remove[r]=l}return a}sort(e){return e.sort((e,a)=>{let r=utils.removeNote(e).length,i=utils.removeNote(a).length;return r===i?a.length-e.length:i-r})}unprefixed(e){let a=this.normalize(vendor.unprefixed(e));return"flex-direction"===a&&(a="flex-flow"),a}values(e,a){let r=this[e],i=r["*"]&&r["*"].values,c=r[a]&&r[a].values;return i&&c?utils.uniq(i.concat(c)):i||c||[]}}module.exports=Prefixes;