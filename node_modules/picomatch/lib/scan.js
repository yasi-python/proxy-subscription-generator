"use strict";const utils=require("./utils"),{CHAR_ASTERISK:CHAR_ASTERISK,CHAR_AT:CHAR_AT,CHAR_BACKWARD_SLASH:CHAR_BACKWARD_SLASH,CHAR_COMMA:CHAR_COMMA,CHAR_DOT:CHAR_DOT,CHAR_EXCLAMATION_MARK:CHAR_EXCLAMATION_MARK,CHAR_FORWARD_SLASH:CHAR_FORWARD_SLASH,CHAR_LEFT_CURLY_BRACE:CHAR_LEFT_CURLY_BRACE,CHAR_LEFT_PARENTHESES:CHAR_LEFT_PARENTHESES,CHAR_LEFT_SQUARE_BRACKET:CHAR_LEFT_SQUARE_BRACKET,CHAR_PLUS:CHAR_PLUS,CHAR_QUESTION_MARK:CHAR_QUESTION_MARK,CHAR_RIGHT_CURLY_BRACE:CHAR_RIGHT_CURLY_BRACE,CHAR_RIGHT_PARENTHESES:CHAR_RIGHT_PARENTHESES,CHAR_RIGHT_SQUARE_BRACKET:CHAR_RIGHT_SQUARE_BRACKET}=require("./constants"),isPathSeparator=A=>A===CHAR_FORWARD_SLASH||A===CHAR_BACKWARD_SLASH,depth=A=>{!0!==A.isPrefix&&(A.depth=A.isGlobstar?1/0:1)},scan=(A,R)=>{const e=R||{},_=A.length-1,s=!0===e.parts||!0===e.scanToEnd,C=[],H=[],i=[];let t,E,a=A,S=-1,l=0,o=0,T=!1,n=!1,r=!1,c=!1,f=!1,L=!1,b=!1,h=!1,u=!1,B=!1,k=0,p={value:"",depth:0,isGlob:!1};const K=()=>S>=_,G=()=>a.charCodeAt(S+1),I=()=>(t=E,a.charCodeAt(++S));for(;S<_;){let A;if(E=I(),E!==CHAR_BACKWARD_SLASH){if(!0===L||E===CHAR_LEFT_CURLY_BRACE){for(k++;!0!==K()&&(E=I());)if(E!==CHAR_BACKWARD_SLASH)if(E!==CHAR_LEFT_CURLY_BRACE){if(!0!==L&&E===CHAR_DOT&&(E=I())===CHAR_DOT){if(T=p.isBrace=!0,r=p.isGlob=!0,B=!0,!0===s)continue;break}if(!0!==L&&E===CHAR_COMMA){if(T=p.isBrace=!0,r=p.isGlob=!0,B=!0,!0===s)continue;break}if(E===CHAR_RIGHT_CURLY_BRACE&&(k--,0===k)){L=!1,T=p.isBrace=!0,B=!0;break}}else k++;else b=p.backslashes=!0,I();if(!0===s)continue;break}if(E!==CHAR_FORWARD_SLASH){if(!0!==e.noext&&1==(E===CHAR_PLUS||E===CHAR_AT||E===CHAR_ASTERISK||E===CHAR_QUESTION_MARK||E===CHAR_EXCLAMATION_MARK)&&G()===CHAR_LEFT_PARENTHESES){if(r=p.isGlob=!0,c=p.isExtglob=!0,B=!0,E===CHAR_EXCLAMATION_MARK&&S===l&&(u=!0),!0===s){for(;!0!==K()&&(E=I());)if(E!==CHAR_BACKWARD_SLASH){if(E===CHAR_RIGHT_PARENTHESES){r=p.isGlob=!0,B=!0;break}}else b=p.backslashes=!0,E=I();continue}break}if(E===CHAR_ASTERISK){if(t===CHAR_ASTERISK&&(f=p.isGlobstar=!0),r=p.isGlob=!0,B=!0,!0===s)continue;break}if(E===CHAR_QUESTION_MARK){if(r=p.isGlob=!0,B=!0,!0===s)continue;break}if(E===CHAR_LEFT_SQUARE_BRACKET){for(;!0!==K()&&(A=I());)if(A!==CHAR_BACKWARD_SLASH){if(A===CHAR_RIGHT_SQUARE_BRACKET){n=p.isBracket=!0,r=p.isGlob=!0,B=!0;break}}else b=p.backslashes=!0,I();if(!0===s)continue;break}if(!0===e.nonegate||E!==CHAR_EXCLAMATION_MARK||S!==l){if(!0!==e.noparen&&E===CHAR_LEFT_PARENTHESES){if(r=p.isGlob=!0,!0===s){for(;!0!==K()&&(E=I());)if(E!==CHAR_LEFT_PARENTHESES){if(E===CHAR_RIGHT_PARENTHESES){B=!0;break}}else b=p.backslashes=!0,E=I();continue}break}if(!0===r){if(B=!0,!0===s)continue;break}}else h=p.negated=!0,l++}else{if(C.push(S),H.push(p),p={value:"",depth:0,isGlob:!1},!0===B)continue;if(t===CHAR_DOT&&S===l+1){l+=2;continue}o=S+1}}else b=p.backslashes=!0,E=I(),E===CHAR_LEFT_CURLY_BRACE&&(L=!0)}!0===e.noext&&(c=!1,r=!1);let O=a,U="",M="";l>0&&(U=a.slice(0,l),a=a.slice(l),o-=l),O&&!0===r&&o>0?(O=a.slice(0,o),M=a.slice(o)):!0===r?(O="",M=a):O=a,O&&""!==O&&"/"!==O&&O!==a&&isPathSeparator(O.charCodeAt(O.length-1))&&(O=O.slice(0,-1)),!0===e.unescape&&(M&&(M=utils.removeBackslashes(M)),O&&!0===b&&(O=utils.removeBackslashes(O)));const D={prefix:U,input:A,start:l,base:O,glob:M,isBrace:T,isBracket:n,isGlob:r,isExtglob:c,isGlobstar:f,negated:h,negatedExtglob:u};if(!0===e.tokens&&(D.maxDepth=0,isPathSeparator(E)||H.push(p),D.tokens=H),!0===e.parts||!0===e.tokens){let R;for(let _=0;_<C.length;_++){const s=R?R+1:l,t=C[_],E=A.slice(s,t);e.tokens&&(0===_&&0!==l?(H[_].isPrefix=!0,H[_].value=U):H[_].value=E,depth(H[_]),D.maxDepth+=H[_].depth),0===_&&""===E||i.push(E),R=t}if(R&&R+1<A.length){const _=A.slice(R+1);i.push(_),e.tokens&&(H[H.length-1].value=_,depth(H[H.length-1]),D.maxDepth+=H[H.length-1].depth)}D.slashes=C,D.parts=i}return D};module.exports=scan;