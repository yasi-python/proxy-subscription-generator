"use strict";const constants=require("./constants"),utils=require("./utils"),{MAX_LENGTH:MAX_LENGTH,POSIX_REGEX_SOURCE:POSIX_REGEX_SOURCE,REGEX_NON_SPECIAL_CHARS:REGEX_NON_SPECIAL_CHARS,REGEX_SPECIAL_CHARS_BACKREF:REGEX_SPECIAL_CHARS_BACKREF,REPLACEMENTS:REPLACEMENTS}=constants,expandRange=(t,e)=>{if("function"==typeof e.expandRange)return e.expandRange(...t,e);t.sort();const u=`[${t.join("-")}]`;try{new RegExp(u)}catch(e){return t.map(t=>utils.escapeRegex(t)).join("..")}return u},syntaxError=(t,e)=>`Missing ${t}: "${e}" - use "\\\\${e}" to match literal characters`,parse=(t,e)=>{if("string"!=typeof t)throw new TypeError("Expected a string");t=REPLACEMENTS[t]||t;const u={...e},o="number"==typeof u.maxLength?Math.min(MAX_LENGTH,u.maxLength):MAX_LENGTH;let n=t.length;if(n>o)throw new SyntaxError(`Input length: ${n}, exceeds maximum allowed length: ${o}`);const a={type:"bos",value:"",output:u.prepend||""},s=[a],p=u.capture?"":"?:",r=utils.isWindows(e),l=constants.globChars(r),i=constants.extglobChars(l),{DOT_LITERAL:c,PLUS_LITERAL:y,SLASH_LITERAL:f,ONE_CHAR:g,DOTS_SLASH:x,NO_DOT:v,NO_DOT_SLASH:h,NO_DOTS_SLASH:b,QMARK:$,QMARK_NO_DOT:d,STAR:E,START_ANCHOR:S}=l,_=t=>`(${p}(?:(?!${S}${t.dot?x:c}).)*?)`,R=u.dot?"":v,k=u.dot?$:d;let A=!0===u.bash?_(u):E;u.capture&&(A=`(${A})`),"boolean"==typeof u.noext&&(u.noextglob=u.noext);const L={input:t,index:-1,start:0,dot:!0===u.dot,consumed:"",output:"",prefix:"",backtrack:!1,negated:!1,brackets:0,braces:0,parens:0,quotes:0,globstar:!1,tokens:s};t=utils.removePrefix(t,L),n=t.length;const m=[],O=[],T=[];let C,w=a;const N=()=>L.index===n-1,H=L.peek=(e=1)=>t[L.index+e],I=L.advance=()=>t[++L.index]||"",X=()=>t.slice(L.index+1),P=(t="",e=0)=>{L.consumed+=t,L.index+=e},G=t=>{L.output+=null!=t.output?t.output:t.value,P(t.value)},M=()=>{let t=1;for(;"!"===H()&&("("!==H(2)||"?"===H(3));)I(),L.start++,t++;return t%2!=0&&(L.negated=!0,L.start++,!0)},B=t=>{L[t]++,T.push(t)},D=t=>{L[t]--,T.pop()},q=t=>{if("globstar"===w.type){const e=L.braces>0&&("comma"===t.type||"brace"===t.type),u=!0===t.extglob||m.length&&("pipe"===t.type||"paren"===t.type);"slash"===t.type||"paren"===t.type||e||u||(L.output=L.output.slice(0,-w.output.length),w.type="star",w.value="*",w.output=A,L.output+=w.output)}if(m.length&&"paren"!==t.type&&(m[m.length-1].inner+=t.value),(t.value||t.output)&&G(t),w&&"text"===w.type&&"text"===t.type)return w.value+=t.value,void(w.output=(w.output||"")+t.value);t.prev=w,s.push(t),w=t},K=(t,e)=>{const o={...i[e],conditions:1,inner:""};o.prev=w,o.parens=L.parens,o.output=L.output;const n=(u.capture?"(":"")+o.open;B("parens"),q({type:t,value:e,output:L.output?"":g}),q({type:"paren",extglob:!0,value:I(),output:n}),m.push(o)},U=t=>{let o,n=t.close+(u.capture?")":"");if("negate"===t.type){let a=A;if(t.inner&&t.inner.length>1&&t.inner.includes("/")&&(a=_(u)),(a!==A||N()||/^\)+$/.test(X()))&&(n=t.close=`)$))${a}`),t.inner.includes("*")&&(o=X())&&/^\.[^\\/.]+$/.test(o)){const u=parse(o,{...e,fastpaths:!1}).output;n=t.close=`)${u})${a})`}"bos"===t.prev.type&&(L.negatedExtglob=!0)}q({type:"paren",extglob:!0,value:C,output:n}),D("parens")};if(!1!==u.fastpaths&&!/(^[*!]|[/()[\]{}"])/.test(t)){let o=!1,n=t.replace(REGEX_SPECIAL_CHARS_BACKREF,(t,e,u,n,a,s)=>"\\"===n?(o=!0,t):"?"===n?e?e+n+(a?$.repeat(a.length):""):0===s?k+(a?$.repeat(a.length):""):$.repeat(u.length):"."===n?c.repeat(u.length):"*"===n?e?e+n+(a?A:""):A:e?t:`\\${t}`);return!0===o&&(n=!0===u.unescape?n.replace(/\\/g,""):n.replace(/\\+/g,t=>t.length%2==0?"\\\\":t?"\\":"")),n===t&&!0===u.contains?(L.output=t,L):(L.output=utils.wrapOutput(n,L,e),L)}for(;!N();){if(C=I(),"\0"===C)continue;if("\\"===C){const t=H();if("/"===t&&!0!==u.bash)continue;if("."===t||";"===t)continue;if(!t){C+="\\",q({type:"text",value:C});continue}const e=/^\\+/.exec(X());let o=0;if(e&&e[0].length>2&&(o=e[0].length,L.index+=o,o%2!=0&&(C+="\\")),!0===u.unescape?C=I():C+=I(),0===L.brackets){q({type:"text",value:C});continue}}if(L.brackets>0&&("]"!==C||"["===w.value||"[^"===w.value)){if(!1!==u.posix&&":"===C){const t=w.value.slice(1);if(t.includes("[")&&(w.posix=!0,t.includes(":"))){const t=w.value.lastIndexOf("["),e=w.value.slice(0,t),u=w.value.slice(t+2),o=POSIX_REGEX_SOURCE[u];if(o){w.value=e+o,L.backtrack=!0,I(),a.output||1!==s.indexOf(w)||(a.output=g);continue}}}("["===C&&":"!==H()||"-"===C&&"]"===H())&&(C=`\\${C}`),"]"!==C||"["!==w.value&&"[^"!==w.value||(C=`\\${C}`),!0===u.posix&&"!"===C&&"["===w.value&&(C="^"),w.value+=C,G({value:C});continue}if(1===L.quotes&&'"'!==C){C=utils.escapeRegex(C),w.value+=C,G({value:C});continue}if('"'===C){L.quotes=1===L.quotes?0:1,!0===u.keepQuotes&&q({type:"text",value:C});continue}if("("===C){B("parens"),q({type:"paren",value:C});continue}if(")"===C){if(0===L.parens&&!0===u.strictBrackets)throw new SyntaxError(syntaxError("opening","("));const t=m[m.length-1];if(t&&L.parens===t.parens+1){U(m.pop());continue}q({type:"paren",value:C,output:L.parens?")":"\\)"}),D("parens");continue}if("["===C){if(!0!==u.nobracket&&X().includes("]"))B("brackets");else{if(!0!==u.nobracket&&!0===u.strictBrackets)throw new SyntaxError(syntaxError("closing","]"));C=`\\${C}`}q({type:"bracket",value:C});continue}if("]"===C){if(!0===u.nobracket||w&&"bracket"===w.type&&1===w.value.length){q({type:"text",value:C,output:`\\${C}`});continue}if(0===L.brackets){if(!0===u.strictBrackets)throw new SyntaxError(syntaxError("opening","["));q({type:"text",value:C,output:`\\${C}`});continue}D("brackets");const t=w.value.slice(1);if(!0===w.posix||"^"!==t[0]||t.includes("/")||(C=`/${C}`),w.value+=C,G({value:C}),!1===u.literalBrackets||utils.hasRegexChars(t))continue;const e=utils.escapeRegex(w.value);if(L.output=L.output.slice(0,-w.value.length),!0===u.literalBrackets){L.output+=e,w.value=e;continue}w.value=`(${p}${e}|${w.value})`,L.output+=w.value;continue}if("{"===C&&!0!==u.nobrace){B("braces");const t={type:"brace",value:C,output:"(",outputIndex:L.output.length,tokensIndex:L.tokens.length};O.push(t),q(t);continue}if("}"===C){const t=O[O.length-1];if(!0===u.nobrace||!t){q({type:"text",value:C,output:C});continue}let e=")";if(!0===t.dots){const t=s.slice(),o=[];for(let e=t.length-1;e>=0&&(s.pop(),"brace"!==t[e].type);e--)"dots"!==t[e].type&&o.unshift(t[e].value);e=expandRange(o,u),L.backtrack=!0}if(!0!==t.comma&&!0!==t.dots){const u=L.output.slice(0,t.outputIndex),o=L.tokens.slice(t.tokensIndex);t.value=t.output="\\{",C=e="\\}",L.output=u;for(const t of o)L.output+=t.output||t.value}q({type:"brace",value:C,output:e}),D("braces"),O.pop();continue}if("|"===C){m.length>0&&m[m.length-1].conditions++,q({type:"text",value:C});continue}if(","===C){let t=C;const e=O[O.length-1];e&&"braces"===T[T.length-1]&&(e.comma=!0,t="|"),q({type:"comma",value:C,output:t});continue}if("/"===C){if("dot"===w.type&&L.index===L.start+1){L.start=L.index+1,L.consumed="",L.output="",s.pop(),w=a;continue}q({type:"slash",value:C,output:f});continue}if("."===C){if(L.braces>0&&"dot"===w.type){"."===w.value&&(w.output=c);const t=O[O.length-1];w.type="dots",w.output+=C,w.value+=C,t.dots=!0;continue}if(L.braces+L.parens===0&&"bos"!==w.type&&"slash"!==w.type){q({type:"text",value:C,output:c});continue}q({type:"dot",value:C,output:c});continue}if("?"===C){if((!w||"("!==w.value)&&!0!==u.noextglob&&"("===H()&&"?"!==H(2)){K("qmark",C);continue}if(w&&"paren"===w.type){const t=H();let e=C;if("<"===t&&!utils.supportsLookbehinds())throw new Error("Node.js v10 or higher is required for regex lookbehinds");("("===w.value&&!/[!=<:]/.test(t)||"<"===t&&!/<([!=]|\w+>)/.test(X()))&&(e=`\\${C}`),q({type:"text",value:C,output:e});continue}if(!0!==u.dot&&("slash"===w.type||"bos"===w.type)){q({type:"qmark",value:C,output:d});continue}q({type:"qmark",value:C,output:$});continue}if("!"===C){if(!0!==u.noextglob&&"("===H()&&("?"!==H(2)||!/[!=<:]/.test(H(3)))){K("negate",C);continue}if(!0!==u.nonegate&&0===L.index){M();continue}}if("+"===C){if(!0!==u.noextglob&&"("===H()&&"?"!==H(2)){K("plus",C);continue}if(w&&"("===w.value||!1===u.regex){q({type:"plus",value:C,output:y});continue}if(w&&("bracket"===w.type||"paren"===w.type||"brace"===w.type)||L.parens>0){q({type:"plus",value:C});continue}q({type:"plus",value:y});continue}if("@"===C){if(!0!==u.noextglob&&"("===H()&&"?"!==H(2)){q({type:"at",extglob:!0,value:C,output:""});continue}q({type:"text",value:C});continue}if("*"!==C){"$"!==C&&"^"!==C||(C=`\\${C}`);const t=REGEX_NON_SPECIAL_CHARS.exec(X());t&&(C+=t[0],L.index+=t[0].length),q({type:"text",value:C});continue}if(w&&("globstar"===w.type||!0===w.star)){w.type="star",w.star=!0,w.value+=C,w.output=A,L.backtrack=!0,L.globstar=!0,P(C);continue}let e=X();if(!0!==u.noextglob&&/^\([^?]/.test(e)){K("star",C);continue}if("star"===w.type){if(!0===u.noglobstar){P(C);continue}const o=w.prev,n=o.prev,a="slash"===o.type||"bos"===o.type,s=n&&("star"===n.type||"globstar"===n.type);if(!0===u.bash&&(!a||e[0]&&"/"!==e[0])){q({type:"star",value:C,output:""});continue}const p=L.braces>0&&("comma"===o.type||"brace"===o.type),r=m.length&&("pipe"===o.type||"paren"===o.type);if(!a&&"paren"!==o.type&&!p&&!r){q({type:"star",value:C,output:""});continue}for(;"/**"===e.slice(0,3);){const u=t[L.index+4];if(u&&"/"!==u)break;e=e.slice(3),P("/**",3)}if("bos"===o.type&&N()){w.type="globstar",w.value+=C,w.output=_(u),L.output=w.output,L.globstar=!0,P(C);continue}if("slash"===o.type&&"bos"!==o.prev.type&&!s&&N()){L.output=L.output.slice(0,-(o.output+w.output).length),o.output=`(?:${o.output}`,w.type="globstar",w.output=_(u)+(u.strictSlashes?")":"|$)"),w.value+=C,L.globstar=!0,L.output+=o.output+w.output,P(C);continue}if("slash"===o.type&&"bos"!==o.prev.type&&"/"===e[0]){const t=void 0!==e[1]?"|$":"";L.output=L.output.slice(0,-(o.output+w.output).length),o.output=`(?:${o.output}`,w.type="globstar",w.output=`${_(u)}${f}|${f}${t})`,w.value+=C,L.output+=o.output+w.output,L.globstar=!0,P(C+I()),q({type:"slash",value:"/",output:""});continue}if("bos"===o.type&&"/"===e[0]){w.type="globstar",w.value+=C,w.output=`(?:^|${f}|${_(u)}${f})`,L.output=w.output,L.globstar=!0,P(C+I()),q({type:"slash",value:"/",output:""});continue}L.output=L.output.slice(0,-w.output.length),w.type="globstar",w.output=_(u),w.value+=C,L.output+=w.output,L.globstar=!0,P(C);continue}const o={type:"star",value:C,output:A};!0!==u.bash?!w||"bracket"!==w.type&&"paren"!==w.type||!0!==u.regex?(L.index!==L.start&&"slash"!==w.type&&"dot"!==w.type||("dot"===w.type?(L.output+=h,w.output+=h):!0===u.dot?(L.output+=b,w.output+=b):(L.output+=R,w.output+=R),"*"!==H()&&(L.output+=g,w.output+=g)),q(o)):(o.output=C,q(o)):(o.output=".*?","bos"!==w.type&&"slash"!==w.type||(o.output=R+o.output),q(o))}for(;L.brackets>0;){if(!0===u.strictBrackets)throw new SyntaxError(syntaxError("closing","]"));L.output=utils.escapeLast(L.output,"["),D("brackets")}for(;L.parens>0;){if(!0===u.strictBrackets)throw new SyntaxError(syntaxError("closing",")"));L.output=utils.escapeLast(L.output,"("),D("parens")}for(;L.braces>0;){if(!0===u.strictBrackets)throw new SyntaxError(syntaxError("closing","}"));L.output=utils.escapeLast(L.output,"{"),D("braces")}if(!0===u.strictSlashes||"star"!==w.type&&"bracket"!==w.type||q({type:"maybe_slash",value:"",output:`${f}?`}),!0===L.backtrack){L.output="";for(const t of L.tokens)L.output+=null!=t.output?t.output:t.value,t.suffix&&(L.output+=t.suffix)}return L};parse.fastpaths=(t,e)=>{const u={...e},o="number"==typeof u.maxLength?Math.min(MAX_LENGTH,u.maxLength):MAX_LENGTH,n=t.length;if(n>o)throw new SyntaxError(`Input length: ${n}, exceeds maximum allowed length: ${o}`);t=REPLACEMENTS[t]||t;const a=utils.isWindows(e),{DOT_LITERAL:s,SLASH_LITERAL:p,ONE_CHAR:r,DOTS_SLASH:l,NO_DOT:i,NO_DOTS:c,NO_DOTS_SLASH:y,STAR:f,START_ANCHOR:g}=constants.globChars(a),x=u.dot?c:i,v=u.dot?y:i,h=u.capture?"":"?:";let b=!0===u.bash?".*?":f;u.capture&&(b=`(${b})`);const $=t=>!0===t.noglobstar?b:`(${h}(?:(?!${g}${t.dot?l:s}).)*?)`,d=t=>{switch(t){case"*":return`${x}${r}${b}`;case".*":return`${s}${r}${b}`;case"*.*":return`${x}${b}${s}${r}${b}`;case"*/*":return`${x}${b}${p}${r}${v}${b}`;case"**":return x+$(u);case"**/*":return`(?:${x}${$(u)}${p})?${v}${r}${b}`;case"**/*.*":return`(?:${x}${$(u)}${p})?${v}${b}${s}${r}${b}`;case"**/.*":return`(?:${x}${$(u)}${p})?${s}${r}${b}`;default:{const e=/^(.*?)\.(\w+)$/.exec(t);if(!e)return;const u=d(e[1]);if(!u)return;return u+s+e[2]}}},E=utils.removePrefix(t,{negated:!1,prefix:""});let S=d(E);return S&&!0!==u.strictSlashes&&(S+=`${p}?`),S},module.exports=parse;