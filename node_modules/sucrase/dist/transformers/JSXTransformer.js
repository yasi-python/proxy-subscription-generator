"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _xhtml=require("../parser/plugins/jsx/xhtml"),_xhtml2=_interopRequireDefault(_xhtml),_tokenizer=require("../parser/tokenizer"),_types=require("../parser/tokenizer/types"),_charcodes=require("../parser/util/charcodes"),_getJSXPragmaInfo=require("../util/getJSXPragmaInfo"),_getJSXPragmaInfo2=_interopRequireDefault(_getJSXPragmaInfo),_Transformer=require("./Transformer"),_Transformer2=_interopRequireDefault(_Transformer);class JSXTransformer extends _Transformer2.default{__init(){this.lastLineNumber=1}__init2(){this.lastIndex=0}__init3(){this.filenameVarName=null}__init4(){this.esmAutomaticImportNameResolutions={}}__init5(){this.cjsAutomaticModuleNameResolutions={}}constructor(e,t,s,o,n){super(),this.rootTransformer=e,this.tokens=t,this.importProcessor=s,this.nameManager=o,this.options=n,JSXTransformer.prototype.__init.call(this),JSXTransformer.prototype.__init2.call(this),JSXTransformer.prototype.__init3.call(this),JSXTransformer.prototype.__init4.call(this),JSXTransformer.prototype.__init5.call(this),this.jsxPragmaInfo=_getJSXPragmaInfo2.default.call(void 0,n),this.isAutomaticRuntime="automatic"===n.jsxRuntime,this.jsxImportSource=n.jsxImportSource||"react"}process(){return!!this.tokens.matches1(_types.TokenType.jsxTagStart)&&(this.processJSXTag(),!0)}getPrefixCode(){let e="";if(this.filenameVarName&&(e+=`const ${this.filenameVarName} = ${JSON.stringify(this.options.filePath||"")};`),this.isAutomaticRuntime)if(this.importProcessor)for(const[t,s]of Object.entries(this.cjsAutomaticModuleNameResolutions))e+=`var ${s} = require("${t}");`;else{const{createElement:t,...s}=this.esmAutomaticImportNameResolutions;t&&(e+=`import {createElement as ${t}} from "${this.jsxImportSource}";`);const o=Object.entries(s).map(([e,t])=>`${e} as ${t}`).join(", ");if(o){e+=`import {${o}} from "${this.jsxImportSource+(this.options.production?"/jsx-runtime":"/jsx-dev-runtime")}";`}}return e}processJSXTag(){const{jsxRole:e,start:t}=this.tokens.currentToken(),s=this.options.production?null:this.getElementLocationCode(t);this.isAutomaticRuntime&&e!==_tokenizer.JSXRole.KeyAfterPropSpread?this.transformTagToJSXFunc(s,e):this.transformTagToCreateElement(s)}getElementLocationCode(e){return`lineNumber: ${this.getLineNumberForIndex(e)}`}getLineNumberForIndex(e){const t=this.tokens.code;for(;this.lastIndex<e&&this.lastIndex<t.length;)"\n"===t[this.lastIndex]&&this.lastLineNumber++,this.lastIndex++;return this.lastLineNumber}transformTagToJSXFunc(e,t){const s=t===_tokenizer.JSXRole.StaticChildren;this.tokens.replaceToken(this.getJSXFuncInvocationCode(s));let o=null;if(this.tokens.matches1(_types.TokenType.jsxTagEnd))this.tokens.replaceToken(`${this.getFragmentCode()}, {`),this.processAutomaticChildrenAndEndProps(t);else{if(this.processTagIntro(),this.tokens.appendCode(", {"),o=this.processProps(!0),this.tokens.matches2(_types.TokenType.slash,_types.TokenType.jsxTagEnd))this.tokens.appendCode("}");else{if(!this.tokens.matches1(_types.TokenType.jsxTagEnd))throw new Error("Expected either /> or > at the end of the tag.");this.tokens.removeToken(),this.processAutomaticChildrenAndEndProps(t)}o&&this.tokens.appendCode(`, ${o}`)}for(this.options.production||(null===o&&this.tokens.appendCode(", void 0"),this.tokens.appendCode(`, ${s}, ${this.getDevSource(e)}, this`)),this.tokens.removeInitialToken();!this.tokens.matches1(_types.TokenType.jsxTagEnd);)this.tokens.removeToken();this.tokens.replaceToken(")")}transformTagToCreateElement(e){if(this.tokens.replaceToken(this.getCreateElementInvocationCode()),this.tokens.matches1(_types.TokenType.jsxTagEnd))this.tokens.replaceToken(`${this.getFragmentCode()}, null`),this.processChildren(!0);else if(this.processTagIntro(),this.processPropsObjectWithDevInfo(e),this.tokens.matches2(_types.TokenType.slash,_types.TokenType.jsxTagEnd));else{if(!this.tokens.matches1(_types.TokenType.jsxTagEnd))throw new Error("Expected either /> or > at the end of the tag.");this.tokens.removeToken(),this.processChildren(!0)}for(this.tokens.removeInitialToken();!this.tokens.matches1(_types.TokenType.jsxTagEnd);)this.tokens.removeToken();this.tokens.replaceToken(")")}getJSXFuncInvocationCode(e){return this.options.production?e?this.claimAutoImportedFuncInvocation("jsxs","/jsx-runtime"):this.claimAutoImportedFuncInvocation("jsx","/jsx-runtime"):this.claimAutoImportedFuncInvocation("jsxDEV","/jsx-dev-runtime")}getCreateElementInvocationCode(){if(this.isAutomaticRuntime)return this.claimAutoImportedFuncInvocation("createElement","");{const{jsxPragmaInfo:e}=this;return`${this.importProcessor&&this.importProcessor.getIdentifierReplacement(e.base)||e.base}${e.suffix}(`}}getFragmentCode(){if(this.isAutomaticRuntime)return this.claimAutoImportedName("Fragment",this.options.production?"/jsx-runtime":"/jsx-dev-runtime");{const{jsxPragmaInfo:e}=this;return(this.importProcessor&&this.importProcessor.getIdentifierReplacement(e.fragmentBase)||e.fragmentBase)+e.fragmentSuffix}}claimAutoImportedFuncInvocation(e,t){const s=this.claimAutoImportedName(e,t);return this.importProcessor?`${s}.call(void 0, `:`${s}(`}claimAutoImportedName(e,t){if(this.importProcessor){const s=this.jsxImportSource+t;return this.cjsAutomaticModuleNameResolutions[s]||(this.cjsAutomaticModuleNameResolutions[s]=this.importProcessor.getFreeIdentifierForPath(s)),`${this.cjsAutomaticModuleNameResolutions[s]}.${e}`}return this.esmAutomaticImportNameResolutions[e]||(this.esmAutomaticImportNameResolutions[e]=this.nameManager.claimFreeName(`_${e}`)),this.esmAutomaticImportNameResolutions[e]}processTagIntro(){let e=this.tokens.currentIndex()+1;for(;this.tokens.tokens[e].isType||!this.tokens.matches2AtIndex(e-1,_types.TokenType.jsxName,_types.TokenType.jsxName)&&!this.tokens.matches2AtIndex(e-1,_types.TokenType.greaterThan,_types.TokenType.jsxName)&&!this.tokens.matches1AtIndex(e,_types.TokenType.braceL)&&!this.tokens.matches1AtIndex(e,_types.TokenType.jsxTagEnd)&&!this.tokens.matches2AtIndex(e,_types.TokenType.slash,_types.TokenType.jsxTagEnd);)e++;if(e===this.tokens.currentIndex()+1){const e=this.tokens.identifierName();startsWithLowerCase(e)&&this.tokens.replaceToken(`'${e}'`)}for(;this.tokens.currentIndex()<e;)this.rootTransformer.processToken()}processPropsObjectWithDevInfo(e){const t=this.options.production?"":`__self: this, __source: ${this.getDevSource(e)}`;this.tokens.matches1(_types.TokenType.jsxName)||this.tokens.matches1(_types.TokenType.braceL)?(this.tokens.appendCode(", {"),this.processProps(!1),t?this.tokens.appendCode(` ${t}}`):this.tokens.appendCode("}")):t?this.tokens.appendCode(`, {${t}}`):this.tokens.appendCode(", null")}processProps(e){let t=null;for(;;){if(this.tokens.matches2(_types.TokenType.jsxName,_types.TokenType.eq)){const s=this.tokens.identifierName();if(e&&"key"===s){null!==t&&this.tokens.appendCode(t.replace(/[^\n]/g,"")),this.tokens.removeToken(),this.tokens.removeToken();const e=this.tokens.snapshot();this.processPropValue(),t=this.tokens.dangerouslyGetAndRemoveCodeSinceSnapshot(e);continue}this.processPropName(s),this.tokens.replaceToken(": "),this.processPropValue()}else if(this.tokens.matches1(_types.TokenType.jsxName)){const e=this.tokens.identifierName();this.processPropName(e),this.tokens.appendCode(": true")}else{if(!this.tokens.matches1(_types.TokenType.braceL))break;this.tokens.replaceToken(""),this.rootTransformer.processBalancedCode(),this.tokens.replaceToken("")}this.tokens.appendCode(",")}return t}processPropName(e){e.includes("-")?this.tokens.replaceToken(`'${e}'`):this.tokens.copyToken()}processPropValue(){this.tokens.matches1(_types.TokenType.braceL)?(this.tokens.replaceToken(""),this.rootTransformer.processBalancedCode(),this.tokens.replaceToken("")):this.tokens.matches1(_types.TokenType.jsxTagStart)?this.processJSXTag():this.processStringPropValue()}processStringPropValue(){const e=this.tokens.currentToken(),t=this.tokens.code.slice(e.start+1,e.end-1),s=formatJSXTextReplacement(t),o=formatJSXStringValueLiteral(t);this.tokens.replaceToken(o+s)}processAutomaticChildrenAndEndProps(e){e===_tokenizer.JSXRole.StaticChildren?(this.tokens.appendCode(" children: ["),this.processChildren(!1),this.tokens.appendCode("]}")):(e===_tokenizer.JSXRole.OneChild&&this.tokens.appendCode(" children: "),this.processChildren(!1),this.tokens.appendCode("}"))}processChildren(e){let t=e;for(;;){if(this.tokens.matches2(_types.TokenType.jsxTagStart,_types.TokenType.slash))return;let e=!1;if(this.tokens.matches1(_types.TokenType.braceL))this.tokens.matches2(_types.TokenType.braceL,_types.TokenType.braceR)?(this.tokens.replaceToken(""),this.tokens.replaceToken("")):(this.tokens.replaceToken(t?", ":""),this.rootTransformer.processBalancedCode(),this.tokens.replaceToken(""),e=!0);else if(this.tokens.matches1(_types.TokenType.jsxTagStart))this.tokens.appendCode(t?", ":""),this.processJSXTag(),e=!0;else{if(!this.tokens.matches1(_types.TokenType.jsxText)&&!this.tokens.matches1(_types.TokenType.jsxEmptyText))throw new Error("Unexpected token when processing JSX children.");e=this.processChildTextElement(t)}e&&(t=!0)}}processChildTextElement(e){const t=this.tokens.currentToken(),s=this.tokens.code.slice(t.start,t.end),o=formatJSXTextReplacement(s),n=formatJSXTextLiteral(s);return'""'===n?(this.tokens.replaceToken(o),!1):(this.tokens.replaceToken(`${e?", ":""}${n}${o}`),!0)}getDevSource(e){return`{fileName: ${this.getFilenameVarName()}, ${e}}`}getFilenameVarName(){return this.filenameVarName||(this.filenameVarName=this.nameManager.claimFreeName("_jsxFileName")),this.filenameVarName}}function startsWithLowerCase(e){const t=e.charCodeAt(0);return t>=_charcodes.charCodes.lowercaseA&&t<=_charcodes.charCodes.lowercaseZ}function formatJSXTextLiteral(e){let t="",s="",o=!1,n=!1;for(let r=0;r<e.length;r++){const i=e[r];if(" "===i||"\t"===i||"\r"===i)o||(s+=i);else if("\n"===i)s="",o=!0;else{if(n&&o&&(t+=" "),t+=s,s="","&"===i){const{entity:s,newI:o}=processEntity(e,r+1);r=o-1,t+=s}else t+=i;n=!0,o=!1}}return o||(t+=s),JSON.stringify(t)}function formatJSXTextReplacement(e){let t=0,s=0;for(const o of e)"\n"===o?(t++,s=0):" "===o&&s++;return"\n".repeat(t)+" ".repeat(s)}function formatJSXStringValueLiteral(e){let t="";for(let s=0;s<e.length;s++){const o=e[s];if("\n"===o)if(/\s/.test(e[s+1]))for(t+=" ";s<e.length&&/\s/.test(e[s+1]);)s++;else t+="\n";else if("&"===o){const{entity:o,newI:n}=processEntity(e,s+1);t+=o,s=n-1}else t+=o}return JSON.stringify(t)}function processEntity(e,t){let s,o="",n=0,r=t;if("#"===e[r]){let t,o=10;if(r++,"x"===e[r])for(o=16,r++,t=r;r<e.length&&isHexDigit(e.charCodeAt(r));)r++;else for(t=r;r<e.length&&isDecimalDigit(e.charCodeAt(r));)r++;if(";"===e[r]){const n=e.slice(t,r);n&&(r++,s=String.fromCodePoint(parseInt(n,o)))}}else for(;r<e.length&&n++<10;){const t=e[r];if(r++,";"===t){s=_xhtml2.default.get(o);break}o+=t}return s?{entity:s,newI:r}:{entity:"&",newI:t}}function isDecimalDigit(e){return e>=_charcodes.charCodes.digit0&&e<=_charcodes.charCodes.digit9}function isHexDigit(e){return e>=_charcodes.charCodes.digit0&&e<=_charcodes.charCodes.digit9||e>=_charcodes.charCodes.lowercaseA&&e<=_charcodes.charCodes.lowercaseF||e>=_charcodes.charCodes.uppercaseA&&e<=_charcodes.charCodes.uppercaseF}exports.default=JSXTransformer,exports.startsWithLowerCase=startsWithLowerCase;