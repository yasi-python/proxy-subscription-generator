"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _tokenizer=require("../parser/tokenizer"),_types=require("../parser/tokenizer/types"),_Transformer=require("./Transformer"),_Transformer2=_interopRequireDefault(_Transformer);class ReactDisplayNameTransformer extends _Transformer2.default{constructor(e,t,s,n){super(),this.rootTransformer=e,this.tokens=t,this.importProcessor=s,this.options=n}process(){const e=this.tokens.currentIndex();if("createReactClass"===this.tokens.identifierName()){const t=this.importProcessor&&this.importProcessor.getIdentifierReplacement("createReactClass");return t?this.tokens.replaceToken(`(0, ${t})`):this.tokens.copyToken(),this.tryProcessCreateClassCall(e),!0}if(this.tokens.matches3(_types.TokenType.name,_types.TokenType.dot,_types.TokenType.name)&&"React"===this.tokens.identifierName()&&"createClass"===this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+2)){const t=this.importProcessor&&this.importProcessor.getIdentifierReplacement("React")||"React";return t?(this.tokens.replaceToken(t),this.tokens.copyToken(),this.tokens.copyToken()):(this.tokens.copyToken(),this.tokens.copyToken(),this.tokens.copyToken()),this.tryProcessCreateClassCall(e),!0}return!1}tryProcessCreateClassCall(e){const t=this.findDisplayName(e);t&&this.classNeedsDisplayName()&&(this.tokens.copyExpectedToken(_types.TokenType.parenL),this.tokens.copyExpectedToken(_types.TokenType.braceL),this.tokens.appendCode(`displayName: '${t}',`),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(_types.TokenType.braceR),this.tokens.copyExpectedToken(_types.TokenType.parenR))}findDisplayName(e){return e<2?null:this.tokens.matches2AtIndex(e-2,_types.TokenType.name,_types.TokenType.eq)||e>=2&&this.tokens.tokens[e-2].identifierRole===_tokenizer.IdentifierRole.ObjectKey?this.tokens.identifierNameAtIndex(e-2):this.tokens.matches2AtIndex(e-2,_types.TokenType._export,_types.TokenType._default)?this.getDisplayNameFromFilename():null}getDisplayNameFromFilename(){const e=(this.options.filePath||"unknown").split("/"),t=e[e.length-1],s=t.lastIndexOf("."),n=-1===s?t:t.slice(0,s);return"index"===n&&e[e.length-2]?e[e.length-2]:n}classNeedsDisplayName(){let e=this.tokens.currentIndex();if(!this.tokens.matches2(_types.TokenType.parenL,_types.TokenType.braceL))return!1;const t=e+1,s=this.tokens.tokens[t].contextId;if(null==s)throw new Error("Expected non-null context ID on object open-brace.");for(;e<this.tokens.tokens.length;e++){const t=this.tokens.tokens[e];if(t.type===_types.TokenType.braceR&&t.contextId===s){e++;break}if("displayName"===this.tokens.identifierNameAtIndex(e)&&this.tokens.tokens[e].identifierRole===_tokenizer.IdentifierRole.ObjectKey&&t.contextId===s)return!1}if(e===this.tokens.tokens.length)throw new Error("Unexpected end of input when processing React class.");return this.tokens.matches1AtIndex(e,_types.TokenType.parenR)||this.tokens.matches2AtIndex(e,_types.TokenType.comma,_types.TokenType.parenR)}}exports.default=ReactDisplayNameTransformer;