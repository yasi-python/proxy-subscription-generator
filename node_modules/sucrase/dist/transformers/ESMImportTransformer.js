"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _keywords=require("../parser/tokenizer/keywords"),_types=require("../parser/tokenizer/types"),_elideImportEquals=require("../util/elideImportEquals"),_elideImportEquals2=_interopRequireDefault(_elideImportEquals),_getDeclarationInfo=require("../util/getDeclarationInfo"),_getDeclarationInfo2=_interopRequireDefault(_getDeclarationInfo),_getImportExportSpecifierInfo=require("../util/getImportExportSpecifierInfo"),_getImportExportSpecifierInfo2=_interopRequireDefault(_getImportExportSpecifierInfo),_getNonTypeIdentifiers=require("../util/getNonTypeIdentifiers"),_isExportFrom=require("../util/isExportFrom"),_isExportFrom2=_interopRequireDefault(_isExportFrom),_removeMaybeImportAttributes=require("../util/removeMaybeImportAttributes"),_shouldElideDefaultExport=require("../util/shouldElideDefaultExport"),_shouldElideDefaultExport2=_interopRequireDefault(_shouldElideDefaultExport),_Transformer=require("./Transformer"),_Transformer2=_interopRequireDefault(_Transformer);class ESMImportTransformer extends _Transformer2.default{constructor(e,t,o,s,n,r,i,p){super(),this.tokens=e,this.nameManager=t,this.helperManager=o,this.reactHotLoaderTransformer=s,this.isTypeScriptTransformEnabled=n,this.isFlowTransformEnabled=r,this.keepUnusedImports=i,this.nonTypeIdentifiers=n&&!i?_getNonTypeIdentifiers.getNonTypeIdentifiers.call(void 0,e,p):new Set,this.declarationInfo=n&&!i?_getDeclarationInfo2.default.call(void 0,e):_getDeclarationInfo.EMPTY_DECLARATION_INFO,this.injectCreateRequireForImportRequire=Boolean(p.injectCreateRequireForImportRequire)}process(){if(this.tokens.matches3(_types.TokenType._import,_types.TokenType.name,_types.TokenType.eq))return this.processImportEquals();if(this.tokens.matches4(_types.TokenType._import,_types.TokenType.name,_types.TokenType.name,_types.TokenType.eq)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,_keywords.ContextualKeyword._type)){this.tokens.removeInitialToken();for(let e=0;e<7;e++)this.tokens.removeToken();return!0}if(this.tokens.matches2(_types.TokenType._export,_types.TokenType.eq))return this.tokens.replaceToken("module.exports"),!0;if(this.tokens.matches5(_types.TokenType._export,_types.TokenType._import,_types.TokenType.name,_types.TokenType.name,_types.TokenType.eq)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,_keywords.ContextualKeyword._type)){this.tokens.removeInitialToken();for(let e=0;e<8;e++)this.tokens.removeToken();return!0}if(this.tokens.matches1(_types.TokenType._import))return this.processImport();if(this.tokens.matches2(_types.TokenType._export,_types.TokenType._default))return this.processExportDefault();if(this.tokens.matches2(_types.TokenType._export,_types.TokenType.braceL))return this.processNamedExports();if(this.tokens.matches2(_types.TokenType._export,_types.TokenType.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,_keywords.ContextualKeyword._type)){if(this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.matches1(_types.TokenType.braceL)){for(;!this.tokens.matches1(_types.TokenType.braceR);)this.tokens.removeToken();this.tokens.removeToken()}else this.tokens.removeToken(),this.tokens.matches1(_types.TokenType._as)&&(this.tokens.removeToken(),this.tokens.removeToken());return this.tokens.matchesContextual(_keywords.ContextualKeyword._from)&&this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,_types.TokenType.string)&&(this.tokens.removeToken(),this.tokens.removeToken(),_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens)),!0}return!1}processImportEquals(){const e=this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+1);return this.shouldAutomaticallyElideImportedName(e)?_elideImportEquals2.default.call(void 0,this.tokens):this.injectCreateRequireForImportRequire?(this.tokens.replaceToken("const"),this.tokens.copyToken(),this.tokens.copyToken(),this.tokens.replaceToken(this.helperManager.getHelperName("require"))):this.tokens.replaceToken("const"),!0}processImport(){if(this.tokens.matches2(_types.TokenType._import,_types.TokenType.parenL))return!1;const e=this.tokens.snapshot();if(this.removeImportTypeBindings()){for(this.tokens.restoreToSnapshot(e);!this.tokens.matches1(_types.TokenType.string);)this.tokens.removeToken();this.tokens.removeToken(),_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens),this.tokens.matches1(_types.TokenType.semi)&&this.tokens.removeToken()}return!0}removeImportTypeBindings(){if(this.tokens.copyExpectedToken(_types.TokenType._import),this.tokens.matchesContextual(_keywords.ContextualKeyword._type)&&!this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,_types.TokenType.comma)&&!this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,_keywords.ContextualKeyword._from))return!0;if(this.tokens.matches1(_types.TokenType.string))return this.tokens.copyToken(),!1;this.tokens.matchesContextual(_keywords.ContextualKeyword._module)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,_keywords.ContextualKeyword._from)&&this.tokens.copyToken();let e=!1,t=!1,o=!1;if(this.tokens.matches1(_types.TokenType.name)&&(this.shouldAutomaticallyElideImportedName(this.tokens.identifierName())?(this.tokens.removeToken(),this.tokens.matches1(_types.TokenType.comma)&&this.tokens.removeToken()):(e=!0,this.tokens.copyToken(),this.tokens.matches1(_types.TokenType.comma)&&(o=!0,this.tokens.removeToken()))),this.tokens.matches1(_types.TokenType.star))this.shouldAutomaticallyElideImportedName(this.tokens.identifierNameAtRelativeIndex(2))?(this.tokens.removeToken(),this.tokens.removeToken(),this.tokens.removeToken()):(o&&this.tokens.appendCode(","),e=!0,this.tokens.copyExpectedToken(_types.TokenType.star),this.tokens.copyExpectedToken(_types.TokenType.name),this.tokens.copyExpectedToken(_types.TokenType.name));else if(this.tokens.matches1(_types.TokenType.braceL)){for(o&&this.tokens.appendCode(","),this.tokens.copyToken();!this.tokens.matches1(_types.TokenType.braceR);){t=!0;const o=_getImportExportSpecifierInfo2.default.call(void 0,this.tokens);if(o.isType||this.shouldAutomaticallyElideImportedName(o.rightName)){for(;this.tokens.currentIndex()<o.endIndex;)this.tokens.removeToken();this.tokens.matches1(_types.TokenType.comma)&&this.tokens.removeToken()}else{for(e=!0;this.tokens.currentIndex()<o.endIndex;)this.tokens.copyToken();this.tokens.matches1(_types.TokenType.comma)&&this.tokens.copyToken()}}this.tokens.copyExpectedToken(_types.TokenType.braceR)}return!this.keepUnusedImports&&(this.isTypeScriptTransformEnabled||!!this.isFlowTransformEnabled&&t)&&!e}shouldAutomaticallyElideImportedName(e){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&!this.nonTypeIdentifiers.has(e)}processExportDefault(){if(_shouldElideDefaultExport2.default.call(void 0,this.isTypeScriptTransformEnabled,this.keepUnusedImports,this.tokens,this.declarationInfo))return this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.removeToken(),!0;if(!(this.tokens.matches4(_types.TokenType._export,_types.TokenType._default,_types.TokenType._function,_types.TokenType.name)||this.tokens.matches5(_types.TokenType._export,_types.TokenType._default,_types.TokenType.name,_types.TokenType._function,_types.TokenType.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,_keywords.ContextualKeyword._async)||this.tokens.matches4(_types.TokenType._export,_types.TokenType._default,_types.TokenType._class,_types.TokenType.name)||this.tokens.matches5(_types.TokenType._export,_types.TokenType._default,_types.TokenType._abstract,_types.TokenType._class,_types.TokenType.name))&&this.reactHotLoaderTransformer){const e=this.nameManager.claimFreeName("_default");return this.tokens.replaceToken(`let ${e}; export`),this.tokens.copyToken(),this.tokens.appendCode(` ${e} =`),this.reactHotLoaderTransformer.setExtractedDefaultExportName(e),!0}return!1}processNamedExports(){if(!this.isTypeScriptTransformEnabled)return!1;this.tokens.copyExpectedToken(_types.TokenType._export),this.tokens.copyExpectedToken(_types.TokenType.braceL);const e=_isExportFrom2.default.call(void 0,this.tokens);let t=!1;for(;!this.tokens.matches1(_types.TokenType.braceR);){const o=_getImportExportSpecifierInfo2.default.call(void 0,this.tokens);if(o.isType||!e&&this.shouldElideExportedName(o.leftName)){for(;this.tokens.currentIndex()<o.endIndex;)this.tokens.removeToken();this.tokens.matches1(_types.TokenType.comma)&&this.tokens.removeToken()}else{for(t=!0;this.tokens.currentIndex()<o.endIndex;)this.tokens.copyToken();this.tokens.matches1(_types.TokenType.comma)&&this.tokens.copyToken()}}return this.tokens.copyExpectedToken(_types.TokenType.braceR),this.keepUnusedImports||!e||t||(this.tokens.removeToken(),this.tokens.removeToken(),_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens)),!0}shouldElideExportedName(e){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&this.declarationInfo.typeDeclarations.has(e)&&!this.declarationInfo.valueDeclarations.has(e)}}exports.default=ESMImportTransformer;