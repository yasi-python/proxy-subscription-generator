"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _keywords=require("../parser/tokenizer/keywords"),_types=require("../parser/tokenizer/types"),_getClassInfo=require("../util/getClassInfo"),_getClassInfo2=_interopRequireDefault(_getClassInfo),_CJSImportTransformer=require("./CJSImportTransformer"),_CJSImportTransformer2=_interopRequireDefault(_CJSImportTransformer),_ESMImportTransformer=require("./ESMImportTransformer"),_ESMImportTransformer2=_interopRequireDefault(_ESMImportTransformer),_FlowTransformer=require("./FlowTransformer"),_FlowTransformer2=_interopRequireDefault(_FlowTransformer),_JestHoistTransformer=require("./JestHoistTransformer"),_JestHoistTransformer2=_interopRequireDefault(_JestHoistTransformer),_JSXTransformer=require("./JSXTransformer"),_JSXTransformer2=_interopRequireDefault(_JSXTransformer),_NumericSeparatorTransformer=require("./NumericSeparatorTransformer"),_NumericSeparatorTransformer2=_interopRequireDefault(_NumericSeparatorTransformer),_OptionalCatchBindingTransformer=require("./OptionalCatchBindingTransformer"),_OptionalCatchBindingTransformer2=_interopRequireDefault(_OptionalCatchBindingTransformer),_OptionalChainingNullishTransformer=require("./OptionalChainingNullishTransformer"),_OptionalChainingNullishTransformer2=_interopRequireDefault(_OptionalChainingNullishTransformer),_ReactDisplayNameTransformer=require("./ReactDisplayNameTransformer"),_ReactDisplayNameTransformer2=_interopRequireDefault(_ReactDisplayNameTransformer),_ReactHotLoaderTransformer=require("./ReactHotLoaderTransformer"),_ReactHotLoaderTransformer2=_interopRequireDefault(_ReactHotLoaderTransformer),_TypeScriptTransformer=require("./TypeScriptTransformer"),_TypeScriptTransformer2=_interopRequireDefault(_TypeScriptTransformer);class RootTransformer{__init(){this.transformers=[]}__init2(){this.generatedVariables=[]}constructor(e,s,t,r){RootTransformer.prototype.__init.call(this),RootTransformer.prototype.__init2.call(this),this.nameManager=e.nameManager,this.helperManager=e.helperManager;const{tokenProcessor:n,importProcessor:o}=e;this.tokens=n,this.isImportsTransformEnabled=s.includes("imports"),this.isReactHotLoaderTransformEnabled=s.includes("react-hot-loader"),this.disableESTransforms=Boolean(r.disableESTransforms),r.disableESTransforms||(this.transformers.push(new(0,_OptionalChainingNullishTransformer2.default)(n,this.nameManager)),this.transformers.push(new(0,_NumericSeparatorTransformer2.default)(n)),this.transformers.push(new(0,_OptionalCatchBindingTransformer2.default)(n,this.nameManager))),s.includes("jsx")&&("preserve"!==r.jsxRuntime&&this.transformers.push(new(0,_JSXTransformer2.default)(this,n,o,this.nameManager,r)),this.transformers.push(new(0,_ReactDisplayNameTransformer2.default)(this,n,o,r)));let i=null;if(s.includes("react-hot-loader")){if(!r.filePath)throw new Error("filePath is required when using the react-hot-loader transform.");i=new(0,_ReactHotLoaderTransformer2.default)(n,r.filePath),this.transformers.push(i)}if(s.includes("imports")){if(null===o)throw new Error("Expected non-null importProcessor with imports transform enabled.");this.transformers.push(new(0,_CJSImportTransformer2.default)(this,n,o,this.nameManager,this.helperManager,i,t,Boolean(r.enableLegacyTypeScriptModuleInterop),s.includes("typescript"),s.includes("flow"),Boolean(r.preserveDynamicImport),Boolean(r.keepUnusedImports)))}else this.transformers.push(new(0,_ESMImportTransformer2.default)(n,this.nameManager,this.helperManager,i,s.includes("typescript"),s.includes("flow"),Boolean(r.keepUnusedImports),r));s.includes("flow")&&this.transformers.push(new(0,_FlowTransformer2.default)(this,n,s.includes("imports"))),s.includes("typescript")&&this.transformers.push(new(0,_TypeScriptTransformer2.default)(this,n,s.includes("imports"))),s.includes("jest")&&this.transformers.push(new(0,_JestHoistTransformer2.default)(this,n,this.nameManager,o))}transform(){this.tokens.reset(),this.processBalancedCode();let e=this.isImportsTransformEnabled?'"use strict";':"";for(const s of this.transformers)e+=s.getPrefixCode();e+=this.helperManager.emitHelpers(),e+=this.generatedVariables.map(e=>` var ${e};`).join("");for(const s of this.transformers)e+=s.getHoistedCode();let s="";for(const e of this.transformers)s+=e.getSuffixCode();const t=this.tokens.finish();let{code:r}=t;if(r.startsWith("#!")){let n=r.indexOf("\n");return-1===n&&(n=r.length,r+="\n"),{code:r.slice(0,n+1)+e+r.slice(n+1)+s,mappings:this.shiftMappings(t.mappings,e.length)}}return{code:e+r+s,mappings:this.shiftMappings(t.mappings,e.length)}}processBalancedCode(){let e=0,s=0;for(;!this.tokens.isAtEnd();){if(this.tokens.matches1(_types.TokenType.braceL)||this.tokens.matches1(_types.TokenType.dollarBraceL))e++;else if(this.tokens.matches1(_types.TokenType.braceR)){if(0===e)return;e--}if(this.tokens.matches1(_types.TokenType.parenL))s++;else if(this.tokens.matches1(_types.TokenType.parenR)){if(0===s)return;s--}this.processToken()}}processToken(){if(this.tokens.matches1(_types.TokenType._class))this.processClass();else{for(const e of this.transformers)if(e.process())return;this.tokens.copyToken()}}processNamedClass(){if(!this.tokens.matches2(_types.TokenType._class,_types.TokenType.name))throw new Error("Expected identifier for exported class name.");const e=this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+1);return this.processClass(),e}processClass(){const e=_getClassInfo2.default.call(void 0,this,this.tokens,this.nameManager,this.disableESTransforms),s=(e.headerInfo.isExpression||!e.headerInfo.className)&&e.staticInitializerNames.length+e.instanceInitializerNames.length>0;let t=e.headerInfo.className;s&&(t=this.nameManager.claimFreeName("_class"),this.generatedVariables.push(t),this.tokens.appendCode(` (${t} =`));const r=this.tokens.currentToken().contextId;if(null==r)throw new Error("Expected class to have a context ID.");for(this.tokens.copyExpectedToken(_types.TokenType._class);!this.tokens.matchesContextIdAndLabel(_types.TokenType.braceL,r);)this.processToken();this.processClassBody(e,t);const n=e.staticInitializerNames.map(e=>`${t}.${e}()`);s?this.tokens.appendCode(`, ${n.map(e=>`${e}, `).join("")}${t})`):e.staticInitializerNames.length>0&&this.tokens.appendCode(` ${n.map(e=>`${e};`).join(" ")}`)}processClassBody(e,s){const{headerInfo:t,constructorInsertPos:r,constructorInitializerStatements:n,fields:o,instanceInitializerNames:i,rangesToRemove:a}=e;let p=0,h=0;const l=this.tokens.currentToken().contextId;if(null==l)throw new Error("Expected non-null context ID on class.");this.tokens.copyExpectedToken(_types.TokenType.braceL),this.isReactHotLoaderTransformEnabled&&this.tokens.appendCode("__reactstandin__regenerateByEval(key, code) {this[key] = eval(code);}");const c=n.length+i.length>0;if(null===r&&c){const e=this.makeConstructorInitCode(n,i,s);if(t.hasSuperclass){const s=this.nameManager.claimFreeName("args");this.tokens.appendCode(`constructor(...${s}) { super(...${s}); ${e}; }`)}else this.tokens.appendCode(`constructor() { ${e}; }`)}for(;!this.tokens.matchesContextIdAndLabel(_types.TokenType.braceR,l);)if(p<o.length&&this.tokens.currentIndex()===o[p].start){let e=!1;for(this.tokens.matches1(_types.TokenType.bracketL)?this.tokens.copyTokenWithPrefix(`${o[p].initializerName}() {this`):this.tokens.matches1(_types.TokenType.string)||this.tokens.matches1(_types.TokenType.num)?(this.tokens.copyTokenWithPrefix(`${o[p].initializerName}() {this[`),e=!0):this.tokens.copyTokenWithPrefix(`${o[p].initializerName}() {this.`);this.tokens.currentIndex()<o[p].end;)e&&this.tokens.currentIndex()===o[p].equalsIndex&&this.tokens.appendCode("]"),this.processToken();this.tokens.appendCode("}"),p++}else if(h<a.length&&this.tokens.currentIndex()>=a[h].start){for(this.tokens.currentIndex()<a[h].end&&this.tokens.removeInitialToken();this.tokens.currentIndex()<a[h].end;)this.tokens.removeToken();h++}else this.tokens.currentIndex()===r?(this.tokens.copyToken(),c&&this.tokens.appendCode(`;${this.makeConstructorInitCode(n,i,s)};`),this.processToken()):this.processToken();this.tokens.copyExpectedToken(_types.TokenType.braceR)}makeConstructorInitCode(e,s,t){return[...e,...s.map(e=>`${t}.prototype.${e}.call(this)`)].join(";")}processPossibleArrowParamEnd(){if(this.tokens.matches2(_types.TokenType.parenR,_types.TokenType.colon)&&this.tokens.tokenAtRelativeIndex(1).isType){let e=this.tokens.currentIndex()+1;for(;this.tokens.tokens[e].isType;)e++;if(this.tokens.matches1AtIndex(e,_types.TokenType.arrow)){for(this.tokens.removeInitialToken();this.tokens.currentIndex()<e;)this.tokens.removeToken();return this.tokens.replaceTokenTrimmingLeftWhitespace(") =>"),!0}}return!1}processPossibleAsyncArrowWithTypeParams(){if(!this.tokens.matchesContextual(_keywords.ContextualKeyword._async)&&!this.tokens.matches1(_types.TokenType._async))return!1;const e=this.tokens.tokenAtRelativeIndex(1);if(e.type!==_types.TokenType.lessThan||!e.isType)return!1;let s=this.tokens.currentIndex()+1;for(;this.tokens.tokens[s].isType;)s++;if(this.tokens.matches1AtIndex(s,_types.TokenType.parenL)){for(this.tokens.replaceToken("async ("),this.tokens.removeInitialToken();this.tokens.currentIndex()<s;)this.tokens.removeToken();return this.tokens.removeToken(),this.processBalancedCode(),this.processToken(),!0}return!1}processPossibleTypeRange(){if(this.tokens.currentToken().isType){for(this.tokens.removeInitialToken();this.tokens.currentToken().isType;)this.tokens.removeToken();return!0}return!1}shiftMappings(e,s){for(let t=0;t<e.length;t++){const r=e[t];void 0!==r&&(e[t]=r+s)}return e}}exports.default=RootTransformer;