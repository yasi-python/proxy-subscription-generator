"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _tokenizer=require("../parser/tokenizer"),_keywords=require("../parser/tokenizer/keywords"),_types=require("../parser/tokenizer/types"),_elideImportEquals=require("../util/elideImportEquals"),_elideImportEquals2=_interopRequireDefault(_elideImportEquals),_getDeclarationInfo=require("../util/getDeclarationInfo"),_getDeclarationInfo2=_interopRequireDefault(_getDeclarationInfo),_getImportExportSpecifierInfo=require("../util/getImportExportSpecifierInfo"),_getImportExportSpecifierInfo2=_interopRequireDefault(_getImportExportSpecifierInfo),_isExportFrom=require("../util/isExportFrom"),_isExportFrom2=_interopRequireDefault(_isExportFrom),_removeMaybeImportAttributes=require("../util/removeMaybeImportAttributes"),_shouldElideDefaultExport=require("../util/shouldElideDefaultExport"),_shouldElideDefaultExport2=_interopRequireDefault(_shouldElideDefaultExport),_Transformer=require("./Transformer"),_Transformer2=_interopRequireDefault(_Transformer);class CJSImportTransformer extends _Transformer2.default{__init(){this.hadExport=!1}__init2(){this.hadNamedExport=!1}__init3(){this.hadDefaultExport=!1}constructor(e,t,s,o,n,r,i,p,k,a,h,T){super(),this.rootTransformer=e,this.tokens=t,this.importProcessor=s,this.nameManager=o,this.helperManager=n,this.reactHotLoaderTransformer=r,this.enableLegacyBabel5ModuleInterop=i,this.enableLegacyTypeScriptModuleInterop=p,this.isTypeScriptTransformEnabled=k,this.isFlowTransformEnabled=a,this.preserveDynamicImport=h,this.keepUnusedImports=T,CJSImportTransformer.prototype.__init.call(this),CJSImportTransformer.prototype.__init2.call(this),CJSImportTransformer.prototype.__init3.call(this),this.declarationInfo=k?_getDeclarationInfo2.default.call(void 0,t):_getDeclarationInfo.EMPTY_DECLARATION_INFO}getPrefixCode(){let e="";return this.hadExport&&(e+='Object.defineProperty(exports, "__esModule", {value: true});'),e}getSuffixCode(){return this.enableLegacyBabel5ModuleInterop&&this.hadDefaultExport&&!this.hadNamedExport?"\nmodule.exports = exports.default;\n":""}process(){return this.tokens.matches3(_types.TokenType._import,_types.TokenType.name,_types.TokenType.eq)?this.processImportEquals():this.tokens.matches1(_types.TokenType._import)?(this.processImport(),!0):this.tokens.matches2(_types.TokenType._export,_types.TokenType.eq)?(this.tokens.replaceToken("module.exports"),!0):this.tokens.matches1(_types.TokenType._export)&&!this.tokens.currentToken().isType?(this.hadExport=!0,this.processExport()):!(!this.tokens.matches2(_types.TokenType.name,_types.TokenType.postIncDec)||!this.processPostIncDec())||(this.tokens.matches1(_types.TokenType.name)||this.tokens.matches1(_types.TokenType.jsxName)?this.processIdentifier():this.tokens.matches1(_types.TokenType.eq)?this.processAssignment():this.tokens.matches1(_types.TokenType.assign)?this.processComplexAssignment():!!this.tokens.matches1(_types.TokenType.preIncDec)&&this.processPreIncDec())}processImportEquals(){const e=this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+1);return this.importProcessor.shouldAutomaticallyElideImportedName(e)?_elideImportEquals2.default.call(void 0,this.tokens):this.tokens.replaceToken("const"),!0}processImport(){if(this.tokens.matches2(_types.TokenType._import,_types.TokenType.parenL)){if(this.preserveDynamicImport)return void this.tokens.copyToken();const e=this.enableLegacyTypeScriptModuleInterop?"":`${this.helperManager.getHelperName("interopRequireWildcard")}(`;this.tokens.replaceToken(`Promise.resolve().then(() => ${e}require`);const t=this.tokens.currentToken().contextId;if(null==t)throw new Error("Expected context ID on dynamic import invocation.");for(this.tokens.copyToken();!this.tokens.matchesContextIdAndLabel(_types.TokenType.parenR,t);)this.rootTransformer.processToken();return void this.tokens.replaceToken(e?")))":"))")}if(this.removeImportAndDetectIfShouldElide())this.tokens.removeToken();else{const e=this.tokens.stringValue();this.tokens.replaceTokenTrimmingLeftWhitespace(this.importProcessor.claimImportCode(e)),this.tokens.appendCode(this.importProcessor.claimImportCode(e))}_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens),this.tokens.matches1(_types.TokenType.semi)&&this.tokens.removeToken()}removeImportAndDetectIfShouldElide(){if(this.tokens.removeInitialToken(),this.tokens.matchesContextual(_keywords.ContextualKeyword._type)&&!this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,_types.TokenType.comma)&&!this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,_keywords.ContextualKeyword._from))return this.removeRemainingImport(),!0;if(this.tokens.matches1(_types.TokenType.name)||this.tokens.matches1(_types.TokenType.star))return this.removeRemainingImport(),!1;if(this.tokens.matches1(_types.TokenType.string))return!1;let e=!1,t=!1;for(;!this.tokens.matches1(_types.TokenType.string);)(!e&&this.tokens.matches1(_types.TokenType.braceL)||this.tokens.matches1(_types.TokenType.comma))&&(this.tokens.removeToken(),this.tokens.matches1(_types.TokenType.braceR)||(t=!0),(this.tokens.matches2(_types.TokenType.name,_types.TokenType.comma)||this.tokens.matches2(_types.TokenType.name,_types.TokenType.braceR)||this.tokens.matches4(_types.TokenType.name,_types.TokenType.name,_types.TokenType.name,_types.TokenType.comma)||this.tokens.matches4(_types.TokenType.name,_types.TokenType.name,_types.TokenType.name,_types.TokenType.braceR))&&(e=!0)),this.tokens.removeToken();return!this.keepUnusedImports&&(this.isTypeScriptTransformEnabled?!e:!!this.isFlowTransformEnabled&&(t&&!e))}removeRemainingImport(){for(;!this.tokens.matches1(_types.TokenType.string);)this.tokens.removeToken()}processIdentifier(){const e=this.tokens.currentToken();if(e.shadowsGlobal)return!1;if(e.identifierRole===_tokenizer.IdentifierRole.ObjectShorthand)return this.processObjectShorthand();if(e.identifierRole!==_tokenizer.IdentifierRole.Access)return!1;const t=this.importProcessor.getIdentifierReplacement(this.tokens.identifierNameForToken(e));if(!t)return!1;let s=this.tokens.currentIndex()+1;for(;s<this.tokens.tokens.length&&this.tokens.tokens[s].type===_types.TokenType.parenR;)s++;return this.tokens.tokens[s].type===_types.TokenType.parenL?this.tokens.tokenAtRelativeIndex(1).type===_types.TokenType.parenL&&this.tokens.tokenAtRelativeIndex(-1).type!==_types.TokenType._new?(this.tokens.replaceToken(`${t}.call(void 0, `),this.tokens.removeToken(),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(_types.TokenType.parenR)):this.tokens.replaceToken(`(0, ${t})`):this.tokens.replaceToken(t),!0}processObjectShorthand(){const e=this.tokens.identifierName(),t=this.importProcessor.getIdentifierReplacement(e);return!!t&&(this.tokens.replaceToken(`${e}: ${t}`),!0)}processExport(){if(this.tokens.matches2(_types.TokenType._export,_types.TokenType._enum)||this.tokens.matches3(_types.TokenType._export,_types.TokenType._const,_types.TokenType._enum))return this.hadNamedExport=!0,!1;if(this.tokens.matches2(_types.TokenType._export,_types.TokenType._default))return this.tokens.matches3(_types.TokenType._export,_types.TokenType._default,_types.TokenType._enum)?(this.hadDefaultExport=!0,!1):(this.processExportDefault(),!0);if(this.tokens.matches2(_types.TokenType._export,_types.TokenType.braceL))return this.processExportBindings(),!0;if(this.tokens.matches2(_types.TokenType._export,_types.TokenType.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,_keywords.ContextualKeyword._type)){if(this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.matches1(_types.TokenType.braceL)){for(;!this.tokens.matches1(_types.TokenType.braceR);)this.tokens.removeToken();this.tokens.removeToken()}else this.tokens.removeToken(),this.tokens.matches1(_types.TokenType._as)&&(this.tokens.removeToken(),this.tokens.removeToken());return this.tokens.matchesContextual(_keywords.ContextualKeyword._from)&&this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,_types.TokenType.string)&&(this.tokens.removeToken(),this.tokens.removeToken(),_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens)),!0}if(this.hadNamedExport=!0,this.tokens.matches2(_types.TokenType._export,_types.TokenType._var)||this.tokens.matches2(_types.TokenType._export,_types.TokenType._let)||this.tokens.matches2(_types.TokenType._export,_types.TokenType._const))return this.processExportVar(),!0;if(this.tokens.matches2(_types.TokenType._export,_types.TokenType._function)||this.tokens.matches3(_types.TokenType._export,_types.TokenType.name,_types.TokenType._function))return this.processExportFunction(),!0;if(this.tokens.matches2(_types.TokenType._export,_types.TokenType._class)||this.tokens.matches3(_types.TokenType._export,_types.TokenType._abstract,_types.TokenType._class)||this.tokens.matches2(_types.TokenType._export,_types.TokenType.at))return this.processExportClass(),!0;if(this.tokens.matches2(_types.TokenType._export,_types.TokenType.star))return this.processExportStar(),!0;throw new Error("Unrecognized export syntax.")}processAssignment(){const e=this.tokens.currentIndex(),t=this.tokens.tokens[e-1];if(t.isType||t.type!==_types.TokenType.name)return!1;if(t.shadowsGlobal)return!1;if(e>=2&&this.tokens.matches1AtIndex(e-2,_types.TokenType.dot))return!1;if(e>=2&&[_types.TokenType._var,_types.TokenType._let,_types.TokenType._const].includes(this.tokens.tokens[e-2].type))return!1;const s=this.importProcessor.resolveExportBinding(this.tokens.identifierNameForToken(t));return!!s&&(this.tokens.copyToken(),this.tokens.appendCode(` ${s} =`),!0)}processComplexAssignment(){const e=this.tokens.currentIndex(),t=this.tokens.tokens[e-1];if(t.type!==_types.TokenType.name)return!1;if(t.shadowsGlobal)return!1;if(e>=2&&this.tokens.matches1AtIndex(e-2,_types.TokenType.dot))return!1;const s=this.importProcessor.resolveExportBinding(this.tokens.identifierNameForToken(t));return!!s&&(this.tokens.appendCode(` = ${s}`),this.tokens.copyToken(),!0)}processPreIncDec(){const e=this.tokens.currentIndex(),t=this.tokens.tokens[e+1];if(t.type!==_types.TokenType.name)return!1;if(t.shadowsGlobal)return!1;if(e+2<this.tokens.tokens.length&&(this.tokens.matches1AtIndex(e+2,_types.TokenType.dot)||this.tokens.matches1AtIndex(e+2,_types.TokenType.bracketL)||this.tokens.matches1AtIndex(e+2,_types.TokenType.parenL)))return!1;const s=this.tokens.identifierNameForToken(t),o=this.importProcessor.resolveExportBinding(s);return!!o&&(this.tokens.appendCode(`${o} = `),this.tokens.copyToken(),!0)}processPostIncDec(){const e=this.tokens.currentIndex(),t=this.tokens.tokens[e],s=this.tokens.tokens[e+1];if(t.type!==_types.TokenType.name)return!1;if(t.shadowsGlobal)return!1;if(e>=1&&this.tokens.matches1AtIndex(e-1,_types.TokenType.dot))return!1;const o=this.tokens.identifierNameForToken(t),n=this.importProcessor.resolveExportBinding(o);if(!n)return!1;const r=this.tokens.rawCodeForToken(s),i=this.importProcessor.getIdentifierReplacement(o)||o;if("++"===r)this.tokens.replaceToken(`(${i} = ${n} = ${i} + 1, ${i} - 1)`);else{if("--"!==r)throw new Error(`Unexpected operator: ${r}`);this.tokens.replaceToken(`(${i} = ${n} = ${i} - 1, ${i} + 1)`)}return this.tokens.removeToken(),!0}processExportDefault(){let e=!0;if(this.tokens.matches4(_types.TokenType._export,_types.TokenType._default,_types.TokenType._function,_types.TokenType.name)||this.tokens.matches5(_types.TokenType._export,_types.TokenType._default,_types.TokenType.name,_types.TokenType._function,_types.TokenType.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,_keywords.ContextualKeyword._async)){this.tokens.removeInitialToken(),this.tokens.removeToken();const e=this.processNamedFunction();this.tokens.appendCode(` exports.default = ${e};`)}else if(this.tokens.matches4(_types.TokenType._export,_types.TokenType._default,_types.TokenType._class,_types.TokenType.name)||this.tokens.matches5(_types.TokenType._export,_types.TokenType._default,_types.TokenType._abstract,_types.TokenType._class,_types.TokenType.name)||this.tokens.matches3(_types.TokenType._export,_types.TokenType._default,_types.TokenType.at)){this.tokens.removeInitialToken(),this.tokens.removeToken(),this.copyDecorators(),this.tokens.matches1(_types.TokenType._abstract)&&this.tokens.removeToken();const e=this.rootTransformer.processNamedClass();this.tokens.appendCode(` exports.default = ${e};`)}else if(_shouldElideDefaultExport2.default.call(void 0,this.isTypeScriptTransformEnabled,this.keepUnusedImports,this.tokens,this.declarationInfo))e=!1,this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.removeToken();else if(this.reactHotLoaderTransformer){const e=this.nameManager.claimFreeName("_default");this.tokens.replaceToken(`let ${e}; exports.`),this.tokens.copyToken(),this.tokens.appendCode(` = ${e} =`),this.reactHotLoaderTransformer.setExtractedDefaultExportName(e)}else this.tokens.replaceToken("exports."),this.tokens.copyToken(),this.tokens.appendCode(" =");e&&(this.hadDefaultExport=!0)}copyDecorators(){for(;this.tokens.matches1(_types.TokenType.at);)if(this.tokens.copyToken(),this.tokens.matches1(_types.TokenType.parenL))this.tokens.copyExpectedToken(_types.TokenType.parenL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(_types.TokenType.parenR);else{for(this.tokens.copyExpectedToken(_types.TokenType.name);this.tokens.matches1(_types.TokenType.dot);)this.tokens.copyExpectedToken(_types.TokenType.dot),this.tokens.copyExpectedToken(_types.TokenType.name);this.tokens.matches1(_types.TokenType.parenL)&&(this.tokens.copyExpectedToken(_types.TokenType.parenL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(_types.TokenType.parenR))}}processExportVar(){this.isSimpleExportVar()?this.processSimpleExportVar():this.processComplexExportVar()}isSimpleExportVar(){let e=this.tokens.currentIndex();if(e++,e++,!this.tokens.matches1AtIndex(e,_types.TokenType.name))return!1;for(e++;e<this.tokens.tokens.length&&this.tokens.tokens[e].isType;)e++;return!!this.tokens.matches1AtIndex(e,_types.TokenType.eq)}processSimpleExportVar(){this.tokens.removeInitialToken(),this.tokens.copyToken();const e=this.tokens.identifierName();for(;!this.tokens.matches1(_types.TokenType.eq);)this.rootTransformer.processToken();const t=this.tokens.currentToken().rhsEndIndex;if(null==t)throw new Error("Expected = token with an end index.");for(;this.tokens.currentIndex()<t;)this.rootTransformer.processToken();this.tokens.appendCode(`; exports.${e} = ${e}`)}processComplexExportVar(){this.tokens.removeInitialToken(),this.tokens.removeToken();const e=this.tokens.matches1(_types.TokenType.braceL);e&&this.tokens.appendCode("(");let t=0;for(;;)if(this.tokens.matches1(_types.TokenType.braceL)||this.tokens.matches1(_types.TokenType.dollarBraceL)||this.tokens.matches1(_types.TokenType.bracketL))t++,this.tokens.copyToken();else if(this.tokens.matches1(_types.TokenType.braceR)||this.tokens.matches1(_types.TokenType.bracketR))t--,this.tokens.copyToken();else{if(0===t&&!this.tokens.matches1(_types.TokenType.name)&&!this.tokens.currentToken().isType)break;if(this.tokens.matches1(_types.TokenType.eq)){const e=this.tokens.currentToken().rhsEndIndex;if(null==e)throw new Error("Expected = token with an end index.");for(;this.tokens.currentIndex()<e;)this.rootTransformer.processToken()}else{const e=this.tokens.currentToken();if(_tokenizer.isDeclaration.call(void 0,e)){const t=this.tokens.identifierName();let s=this.importProcessor.getIdentifierReplacement(t);if(null===s)throw new Error(`Expected a replacement for ${t} in \`export var\` syntax.`);_tokenizer.isObjectShorthandDeclaration.call(void 0,e)&&(s=`${t}: ${s}`),this.tokens.replaceToken(s)}else this.rootTransformer.processToken()}}if(e){const e=this.tokens.currentToken().rhsEndIndex;if(null==e)throw new Error("Expected = token with an end index.");for(;this.tokens.currentIndex()<e;)this.rootTransformer.processToken();this.tokens.appendCode(")")}}processExportFunction(){this.tokens.replaceToken("");const e=this.processNamedFunction();this.tokens.appendCode(` exports.${e} = ${e};`)}processNamedFunction(){if(this.tokens.matches1(_types.TokenType._function))this.tokens.copyToken();else if(this.tokens.matches2(_types.TokenType.name,_types.TokenType._function)){if(!this.tokens.matchesContextual(_keywords.ContextualKeyword._async))throw new Error("Expected async keyword in function export.");this.tokens.copyToken(),this.tokens.copyToken()}if(this.tokens.matches1(_types.TokenType.star)&&this.tokens.copyToken(),!this.tokens.matches1(_types.TokenType.name))throw new Error("Expected identifier for exported function name.");const e=this.tokens.identifierName();if(this.tokens.copyToken(),this.tokens.currentToken().isType)for(this.tokens.removeInitialToken();this.tokens.currentToken().isType;)this.tokens.removeToken();return this.tokens.copyExpectedToken(_types.TokenType.parenL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(_types.TokenType.parenR),this.rootTransformer.processPossibleTypeRange(),this.tokens.copyExpectedToken(_types.TokenType.braceL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(_types.TokenType.braceR),e}processExportClass(){this.tokens.removeInitialToken(),this.copyDecorators(),this.tokens.matches1(_types.TokenType._abstract)&&this.tokens.removeToken();const e=this.rootTransformer.processNamedClass();this.tokens.appendCode(` exports.${e} = ${e};`)}processExportBindings(){this.tokens.removeInitialToken(),this.tokens.removeToken();const e=_isExportFrom2.default.call(void 0,this.tokens),t=[];for(;;){if(this.tokens.matches1(_types.TokenType.braceR)){this.tokens.removeToken();break}const s=_getImportExportSpecifierInfo2.default.call(void 0,this.tokens);for(;this.tokens.currentIndex()<s.endIndex;)this.tokens.removeToken();if(!(s.isType||!e&&this.shouldElideExportedIdentifier(s.leftName))){const e=s.rightName;"default"===e?this.hadDefaultExport=!0:this.hadNamedExport=!0;const o=s.leftName,n=this.importProcessor.getIdentifierReplacement(o);t.push(`exports.${e} = ${n||o};`)}if(this.tokens.matches1(_types.TokenType.braceR)){this.tokens.removeToken();break}if(this.tokens.matches2(_types.TokenType.comma,_types.TokenType.braceR)){this.tokens.removeToken(),this.tokens.removeToken();break}if(!this.tokens.matches1(_types.TokenType.comma))throw new Error(`Unexpected token: ${JSON.stringify(this.tokens.currentToken())}`);this.tokens.removeToken()}if(this.tokens.matchesContextual(_keywords.ContextualKeyword._from)){this.tokens.removeToken();const e=this.tokens.stringValue();this.tokens.replaceTokenTrimmingLeftWhitespace(this.importProcessor.claimImportCode(e)),_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens)}else this.tokens.appendCode(t.join(" "));this.tokens.matches1(_types.TokenType.semi)&&this.tokens.removeToken()}processExportStar(){for(this.tokens.removeInitialToken();!this.tokens.matches1(_types.TokenType.string);)this.tokens.removeToken();const e=this.tokens.stringValue();this.tokens.replaceTokenTrimmingLeftWhitespace(this.importProcessor.claimImportCode(e)),_removeMaybeImportAttributes.removeMaybeImportAttributes.call(void 0,this.tokens),this.tokens.matches1(_types.TokenType.semi)&&this.tokens.removeToken()}shouldElideExportedIdentifier(e){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&!this.declarationInfo.valueDeclarations.has(e)}}exports.default=CJSImportTransformer;