"use strict";function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}Object.defineProperty(exports,"__esModule",{value:!0});var _tokenizer=require("./parser/tokenizer"),_keywords=require("./parser/tokenizer/keywords"),_types=require("./parser/tokenizer/types"),_getImportExportSpecifierInfo=require("./util/getImportExportSpecifierInfo"),_getImportExportSpecifierInfo2=_interopRequireDefault(_getImportExportSpecifierInfo),_getNonTypeIdentifiers=require("./util/getNonTypeIdentifiers");class CJSImportProcessor{__init(){this.nonTypeIdentifiers=new Set}__init2(){this.importInfoByPath=new Map}__init3(){this.importsToReplace=new Map}__init4(){this.identifierReplacements=new Map}__init5(){this.exportBindingsByLocalName=new Map}constructor(e,t,s,n,o,r,i){this.nameManager=e,this.tokens=t,this.enableLegacyTypeScriptModuleInterop=s,this.options=n,this.isTypeScriptTransformEnabled=o,this.keepUnusedImports=r,this.helperManager=i,CJSImportProcessor.prototype.__init.call(this),CJSImportProcessor.prototype.__init2.call(this),CJSImportProcessor.prototype.__init3.call(this),CJSImportProcessor.prototype.__init4.call(this),CJSImportProcessor.prototype.__init5.call(this)}preprocessTokens(){for(let e=0;e<this.tokens.tokens.length;e++)this.tokens.matches1AtIndex(e,_types.TokenType._import)&&!this.tokens.matches3AtIndex(e,_types.TokenType._import,_types.TokenType.name,_types.TokenType.eq)&&this.preprocessImportAtIndex(e),this.tokens.matches1AtIndex(e,_types.TokenType._export)&&!this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType.eq)&&this.preprocessExportAtIndex(e);this.generateImportReplacements()}pruneTypeOnlyImports(){this.nonTypeIdentifiers=_getNonTypeIdentifiers.getNonTypeIdentifiers.call(void 0,this.tokens,this.options);for(const[e,t]of this.importInfoByPath.entries())t.hasBareImport||t.hasStarExport||t.exportStarNames.length>0||t.namedExports.length>0||[...t.defaultNames,...t.wildcardNames,...t.namedImports.map(({localName:e})=>e)].every(e=>this.shouldAutomaticallyElideImportedName(e))&&this.importsToReplace.set(e,"")}shouldAutomaticallyElideImportedName(e){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&!this.nonTypeIdentifiers.has(e)}generateImportReplacements(){for(const[e,t]of this.importInfoByPath.entries()){const{defaultNames:s,wildcardNames:n,namedImports:o,namedExports:r,exportStarNames:i,hasStarExport:p}=t;if(0===s.length&&0===n.length&&0===o.length&&0===r.length&&0===i.length&&!p){this.importsToReplace.set(e,`require('${e}');`);continue}const a=this.getFreeIdentifierForPath(e);let h;h=this.enableLegacyTypeScriptModuleInterop?a:n.length>0?n[0]:this.getFreeIdentifierForPath(e);let m=`var ${a} = require('${e}');`;if(n.length>0)for(const e of n)m+=` var ${e} = ${this.enableLegacyTypeScriptModuleInterop?a:`${this.helperManager.getHelperName("interopRequireWildcard")}(${a})`};`;else i.length>0&&h!==a?m+=` var ${h} = ${this.helperManager.getHelperName("interopRequireWildcard")}(${a});`:s.length>0&&h!==a&&(m+=` var ${h} = ${this.helperManager.getHelperName("interopRequireDefault")}(${a});`);for(const{importedName:e,localName:t}of r)m+=` ${this.helperManager.getHelperName("createNamedExportFrom")}(${a}, '${t}', '${e}');`;for(const e of i)m+=` exports.${e} = ${h};`;p&&(m+=` ${this.helperManager.getHelperName("createStarExport")}(${a});`),this.importsToReplace.set(e,m);for(const e of s)this.identifierReplacements.set(e,`${h}.default`);for(const{importedName:e,localName:t}of o)this.identifierReplacements.set(t,`${a}.${e}`)}}getFreeIdentifierForPath(e){const t=e.split("/"),s=t[t.length-1].replace(/\W/g,"");return this.nameManager.claimFreeName(`_${s}`)}preprocessImportAtIndex(e){const t=[],s=[],n=[];if(e++,(this.tokens.matchesContextualAtIndex(e,_keywords.ContextualKeyword._type)||this.tokens.matches1AtIndex(e,_types.TokenType._typeof))&&!this.tokens.matches1AtIndex(e+1,_types.TokenType.comma)&&!this.tokens.matchesContextualAtIndex(e+1,_keywords.ContextualKeyword._from))return;if(this.tokens.matches1AtIndex(e,_types.TokenType.parenL))return;if(this.tokens.matches1AtIndex(e,_types.TokenType.name)&&(t.push(this.tokens.identifierNameAtIndex(e)),e++,this.tokens.matches1AtIndex(e,_types.TokenType.comma)&&e++),this.tokens.matches1AtIndex(e,_types.TokenType.star)&&(e+=2,s.push(this.tokens.identifierNameAtIndex(e)),e++),this.tokens.matches1AtIndex(e,_types.TokenType.braceL)){const s=this.getNamedImports(e+1);e=s.newIndex;for(const e of s.namedImports)"default"===e.importedName?t.push(e.localName):n.push(e)}if(this.tokens.matchesContextualAtIndex(e,_keywords.ContextualKeyword._from)&&e++,!this.tokens.matches1AtIndex(e,_types.TokenType.string))throw new Error("Expected string token at the end of import statement.");const o=this.tokens.stringValueAtIndex(e),r=this.getImportInfo(o);r.defaultNames.push(...t),r.wildcardNames.push(...s),r.namedImports.push(...n),0===t.length&&0===s.length&&0===n.length&&(r.hasBareImport=!0)}preprocessExportAtIndex(e){if(this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType._var)||this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType._let)||this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType._const))this.preprocessVarExportAtIndex(e);else if(this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType._function)||this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType._class)){const t=this.tokens.identifierNameAtIndex(e+2);this.addExportBinding(t,t)}else if(this.tokens.matches3AtIndex(e,_types.TokenType._export,_types.TokenType.name,_types.TokenType._function)){const t=this.tokens.identifierNameAtIndex(e+3);this.addExportBinding(t,t)}else this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType.braceL)?this.preprocessNamedExportAtIndex(e):this.tokens.matches2AtIndex(e,_types.TokenType._export,_types.TokenType.star)&&this.preprocessExportStarAtIndex(e)}preprocessVarExportAtIndex(e){let t=0;for(let s=e+2;;s++)if(this.tokens.matches1AtIndex(s,_types.TokenType.braceL)||this.tokens.matches1AtIndex(s,_types.TokenType.dollarBraceL)||this.tokens.matches1AtIndex(s,_types.TokenType.bracketL))t++;else if(this.tokens.matches1AtIndex(s,_types.TokenType.braceR)||this.tokens.matches1AtIndex(s,_types.TokenType.bracketR))t--;else{if(0===t&&!this.tokens.matches1AtIndex(s,_types.TokenType.name))break;if(this.tokens.matches1AtIndex(1,_types.TokenType.eq)){const e=this.tokens.currentToken().rhsEndIndex;if(null==e)throw new Error("Expected = token with an end index.");s=e-1}else{const e=this.tokens.tokens[s];if(_tokenizer.isDeclaration.call(void 0,e)){const e=this.tokens.identifierNameAtIndex(s);this.identifierReplacements.set(e,`exports.${e}`)}}}}preprocessNamedExportAtIndex(e){e+=2;const{newIndex:t,namedImports:s}=this.getNamedImports(e);if(e=t,!this.tokens.matchesContextualAtIndex(e,_keywords.ContextualKeyword._from)){for(const{importedName:e,localName:t}of s)this.addExportBinding(e,t);return}if(e++,!this.tokens.matches1AtIndex(e,_types.TokenType.string))throw new Error("Expected string token at the end of import statement.");const n=this.tokens.stringValueAtIndex(e);this.getImportInfo(n).namedExports.push(...s)}preprocessExportStarAtIndex(e){let t=null;if(this.tokens.matches3AtIndex(e,_types.TokenType._export,_types.TokenType.star,_types.TokenType._as)?(e+=3,t=this.tokens.identifierNameAtIndex(e),e+=2):e+=3,!this.tokens.matches1AtIndex(e,_types.TokenType.string))throw new Error("Expected string token at the end of star export statement.");const s=this.tokens.stringValueAtIndex(e),n=this.getImportInfo(s);null!==t?n.exportStarNames.push(t):n.hasStarExport=!0}getNamedImports(e){const t=[];for(;;){if(this.tokens.matches1AtIndex(e,_types.TokenType.braceR)){e++;break}const s=_getImportExportSpecifierInfo2.default.call(void 0,this.tokens,e);if(e=s.endIndex,s.isType||t.push({importedName:s.leftName,localName:s.rightName}),this.tokens.matches2AtIndex(e,_types.TokenType.comma,_types.TokenType.braceR)){e+=2;break}if(this.tokens.matches1AtIndex(e,_types.TokenType.braceR)){e++;break}if(!this.tokens.matches1AtIndex(e,_types.TokenType.comma))throw new Error(`Unexpected token: ${JSON.stringify(this.tokens.tokens[e])}`);e++}return{newIndex:e,namedImports:t}}getImportInfo(e){const t=this.importInfoByPath.get(e);if(t)return t;const s={defaultNames:[],wildcardNames:[],namedImports:[],namedExports:[],hasBareImport:!1,exportStarNames:[],hasStarExport:!1};return this.importInfoByPath.set(e,s),s}addExportBinding(e,t){this.exportBindingsByLocalName.has(e)||this.exportBindingsByLocalName.set(e,[]),this.exportBindingsByLocalName.get(e).push(t)}claimImportCode(e){const t=this.importsToReplace.get(e);return this.importsToReplace.set(e,""),t||""}getIdentifierReplacement(e){return this.identifierReplacements.get(e)||null}resolveExportBinding(e){const t=this.exportBindingsByLocalName.get(e);return t&&0!==t.length?t.map(e=>`exports.${e}`).join(" = "):null}getGlobalNames(){return new Set([...this.identifierReplacements.keys(),...this.exportBindingsByLocalName.keys()])}}exports.default=CJSImportProcessor;