import{File}from"../index";import{flowAfterParseClassSuper,flowAfterParseVarHead,flowParseExportDeclaration,flowParseExportStar,flowParseIdentifierStatement,flowParseImportSpecifier,flowParseTypeAnnotation,flowParseTypeParameterDeclaration,flowShouldDisallowExportDefaultSpecifier,flowShouldParseExportDeclaration,flowShouldParseExportStar,flowStartParseFunctionParams,flowStartParseImportSpecifiers,flowTryParseExportDefaultExpression,flowTryParseStatement}from"../plugins/flow";import{tsAfterParseClassSuper,tsAfterParseVarHead,tsIsDeclarationStart,tsParseExportDeclaration,tsParseExportSpecifier,tsParseIdentifierStatement,tsParseImportEqualsDeclaration,tsParseImportSpecifier,tsParseMaybeDecoratorArguments,tsParseModifiers,tsStartParseFunctionParams,tsTryParseClassMemberWithIsStatic,tsTryParseExport,tsTryParseExportDefaultExpression,tsTryParseStatementContent,tsTryParseTypeAnnotation,tsTryParseTypeParameters}from"../plugins/typescript";import{eat,eatTypeToken,IdentifierRole,lookaheadType,lookaheadTypeAndKeyword,match,next,nextTokenStart,nextTokenStartSince,popTypeContext,pushTypeContext}from"../tokenizer";import{ContextualKeyword}from"../tokenizer/keywords";import{Scope}from"../tokenizer/state";import{TokenType as tt}from"../tokenizer/types";import{charCodes}from"../util/charcodes";import{getNextContextId,input,isFlowEnabled,isTypeScriptEnabled,state}from"./base";import{parseCallExpressionArguments,parseExprAtom,parseExpression,parseExprSubscripts,parseFunctionBodyAndFinish,parseIdentifier,parseMaybeAssign,parseMethod,parseObj,parseParenExpression,parsePropertyName}from"./expression";import{parseBindingAtom,parseBindingIdentifier,parseBindingList,parseImportedIdentifier}from"./lval";import{canInsertSemicolon,eatContextual,expect,expectContextual,hasFollowingLineBreak,hasPrecedingLineBreak,isContextual,isLineTerminator,isLookaheadContextual,semicolon,unexpected}from"./util";export function parseTopLevel(){if(parseBlockBody(tt.eof),state.scopes.push(new Scope(0,state.tokens.length,!0)),0!==state.scopeDepth)throw new Error(`Invalid scope depth at end of file: ${state.scopeDepth}`);return new File(state.tokens,state.scopes)}export function parseStatement(t){isFlowEnabled&&flowTryParseStatement()||(match(tt.at)&&parseDecorators(),parseStatementContent(t))}function parseStatementContent(t){if(isTypeScriptEnabled&&tsTryParseStatementContent())return;const e=state.type;switch(e){case tt._break:case tt._continue:return void parseBreakContinueStatement();case tt._debugger:return void parseDebuggerStatement();case tt._do:return void parseDoStatement();case tt._for:return void parseForStatement();case tt._function:if(lookaheadType()===tt.dot)break;return t||unexpected(),void parseFunctionStatement();case tt._class:return t||unexpected(),void parseClass(!0);case tt._if:return void parseIfStatement();case tt._return:return void parseReturnStatement();case tt._switch:return void parseSwitchStatement();case tt._throw:return void parseThrowStatement();case tt._try:return void parseTryStatement();case tt._let:case tt._const:t||unexpected();case tt._var:return void parseVarStatement(e!==tt._var);case tt._while:return void parseWhileStatement();case tt.braceL:return void parseBlock();case tt.semi:return void parseEmptyStatement();case tt._export:case tt._import:{const t=lookaheadType();if(t===tt.parenL||t===tt.dot)break;return next(),void(e===tt._import?parseImport():parseExport())}case tt.name:if(state.contextualKeyword===ContextualKeyword._async){const t=state.start,e=state.snapshot();if(next(),match(tt._function)&&!canInsertSemicolon())return expect(tt._function),void parseFunction(t,!0);state.restoreFromSnapshot(e)}else{if(state.contextualKeyword===ContextualKeyword._using&&!hasFollowingLineBreak()&&lookaheadType()===tt.name)return void parseVarStatement(!0);if(startsAwaitUsing())return expectContextual(ContextualKeyword._await),void parseVarStatement(!0)}}const a=state.tokens.length;parseExpression();let r=null;if(state.tokens.length===a+1){const t=state.tokens[state.tokens.length-1];t.type===tt.name&&(r=t.contextualKeyword)}null!=r?eat(tt.colon)?parseLabeledStatement():parseIdentifierStatement(r):semicolon()}function startsAwaitUsing(){if(!isContextual(ContextualKeyword._await))return!1;const t=state.snapshot();return next(),!isContextual(ContextualKeyword._using)||hasPrecedingLineBreak()?(state.restoreFromSnapshot(t),!1):(next(),!match(tt.name)||hasPrecedingLineBreak()?(state.restoreFromSnapshot(t),!1):(state.restoreFromSnapshot(t),!0))}export function parseDecorators(){for(;match(tt.at);)parseDecorator()}function parseDecorator(){if(next(),eat(tt.parenL))parseExpression(),expect(tt.parenR);else{for(parseIdentifier();eat(tt.dot);)parseIdentifier();parseMaybeDecoratorArguments()}}function parseMaybeDecoratorArguments(){isTypeScriptEnabled?tsParseMaybeDecoratorArguments():baseParseMaybeDecoratorArguments()}export function baseParseMaybeDecoratorArguments(){eat(tt.parenL)&&parseCallExpressionArguments()}function parseBreakContinueStatement(){next(),isLineTerminator()||(parseIdentifier(),semicolon())}function parseDebuggerStatement(){next(),semicolon()}function parseDoStatement(){next(),parseStatement(!1),expect(tt._while),parseParenExpression(),eat(tt.semi)}function parseForStatement(){state.scopeDepth++;const t=state.tokens.length;parseAmbiguousForStatement();const e=state.tokens.length;state.scopes.push(new Scope(t,e,!1)),state.scopeDepth--}function isUsingInLoop(){return!!isContextual(ContextualKeyword._using)&&!isLookaheadContextual(ContextualKeyword._of)}function parseAmbiguousForStatement(){next();let t=!1;if(isContextual(ContextualKeyword._await)&&(t=!0,next()),expect(tt.parenL),match(tt.semi))return t&&unexpected(),void parseFor();const e=startsAwaitUsing();if(e||match(tt._var)||match(tt._let)||match(tt._const)||isUsingInLoop())return e&&expectContextual(ContextualKeyword._await),next(),parseVar(!0,state.type!==tt._var),match(tt._in)||isContextual(ContextualKeyword._of)?void parseForIn(t):void parseFor();parseExpression(!0),match(tt._in)||isContextual(ContextualKeyword._of)?parseForIn(t):(t&&unexpected(),parseFor())}function parseFunctionStatement(){const t=state.start;next(),parseFunction(t,!0)}function parseIfStatement(){next(),parseParenExpression(),parseStatement(!1),eat(tt._else)&&parseStatement(!1)}function parseReturnStatement(){next(),isLineTerminator()||(parseExpression(),semicolon())}function parseSwitchStatement(){next(),parseParenExpression(),state.scopeDepth++;const t=state.tokens.length;for(expect(tt.braceL);!match(tt.braceR)&&!state.error;)if(match(tt._case)||match(tt._default)){const t=match(tt._case);next(),t&&parseExpression(),expect(tt.colon)}else parseStatement(!0);next();const e=state.tokens.length;state.scopes.push(new Scope(t,e,!1)),state.scopeDepth--}function parseThrowStatement(){next(),parseExpression(),semicolon()}function parseCatchClauseParam(){parseBindingAtom(!0),isTypeScriptEnabled&&tsTryParseTypeAnnotation()}function parseTryStatement(){if(next(),parseBlock(),match(tt._catch)){next();let t=null;if(match(tt.parenL)&&(state.scopeDepth++,t=state.tokens.length,expect(tt.parenL),parseCatchClauseParam(),expect(tt.parenR)),parseBlock(),null!=t){const e=state.tokens.length;state.scopes.push(new Scope(t,e,!1)),state.scopeDepth--}}eat(tt._finally)&&parseBlock()}export function parseVarStatement(t){next(),parseVar(!1,t),semicolon()}function parseWhileStatement(){next(),parseParenExpression(),parseStatement(!1)}function parseEmptyStatement(){next()}function parseLabeledStatement(){parseStatement(!0)}function parseIdentifierStatement(t){isTypeScriptEnabled?tsParseIdentifierStatement(t):isFlowEnabled?flowParseIdentifierStatement(t):semicolon()}export function parseBlock(t=!1,e=0){const a=state.tokens.length;state.scopeDepth++,expect(tt.braceL),e&&(state.tokens[state.tokens.length-1].contextId=e),parseBlockBody(tt.braceR),e&&(state.tokens[state.tokens.length-1].contextId=e);const r=state.tokens.length;state.scopes.push(new Scope(a,r,t)),state.scopeDepth--}export function parseBlockBody(t){for(;!eat(t)&&!state.error;)parseStatement(!0)}function parseFor(){expect(tt.semi),match(tt.semi)||parseExpression(),expect(tt.semi),match(tt.parenR)||parseExpression(),expect(tt.parenR),parseStatement(!1)}function parseForIn(t){t?eatContextual(ContextualKeyword._of):next(),parseExpression(),expect(tt.parenR),parseStatement(!1)}function parseVar(t,e){for(;;){if(parseVarHead(e),eat(tt.eq)){const e=state.tokens.length-1;parseMaybeAssign(t),state.tokens[e].rhsEndIndex=state.tokens.length}if(!eat(tt.comma))break}}function parseVarHead(t){parseBindingAtom(t),isTypeScriptEnabled?tsAfterParseVarHead():isFlowEnabled&&flowAfterParseVarHead()}export function parseFunction(t,e,a=!1){match(tt.star)&&next(),!e||a||match(tt.name)||match(tt._yield)||unexpected();let r=null;match(tt.name)&&(e||(r=state.tokens.length,state.scopeDepth++),parseBindingIdentifier(!1));const s=state.tokens.length;state.scopeDepth++,parseFunctionParams(),parseFunctionBodyAndFinish(t);const o=state.tokens.length;state.scopes.push(new Scope(s,o,!0)),state.scopeDepth--,null!==r&&(state.scopes.push(new Scope(r,o,!0)),state.scopeDepth--)}export function parseFunctionParams(t=!1,e=0){isTypeScriptEnabled?tsStartParseFunctionParams():isFlowEnabled&&flowStartParseFunctionParams(),expect(tt.parenL),e&&(state.tokens[state.tokens.length-1].contextId=e),parseBindingList(tt.parenR,!1,!1,t,e),e&&(state.tokens[state.tokens.length-1].contextId=e)}export function parseClass(t,e=!1){const a=getNextContextId();next(),state.tokens[state.tokens.length-1].contextId=a,state.tokens[state.tokens.length-1].isExpression=!t;let r=null;t||(r=state.tokens.length,state.scopeDepth++),parseClassId(t,e),parseClassSuper();const s=state.tokens.length;if(parseClassBody(a),!state.error&&(state.tokens[s].contextId=a,state.tokens[state.tokens.length-1].contextId=a,null!==r)){const t=state.tokens.length;state.scopes.push(new Scope(r,t,!1)),state.scopeDepth--}}function isClassProperty(){return match(tt.eq)||match(tt.semi)||match(tt.braceR)||match(tt.bang)||match(tt.colon)}function isClassMethod(){return match(tt.parenL)||match(tt.lessThan)}function parseClassBody(t){for(expect(tt.braceL);!eat(tt.braceR)&&!state.error;){if(eat(tt.semi))continue;if(match(tt.at)){parseDecorator();continue}parseClassMember(state.start,t)}}function parseClassMember(t,e){isTypeScriptEnabled&&tsParseModifiers([ContextualKeyword._declare,ContextualKeyword._public,ContextualKeyword._protected,ContextualKeyword._private,ContextualKeyword._override]);let a=!1;if(match(tt.name)&&state.contextualKeyword===ContextualKeyword._static){if(parseIdentifier(),isClassMethod())return void parseClassMethod(t,!1);if(isClassProperty())return void parseClassProperty();if(state.tokens[state.tokens.length-1].type=tt._static,a=!0,match(tt.braceL))return state.tokens[state.tokens.length-1].contextId=e,void parseBlock()}parseClassMemberWithIsStatic(t,a,e)}function parseClassMemberWithIsStatic(t,e,a){if(isTypeScriptEnabled&&tsTryParseClassMemberWithIsStatic(e))return;if(eat(tt.star))return parseClassPropertyName(a),void parseClassMethod(t,!1);parseClassPropertyName(a);let r=!1;const s=state.tokens[state.tokens.length-1];if(s.contextualKeyword===ContextualKeyword._constructor&&(r=!0),parsePostMemberNameModifiers(),isClassMethod())parseClassMethod(t,r);else if(isClassProperty())parseClassProperty();else if(s.contextualKeyword!==ContextualKeyword._async||isLineTerminator())s.contextualKeyword!==ContextualKeyword._get&&s.contextualKeyword!==ContextualKeyword._set||isLineTerminator()&&match(tt.star)?s.contextualKeyword!==ContextualKeyword._accessor||isLineTerminator()?isLineTerminator()?parseClassProperty():unexpected():(parseClassPropertyName(a),parseClassProperty()):(s.contextualKeyword===ContextualKeyword._get?state.tokens[state.tokens.length-1].type=tt._get:state.tokens[state.tokens.length-1].type=tt._set,parseClassPropertyName(a),parseClassMethod(t,!1));else{state.tokens[state.tokens.length-1].type=tt._async;match(tt.star)&&next(),parseClassPropertyName(a),parsePostMemberNameModifiers(),parseClassMethod(t,!1)}}function parseClassMethod(t,e){isTypeScriptEnabled?tsTryParseTypeParameters():isFlowEnabled&&match(tt.lessThan)&&flowParseTypeParameterDeclaration(),parseMethod(t,e)}export function parseClassPropertyName(t){parsePropertyName(t)}export function parsePostMemberNameModifiers(){if(isTypeScriptEnabled){const t=pushTypeContext(0);eat(tt.question),popTypeContext(t)}}export function parseClassProperty(){if(isTypeScriptEnabled?(eatTypeToken(tt.bang),tsTryParseTypeAnnotation()):isFlowEnabled&&match(tt.colon)&&flowParseTypeAnnotation(),match(tt.eq)){const t=state.tokens.length;next(),parseMaybeAssign(),state.tokens[t].rhsEndIndex=state.tokens.length}semicolon()}function parseClassId(t,e=!1){isTypeScriptEnabled&&(!t||e)&&isContextual(ContextualKeyword._implements)||(match(tt.name)&&parseBindingIdentifier(!0),isTypeScriptEnabled?tsTryParseTypeParameters():isFlowEnabled&&match(tt.lessThan)&&flowParseTypeParameterDeclaration())}function parseClassSuper(){let t=!1;eat(tt._extends)?(parseExprSubscripts(),t=!0):t=!1,isTypeScriptEnabled?tsAfterParseClassSuper(t):isFlowEnabled&&flowAfterParseClassSuper(t)}export function parseExport(){const t=state.tokens.length-1;isTypeScriptEnabled&&tsTryParseExport()||(shouldParseExportStar()?parseExportStar():isExportDefaultSpecifier()?(parseIdentifier(),match(tt.comma)&&lookaheadType()===tt.star?(expect(tt.comma),expect(tt.star),expectContextual(ContextualKeyword._as),parseIdentifier()):parseExportSpecifiersMaybe(),parseExportFrom()):eat(tt._default)?parseExportDefaultExpression():shouldParseExportDeclaration()?parseExportDeclaration():(parseExportSpecifiers(),parseExportFrom()),state.tokens[t].rhsEndIndex=state.tokens.length)}function parseExportDefaultExpression(){if(isTypeScriptEnabled&&tsTryParseExportDefaultExpression())return;if(isFlowEnabled&&flowTryParseExportDefaultExpression())return;const t=state.start;eat(tt._function)?parseFunction(t,!0,!0):isContextual(ContextualKeyword._async)&&lookaheadType()===tt._function?(eatContextual(ContextualKeyword._async),eat(tt._function),parseFunction(t,!0,!0)):match(tt._class)?parseClass(!0,!0):match(tt.at)?(parseDecorators(),parseClass(!0,!0)):(parseMaybeAssign(),semicolon())}function parseExportDeclaration(){isTypeScriptEnabled?tsParseExportDeclaration():isFlowEnabled?flowParseExportDeclaration():parseStatement(!0)}function isExportDefaultSpecifier(){if(isTypeScriptEnabled&&tsIsDeclarationStart())return!1;if(isFlowEnabled&&flowShouldDisallowExportDefaultSpecifier())return!1;if(match(tt.name))return state.contextualKeyword!==ContextualKeyword._async;if(!match(tt._default))return!1;const t=nextTokenStart(),e=lookaheadTypeAndKeyword(),a=e.type===tt.name&&e.contextualKeyword===ContextualKeyword._from;if(e.type===tt.comma)return!0;if(a){const e=input.charCodeAt(nextTokenStartSince(t+4));return e===charCodes.quotationMark||e===charCodes.apostrophe}return!1}function parseExportSpecifiersMaybe(){eat(tt.comma)&&parseExportSpecifiers()}export function parseExportFrom(){eatContextual(ContextualKeyword._from)&&(parseExprAtom(),maybeParseImportAttributes()),semicolon()}function shouldParseExportStar(){return isFlowEnabled?flowShouldParseExportStar():match(tt.star)}function parseExportStar(){isFlowEnabled?flowParseExportStar():baseParseExportStar()}export function baseParseExportStar(){expect(tt.star),isContextual(ContextualKeyword._as)?parseExportNamespace():parseExportFrom()}function parseExportNamespace(){next(),state.tokens[state.tokens.length-1].type=tt._as,parseIdentifier(),parseExportSpecifiersMaybe(),parseExportFrom()}function shouldParseExportDeclaration(){return isTypeScriptEnabled&&tsIsDeclarationStart()||isFlowEnabled&&flowShouldParseExportDeclaration()||state.type===tt._var||state.type===tt._const||state.type===tt._let||state.type===tt._function||state.type===tt._class||isContextual(ContextualKeyword._async)||match(tt.at)}export function parseExportSpecifiers(){let t=!0;for(expect(tt.braceL);!eat(tt.braceR)&&!state.error;){if(t)t=!1;else if(expect(tt.comma),eat(tt.braceR))break;parseExportSpecifier()}}function parseExportSpecifier(){isTypeScriptEnabled?tsParseExportSpecifier():(parseIdentifier(),state.tokens[state.tokens.length-1].identifierRole=IdentifierRole.ExportAccess,eatContextual(ContextualKeyword._as)&&parseIdentifier())}function isImportReflection(){const t=state.snapshot();return expectContextual(ContextualKeyword._module),eatContextual(ContextualKeyword._from)?isContextual(ContextualKeyword._from)?(state.restoreFromSnapshot(t),!0):(state.restoreFromSnapshot(t),!1):match(tt.comma)?(state.restoreFromSnapshot(t),!1):(state.restoreFromSnapshot(t),!0)}function parseMaybeImportReflection(){isContextual(ContextualKeyword._module)&&isImportReflection()&&next()}export function parseImport(){if(isTypeScriptEnabled&&match(tt.name)&&lookaheadType()===tt.eq)tsParseImportEqualsDeclaration();else{if(isTypeScriptEnabled&&isContextual(ContextualKeyword._type)){const t=lookaheadTypeAndKeyword();if(t.type===tt.name&&t.contextualKeyword!==ContextualKeyword._from){if(expectContextual(ContextualKeyword._type),lookaheadType()===tt.eq)return void tsParseImportEqualsDeclaration()}else t.type!==tt.star&&t.type!==tt.braceL||expectContextual(ContextualKeyword._type)}match(tt.string)||(parseMaybeImportReflection(),parseImportSpecifiers(),expectContextual(ContextualKeyword._from)),parseExprAtom(),maybeParseImportAttributes(),semicolon()}}function shouldParseDefaultImport(){return match(tt.name)}function parseImportSpecifierLocal(){parseImportedIdentifier()}function parseImportSpecifiers(){isFlowEnabled&&flowStartParseImportSpecifiers();let t=!0;if(!shouldParseDefaultImport()||(parseImportSpecifierLocal(),eat(tt.comma))){if(match(tt.star))return next(),expectContextual(ContextualKeyword._as),void parseImportSpecifierLocal();for(expect(tt.braceL);!eat(tt.braceR)&&!state.error;){if(t)t=!1;else if(eat(tt.colon)&&unexpected("ES2015 named imports do not destructure. Use another statement for destructuring after the import."),expect(tt.comma),eat(tt.braceR))break;parseImportSpecifier()}}}function parseImportSpecifier(){isTypeScriptEnabled?tsParseImportSpecifier():isFlowEnabled?flowParseImportSpecifier():(parseImportedIdentifier(),isContextual(ContextualKeyword._as)&&(state.tokens[state.tokens.length-1].identifierRole=IdentifierRole.ImportAccess,next(),parseImportedIdentifier()))}function maybeParseImportAttributes(){(match(tt._with)||isContextual(ContextualKeyword._assert)&&!hasPrecedingLineBreak())&&(next(),parseObj(!1,!1))}