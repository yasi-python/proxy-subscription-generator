import{input,isFlowEnabled,state}from"../traverser/base";import{unexpected}from"../traverser/util";import{charCodes}from"../util/charcodes";import{IS_IDENTIFIER_CHAR,IS_IDENTIFIER_START}from"../util/identifier";import{IS_WHITESPACE,skipWhiteSpace}from"../util/whitespace";import{ContextualKeyword}from"./keywords";import readWord from"./readWord";import{TokenType as tt}from"./types";export var IdentifierRole;!function(e){e[e.Access=0]="Access",e[e.ExportAccess=1]="ExportAccess",e[e.TopLevelDeclaration=2]="TopLevelDeclaration",e[e.FunctionScopedDeclaration=3]="FunctionScopedDeclaration",e[e.BlockScopedDeclaration=4]="BlockScopedDeclaration",e[e.ObjectShorthandTopLevelDeclaration=5]="ObjectShorthandTopLevelDeclaration",e[e.ObjectShorthandFunctionScopedDeclaration=6]="ObjectShorthandFunctionScopedDeclaration",e[e.ObjectShorthandBlockScopedDeclaration=7]="ObjectShorthandBlockScopedDeclaration",e[e.ObjectShorthand=8]="ObjectShorthand",e[e.ImportDeclaration=9]="ImportDeclaration",e[e.ObjectKey=10]="ObjectKey",e[e.ImportAccess=11]="ImportAccess"}(IdentifierRole||(IdentifierRole={}));export var JSXRole;!function(e){e[e.NoChildren=0]="NoChildren",e[e.OneChild=1]="OneChild",e[e.StaticChildren=2]="StaticChildren",e[e.KeyAfterPropSpread=3]="KeyAfterPropSpread"}(JSXRole||(JSXRole={}));export function isDeclaration(e){const t=e.identifierRole;return t===IdentifierRole.TopLevelDeclaration||t===IdentifierRole.FunctionScopedDeclaration||t===IdentifierRole.BlockScopedDeclaration||t===IdentifierRole.ObjectShorthandTopLevelDeclaration||t===IdentifierRole.ObjectShorthandFunctionScopedDeclaration||t===IdentifierRole.ObjectShorthandBlockScopedDeclaration}export function isNonTopLevelDeclaration(e){const t=e.identifierRole;return t===IdentifierRole.FunctionScopedDeclaration||t===IdentifierRole.BlockScopedDeclaration||t===IdentifierRole.ObjectShorthandFunctionScopedDeclaration||t===IdentifierRole.ObjectShorthandBlockScopedDeclaration}export function isTopLevelDeclaration(e){const t=e.identifierRole;return t===IdentifierRole.TopLevelDeclaration||t===IdentifierRole.ObjectShorthandTopLevelDeclaration||t===IdentifierRole.ImportDeclaration}export function isBlockScopedDeclaration(e){const t=e.identifierRole;return t===IdentifierRole.TopLevelDeclaration||t===IdentifierRole.BlockScopedDeclaration||t===IdentifierRole.ObjectShorthandTopLevelDeclaration||t===IdentifierRole.ObjectShorthandBlockScopedDeclaration}export function isFunctionScopedDeclaration(e){const t=e.identifierRole;return t===IdentifierRole.FunctionScopedDeclaration||t===IdentifierRole.ObjectShorthandFunctionScopedDeclaration}export function isObjectShorthandDeclaration(e){return e.identifierRole===IdentifierRole.ObjectShorthandTopLevelDeclaration||e.identifierRole===IdentifierRole.ObjectShorthandBlockScopedDeclaration||e.identifierRole===IdentifierRole.ObjectShorthandFunctionScopedDeclaration}export class Token{constructor(){this.type=state.type,this.contextualKeyword=state.contextualKeyword,this.start=state.start,this.end=state.end,this.scopeDepth=state.scopeDepth,this.isType=state.isType,this.identifierRole=null,this.jsxRole=null,this.shadowsGlobal=!1,this.isAsyncOperation=!1,this.contextId=null,this.rhsEndIndex=null,this.isExpression=!1,this.numNullishCoalesceStarts=0,this.numNullishCoalesceEnds=0,this.isOptionalChainStart=!1,this.isOptionalChainEnd=!1,this.subscriptStartIndex=null,this.nullishStartIndex=null}}export function next(){state.tokens.push(new Token),nextToken()}export function nextTemplateToken(){state.tokens.push(new Token),state.start=state.pos,readTmplToken()}export function retokenizeSlashAsRegex(){state.type===tt.assign&&--state.pos,readRegexp()}export function pushTypeContext(e){for(let t=state.tokens.length-e;t<state.tokens.length;t++)state.tokens[t].isType=!0;const t=state.isType;return state.isType=!0,t}export function popTypeContext(e){state.isType=e}export function eat(e){return!!match(e)&&(next(),!0)}export function eatTypeToken(e){const t=state.isType;state.isType=!0,eat(e),state.isType=t}export function match(e){return state.type===e}export function lookaheadType(){const e=state.snapshot();next();const t=state.type;return state.restoreFromSnapshot(e),t}export class TypeAndKeyword{constructor(e,t){this.type=e,this.contextualKeyword=t}}export function lookaheadTypeAndKeyword(){const e=state.snapshot();next();const t=state.type,o=state.contextualKeyword;return state.restoreFromSnapshot(e),new TypeAndKeyword(t,o)}export function nextTokenStart(){return nextTokenStartSince(state.pos)}export function nextTokenStartSince(e){return skipWhiteSpace.lastIndex=e,e+skipWhiteSpace.exec(input)[0].length}export function lookaheadCharCode(){return input.charCodeAt(nextTokenStart())}export function nextToken(){if(skipSpace(),state.start=state.pos,state.pos>=input.length){const e=state.tokens;return e.length>=2&&e[e.length-1].start>=input.length&&e[e.length-2].start>=input.length&&unexpected("Unexpectedly reached the end of input."),void finishToken(tt.eof)}readToken(input.charCodeAt(state.pos))}function readToken(e){IS_IDENTIFIER_START[e]||e===charCodes.backslash||e===charCodes.atSign&&input.charCodeAt(state.pos+1)===charCodes.atSign?readWord():getTokenFromCode(e)}function skipBlockComment(){for(;input.charCodeAt(state.pos)!==charCodes.asterisk||input.charCodeAt(state.pos+1)!==charCodes.slash;)if(state.pos++,state.pos>input.length)return void unexpected("Unterminated comment",state.pos-2);state.pos+=2}export function skipLineComment(e){let t=input.charCodeAt(state.pos+=e);if(state.pos<input.length)for(;t!==charCodes.lineFeed&&t!==charCodes.carriageReturn&&t!==charCodes.lineSeparator&&t!==charCodes.paragraphSeparator&&++state.pos<input.length;)t=input.charCodeAt(state.pos)}export function skipSpace(){for(;state.pos<input.length;){const e=input.charCodeAt(state.pos);switch(e){case charCodes.carriageReturn:input.charCodeAt(state.pos+1)===charCodes.lineFeed&&++state.pos;case charCodes.lineFeed:case charCodes.lineSeparator:case charCodes.paragraphSeparator:++state.pos;break;case charCodes.slash:switch(input.charCodeAt(state.pos+1)){case charCodes.asterisk:state.pos+=2,skipBlockComment();break;case charCodes.slash:skipLineComment(2);break;default:return}break;default:if(!IS_WHITESPACE[e])return;++state.pos}}}export function finishToken(e,t=ContextualKeyword.NONE){state.end=state.pos,state.type=e,state.contextualKeyword=t}function readToken_dot(){const e=input.charCodeAt(state.pos+1);e>=charCodes.digit0&&e<=charCodes.digit9?readNumber(!0):e===charCodes.dot&&input.charCodeAt(state.pos+2)===charCodes.dot?(state.pos+=3,finishToken(tt.ellipsis)):(++state.pos,finishToken(tt.dot))}function readToken_slash(){input.charCodeAt(state.pos+1)===charCodes.equalsTo?finishOp(tt.assign,2):finishOp(tt.slash,1)}function readToken_mult_modulo(e){let t=e===charCodes.asterisk?tt.star:tt.modulo,o=1,a=input.charCodeAt(state.pos+1);e===charCodes.asterisk&&a===charCodes.asterisk&&(o++,a=input.charCodeAt(state.pos+2),t=tt.exponent),a===charCodes.equalsTo&&input.charCodeAt(state.pos+2)!==charCodes.greaterThan&&(o++,t=tt.assign),finishOp(t,o)}function readToken_pipe_amp(e){const t=input.charCodeAt(state.pos+1);if(t!==e){if(e===charCodes.verticalBar){if(t===charCodes.greaterThan)return void finishOp(tt.pipeline,2);if(t===charCodes.rightCurlyBrace&&isFlowEnabled)return void finishOp(tt.braceBarR,2)}t!==charCodes.equalsTo?finishOp(e===charCodes.verticalBar?tt.bitwiseOR:tt.bitwiseAND,1):finishOp(tt.assign,2)}else input.charCodeAt(state.pos+2)===charCodes.equalsTo?finishOp(tt.assign,3):finishOp(e===charCodes.verticalBar?tt.logicalOR:tt.logicalAND,2)}function readToken_caret(){input.charCodeAt(state.pos+1)===charCodes.equalsTo?finishOp(tt.assign,2):finishOp(tt.bitwiseXOR,1)}function readToken_plus_min(e){const t=input.charCodeAt(state.pos+1);t!==e?t===charCodes.equalsTo?finishOp(tt.assign,2):e===charCodes.plusSign?finishOp(tt.plus,1):finishOp(tt.minus,1):finishOp(tt.preIncDec,2)}function readToken_lt(){const e=input.charCodeAt(state.pos+1);if(e===charCodes.lessThan)return input.charCodeAt(state.pos+2)===charCodes.equalsTo?void finishOp(tt.assign,3):void(state.isType?finishOp(tt.lessThan,1):finishOp(tt.bitShiftL,2));e===charCodes.equalsTo?finishOp(tt.relationalOrEqual,2):finishOp(tt.lessThan,1)}function readToken_gt(){if(state.isType)return void finishOp(tt.greaterThan,1);const e=input.charCodeAt(state.pos+1);if(e===charCodes.greaterThan){const e=input.charCodeAt(state.pos+2)===charCodes.greaterThan?3:2;return input.charCodeAt(state.pos+e)===charCodes.equalsTo?void finishOp(tt.assign,e+1):void finishOp(tt.bitShiftR,e)}e===charCodes.equalsTo?finishOp(tt.relationalOrEqual,2):finishOp(tt.greaterThan,1)}export function rescan_gt(){state.type===tt.greaterThan&&(state.pos-=1,readToken_gt())}function readToken_eq_excl(e){const t=input.charCodeAt(state.pos+1);if(t!==charCodes.equalsTo)return e===charCodes.equalsTo&&t===charCodes.greaterThan?(state.pos+=2,void finishToken(tt.arrow)):void finishOp(e===charCodes.equalsTo?tt.eq:tt.bang,1);finishOp(tt.equality,input.charCodeAt(state.pos+2)===charCodes.equalsTo?3:2)}function readToken_question(){const e=input.charCodeAt(state.pos+1),t=input.charCodeAt(state.pos+2);e!==charCodes.questionMark||isFlowEnabled&&state.isType?e!==charCodes.dot||t>=charCodes.digit0&&t<=charCodes.digit9?(++state.pos,finishToken(tt.question)):(state.pos+=2,finishToken(tt.questionDot)):t===charCodes.equalsTo?finishOp(tt.assign,3):finishOp(tt.nullishCoalescing,2)}export function getTokenFromCode(e){switch(e){case charCodes.numberSign:return++state.pos,void finishToken(tt.hash);case charCodes.dot:return void readToken_dot();case charCodes.leftParenthesis:return++state.pos,void finishToken(tt.parenL);case charCodes.rightParenthesis:return++state.pos,void finishToken(tt.parenR);case charCodes.semicolon:return++state.pos,void finishToken(tt.semi);case charCodes.comma:return++state.pos,void finishToken(tt.comma);case charCodes.leftSquareBracket:return++state.pos,void finishToken(tt.bracketL);case charCodes.rightSquareBracket:return++state.pos,void finishToken(tt.bracketR);case charCodes.leftCurlyBrace:return void(isFlowEnabled&&input.charCodeAt(state.pos+1)===charCodes.verticalBar?finishOp(tt.braceBarL,2):(++state.pos,finishToken(tt.braceL)));case charCodes.rightCurlyBrace:return++state.pos,void finishToken(tt.braceR);case charCodes.colon:return void(input.charCodeAt(state.pos+1)===charCodes.colon?finishOp(tt.doubleColon,2):(++state.pos,finishToken(tt.colon)));case charCodes.questionMark:return void readToken_question();case charCodes.atSign:return++state.pos,void finishToken(tt.at);case charCodes.graveAccent:return++state.pos,void finishToken(tt.backQuote);case charCodes.digit0:{const e=input.charCodeAt(state.pos+1);if(e===charCodes.lowercaseX||e===charCodes.uppercaseX||e===charCodes.lowercaseO||e===charCodes.uppercaseO||e===charCodes.lowercaseB||e===charCodes.uppercaseB)return void readRadixNumber()}case charCodes.digit1:case charCodes.digit2:case charCodes.digit3:case charCodes.digit4:case charCodes.digit5:case charCodes.digit6:case charCodes.digit7:case charCodes.digit8:case charCodes.digit9:return void readNumber(!1);case charCodes.quotationMark:case charCodes.apostrophe:return void readString(e);case charCodes.slash:return void readToken_slash();case charCodes.percentSign:case charCodes.asterisk:return void readToken_mult_modulo(e);case charCodes.verticalBar:case charCodes.ampersand:return void readToken_pipe_amp(e);case charCodes.caret:return void readToken_caret();case charCodes.plusSign:case charCodes.dash:return void readToken_plus_min(e);case charCodes.lessThan:return void readToken_lt();case charCodes.greaterThan:return void readToken_gt();case charCodes.equalsTo:case charCodes.exclamationMark:return void readToken_eq_excl(e);case charCodes.tilde:return void finishOp(tt.tilde,1)}unexpected(`Unexpected character '${String.fromCharCode(e)}'`,state.pos)}function finishOp(e,t){state.pos+=t,finishToken(e)}function readRegexp(){const e=state.pos;let t=!1,o=!1;for(;;){if(state.pos>=input.length)return void unexpected("Unterminated regular expression",e);const a=input.charCodeAt(state.pos);if(t)t=!1;else{if(a===charCodes.leftSquareBracket)o=!0;else if(a===charCodes.rightSquareBracket&&o)o=!1;else if(a===charCodes.slash&&!o)break;t=a===charCodes.backslash}++state.pos}++state.pos,skipWord(),finishToken(tt.regexp)}function readInt(){for(;;){const e=input.charCodeAt(state.pos);if(!(e>=charCodes.digit0&&e<=charCodes.digit9||e===charCodes.underscore))break;state.pos++}}function readRadixNumber(){for(state.pos+=2;;){const e=input.charCodeAt(state.pos);if(!(e>=charCodes.digit0&&e<=charCodes.digit9||e>=charCodes.lowercaseA&&e<=charCodes.lowercaseF||e>=charCodes.uppercaseA&&e<=charCodes.uppercaseF||e===charCodes.underscore))break;state.pos++}input.charCodeAt(state.pos)===charCodes.lowercaseN?(++state.pos,finishToken(tt.bigint)):finishToken(tt.num)}function readNumber(e){let t=!1,o=!1;e||readInt();let a=input.charCodeAt(state.pos);a===charCodes.dot&&(++state.pos,readInt(),a=input.charCodeAt(state.pos)),a!==charCodes.uppercaseE&&a!==charCodes.lowercaseE||(a=input.charCodeAt(++state.pos),a!==charCodes.plusSign&&a!==charCodes.dash||++state.pos,readInt(),a=input.charCodeAt(state.pos)),a===charCodes.lowercaseN?(++state.pos,t=!0):a===charCodes.lowercaseM&&(++state.pos,o=!0),finishToken(t?tt.bigint:o?tt.decimal:tt.num)}function readString(e){for(state.pos++;;){if(state.pos>=input.length)return void unexpected("Unterminated string constant");const t=input.charCodeAt(state.pos);if(t===charCodes.backslash)state.pos++;else if(t===e)break;state.pos++}state.pos++,finishToken(tt.string)}function readTmplToken(){for(;;){if(state.pos>=input.length)return void unexpected("Unterminated template");const e=input.charCodeAt(state.pos);if(e===charCodes.graveAccent||e===charCodes.dollarSign&&input.charCodeAt(state.pos+1)===charCodes.leftCurlyBrace)return state.pos===state.start&&match(tt.template)?e===charCodes.dollarSign?(state.pos+=2,void finishToken(tt.dollarBraceL)):(++state.pos,void finishToken(tt.backQuote)):void finishToken(tt.template);e===charCodes.backslash&&state.pos++,state.pos++}}export function skipWord(){for(;state.pos<input.length;){const e=input.charCodeAt(state.pos);if(IS_IDENTIFIER_CHAR[e])state.pos++;else{if(e!==charCodes.backslash)break;if(state.pos+=2,input.charCodeAt(state.pos)===charCodes.leftCurlyBrace){for(;state.pos<input.length&&input.charCodeAt(state.pos)!==charCodes.rightCurlyBrace;)state.pos++;state.pos++}}}}