import{isDeclaration}from"./parser/tokenizer";import{ContextualKeyword}from"./parser/tokenizer/keywords";import{TokenType as tt}from"./parser/tokenizer/types";import getImportExportSpecifierInfo from"./util/getImportExportSpecifierInfo";import{getNonTypeIdentifiers}from"./util/getNonTypeIdentifiers";export default class CJSImportProcessor{__init(){this.nonTypeIdentifiers=new Set}__init2(){this.importInfoByPath=new Map}__init3(){this.importsToReplace=new Map}__init4(){this.identifierReplacements=new Map}__init5(){this.exportBindingsByLocalName=new Map}constructor(t,e,s,n,r,o,i){this.nameManager=t,this.tokens=e,this.enableLegacyTypeScriptModuleInterop=s,this.options=n,this.isTypeScriptTransformEnabled=r,this.keepUnusedImports=o,this.helperManager=i,CJSImportProcessor.prototype.__init.call(this),CJSImportProcessor.prototype.__init2.call(this),CJSImportProcessor.prototype.__init3.call(this),CJSImportProcessor.prototype.__init4.call(this),CJSImportProcessor.prototype.__init5.call(this)}preprocessTokens(){for(let t=0;t<this.tokens.tokens.length;t++)this.tokens.matches1AtIndex(t,tt._import)&&!this.tokens.matches3AtIndex(t,tt._import,tt.name,tt.eq)&&this.preprocessImportAtIndex(t),this.tokens.matches1AtIndex(t,tt._export)&&!this.tokens.matches2AtIndex(t,tt._export,tt.eq)&&this.preprocessExportAtIndex(t);this.generateImportReplacements()}pruneTypeOnlyImports(){this.nonTypeIdentifiers=getNonTypeIdentifiers(this.tokens,this.options);for(const[t,e]of this.importInfoByPath.entries()){if(e.hasBareImport||e.hasStarExport||e.exportStarNames.length>0||e.namedExports.length>0)continue;[...e.defaultNames,...e.wildcardNames,...e.namedImports.map(({localName:t})=>t)].every(t=>this.shouldAutomaticallyElideImportedName(t))&&this.importsToReplace.set(t,"")}}shouldAutomaticallyElideImportedName(t){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&!this.nonTypeIdentifiers.has(t)}generateImportReplacements(){for(const[t,e]of this.importInfoByPath.entries()){const{defaultNames:s,wildcardNames:n,namedImports:r,namedExports:o,exportStarNames:i,hasStarExport:a}=e;if(0===s.length&&0===n.length&&0===r.length&&0===o.length&&0===i.length&&!a){this.importsToReplace.set(t,`require('${t}');`);continue}const p=this.getFreeIdentifierForPath(t);let h;h=this.enableLegacyTypeScriptModuleInterop?p:n.length>0?n[0]:this.getFreeIdentifierForPath(t);let m=`var ${p} = require('${t}');`;if(n.length>0)for(const t of n){m+=` var ${t} = ${this.enableLegacyTypeScriptModuleInterop?p:`${this.helperManager.getHelperName("interopRequireWildcard")}(${p})`};`}else i.length>0&&h!==p?m+=` var ${h} = ${this.helperManager.getHelperName("interopRequireWildcard")}(${p});`:s.length>0&&h!==p&&(m+=` var ${h} = ${this.helperManager.getHelperName("interopRequireDefault")}(${p});`);for(const{importedName:t,localName:e}of o)m+=` ${this.helperManager.getHelperName("createNamedExportFrom")}(${p}, '${e}', '${t}');`;for(const t of i)m+=` exports.${t} = ${h};`;a&&(m+=` ${this.helperManager.getHelperName("createStarExport")}(${p});`),this.importsToReplace.set(t,m);for(const t of s)this.identifierReplacements.set(t,`${h}.default`);for(const{importedName:t,localName:e}of r)this.identifierReplacements.set(e,`${p}.${t}`)}}getFreeIdentifierForPath(t){const e=t.split("/"),s=e[e.length-1].replace(/\W/g,"");return this.nameManager.claimFreeName(`_${s}`)}preprocessImportAtIndex(t){const e=[],s=[],n=[];if(t++,(this.tokens.matchesContextualAtIndex(t,ContextualKeyword._type)||this.tokens.matches1AtIndex(t,tt._typeof))&&!this.tokens.matches1AtIndex(t+1,tt.comma)&&!this.tokens.matchesContextualAtIndex(t+1,ContextualKeyword._from))return;if(this.tokens.matches1AtIndex(t,tt.parenL))return;if(this.tokens.matches1AtIndex(t,tt.name)&&(e.push(this.tokens.identifierNameAtIndex(t)),t++,this.tokens.matches1AtIndex(t,tt.comma)&&t++),this.tokens.matches1AtIndex(t,tt.star)&&(t+=2,s.push(this.tokens.identifierNameAtIndex(t)),t++),this.tokens.matches1AtIndex(t,tt.braceL)){const s=this.getNamedImports(t+1);t=s.newIndex;for(const t of s.namedImports)"default"===t.importedName?e.push(t.localName):n.push(t)}if(this.tokens.matchesContextualAtIndex(t,ContextualKeyword._from)&&t++,!this.tokens.matches1AtIndex(t,tt.string))throw new Error("Expected string token at the end of import statement.");const r=this.tokens.stringValueAtIndex(t),o=this.getImportInfo(r);o.defaultNames.push(...e),o.wildcardNames.push(...s),o.namedImports.push(...n),0===e.length&&0===s.length&&0===n.length&&(o.hasBareImport=!0)}preprocessExportAtIndex(t){if(this.tokens.matches2AtIndex(t,tt._export,tt._var)||this.tokens.matches2AtIndex(t,tt._export,tt._let)||this.tokens.matches2AtIndex(t,tt._export,tt._const))this.preprocessVarExportAtIndex(t);else if(this.tokens.matches2AtIndex(t,tt._export,tt._function)||this.tokens.matches2AtIndex(t,tt._export,tt._class)){const e=this.tokens.identifierNameAtIndex(t+2);this.addExportBinding(e,e)}else if(this.tokens.matches3AtIndex(t,tt._export,tt.name,tt._function)){const e=this.tokens.identifierNameAtIndex(t+3);this.addExportBinding(e,e)}else this.tokens.matches2AtIndex(t,tt._export,tt.braceL)?this.preprocessNamedExportAtIndex(t):this.tokens.matches2AtIndex(t,tt._export,tt.star)&&this.preprocessExportStarAtIndex(t)}preprocessVarExportAtIndex(t){let e=0;for(let s=t+2;;s++)if(this.tokens.matches1AtIndex(s,tt.braceL)||this.tokens.matches1AtIndex(s,tt.dollarBraceL)||this.tokens.matches1AtIndex(s,tt.bracketL))e++;else if(this.tokens.matches1AtIndex(s,tt.braceR)||this.tokens.matches1AtIndex(s,tt.bracketR))e--;else{if(0===e&&!this.tokens.matches1AtIndex(s,tt.name))break;if(this.tokens.matches1AtIndex(1,tt.eq)){const t=this.tokens.currentToken().rhsEndIndex;if(null==t)throw new Error("Expected = token with an end index.");s=t-1}else{const t=this.tokens.tokens[s];if(isDeclaration(t)){const t=this.tokens.identifierNameAtIndex(s);this.identifierReplacements.set(t,`exports.${t}`)}}}}preprocessNamedExportAtIndex(t){t+=2;const{newIndex:e,namedImports:s}=this.getNamedImports(t);if(t=e,!this.tokens.matchesContextualAtIndex(t,ContextualKeyword._from)){for(const{importedName:t,localName:e}of s)this.addExportBinding(t,e);return}if(t++,!this.tokens.matches1AtIndex(t,tt.string))throw new Error("Expected string token at the end of import statement.");const n=this.tokens.stringValueAtIndex(t);this.getImportInfo(n).namedExports.push(...s)}preprocessExportStarAtIndex(t){let e=null;if(this.tokens.matches3AtIndex(t,tt._export,tt.star,tt._as)?(t+=3,e=this.tokens.identifierNameAtIndex(t),t+=2):t+=3,!this.tokens.matches1AtIndex(t,tt.string))throw new Error("Expected string token at the end of star export statement.");const s=this.tokens.stringValueAtIndex(t),n=this.getImportInfo(s);null!==e?n.exportStarNames.push(e):n.hasStarExport=!0}getNamedImports(t){const e=[];for(;;){if(this.tokens.matches1AtIndex(t,tt.braceR)){t++;break}const s=getImportExportSpecifierInfo(this.tokens,t);if(t=s.endIndex,s.isType||e.push({importedName:s.leftName,localName:s.rightName}),this.tokens.matches2AtIndex(t,tt.comma,tt.braceR)){t+=2;break}if(this.tokens.matches1AtIndex(t,tt.braceR)){t++;break}if(!this.tokens.matches1AtIndex(t,tt.comma))throw new Error(`Unexpected token: ${JSON.stringify(this.tokens.tokens[t])}`);t++}return{newIndex:t,namedImports:e}}getImportInfo(t){const e=this.importInfoByPath.get(t);if(e)return e;const s={defaultNames:[],wildcardNames:[],namedImports:[],namedExports:[],hasBareImport:!1,exportStarNames:[],hasStarExport:!1};return this.importInfoByPath.set(t,s),s}addExportBinding(t,e){this.exportBindingsByLocalName.has(t)||this.exportBindingsByLocalName.set(t,[]),this.exportBindingsByLocalName.get(t).push(e)}claimImportCode(t){const e=this.importsToReplace.get(t);return this.importsToReplace.set(t,""),e||""}getIdentifierReplacement(t){return this.identifierReplacements.get(t)||null}resolveExportBinding(t){const e=this.exportBindingsByLocalName.get(t);return e&&0!==e.length?e.map(t=>`exports.${t}`).join(" = "):null}getGlobalNames(){return new Set([...this.identifierReplacements.keys(),...this.exportBindingsByLocalName.keys()])}}