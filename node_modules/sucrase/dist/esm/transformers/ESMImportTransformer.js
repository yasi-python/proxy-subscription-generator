import{ContextualKeyword}from"../parser/tokenizer/keywords";import{TokenType as tt}from"../parser/tokenizer/types";import elideImportEquals from"../util/elideImportEquals";import getDeclarationInfo,{EMPTY_DECLARATION_INFO}from"../util/getDeclarationInfo";import getImportExportSpecifierInfo from"../util/getImportExportSpecifierInfo";import{getNonTypeIdentifiers}from"../util/getNonTypeIdentifiers";import isExportFrom from"../util/isExportFrom";import{removeMaybeImportAttributes}from"../util/removeMaybeImportAttributes";import shouldElideDefaultExport from"../util/shouldElideDefaultExport";import Transformer from"./Transformer";export default class ESMImportTransformer extends Transformer{constructor(t,e,o,s,n,r,i,a){super(),this.tokens=t,this.nameManager=e,this.helperManager=o,this.reactHotLoaderTransformer=s,this.isTypeScriptTransformEnabled=n,this.isFlowTransformEnabled=r,this.keepUnusedImports=i,this.nonTypeIdentifiers=n&&!i?getNonTypeIdentifiers(t,a):new Set,this.declarationInfo=n&&!i?getDeclarationInfo(t):EMPTY_DECLARATION_INFO,this.injectCreateRequireForImportRequire=Boolean(a.injectCreateRequireForImportRequire)}process(){if(this.tokens.matches3(tt._import,tt.name,tt.eq))return this.processImportEquals();if(this.tokens.matches4(tt._import,tt.name,tt.name,tt.eq)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,ContextualKeyword._type)){this.tokens.removeInitialToken();for(let t=0;t<7;t++)this.tokens.removeToken();return!0}if(this.tokens.matches2(tt._export,tt.eq))return this.tokens.replaceToken("module.exports"),!0;if(this.tokens.matches5(tt._export,tt._import,tt.name,tt.name,tt.eq)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,ContextualKeyword._type)){this.tokens.removeInitialToken();for(let t=0;t<8;t++)this.tokens.removeToken();return!0}if(this.tokens.matches1(tt._import))return this.processImport();if(this.tokens.matches2(tt._export,tt._default))return this.processExportDefault();if(this.tokens.matches2(tt._export,tt.braceL))return this.processNamedExports();if(this.tokens.matches2(tt._export,tt.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,ContextualKeyword._type)){if(this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.matches1(tt.braceL)){for(;!this.tokens.matches1(tt.braceR);)this.tokens.removeToken();this.tokens.removeToken()}else this.tokens.removeToken(),this.tokens.matches1(tt._as)&&(this.tokens.removeToken(),this.tokens.removeToken());return this.tokens.matchesContextual(ContextualKeyword._from)&&this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,tt.string)&&(this.tokens.removeToken(),this.tokens.removeToken(),removeMaybeImportAttributes(this.tokens)),!0}return!1}processImportEquals(){const t=this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+1);return this.shouldAutomaticallyElideImportedName(t)?elideImportEquals(this.tokens):this.injectCreateRequireForImportRequire?(this.tokens.replaceToken("const"),this.tokens.copyToken(),this.tokens.copyToken(),this.tokens.replaceToken(this.helperManager.getHelperName("require"))):this.tokens.replaceToken("const"),!0}processImport(){if(this.tokens.matches2(tt._import,tt.parenL))return!1;const t=this.tokens.snapshot();if(this.removeImportTypeBindings()){for(this.tokens.restoreToSnapshot(t);!this.tokens.matches1(tt.string);)this.tokens.removeToken();this.tokens.removeToken(),removeMaybeImportAttributes(this.tokens),this.tokens.matches1(tt.semi)&&this.tokens.removeToken()}return!0}removeImportTypeBindings(){if(this.tokens.copyExpectedToken(tt._import),this.tokens.matchesContextual(ContextualKeyword._type)&&!this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,tt.comma)&&!this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,ContextualKeyword._from))return!0;if(this.tokens.matches1(tt.string))return this.tokens.copyToken(),!1;this.tokens.matchesContextual(ContextualKeyword._module)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,ContextualKeyword._from)&&this.tokens.copyToken();let t=!1,e=!1,o=!1;if(this.tokens.matches1(tt.name)&&(this.shouldAutomaticallyElideImportedName(this.tokens.identifierName())?(this.tokens.removeToken(),this.tokens.matches1(tt.comma)&&this.tokens.removeToken()):(t=!0,this.tokens.copyToken(),this.tokens.matches1(tt.comma)&&(o=!0,this.tokens.removeToken()))),this.tokens.matches1(tt.star))this.shouldAutomaticallyElideImportedName(this.tokens.identifierNameAtRelativeIndex(2))?(this.tokens.removeToken(),this.tokens.removeToken(),this.tokens.removeToken()):(o&&this.tokens.appendCode(","),t=!0,this.tokens.copyExpectedToken(tt.star),this.tokens.copyExpectedToken(tt.name),this.tokens.copyExpectedToken(tt.name));else if(this.tokens.matches1(tt.braceL)){for(o&&this.tokens.appendCode(","),this.tokens.copyToken();!this.tokens.matches1(tt.braceR);){e=!0;const o=getImportExportSpecifierInfo(this.tokens);if(o.isType||this.shouldAutomaticallyElideImportedName(o.rightName)){for(;this.tokens.currentIndex()<o.endIndex;)this.tokens.removeToken();this.tokens.matches1(tt.comma)&&this.tokens.removeToken()}else{for(t=!0;this.tokens.currentIndex()<o.endIndex;)this.tokens.copyToken();this.tokens.matches1(tt.comma)&&this.tokens.copyToken()}}this.tokens.copyExpectedToken(tt.braceR)}return!this.keepUnusedImports&&(this.isTypeScriptTransformEnabled||!!this.isFlowTransformEnabled&&e)&&!t}shouldAutomaticallyElideImportedName(t){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&!this.nonTypeIdentifiers.has(t)}processExportDefault(){if(shouldElideDefaultExport(this.isTypeScriptTransformEnabled,this.keepUnusedImports,this.tokens,this.declarationInfo))return this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.removeToken(),!0;if(!(this.tokens.matches4(tt._export,tt._default,tt._function,tt.name)||this.tokens.matches5(tt._export,tt._default,tt.name,tt._function,tt.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,ContextualKeyword._async)||this.tokens.matches4(tt._export,tt._default,tt._class,tt.name)||this.tokens.matches5(tt._export,tt._default,tt._abstract,tt._class,tt.name))&&this.reactHotLoaderTransformer){const t=this.nameManager.claimFreeName("_default");return this.tokens.replaceToken(`let ${t}; export`),this.tokens.copyToken(),this.tokens.appendCode(` ${t} =`),this.reactHotLoaderTransformer.setExtractedDefaultExportName(t),!0}return!1}processNamedExports(){if(!this.isTypeScriptTransformEnabled)return!1;this.tokens.copyExpectedToken(tt._export),this.tokens.copyExpectedToken(tt.braceL);const t=isExportFrom(this.tokens);let e=!1;for(;!this.tokens.matches1(tt.braceR);){const o=getImportExportSpecifierInfo(this.tokens);if(o.isType||!t&&this.shouldElideExportedName(o.leftName)){for(;this.tokens.currentIndex()<o.endIndex;)this.tokens.removeToken();this.tokens.matches1(tt.comma)&&this.tokens.removeToken()}else{for(e=!0;this.tokens.currentIndex()<o.endIndex;)this.tokens.copyToken();this.tokens.matches1(tt.comma)&&this.tokens.copyToken()}}return this.tokens.copyExpectedToken(tt.braceR),this.keepUnusedImports||!t||e||(this.tokens.removeToken(),this.tokens.removeToken(),removeMaybeImportAttributes(this.tokens)),!0}shouldElideExportedName(t){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&this.declarationInfo.typeDeclarations.has(t)&&!this.declarationInfo.valueDeclarations.has(t)}}