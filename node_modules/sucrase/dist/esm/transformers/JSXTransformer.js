import XHTMLEntities from"../parser/plugins/jsx/xhtml";import{JSXRole}from"../parser/tokenizer";import{TokenType as tt}from"../parser/tokenizer/types";import{charCodes}from"../parser/util/charcodes";import getJSXPragmaInfo,{}from"../util/getJSXPragmaInfo";import Transformer from"./Transformer";export default class JSXTransformer extends Transformer{__init(){this.lastLineNumber=1}__init2(){this.lastIndex=0}__init3(){this.filenameVarName=null}__init4(){this.esmAutomaticImportNameResolutions={}}__init5(){this.cjsAutomaticModuleNameResolutions={}}constructor(e,t,s,o,n){super(),this.rootTransformer=e,this.tokens=t,this.importProcessor=s,this.nameManager=o,this.options=n,JSXTransformer.prototype.__init.call(this),JSXTransformer.prototype.__init2.call(this),JSXTransformer.prototype.__init3.call(this),JSXTransformer.prototype.__init4.call(this),JSXTransformer.prototype.__init5.call(this),this.jsxPragmaInfo=getJSXPragmaInfo(n),this.isAutomaticRuntime="automatic"===n.jsxRuntime,this.jsxImportSource=n.jsxImportSource||"react"}process(){return!!this.tokens.matches1(tt.jsxTagStart)&&(this.processJSXTag(),!0)}getPrefixCode(){let e="";if(this.filenameVarName&&(e+=`const ${this.filenameVarName} = ${JSON.stringify(this.options.filePath||"")};`),this.isAutomaticRuntime)if(this.importProcessor)for(const[t,s]of Object.entries(this.cjsAutomaticModuleNameResolutions))e+=`var ${s} = require("${t}");`;else{const{createElement:t,...s}=this.esmAutomaticImportNameResolutions;t&&(e+=`import {createElement as ${t}} from "${this.jsxImportSource}";`);const o=Object.entries(s).map(([e,t])=>`${e} as ${t}`).join(", ");o&&(e+=`import {${o}} from "${this.jsxImportSource+(this.options.production?"/jsx-runtime":"/jsx-dev-runtime")}";`)}return e}processJSXTag(){const{jsxRole:e,start:t}=this.tokens.currentToken(),s=this.options.production?null:this.getElementLocationCode(t);this.isAutomaticRuntime&&e!==JSXRole.KeyAfterPropSpread?this.transformTagToJSXFunc(s,e):this.transformTagToCreateElement(s)}getElementLocationCode(e){return`lineNumber: ${this.getLineNumberForIndex(e)}`}getLineNumberForIndex(e){const t=this.tokens.code;for(;this.lastIndex<e&&this.lastIndex<t.length;)"\n"===t[this.lastIndex]&&this.lastLineNumber++,this.lastIndex++;return this.lastLineNumber}transformTagToJSXFunc(e,t){const s=t===JSXRole.StaticChildren;this.tokens.replaceToken(this.getJSXFuncInvocationCode(s));let o=null;if(this.tokens.matches1(tt.jsxTagEnd))this.tokens.replaceToken(`${this.getFragmentCode()}, {`),this.processAutomaticChildrenAndEndProps(t);else{if(this.processTagIntro(),this.tokens.appendCode(", {"),o=this.processProps(!0),this.tokens.matches2(tt.slash,tt.jsxTagEnd))this.tokens.appendCode("}");else{if(!this.tokens.matches1(tt.jsxTagEnd))throw new Error("Expected either /> or > at the end of the tag.");this.tokens.removeToken(),this.processAutomaticChildrenAndEndProps(t)}o&&this.tokens.appendCode(`, ${o}`)}for(this.options.production||(null===o&&this.tokens.appendCode(", void 0"),this.tokens.appendCode(`, ${s}, ${this.getDevSource(e)}, this`)),this.tokens.removeInitialToken();!this.tokens.matches1(tt.jsxTagEnd);)this.tokens.removeToken();this.tokens.replaceToken(")")}transformTagToCreateElement(e){if(this.tokens.replaceToken(this.getCreateElementInvocationCode()),this.tokens.matches1(tt.jsxTagEnd))this.tokens.replaceToken(`${this.getFragmentCode()}, null`),this.processChildren(!0);else if(this.processTagIntro(),this.processPropsObjectWithDevInfo(e),this.tokens.matches2(tt.slash,tt.jsxTagEnd));else{if(!this.tokens.matches1(tt.jsxTagEnd))throw new Error("Expected either /> or > at the end of the tag.");this.tokens.removeToken(),this.processChildren(!0)}for(this.tokens.removeInitialToken();!this.tokens.matches1(tt.jsxTagEnd);)this.tokens.removeToken();this.tokens.replaceToken(")")}getJSXFuncInvocationCode(e){return this.options.production?e?this.claimAutoImportedFuncInvocation("jsxs","/jsx-runtime"):this.claimAutoImportedFuncInvocation("jsx","/jsx-runtime"):this.claimAutoImportedFuncInvocation("jsxDEV","/jsx-dev-runtime")}getCreateElementInvocationCode(){if(this.isAutomaticRuntime)return this.claimAutoImportedFuncInvocation("createElement","");{const{jsxPragmaInfo:e}=this;return`${this.importProcessor&&this.importProcessor.getIdentifierReplacement(e.base)||e.base}${e.suffix}(`}}getFragmentCode(){if(this.isAutomaticRuntime)return this.claimAutoImportedName("Fragment",this.options.production?"/jsx-runtime":"/jsx-dev-runtime");{const{jsxPragmaInfo:e}=this;return(this.importProcessor&&this.importProcessor.getIdentifierReplacement(e.fragmentBase)||e.fragmentBase)+e.fragmentSuffix}}claimAutoImportedFuncInvocation(e,t){const s=this.claimAutoImportedName(e,t);return this.importProcessor?`${s}.call(void 0, `:`${s}(`}claimAutoImportedName(e,t){if(this.importProcessor){const s=this.jsxImportSource+t;return this.cjsAutomaticModuleNameResolutions[s]||(this.cjsAutomaticModuleNameResolutions[s]=this.importProcessor.getFreeIdentifierForPath(s)),`${this.cjsAutomaticModuleNameResolutions[s]}.${e}`}return this.esmAutomaticImportNameResolutions[e]||(this.esmAutomaticImportNameResolutions[e]=this.nameManager.claimFreeName(`_${e}`)),this.esmAutomaticImportNameResolutions[e]}processTagIntro(){let e=this.tokens.currentIndex()+1;for(;this.tokens.tokens[e].isType||!this.tokens.matches2AtIndex(e-1,tt.jsxName,tt.jsxName)&&!this.tokens.matches2AtIndex(e-1,tt.greaterThan,tt.jsxName)&&!this.tokens.matches1AtIndex(e,tt.braceL)&&!this.tokens.matches1AtIndex(e,tt.jsxTagEnd)&&!this.tokens.matches2AtIndex(e,tt.slash,tt.jsxTagEnd);)e++;if(e===this.tokens.currentIndex()+1){const e=this.tokens.identifierName();startsWithLowerCase(e)&&this.tokens.replaceToken(`'${e}'`)}for(;this.tokens.currentIndex()<e;)this.rootTransformer.processToken()}processPropsObjectWithDevInfo(e){const t=this.options.production?"":`__self: this, __source: ${this.getDevSource(e)}`;this.tokens.matches1(tt.jsxName)||this.tokens.matches1(tt.braceL)?(this.tokens.appendCode(", {"),this.processProps(!1),t?this.tokens.appendCode(` ${t}}`):this.tokens.appendCode("}")):t?this.tokens.appendCode(`, {${t}}`):this.tokens.appendCode(", null")}processProps(e){let t=null;for(;;){if(this.tokens.matches2(tt.jsxName,tt.eq)){const s=this.tokens.identifierName();if(e&&"key"===s){null!==t&&this.tokens.appendCode(t.replace(/[^\n]/g,"")),this.tokens.removeToken(),this.tokens.removeToken();const e=this.tokens.snapshot();this.processPropValue(),t=this.tokens.dangerouslyGetAndRemoveCodeSinceSnapshot(e);continue}this.processPropName(s),this.tokens.replaceToken(": "),this.processPropValue()}else if(this.tokens.matches1(tt.jsxName)){const e=this.tokens.identifierName();this.processPropName(e),this.tokens.appendCode(": true")}else{if(!this.tokens.matches1(tt.braceL))break;this.tokens.replaceToken(""),this.rootTransformer.processBalancedCode(),this.tokens.replaceToken("")}this.tokens.appendCode(",")}return t}processPropName(e){e.includes("-")?this.tokens.replaceToken(`'${e}'`):this.tokens.copyToken()}processPropValue(){this.tokens.matches1(tt.braceL)?(this.tokens.replaceToken(""),this.rootTransformer.processBalancedCode(),this.tokens.replaceToken("")):this.tokens.matches1(tt.jsxTagStart)?this.processJSXTag():this.processStringPropValue()}processStringPropValue(){const e=this.tokens.currentToken(),t=this.tokens.code.slice(e.start+1,e.end-1),s=formatJSXTextReplacement(t),o=formatJSXStringValueLiteral(t);this.tokens.replaceToken(o+s)}processAutomaticChildrenAndEndProps(e){e===JSXRole.StaticChildren?(this.tokens.appendCode(" children: ["),this.processChildren(!1),this.tokens.appendCode("]}")):(e===JSXRole.OneChild&&this.tokens.appendCode(" children: "),this.processChildren(!1),this.tokens.appendCode("}"))}processChildren(e){let t=e;for(;;){if(this.tokens.matches2(tt.jsxTagStart,tt.slash))return;let e=!1;if(this.tokens.matches1(tt.braceL))this.tokens.matches2(tt.braceL,tt.braceR)?(this.tokens.replaceToken(""),this.tokens.replaceToken("")):(this.tokens.replaceToken(t?", ":""),this.rootTransformer.processBalancedCode(),this.tokens.replaceToken(""),e=!0);else if(this.tokens.matches1(tt.jsxTagStart))this.tokens.appendCode(t?", ":""),this.processJSXTag(),e=!0;else{if(!this.tokens.matches1(tt.jsxText)&&!this.tokens.matches1(tt.jsxEmptyText))throw new Error("Unexpected token when processing JSX children.");e=this.processChildTextElement(t)}e&&(t=!0)}}processChildTextElement(e){const t=this.tokens.currentToken(),s=this.tokens.code.slice(t.start,t.end),o=formatJSXTextReplacement(s),n=formatJSXTextLiteral(s);return'""'===n?(this.tokens.replaceToken(o),!1):(this.tokens.replaceToken(`${e?", ":""}${n}${o}`),!0)}getDevSource(e){return`{fileName: ${this.getFilenameVarName()}, ${e}}`}getFilenameVarName(){return this.filenameVarName||(this.filenameVarName=this.nameManager.claimFreeName("_jsxFileName")),this.filenameVarName}}export function startsWithLowerCase(e){const t=e.charCodeAt(0);return t>=charCodes.lowercaseA&&t<=charCodes.lowercaseZ}function formatJSXTextLiteral(e){let t="",s="",o=!1,n=!1;for(let i=0;i<e.length;i++){const r=e[i];if(" "===r||"\t"===r||"\r"===r)o||(s+=r);else if("\n"===r)s="",o=!0;else{if(n&&o&&(t+=" "),t+=s,s="","&"===r){const{entity:s,newI:o}=processEntity(e,i+1);i=o-1,t+=s}else t+=r;n=!0,o=!1}}return o||(t+=s),JSON.stringify(t)}function formatJSXTextReplacement(e){let t=0,s=0;for(const o of e)"\n"===o?(t++,s=0):" "===o&&s++;return"\n".repeat(t)+" ".repeat(s)}function formatJSXStringValueLiteral(e){let t="";for(let s=0;s<e.length;s++){const o=e[s];if("\n"===o)if(/\s/.test(e[s+1]))for(t+=" ";s<e.length&&/\s/.test(e[s+1]);)s++;else t+="\n";else if("&"===o){const{entity:o,newI:n}=processEntity(e,s+1);t+=o,s=n-1}else t+=o}return JSON.stringify(t)}function processEntity(e,t){let s,o="",n=0,i=t;if("#"===e[i]){let t,o=10;if(i++,"x"===e[i])for(o=16,i++,t=i;i<e.length&&isHexDigit(e.charCodeAt(i));)i++;else for(t=i;i<e.length&&isDecimalDigit(e.charCodeAt(i));)i++;if(";"===e[i]){const n=e.slice(t,i);n&&(i++,s=String.fromCodePoint(parseInt(n,o)))}}else for(;i<e.length&&n++<10;){const t=e[i];if(i++,";"===t){s=XHTMLEntities.get(o);break}o+=t}return s?{entity:s,newI:i}:{entity:"&",newI:t}}function isDecimalDigit(e){return e>=charCodes.digit0&&e<=charCodes.digit9}function isHexDigit(e){return e>=charCodes.digit0&&e<=charCodes.digit9||e>=charCodes.lowercaseA&&e<=charCodes.lowercaseF||e>=charCodes.uppercaseA&&e<=charCodes.uppercaseF}