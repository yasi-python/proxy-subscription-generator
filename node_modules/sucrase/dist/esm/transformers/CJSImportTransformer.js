import{IdentifierRole,isDeclaration,isObjectShorthandDeclaration}from"../parser/tokenizer";import{ContextualKeyword}from"../parser/tokenizer/keywords";import{TokenType as tt}from"../parser/tokenizer/types";import elideImportEquals from"../util/elideImportEquals";import getDeclarationInfo,{EMPTY_DECLARATION_INFO}from"../util/getDeclarationInfo";import getImportExportSpecifierInfo from"../util/getImportExportSpecifierInfo";import isExportFrom from"../util/isExportFrom";import{removeMaybeImportAttributes}from"../util/removeMaybeImportAttributes";import shouldElideDefaultExport from"../util/shouldElideDefaultExport";import Transformer from"./Transformer";export default class CJSImportTransformer extends Transformer{__init(){this.hadExport=!1}__init2(){this.hadNamedExport=!1}__init3(){this.hadDefaultExport=!1}constructor(t,e,s,o,n,r,i,h,a,c,k,p){super(),this.rootTransformer=t,this.tokens=e,this.importProcessor=s,this.nameManager=o,this.helperManager=n,this.reactHotLoaderTransformer=r,this.enableLegacyBabel5ModuleInterop=i,this.enableLegacyTypeScriptModuleInterop=h,this.isTypeScriptTransformEnabled=a,this.isFlowTransformEnabled=c,this.preserveDynamicImport=k,this.keepUnusedImports=p,CJSImportTransformer.prototype.__init.call(this),CJSImportTransformer.prototype.__init2.call(this),CJSImportTransformer.prototype.__init3.call(this),this.declarationInfo=a?getDeclarationInfo(e):EMPTY_DECLARATION_INFO}getPrefixCode(){let t="";return this.hadExport&&(t+='Object.defineProperty(exports, "__esModule", {value: true});'),t}getSuffixCode(){return this.enableLegacyBabel5ModuleInterop&&this.hadDefaultExport&&!this.hadNamedExport?"\nmodule.exports = exports.default;\n":""}process(){return this.tokens.matches3(tt._import,tt.name,tt.eq)?this.processImportEquals():this.tokens.matches1(tt._import)?(this.processImport(),!0):this.tokens.matches2(tt._export,tt.eq)?(this.tokens.replaceToken("module.exports"),!0):this.tokens.matches1(tt._export)&&!this.tokens.currentToken().isType?(this.hadExport=!0,this.processExport()):!(!this.tokens.matches2(tt.name,tt.postIncDec)||!this.processPostIncDec())||(this.tokens.matches1(tt.name)||this.tokens.matches1(tt.jsxName)?this.processIdentifier():this.tokens.matches1(tt.eq)?this.processAssignment():this.tokens.matches1(tt.assign)?this.processComplexAssignment():!!this.tokens.matches1(tt.preIncDec)&&this.processPreIncDec())}processImportEquals(){const t=this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+1);return this.importProcessor.shouldAutomaticallyElideImportedName(t)?elideImportEquals(this.tokens):this.tokens.replaceToken("const"),!0}processImport(){if(this.tokens.matches2(tt._import,tt.parenL)){if(this.preserveDynamicImport)return void this.tokens.copyToken();const t=this.enableLegacyTypeScriptModuleInterop?"":`${this.helperManager.getHelperName("interopRequireWildcard")}(`;this.tokens.replaceToken(`Promise.resolve().then(() => ${t}require`);const e=this.tokens.currentToken().contextId;if(null==e)throw new Error("Expected context ID on dynamic import invocation.");for(this.tokens.copyToken();!this.tokens.matchesContextIdAndLabel(tt.parenR,e);)this.rootTransformer.processToken();return void this.tokens.replaceToken(t?")))":"))")}if(this.removeImportAndDetectIfShouldElide())this.tokens.removeToken();else{const t=this.tokens.stringValue();this.tokens.replaceTokenTrimmingLeftWhitespace(this.importProcessor.claimImportCode(t)),this.tokens.appendCode(this.importProcessor.claimImportCode(t))}removeMaybeImportAttributes(this.tokens),this.tokens.matches1(tt.semi)&&this.tokens.removeToken()}removeImportAndDetectIfShouldElide(){if(this.tokens.removeInitialToken(),this.tokens.matchesContextual(ContextualKeyword._type)&&!this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,tt.comma)&&!this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,ContextualKeyword._from))return this.removeRemainingImport(),!0;if(this.tokens.matches1(tt.name)||this.tokens.matches1(tt.star))return this.removeRemainingImport(),!1;if(this.tokens.matches1(tt.string))return!1;let t=!1,e=!1;for(;!this.tokens.matches1(tt.string);)(!t&&this.tokens.matches1(tt.braceL)||this.tokens.matches1(tt.comma))&&(this.tokens.removeToken(),this.tokens.matches1(tt.braceR)||(e=!0),(this.tokens.matches2(tt.name,tt.comma)||this.tokens.matches2(tt.name,tt.braceR)||this.tokens.matches4(tt.name,tt.name,tt.name,tt.comma)||this.tokens.matches4(tt.name,tt.name,tt.name,tt.braceR))&&(t=!0)),this.tokens.removeToken();return!this.keepUnusedImports&&(this.isTypeScriptTransformEnabled||!!this.isFlowTransformEnabled&&e)&&!t}removeRemainingImport(){for(;!this.tokens.matches1(tt.string);)this.tokens.removeToken()}processIdentifier(){const t=this.tokens.currentToken();if(t.shadowsGlobal)return!1;if(t.identifierRole===IdentifierRole.ObjectShorthand)return this.processObjectShorthand();if(t.identifierRole!==IdentifierRole.Access)return!1;const e=this.importProcessor.getIdentifierReplacement(this.tokens.identifierNameForToken(t));if(!e)return!1;let s=this.tokens.currentIndex()+1;for(;s<this.tokens.tokens.length&&this.tokens.tokens[s].type===tt.parenR;)s++;return this.tokens.tokens[s].type===tt.parenL?this.tokens.tokenAtRelativeIndex(1).type===tt.parenL&&this.tokens.tokenAtRelativeIndex(-1).type!==tt._new?(this.tokens.replaceToken(`${e}.call(void 0, `),this.tokens.removeToken(),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(tt.parenR)):this.tokens.replaceToken(`(0, ${e})`):this.tokens.replaceToken(e),!0}processObjectShorthand(){const t=this.tokens.identifierName(),e=this.importProcessor.getIdentifierReplacement(t);return!!e&&(this.tokens.replaceToken(`${t}: ${e}`),!0)}processExport(){if(this.tokens.matches2(tt._export,tt._enum)||this.tokens.matches3(tt._export,tt._const,tt._enum))return this.hadNamedExport=!0,!1;if(this.tokens.matches2(tt._export,tt._default))return this.tokens.matches3(tt._export,tt._default,tt._enum)?(this.hadDefaultExport=!0,!1):(this.processExportDefault(),!0);if(this.tokens.matches2(tt._export,tt.braceL))return this.processExportBindings(),!0;if(this.tokens.matches2(tt._export,tt.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+1,ContextualKeyword._type)){if(this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.matches1(tt.braceL)){for(;!this.tokens.matches1(tt.braceR);)this.tokens.removeToken();this.tokens.removeToken()}else this.tokens.removeToken(),this.tokens.matches1(tt._as)&&(this.tokens.removeToken(),this.tokens.removeToken());return this.tokens.matchesContextual(ContextualKeyword._from)&&this.tokens.matches1AtIndex(this.tokens.currentIndex()+1,tt.string)&&(this.tokens.removeToken(),this.tokens.removeToken(),removeMaybeImportAttributes(this.tokens)),!0}if(this.hadNamedExport=!0,this.tokens.matches2(tt._export,tt._var)||this.tokens.matches2(tt._export,tt._let)||this.tokens.matches2(tt._export,tt._const))return this.processExportVar(),!0;if(this.tokens.matches2(tt._export,tt._function)||this.tokens.matches3(tt._export,tt.name,tt._function))return this.processExportFunction(),!0;if(this.tokens.matches2(tt._export,tt._class)||this.tokens.matches3(tt._export,tt._abstract,tt._class)||this.tokens.matches2(tt._export,tt.at))return this.processExportClass(),!0;if(this.tokens.matches2(tt._export,tt.star))return this.processExportStar(),!0;throw new Error("Unrecognized export syntax.")}processAssignment(){const t=this.tokens.currentIndex(),e=this.tokens.tokens[t-1];if(e.isType||e.type!==tt.name)return!1;if(e.shadowsGlobal)return!1;if(t>=2&&this.tokens.matches1AtIndex(t-2,tt.dot))return!1;if(t>=2&&[tt._var,tt._let,tt._const].includes(this.tokens.tokens[t-2].type))return!1;const s=this.importProcessor.resolveExportBinding(this.tokens.identifierNameForToken(e));return!!s&&(this.tokens.copyToken(),this.tokens.appendCode(` ${s} =`),!0)}processComplexAssignment(){const t=this.tokens.currentIndex(),e=this.tokens.tokens[t-1];if(e.type!==tt.name)return!1;if(e.shadowsGlobal)return!1;if(t>=2&&this.tokens.matches1AtIndex(t-2,tt.dot))return!1;const s=this.importProcessor.resolveExportBinding(this.tokens.identifierNameForToken(e));return!!s&&(this.tokens.appendCode(` = ${s}`),this.tokens.copyToken(),!0)}processPreIncDec(){const t=this.tokens.currentIndex(),e=this.tokens.tokens[t+1];if(e.type!==tt.name)return!1;if(e.shadowsGlobal)return!1;if(t+2<this.tokens.tokens.length&&(this.tokens.matches1AtIndex(t+2,tt.dot)||this.tokens.matches1AtIndex(t+2,tt.bracketL)||this.tokens.matches1AtIndex(t+2,tt.parenL)))return!1;const s=this.tokens.identifierNameForToken(e),o=this.importProcessor.resolveExportBinding(s);return!!o&&(this.tokens.appendCode(`${o} = `),this.tokens.copyToken(),!0)}processPostIncDec(){const t=this.tokens.currentIndex(),e=this.tokens.tokens[t],s=this.tokens.tokens[t+1];if(e.type!==tt.name)return!1;if(e.shadowsGlobal)return!1;if(t>=1&&this.tokens.matches1AtIndex(t-1,tt.dot))return!1;const o=this.tokens.identifierNameForToken(e),n=this.importProcessor.resolveExportBinding(o);if(!n)return!1;const r=this.tokens.rawCodeForToken(s),i=this.importProcessor.getIdentifierReplacement(o)||o;if("++"===r)this.tokens.replaceToken(`(${i} = ${n} = ${i} + 1, ${i} - 1)`);else{if("--"!==r)throw new Error(`Unexpected operator: ${r}`);this.tokens.replaceToken(`(${i} = ${n} = ${i} - 1, ${i} + 1)`)}return this.tokens.removeToken(),!0}processExportDefault(){let t=!0;if(this.tokens.matches4(tt._export,tt._default,tt._function,tt.name)||this.tokens.matches5(tt._export,tt._default,tt.name,tt._function,tt.name)&&this.tokens.matchesContextualAtIndex(this.tokens.currentIndex()+2,ContextualKeyword._async)){this.tokens.removeInitialToken(),this.tokens.removeToken();const t=this.processNamedFunction();this.tokens.appendCode(` exports.default = ${t};`)}else if(this.tokens.matches4(tt._export,tt._default,tt._class,tt.name)||this.tokens.matches5(tt._export,tt._default,tt._abstract,tt._class,tt.name)||this.tokens.matches3(tt._export,tt._default,tt.at)){this.tokens.removeInitialToken(),this.tokens.removeToken(),this.copyDecorators(),this.tokens.matches1(tt._abstract)&&this.tokens.removeToken();const t=this.rootTransformer.processNamedClass();this.tokens.appendCode(` exports.default = ${t};`)}else if(shouldElideDefaultExport(this.isTypeScriptTransformEnabled,this.keepUnusedImports,this.tokens,this.declarationInfo))t=!1,this.tokens.removeInitialToken(),this.tokens.removeToken(),this.tokens.removeToken();else if(this.reactHotLoaderTransformer){const t=this.nameManager.claimFreeName("_default");this.tokens.replaceToken(`let ${t}; exports.`),this.tokens.copyToken(),this.tokens.appendCode(` = ${t} =`),this.reactHotLoaderTransformer.setExtractedDefaultExportName(t)}else this.tokens.replaceToken("exports."),this.tokens.copyToken(),this.tokens.appendCode(" =");t&&(this.hadDefaultExport=!0)}copyDecorators(){for(;this.tokens.matches1(tt.at);)if(this.tokens.copyToken(),this.tokens.matches1(tt.parenL))this.tokens.copyExpectedToken(tt.parenL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(tt.parenR);else{for(this.tokens.copyExpectedToken(tt.name);this.tokens.matches1(tt.dot);)this.tokens.copyExpectedToken(tt.dot),this.tokens.copyExpectedToken(tt.name);this.tokens.matches1(tt.parenL)&&(this.tokens.copyExpectedToken(tt.parenL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(tt.parenR))}}processExportVar(){this.isSimpleExportVar()?this.processSimpleExportVar():this.processComplexExportVar()}isSimpleExportVar(){let t=this.tokens.currentIndex();if(t++,t++,!this.tokens.matches1AtIndex(t,tt.name))return!1;for(t++;t<this.tokens.tokens.length&&this.tokens.tokens[t].isType;)t++;return!!this.tokens.matches1AtIndex(t,tt.eq)}processSimpleExportVar(){this.tokens.removeInitialToken(),this.tokens.copyToken();const t=this.tokens.identifierName();for(;!this.tokens.matches1(tt.eq);)this.rootTransformer.processToken();const e=this.tokens.currentToken().rhsEndIndex;if(null==e)throw new Error("Expected = token with an end index.");for(;this.tokens.currentIndex()<e;)this.rootTransformer.processToken();this.tokens.appendCode(`; exports.${t} = ${t}`)}processComplexExportVar(){this.tokens.removeInitialToken(),this.tokens.removeToken();const t=this.tokens.matches1(tt.braceL);t&&this.tokens.appendCode("(");let e=0;for(;;)if(this.tokens.matches1(tt.braceL)||this.tokens.matches1(tt.dollarBraceL)||this.tokens.matches1(tt.bracketL))e++,this.tokens.copyToken();else if(this.tokens.matches1(tt.braceR)||this.tokens.matches1(tt.bracketR))e--,this.tokens.copyToken();else{if(0===e&&!this.tokens.matches1(tt.name)&&!this.tokens.currentToken().isType)break;if(this.tokens.matches1(tt.eq)){const t=this.tokens.currentToken().rhsEndIndex;if(null==t)throw new Error("Expected = token with an end index.");for(;this.tokens.currentIndex()<t;)this.rootTransformer.processToken()}else{const t=this.tokens.currentToken();if(isDeclaration(t)){const e=this.tokens.identifierName();let s=this.importProcessor.getIdentifierReplacement(e);if(null===s)throw new Error(`Expected a replacement for ${e} in \`export var\` syntax.`);isObjectShorthandDeclaration(t)&&(s=`${e}: ${s}`),this.tokens.replaceToken(s)}else this.rootTransformer.processToken()}}if(t){const t=this.tokens.currentToken().rhsEndIndex;if(null==t)throw new Error("Expected = token with an end index.");for(;this.tokens.currentIndex()<t;)this.rootTransformer.processToken();this.tokens.appendCode(")")}}processExportFunction(){this.tokens.replaceToken("");const t=this.processNamedFunction();this.tokens.appendCode(` exports.${t} = ${t};`)}processNamedFunction(){if(this.tokens.matches1(tt._function))this.tokens.copyToken();else if(this.tokens.matches2(tt.name,tt._function)){if(!this.tokens.matchesContextual(ContextualKeyword._async))throw new Error("Expected async keyword in function export.");this.tokens.copyToken(),this.tokens.copyToken()}if(this.tokens.matches1(tt.star)&&this.tokens.copyToken(),!this.tokens.matches1(tt.name))throw new Error("Expected identifier for exported function name.");const t=this.tokens.identifierName();if(this.tokens.copyToken(),this.tokens.currentToken().isType)for(this.tokens.removeInitialToken();this.tokens.currentToken().isType;)this.tokens.removeToken();return this.tokens.copyExpectedToken(tt.parenL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(tt.parenR),this.rootTransformer.processPossibleTypeRange(),this.tokens.copyExpectedToken(tt.braceL),this.rootTransformer.processBalancedCode(),this.tokens.copyExpectedToken(tt.braceR),t}processExportClass(){this.tokens.removeInitialToken(),this.copyDecorators(),this.tokens.matches1(tt._abstract)&&this.tokens.removeToken();const t=this.rootTransformer.processNamedClass();this.tokens.appendCode(` exports.${t} = ${t};`)}processExportBindings(){this.tokens.removeInitialToken(),this.tokens.removeToken();const t=isExportFrom(this.tokens),e=[];for(;;){if(this.tokens.matches1(tt.braceR)){this.tokens.removeToken();break}const s=getImportExportSpecifierInfo(this.tokens);for(;this.tokens.currentIndex()<s.endIndex;)this.tokens.removeToken();if(!(s.isType||!t&&this.shouldElideExportedIdentifier(s.leftName))){const t=s.rightName;"default"===t?this.hadDefaultExport=!0:this.hadNamedExport=!0;const o=s.leftName,n=this.importProcessor.getIdentifierReplacement(o);e.push(`exports.${t} = ${n||o};`)}if(this.tokens.matches1(tt.braceR)){this.tokens.removeToken();break}if(this.tokens.matches2(tt.comma,tt.braceR)){this.tokens.removeToken(),this.tokens.removeToken();break}if(!this.tokens.matches1(tt.comma))throw new Error(`Unexpected token: ${JSON.stringify(this.tokens.currentToken())}`);this.tokens.removeToken()}if(this.tokens.matchesContextual(ContextualKeyword._from)){this.tokens.removeToken();const t=this.tokens.stringValue();this.tokens.replaceTokenTrimmingLeftWhitespace(this.importProcessor.claimImportCode(t)),removeMaybeImportAttributes(this.tokens)}else this.tokens.appendCode(e.join(" "));this.tokens.matches1(tt.semi)&&this.tokens.removeToken()}processExportStar(){for(this.tokens.removeInitialToken();!this.tokens.matches1(tt.string);)this.tokens.removeToken();const t=this.tokens.stringValue();this.tokens.replaceTokenTrimmingLeftWhitespace(this.importProcessor.claimImportCode(t)),removeMaybeImportAttributes(this.tokens),this.tokens.matches1(tt.semi)&&this.tokens.removeToken()}shouldElideExportedIdentifier(t){return this.isTypeScriptTransformEnabled&&!this.keepUnusedImports&&!this.declarationInfo.valueDeclarations.has(t)}}