import{ContextualKeyword}from"../parser/tokenizer/keywords";import{TokenType as tt}from"../parser/tokenizer/types";import getClassInfo,{}from"../util/getClassInfo";import CJSImportTransformer from"./CJSImportTransformer";import ESMImportTransformer from"./ESMImportTransformer";import FlowTransformer from"./FlowTransformer";import JestHoistTransformer from"./JestHoistTransformer";import JSXTransformer from"./JSXTransformer";import NumericSeparatorTransformer from"./NumericSeparatorTransformer";import OptionalCatchBindingTransformer from"./OptionalCatchBindingTransformer";import OptionalChainingNullishTransformer from"./OptionalChainingNullishTransformer";import ReactDisplayNameTransformer from"./ReactDisplayNameTransformer";import ReactHotLoaderTransformer from"./ReactHotLoaderTransformer";import TypeScriptTransformer from"./TypeScriptTransformer";export default class RootTransformer{__init(){this.transformers=[]}__init2(){this.generatedVariables=[]}constructor(e,t,s,r){RootTransformer.prototype.__init.call(this),RootTransformer.prototype.__init2.call(this),this.nameManager=e.nameManager,this.helperManager=e.helperManager;const{tokenProcessor:n,importProcessor:o}=e;this.tokens=n,this.isImportsTransformEnabled=t.includes("imports"),this.isReactHotLoaderTransformEnabled=t.includes("react-hot-loader"),this.disableESTransforms=Boolean(r.disableESTransforms),r.disableESTransforms||(this.transformers.push(new OptionalChainingNullishTransformer(n,this.nameManager)),this.transformers.push(new NumericSeparatorTransformer(n)),this.transformers.push(new OptionalCatchBindingTransformer(n,this.nameManager))),t.includes("jsx")&&("preserve"!==r.jsxRuntime&&this.transformers.push(new JSXTransformer(this,n,o,this.nameManager,r)),this.transformers.push(new ReactDisplayNameTransformer(this,n,o,r)));let i=null;if(t.includes("react-hot-loader")){if(!r.filePath)throw new Error("filePath is required when using the react-hot-loader transform.");i=new ReactHotLoaderTransformer(n,r.filePath),this.transformers.push(i)}if(t.includes("imports")){if(null===o)throw new Error("Expected non-null importProcessor with imports transform enabled.");this.transformers.push(new CJSImportTransformer(this,n,o,this.nameManager,this.helperManager,i,s,Boolean(r.enableLegacyTypeScriptModuleInterop),t.includes("typescript"),t.includes("flow"),Boolean(r.preserveDynamicImport),Boolean(r.keepUnusedImports)))}else this.transformers.push(new ESMImportTransformer(n,this.nameManager,this.helperManager,i,t.includes("typescript"),t.includes("flow"),Boolean(r.keepUnusedImports),r));t.includes("flow")&&this.transformers.push(new FlowTransformer(this,n,t.includes("imports"))),t.includes("typescript")&&this.transformers.push(new TypeScriptTransformer(this,n,t.includes("imports"))),t.includes("jest")&&this.transformers.push(new JestHoistTransformer(this,n,this.nameManager,o))}transform(){this.tokens.reset(),this.processBalancedCode();let e=this.isImportsTransformEnabled?'"use strict";':"";for(const t of this.transformers)e+=t.getPrefixCode();e+=this.helperManager.emitHelpers(),e+=this.generatedVariables.map(e=>` var ${e};`).join("");for(const t of this.transformers)e+=t.getHoistedCode();let t="";for(const e of this.transformers)t+=e.getSuffixCode();const s=this.tokens.finish();let{code:r}=s;if(r.startsWith("#!")){let n=r.indexOf("\n");return-1===n&&(n=r.length,r+="\n"),{code:r.slice(0,n+1)+e+r.slice(n+1)+t,mappings:this.shiftMappings(s.mappings,e.length)}}return{code:e+r+t,mappings:this.shiftMappings(s.mappings,e.length)}}processBalancedCode(){let e=0,t=0;for(;!this.tokens.isAtEnd();){if(this.tokens.matches1(tt.braceL)||this.tokens.matches1(tt.dollarBraceL))e++;else if(this.tokens.matches1(tt.braceR)){if(0===e)return;e--}if(this.tokens.matches1(tt.parenL))t++;else if(this.tokens.matches1(tt.parenR)){if(0===t)return;t--}this.processToken()}}processToken(){if(this.tokens.matches1(tt._class))this.processClass();else{for(const e of this.transformers)if(e.process())return;this.tokens.copyToken()}}processNamedClass(){if(!this.tokens.matches2(tt._class,tt.name))throw new Error("Expected identifier for exported class name.");const e=this.tokens.identifierNameAtIndex(this.tokens.currentIndex()+1);return this.processClass(),e}processClass(){const e=getClassInfo(this,this.tokens,this.nameManager,this.disableESTransforms),t=(e.headerInfo.isExpression||!e.headerInfo.className)&&e.staticInitializerNames.length+e.instanceInitializerNames.length>0;let s=e.headerInfo.className;t&&(s=this.nameManager.claimFreeName("_class"),this.generatedVariables.push(s),this.tokens.appendCode(` (${s} =`));const r=this.tokens.currentToken().contextId;if(null==r)throw new Error("Expected class to have a context ID.");for(this.tokens.copyExpectedToken(tt._class);!this.tokens.matchesContextIdAndLabel(tt.braceL,r);)this.processToken();this.processClassBody(e,s);const n=e.staticInitializerNames.map(e=>`${s}.${e}()`);t?this.tokens.appendCode(`, ${n.map(e=>`${e}, `).join("")}${s})`):e.staticInitializerNames.length>0&&this.tokens.appendCode(` ${n.map(e=>`${e};`).join(" ")}`)}processClassBody(e,t){const{headerInfo:s,constructorInsertPos:r,constructorInitializerStatements:n,fields:o,instanceInitializerNames:i,rangesToRemove:a}=e;let h=0,c=0;const m=this.tokens.currentToken().contextId;if(null==m)throw new Error("Expected non-null context ID on class.");this.tokens.copyExpectedToken(tt.braceL),this.isReactHotLoaderTransformEnabled&&this.tokens.appendCode("__reactstandin__regenerateByEval(key, code) {this[key] = eval(code);}");const p=n.length+i.length>0;if(null===r&&p){const e=this.makeConstructorInitCode(n,i,t);if(s.hasSuperclass){const t=this.nameManager.claimFreeName("args");this.tokens.appendCode(`constructor(...${t}) { super(...${t}); ${e}; }`)}else this.tokens.appendCode(`constructor() { ${e}; }`)}for(;!this.tokens.matchesContextIdAndLabel(tt.braceR,m);)if(h<o.length&&this.tokens.currentIndex()===o[h].start){let e=!1;for(this.tokens.matches1(tt.bracketL)?this.tokens.copyTokenWithPrefix(`${o[h].initializerName}() {this`):this.tokens.matches1(tt.string)||this.tokens.matches1(tt.num)?(this.tokens.copyTokenWithPrefix(`${o[h].initializerName}() {this[`),e=!0):this.tokens.copyTokenWithPrefix(`${o[h].initializerName}() {this.`);this.tokens.currentIndex()<o[h].end;)e&&this.tokens.currentIndex()===o[h].equalsIndex&&this.tokens.appendCode("]"),this.processToken();this.tokens.appendCode("}"),h++}else if(c<a.length&&this.tokens.currentIndex()>=a[c].start){for(this.tokens.currentIndex()<a[c].end&&this.tokens.removeInitialToken();this.tokens.currentIndex()<a[c].end;)this.tokens.removeToken();c++}else this.tokens.currentIndex()===r?(this.tokens.copyToken(),p&&this.tokens.appendCode(`;${this.makeConstructorInitCode(n,i,t)};`),this.processToken()):this.processToken();this.tokens.copyExpectedToken(tt.braceR)}makeConstructorInitCode(e,t,s){return[...e,...t.map(e=>`${s}.prototype.${e}.call(this)`)].join(";")}processPossibleArrowParamEnd(){if(this.tokens.matches2(tt.parenR,tt.colon)&&this.tokens.tokenAtRelativeIndex(1).isType){let e=this.tokens.currentIndex()+1;for(;this.tokens.tokens[e].isType;)e++;if(this.tokens.matches1AtIndex(e,tt.arrow)){for(this.tokens.removeInitialToken();this.tokens.currentIndex()<e;)this.tokens.removeToken();return this.tokens.replaceTokenTrimmingLeftWhitespace(") =>"),!0}}return!1}processPossibleAsyncArrowWithTypeParams(){if(!this.tokens.matchesContextual(ContextualKeyword._async)&&!this.tokens.matches1(tt._async))return!1;const e=this.tokens.tokenAtRelativeIndex(1);if(e.type!==tt.lessThan||!e.isType)return!1;let t=this.tokens.currentIndex()+1;for(;this.tokens.tokens[t].isType;)t++;if(this.tokens.matches1AtIndex(t,tt.parenL)){for(this.tokens.replaceToken("async ("),this.tokens.removeInitialToken();this.tokens.currentIndex()<t;)this.tokens.removeToken();return this.tokens.removeToken(),this.processBalancedCode(),this.processToken(),!0}return!1}processPossibleTypeRange(){if(this.tokens.currentToken().isType){for(this.tokens.removeInitialToken();this.tokens.currentToken().isType;)this.tokens.removeToken();return!0}return!1}shiftMappings(e,t){for(let s=0;s<e.length;s++){const r=e[s];void 0!==r&&(e[s]=r+t)}return e}}