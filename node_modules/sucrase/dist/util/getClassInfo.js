"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var _keywords=require("../parser/tokenizer/keywords"),_types=require("../parser/tokenizer/types");function getClassInfo(e,t,n,o){const s=t.snapshot(),r=processClassHeader(t);let c=[];const i=[],a=[];let p=null;const T=[],k=[],u=t.currentToken().contextId;if(null==u)throw new Error("Expected non-null class context ID on class open-brace.");for(t.nextToken();!t.matchesContextIdAndLabel(_types.TokenType.braceR,u);)if(t.matchesContextual(_keywords.ContextualKeyword._constructor)&&!t.currentToken().isType)({constructorInitializerStatements:c,constructorInsertPos:p}=processConstructor(t));else if(t.matches1(_types.TokenType.semi))o||k.push({start:t.currentIndex(),end:t.currentIndex()+1}),t.nextToken();else if(t.currentToken().isType)t.nextToken();else{const s=t.currentIndex();let r=!1,l=!1,y=!1;for(;isAccessModifier(t.currentToken());)t.matches1(_types.TokenType._static)&&(r=!0),t.matches1(_types.TokenType.hash)&&(l=!0),(t.matches1(_types.TokenType._declare)||t.matches1(_types.TokenType._abstract))&&(y=!0),t.nextToken();if(r&&t.matches1(_types.TokenType.braceL)){skipToNextClassElement(t,u);continue}if(l){skipToNextClassElement(t,u);continue}if(t.matchesContextual(_keywords.ContextualKeyword._constructor)&&!t.currentToken().isType){({constructorInitializerStatements:c,constructorInsertPos:p}=processConstructor(t));continue}const d=t.currentIndex();if(skipFieldName(t),t.matches1(_types.TokenType.lessThan)||t.matches1(_types.TokenType.parenL)){skipToNextClassElement(t,u);continue}for(;t.currentToken().isType;)t.nextToken();if(t.matches1(_types.TokenType.eq)){const o=t.currentIndex(),s=t.currentToken().rhsEndIndex;if(null==s)throw new Error("Expected rhsEndIndex on class field assignment.");for(t.nextToken();t.currentIndex()<s;)e.processToken();let c;r?(c=n.claimFreeName("__initStatic"),a.push(c)):(c=n.claimFreeName("__init"),i.push(c)),T.push({initializerName:c,equalsIndex:o,start:d,end:t.currentIndex()})}else o&&!y||k.push({start:s,end:t.currentIndex()})}return t.restoreToSnapshot(s),o?{headerInfo:r,constructorInitializerStatements:c,instanceInitializerNames:[],staticInitializerNames:[],constructorInsertPos:p,fields:[],rangesToRemove:k}:{headerInfo:r,constructorInitializerStatements:c,instanceInitializerNames:i,staticInitializerNames:a,constructorInsertPos:p,fields:T,rangesToRemove:k}}function skipToNextClassElement(e,t){for(e.nextToken();e.currentToken().contextId!==t;)e.nextToken();for(;isAccessModifier(e.tokenAtRelativeIndex(-1));)e.previousToken()}function processClassHeader(e){const t=e.currentToken(),n=t.contextId;if(null==n)throw new Error("Expected context ID on class token.");const o=t.isExpression;if(null==o)throw new Error("Expected isExpression on class token.");let s=null,r=!1;for(e.nextToken(),e.matches1(_types.TokenType.name)&&(s=e.identifierName());!e.matchesContextIdAndLabel(_types.TokenType.braceL,n);)e.matches1(_types.TokenType._extends)&&!e.currentToken().isType&&(r=!0),e.nextToken();return{isExpression:o,className:s,hasSuperclass:r}}function processConstructor(e){const t=[];e.nextToken();const n=e.currentToken().contextId;if(null==n)throw new Error("Expected context ID on open-paren starting constructor params.");for(;!e.matchesContextIdAndLabel(_types.TokenType.parenR,n);)if(e.currentToken().contextId===n){if(e.nextToken(),isAccessModifier(e.currentToken())){for(e.nextToken();isAccessModifier(e.currentToken());)e.nextToken();const n=e.currentToken();if(n.type!==_types.TokenType.name)throw new Error("Expected identifier after access modifiers in constructor arg.");const o=e.identifierNameForToken(n);t.push(`this.${o} = ${o}`)}}else e.nextToken();for(e.nextToken();e.currentToken().isType;)e.nextToken();let o=e.currentIndex(),s=!1;for(;!e.matchesContextIdAndLabel(_types.TokenType.braceR,n);){if(!s&&e.matches2(_types.TokenType._super,_types.TokenType.parenL)){e.nextToken();const t=e.currentToken().contextId;if(null==t)throw new Error("Expected a context ID on the super call");for(;!e.matchesContextIdAndLabel(_types.TokenType.parenR,t);)e.nextToken();o=e.currentIndex(),s=!0}e.nextToken()}return e.nextToken(),{constructorInitializerStatements:t,constructorInsertPos:o}}function isAccessModifier(e){return[_types.TokenType._async,_types.TokenType._get,_types.TokenType._set,_types.TokenType.plus,_types.TokenType.minus,_types.TokenType._readonly,_types.TokenType._static,_types.TokenType._public,_types.TokenType._private,_types.TokenType._protected,_types.TokenType._override,_types.TokenType._abstract,_types.TokenType.star,_types.TokenType._declare,_types.TokenType.hash].includes(e.type)}function skipFieldName(e){if(e.matches1(_types.TokenType.bracketL)){const t=e.currentToken().contextId;if(null==t)throw new Error("Expected class context ID on computed name open bracket.");for(;!e.matchesContextIdAndLabel(_types.TokenType.bracketR,t);)e.nextToken();e.nextToken()}else e.nextToken()}exports.default=getClassInfo;