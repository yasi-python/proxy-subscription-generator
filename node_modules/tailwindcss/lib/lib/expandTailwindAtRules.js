"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"default",{enumerable:!0,get:function(){return expandTailwindAtRules}});const _fs=_interop_require_default(require("fs")),_quicklru=_interop_require_default(require("@alloc/quick-lru")),_sharedState=_interop_require_wildcard(require("./sharedState")),_generateRules=require("./generateRules"),_log=_interop_require_default(require("../util/log")),_cloneNodes=_interop_require_default(require("../util/cloneNodes")),_defaultExtractor=require("./defaultExtractor");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(_getRequireWildcardCache=function(e){return e?r:t})(e)}function _interop_require_wildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};var r=_getRequireWildcardCache(t);if(r&&r.has(e))return r.get(e);var n={},a=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var l in e)if("default"!==l&&Object.prototype.hasOwnProperty.call(e,l)){var o=a?Object.getOwnPropertyDescriptor(e,l):null;o&&(o.get||o.set)?Object.defineProperty(n,l,o):n[l]=e[l]}return n.default=e,r&&r.set(e,n),n}let env=_sharedState.env;const builtInExtractors={DEFAULT:_defaultExtractor.defaultExtractor},builtInTransformers={DEFAULT:e=>e,svelte:e=>e.replace(/(?:^|\s)class:/g," ")};function getExtractor(e,t){let r=e.tailwindConfig.content.extract;return r[t]||r.DEFAULT||builtInExtractors[t]||builtInExtractors.DEFAULT(e)}function getTransformer(e,t){let r=e.content.transform;return r[t]||r.DEFAULT||builtInTransformers[t]||builtInTransformers.DEFAULT}let extractorCache=new WeakMap;function getClassCandidates(e,t,r,n){extractorCache.has(t)||extractorCache.set(t,new _quicklru.default({maxSize:25e3}));for(let a of e.split("\n"))if(a=a.trim(),!n.has(a))if(n.add(a),extractorCache.get(t).has(a))for(let e of extractorCache.get(t).get(a))r.add(e);else{let e=t(a).filter(e=>"!*"!==e),n=new Set(e);for(let e of n)r.add(e);extractorCache.get(t).set(a,n)}}function buildStylesheet(e,t){let r=t.offsets.sort(e),n={base:new Set,defaults:new Set,components:new Set,utilities:new Set,variants:new Set};for(let[e,t]of r)n[e.layer].add(t);return n}function expandTailwindAtRules(e){return async t=>{let r={base:null,components:null,utilities:null,variants:null};if(t.walkAtRules(e=>{"tailwind"===e.name&&Object.keys(r).includes(e.params)&&(r[e.params]=e)}),Object.values(r).every(e=>null===e))return t;var n;let a=new Set([...null!==(n=e.candidates)&&void 0!==n?n:[],_sharedState.NOT_ON_DEMAND]),l=new Set;env.DEBUG&&console.time("Reading changed files");let o=[];for(let t of e.changedContent){let r=getTransformer(e.tailwindConfig,t.extension),n=getExtractor(e,t.extension);o.push([t,{transformer:r,extractor:n}])}for(let e=0;e<o.length;e+=500){let t=o.slice(e,e+500);await Promise.all(t.map(async([{file:e,content:t},{transformer:r,extractor:n}])=>{getClassCandidates(r(t=e?await _fs.default.promises.readFile(e,"utf8"):t),n,a,l)}))}env.DEBUG&&console.timeEnd("Reading changed files");let s=e.classCache.size;env.DEBUG&&console.time("Generate rules"),env.DEBUG&&console.time("Sorting candidates");let i=new Set([...a].sort((e,t)=>e===t?0:e<t?-1:1));env.DEBUG&&console.timeEnd("Sorting candidates"),(0,_generateRules.generateRules)(i,e),env.DEBUG&&console.timeEnd("Generate rules"),env.DEBUG&&console.time("Build stylesheet"),null!==e.stylesheetCache&&e.classCache.size===s||(e.stylesheetCache=buildStylesheet([...e.ruleCache],e)),env.DEBUG&&console.timeEnd("Build stylesheet");let{defaults:u,base:c,components:d,utilities:f,variants:p}=e.stylesheetCache;r.base&&(r.base.before((0,_cloneNodes.default)([...u,...c],r.base.source,{layer:"base"})),r.base.remove()),r.components&&(r.components.before((0,_cloneNodes.default)([...d],r.components.source,{layer:"components"})),r.components.remove()),r.utilities&&(r.utilities.before((0,_cloneNodes.default)([...f],r.utilities.source,{layer:"utilities"})),r.utilities.remove());const _=Array.from(p).filter(e=>{var t;const n=null===(t=e.raws.tailwind)||void 0===t?void 0:t.parentLayer;return"components"===n?null!==r.components:"utilities"!==n||null!==r.utilities});var m;r.variants?(r.variants.before((0,_cloneNodes.default)(_,r.variants.source,{layer:"variants"})),r.variants.remove()):_.length>0&&t.append((0,_cloneNodes.default)(_,t.source,{layer:"variants"})),t.source.end=null!==(m=t.source.end)&&void 0!==m?m:t.source.start;const v=_.some(e=>{var t;return"utilities"===(null===(t=e.raws.tailwind)||void 0===t?void 0:t.parentLayer)});r.utilities&&0===f.size&&!v&&_log.default.warn("content-problems",["No utility classes were detected in your source files. If this is unexpected, double-check the `content` option in your Tailwind CSS configuration.","https://tailwindcss.com/docs/content-configuration"]),env.DEBUG&&(console.log("Potential classes: ",a.size),console.log("Active contexts: ",_sharedState.contextSourcesMap.size)),e.changedContent=[],t.walkAtRules("layer",e=>{Object.keys(r).includes(e.params)&&e.remove()})}}