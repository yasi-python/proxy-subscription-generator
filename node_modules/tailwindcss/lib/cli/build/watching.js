"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),Object.defineProperty(exports,"createWatcher",{enumerable:!0,get:function(){return createWatcher}});const _chokidar=_interop_require_default(require("chokidar")),_fs=_interop_require_default(require("fs")),_micromatch=_interop_require_default(require("micromatch")),_normalizepath=_interop_require_default(require("normalize-path")),_path=_interop_require_default(require("path")),_utils=require("./utils.js");function _interop_require_default(e){return e&&e.__esModule?e:{default:e}}function createWatcher(e,{state:t,rebuild:r}){let a,i,n=e["--poll"],o=n||"win32"===process.platform,l=_chokidar.default.watch([],{atomic:!0,usePolling:n,interval:n?10:void 0,ignoreInitial:!0,awaitWriteFinish:!!o&&{stabilityThreshold:50,pollInterval:10}}),u=Promise.resolve(),s=[],c=new Set;async function d(){let e=s.splice(0);return 0===e.length?Promise.resolve():(e.forEach(e=>c.delete(e.file)),r(e).then(()=>{},e=>{console.error(e.toString())}))}function h(e,t=null,r=!1){return e=_path.default.resolve(e),c.has(e)&&!r?Promise.resolve():(c.add(e),s.push({file:e,content:null!=t?t:()=>_fs.default.promises.readFile(e,"utf8"),extension:_path.default.extname(e).slice(1)}),a&&(clearTimeout(a),i()),u=u.then(()=>new Promise((e,t)=>{a=setTimeout(e,10),i=t})),u=u.then(d,d),u)}return l.on("change",e=>h(e)),l.on("add",e=>h(e)),l.on("unlink",e=>{e=(0,_normalizepath.default)(e),_micromatch.default.some([e],t.contentPatterns.dynamic)||l.add(e)}),l.on("raw",(e,r,a)=>{if("rename"!==e||null===r)return;let i=a.watchedPath;r=i.endsWith(r)?i:_path.default.join(i,r),_micromatch.default.some([r],t.contentPatterns.all)&&(c.has(r)||(c.add(r),async function(){try{let e=await(0,_utils.readFileWithRetries)(_path.default.resolve(r));if(void 0===e)return;await h(r,()=>e,!0)}catch{}}().then(()=>{c.delete(r)})))}),{fswatcher:l,refreshWatchedFiles(){l.add(Array.from(t.contextDependencies)),l.add(Array.from(t.configBag.dependencies)),l.add(t.contentPatterns.all)}}}