import*as regex from"./regex";import{splitAtTopLevelOnly}from"../util/splitAtTopLevelOnly";export function defaultExtractor(e){let t=Array.from(buildRegExps(e));return e=>{let r=[];for(let s of t)for(let t of e.match(s)??[])r.push(clipAtBalancedParens(t));for(let e of r.slice()){let t=splitAtTopLevelOnly(e,".");for(let e=0;e<t.length;e++){let s=t[e];if(e>=t.length-1){r.push(s);continue}let n=Number(t[e+1]);isNaN(n)?r.push(s):e++}}return r}}function*buildRegExps(e){let t=e.tailwindConfig.separator,r=""!==e.tailwindConfig.prefix?regex.optional(regex.pattern([/-?/,regex.escape(e.tailwindConfig.prefix)])):"",s=regex.any([/\[[^\s:'"`]+:[^\s\[\]]+\]/,/\[[^\s:'"`\]]+:[^\s]+?\[[^\s]+\][^\s]+?\]/,regex.pattern([regex.any([/-?(?:\w+)/,/@(?:\w+)/]),regex.optional(regex.any([regex.pattern([regex.any([/-(?:\w+-)*\['[^\s]+'\]/,/-(?:\w+-)*\["[^\s]+"\]/,/-(?:\w+-)*\[`[^\s]+`\]/,/-(?:\w+-)*\[(?:[^\s\[\]]+\[[^\s\[\]]+\])*[^\s:\[\]]+\]/]),/(?![{([]])/,/(?:\/[^\s'"`\\><$]*)?/]),regex.pattern([regex.any([/-(?:\w+-)*\['[^\s]+'\]/,/-(?:\w+-)*\["[^\s]+"\]/,/-(?:\w+-)*\[`[^\s]+`\]/,/-(?:\w+-)*\[(?:[^\s\[\]]+\[[^\s\[\]]+\])*[^\s\[\]]+\]/]),/(?![{([]])/,/(?:\/[^\s'"`\\$]*)?/]),/[-\/][^\s'"`\\$={><]*/]))])]),n=[regex.any([regex.pattern([/@\[[^\s"'`]+\](\/[^\s"'`]+)?/,t]),regex.pattern([/([^\s"'`\[\\]+-)?\[[^\s"'`]+\]\/[\w_-]+/,t]),regex.pattern([/([^\s"'`\[\\]+-)?\[[^\s"'`]+\]/,t]),regex.pattern([/[^\s"'`\[\\]+/,t])]),regex.any([regex.pattern([/([^\s"'`\[\\]+-)?\[[^\s`]+\]\/[\w_-]+/,t]),regex.pattern([/([^\s"'`\[\\]+-)?\[[^\s`]+\]/,t]),regex.pattern([/[^\s`\[\\]+/,t])])];for(const e of n)yield regex.pattern(["((?=((",e,")+))\\2)?",/!?/,r,s]);yield/[^<>"'`\s.(){}[\]#=%$][^<>"'`\s(){}[\]#=%$]*[^<>"'`\s.(){}[\]#=%:$]/g}let SPECIALS=/([\[\]'"`])([^\[\]'"`])?/g,ALLOWED_CLASS_CHARACTERS=/[^"'`\s<>\]]+/;function clipAtBalancedParens(e){if(!e.includes("-["))return e;let t=0,r=[],s=e.matchAll(SPECIALS);s=Array.from(s).flatMap(e=>{const[,...t]=e;return t.map((t,r)=>Object.assign([],e,{index:e.index+r,0:t}))});for(let n of s){let s=n[0],l=r[r.length-1];if(s===l?r.pop():"'"!==s&&'"'!==s&&"`"!==s||r.push(s),!l)if("["!==s)if("]"!==s){if(t<0)return e.substring(0,n.index-1);if(0===t&&!ALLOWED_CLASS_CHARACTERS.test(s))return e.substring(0,n.index)}else t--;else t++}return e}