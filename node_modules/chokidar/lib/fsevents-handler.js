"use strict";const fs=require("fs"),sysPath=require("path"),{promisify:promisify}=require("util");let fsevents;try{fsevents=require("fsevents")}catch(t){process.env.CHOKIDAR_PRINT_FSEVENTS_REQUIRE_ERROR&&console.error(t)}if(fsevents){const t=process.version.match(/v(\d+)\.(\d+)/);if(t&&t[1]&&t[2]){const s=Number.parseInt(t[1],10),e=Number.parseInt(t[2],10);8===s&&e<16&&(fsevents=void 0)}}const{EV_ADD:EV_ADD,EV_CHANGE:EV_CHANGE,EV_ADD_DIR:EV_ADD_DIR,EV_UNLINK:EV_UNLINK,EV_ERROR:EV_ERROR,STR_DATA:STR_DATA,STR_END:STR_END,FSEVENT_CREATED:FSEVENT_CREATED,FSEVENT_MODIFIED:FSEVENT_MODIFIED,FSEVENT_DELETED:FSEVENT_DELETED,FSEVENT_MOVED:FSEVENT_MOVED,FSEVENT_UNKNOWN:FSEVENT_UNKNOWN,FSEVENT_FLAG_MUST_SCAN_SUBDIRS:FSEVENT_FLAG_MUST_SCAN_SUBDIRS,FSEVENT_TYPE_FILE:FSEVENT_TYPE_FILE,FSEVENT_TYPE_DIRECTORY:FSEVENT_TYPE_DIRECTORY,FSEVENT_TYPE_SYMLINK:FSEVENT_TYPE_SYMLINK,ROOT_GLOBSTAR:ROOT_GLOBSTAR,DIR_SUFFIX:DIR_SUFFIX,DOT_SLASH:DOT_SLASH,FUNCTION_TYPE:FUNCTION_TYPE,EMPTY_FN:EMPTY_FN,IDENTITY_FN:IDENTITY_FN}=require("./constants"),Depth=t=>isNaN(t)?{}:{depth:t},stat=promisify(fs.stat),lstat=promisify(fs.lstat),realpath=promisify(fs.realpath),statMethods={stat:stat,lstat:lstat},FSEventsWatchers=new Map,consolidateThreshhold=10,wrongEventFlags=new Set([69888,70400,71424,72704,73472,131328,131840,262912]),createFSEventsInstance=(t,s)=>({stop:fsevents.watch(t,s)});function setFSEventsListener(t,s,e,i){let a=sysPath.extname(s)?sysPath.dirname(s):s;const r=sysPath.dirname(a);let n=FSEventsWatchers.get(a);couldConsolidate(r)&&(a=r);const h=sysPath.resolve(t),E=h!==s,_=(t,i,a)=>{E&&(t=t.replace(s,h)),t!==h&&t.indexOf(h+sysPath.sep)||e(t,i,a)};let c=!1;for(const t of FSEventsWatchers.keys())if(0===s.indexOf(sysPath.resolve(t)+sysPath.sep)){a=t,n=FSEventsWatchers.get(a),c=!0;break}return n||c?n.listeners.add(_):(n={listeners:new Set([_]),rawEmitter:i,watcher:createFSEventsInstance(a,(t,s)=>{if(!n.listeners.size)return;if(s&FSEVENT_FLAG_MUST_SCAN_SUBDIRS)return;const e=fsevents.getInfo(t,s);n.listeners.forEach(i=>{i(t,s,e)}),n.rawEmitter(e.event,t,e)})},FSEventsWatchers.set(a,n)),()=>{const t=n.listeners;if(t.delete(_),!t.size&&(FSEventsWatchers.delete(a),n.watcher))return n.watcher.stop().then(()=>{n.rawEmitter=n.watcher=void 0,Object.freeze(n)})}}const couldConsolidate=t=>{let s=0;for(const e of FSEventsWatchers.keys())if(0===e.indexOf(t)&&(s++,s>=10))return!0;return!1},canUse=()=>fsevents&&FSEventsWatchers.size<128,calcDepth=(t,s)=>{let e=0;for(;!t.indexOf(s)&&(t=sysPath.dirname(t))!==s;)e++;return e},sameTypes=(t,s)=>t.type===FSEVENT_TYPE_DIRECTORY&&s.isDirectory()||t.type===FSEVENT_TYPE_SYMLINK&&s.isSymbolicLink()||t.type===FSEVENT_TYPE_FILE&&s.isFile();class FsEventsHandler{constructor(t){this.fsw=t}checkIgnored(t,s){const e=this.fsw._ignoredPaths;if(this.fsw._isIgnored(t,s))return e.add(t),s&&s.isDirectory()&&e.add(t+ROOT_GLOBSTAR),!0;e.delete(t),e.delete(t+ROOT_GLOBSTAR)}addOrChange(t,s,e,i,a,r,n,h){const E=a.has(r)?EV_CHANGE:EV_ADD;this.handleEvent(E,t,s,e,i,a,r,n,h)}async checkExists(t,s,e,i,a,r,n,h){try{const E=await stat(t);if(this.fsw.closed)return;sameTypes(n,E)?this.addOrChange(t,s,e,i,a,r,n,h):this.handleEvent(EV_UNLINK,t,s,e,i,a,r,n,h)}catch(E){"EACCES"===E.code?this.addOrChange(t,s,e,i,a,r,n,h):this.handleEvent(EV_UNLINK,t,s,e,i,a,r,n,h)}}handleEvent(t,s,e,i,a,r,n,h,E){if(!this.fsw.closed&&!this.checkIgnored(s))if(t===EV_UNLINK){const t=h.type===FSEVENT_TYPE_DIRECTORY;(t||r.has(n))&&this.fsw._remove(a,n,t)}else{if(t===EV_ADD){if(h.type===FSEVENT_TYPE_DIRECTORY&&this.fsw._getWatchedDir(s),h.type===FSEVENT_TYPE_SYMLINK&&E.followSymlinks){const t=void 0===E.depth?void 0:calcDepth(e,i)+1;return this._addToFsEvents(s,!1,!0,t)}this.fsw._getWatchedDir(a).add(n)}const r=h.type===FSEVENT_TYPE_DIRECTORY?t+DIR_SUFFIX:t;this.fsw._emit(r,s),r===EV_ADD_DIR&&this._addToFsEvents(s,!1,!0)}}_watchWithFsEvents(t,s,e,i){if(this.fsw.closed||this.fsw._isIgnored(t))return;const a=this.fsw.options,r=setFSEventsListener(t,s,async(r,n,h)=>{if(this.fsw.closed)return;if(void 0!==a.depth&&calcDepth(r,s)>a.depth)return;const E=e(sysPath.join(t,sysPath.relative(t,r)));if(i&&!i(E))return;const _=sysPath.dirname(E),c=sysPath.basename(E),o=this.fsw._getWatchedDir(h.type===FSEVENT_TYPE_DIRECTORY?E:_);if(wrongEventFlags.has(n)||h.event===FSEVENT_UNKNOWN)if(typeof a.ignored===FUNCTION_TYPE){let t;try{t=await stat(E)}catch(t){}if(this.fsw.closed)return;if(this.checkIgnored(E,t))return;sameTypes(h,t)?this.addOrChange(E,r,s,_,o,c,h,a):this.handleEvent(EV_UNLINK,E,r,s,_,o,c,h,a)}else this.checkExists(E,r,s,_,o,c,h,a);else switch(h.event){case FSEVENT_CREATED:case FSEVENT_MODIFIED:return this.addOrChange(E,r,s,_,o,c,h,a);case FSEVENT_DELETED:case FSEVENT_MOVED:return this.checkExists(E,r,s,_,o,c,h,a)}},this.fsw._emitRaw);return this.fsw._emitReady(),r}async _handleFsEventsSymlink(t,s,e,i){if(!this.fsw.closed&&!this.fsw._symlinkPaths.has(s)){this.fsw._symlinkPaths.set(s,!0),this.fsw._incrReadyCount();try{const s=await realpath(t);if(this.fsw.closed)return;if(this.fsw._isIgnored(s))return this.fsw._emitReady();this.fsw._incrReadyCount(),this._addToFsEvents(s||t,i=>{let a=t;return s&&s!==DOT_SLASH?a=i.replace(s,t):i!==DOT_SLASH&&(a=sysPath.join(t,i)),e(a)},!1,i)}catch(t){if(this.fsw._handleError(t))return this.fsw._emitReady()}}}emitAdd(t,s,e,i,a){const r=e(t),n=s.isDirectory(),h=this.fsw._getWatchedDir(sysPath.dirname(r)),E=sysPath.basename(r);n&&this.fsw._getWatchedDir(r),h.has(E)||(h.add(E),i.ignoreInitial&&!0!==a||this.fsw._emit(n?EV_ADD_DIR:EV_ADD,r,s))}initWatch(t,s,e,i){if(this.fsw.closed)return;const a=this._watchWithFsEvents(e.watchPath,sysPath.resolve(t||e.watchPath),i,e.globFilter);this.fsw._addPathCloser(s,a)}async _addToFsEvents(t,s,e,i){if(this.fsw.closed)return;const a=this.fsw.options,r=typeof s===FUNCTION_TYPE?s:IDENTITY_FN,n=this.fsw._getWatchHelpers(t);try{const s=await statMethods[n.statMethod](n.watchPath);if(this.fsw.closed)return;if(this.fsw._isIgnored(n.watchPath,s))throw null;if(s.isDirectory()){if(n.globFilter||this.emitAdd(r(t),s,r,a,e),i&&i>a.depth)return;this.fsw._readdirp(n.watchPath,{fileFilter:t=>n.filterPath(t),directoryFilter:t=>n.filterDir(t),...Depth(a.depth-(i||0))}).on(STR_DATA,t=>{if(this.fsw.closed)return;if(t.stats.isDirectory()&&!n.filterPath(t))return;const s=sysPath.join(n.watchPath,t.path),{fullPath:i}=t;if(n.followSymlinks&&t.stats.isSymbolicLink()){const t=void 0===a.depth?void 0:calcDepth(s,sysPath.resolve(n.watchPath))+1;this._handleFsEventsSymlink(s,i,r,t)}else this.emitAdd(s,t.stats,r,a,e)}).on(EV_ERROR,EMPTY_FN).on(STR_END,()=>{this.fsw._emitReady()})}else this.emitAdd(n.watchPath,s,r,a,e),this.fsw._emitReady()}catch(t){t&&!this.fsw._handleError(t)||(this.fsw._emitReady(),this.fsw._emitReady())}if(a.persistent&&!0!==e)if(typeof s===FUNCTION_TYPE)this.initWatch(void 0,t,n,r);else{let s;try{s=await realpath(n.watchPath)}catch(t){}this.initWatch(s,t,n,r)}}}module.exports=FsEventsHandler,module.exports.canUse=canUse;