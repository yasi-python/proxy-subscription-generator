var t=require("tap"),fs=require("fs"),path=require("path"),fixture=path.resolve(__dirname,"fixtures"),meow=fixture+"/meow.cat",mine=fixture+"/mine.cat",ours=fixture+"/ours.cat",fail=fixture+"/fail.false",noent=fixture+"/enoent.exe",mkdirp=require("mkdirp"),rimraf=require("rimraf"),isWindows="win32"===process.platform,hasAccess="function"==typeof fs.access,winSkip=isWindows&&"windows",accessSkip=!hasAccess&&"no fs.access function",hasPromise="function"==typeof Promise,promiseSkip=!hasPromise&&"no global Promise";function reset(){return delete require.cache[require.resolve("../")],require("../")}function runTest(n,e){var t=reset(),i=Object.create(e||{});i.ignoreErrors=!0,e&&e.skipFail||n.notOk(t.sync(fail,e)),n.notOk(t.sync(noent,i)),e?n.ok(t.sync(meow,e)):n.ok(t.sync(meow)),n.ok(t.sync(mine,e)),n.ok(t.sync(ours,e)),n.throws(function(){t.sync(noent,e)}),n.test("meow async",function(n){e?t(meow,e,function(e,t){if(e)throw e;n.ok(t),n.end()}):t(meow,function(e,t){if(e)throw e;n.ok(t),n.end()})}),n.test("mine async",function(n){t(mine,e,function(e,t){if(e)throw e;n.ok(t),n.end()})}),n.test("ours async",function(n){t(ours,e,function(e,t){if(e)throw e;n.ok(t),n.end()})}),e&&e.skipFail||n.test("fail async",function(n){t(fail,e,function(e,t){if(e)throw e;n.notOk(t),n.end()})}),n.test("noent async",function(n){t(noent,e,function(e,t){n.ok(e),n.notOk(t),n.end()})}),n.test("noent ignore async",function(n){t(noent,i,function(e,t){if(e)throw e;n.notOk(t),n.end()})}),n.test("directory is not executable",function(n){t(__dirname,e,function(e,t){if(e)throw e;n.notOk(t),n.end()})}),n.end()}t.test("setup fixtures",function(n){rimraf.sync(fixture),mkdirp.sync(fixture),fs.writeFileSync(meow,"#!/usr/bin/env cat\nmeow\n"),fs.chmodSync(meow,parseInt("0755",8)),fs.writeFileSync(fail,"#!/usr/bin/env false\n"),fs.chmodSync(fail,parseInt("0644",8)),fs.writeFileSync(mine,"#!/usr/bin/env cat\nmine\n"),fs.chmodSync(mine,parseInt("0744",8)),fs.writeFileSync(ours,"#!/usr/bin/env cat\nours\n"),fs.chmodSync(ours,parseInt("0754",8)),n.end()}),t.test("promise",{skip:promiseSkip},function(n){var e=reset();n.test("meow async",function(n){e(meow).then(function(e){n.ok(e),n.end()})}),n.test("fail async",function(n){e(fail).then(function(e){n.notOk(e),n.end()})}),n.test("noent async",function(n){e(noent).catch(function(e){n.ok(e),n.end()})}),n.test("noent ignore async",function(n){e(noent,{ignoreErrors:!0}).then(function(e){n.notOk(e),n.end()})}),n.end()}),t.test("no promise",function(n){global.Promise=null;var e=reset();n.throws("try to meow a promise",function(){e(meow)}),n.end()}),t.test("access",{skip:accessSkip||winSkip},function(n){runTest(n)}),t.test("mode",{skip:winSkip},function(n){delete fs.access,delete fs.accessSync;var e=reset();n.ok(e.sync(ours,{uid:0,gid:0})),n.ok(e.sync(mine,{uid:0,gid:0})),runTest(n)}),t.test("windows",function(n){global.TESTING_WINDOWS=!0;var e=".EXE;.CAT;.CMD;.COM";n.test("pathExt option",function(n){runTest(n,{pathExt:".EXE;.CAT;.CMD;.COM"})}),n.test("pathExt env",function(n){process.env.PATHEXT=e,runTest(n)}),n.test("no pathExt",function(n){runTest(n,{pathExt:"",skipFail:!0})}),n.test("pathext with empty entry",function(n){runTest(n,{pathExt:";"+e,skipFail:!0})}),n.end()}),t.test("cleanup",function(n){rimraf.sync(fixture),n.end()});