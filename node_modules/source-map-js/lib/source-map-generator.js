var base64VLQ=require("./base64-vlq"),util=require("./util"),ArraySet=require("./array-set").ArraySet,MappingList=require("./mapping-list").MappingList;function SourceMapGenerator(e){e||(e={}),this._file=util.getArg(e,"file",null),this._sourceRoot=util.getArg(e,"sourceRoot",null),this._skipValidation=util.getArg(e,"skipValidation",!1),this._ignoreInvalidMapping=util.getArg(e,"ignoreInvalidMapping",!1),this._sources=new ArraySet,this._names=new ArraySet,this._mappings=new MappingList,this._sourcesContents=null}SourceMapGenerator.prototype._version=3,SourceMapGenerator.fromSourceMap=function(e,n){var o=e.sourceRoot,r=new SourceMapGenerator(Object.assign(n||{},{file:e.file,sourceRoot:o}));return e.eachMapping(function(e){var n={generated:{line:e.generatedLine,column:e.generatedColumn}};null!=e.source&&(n.source=e.source,null!=o&&(n.source=util.relative(o,n.source)),n.original={line:e.originalLine,column:e.originalColumn},null!=e.name&&(n.name=e.name)),r.addMapping(n)}),e.sources.forEach(function(n){var t=n;null!==o&&(t=util.relative(o,n)),r._sources.has(t)||r._sources.add(t);var i=e.sourceContentFor(n);null!=i&&r.setSourceContent(n,i)}),r},SourceMapGenerator.prototype.addMapping=function(e){var n=util.getArg(e,"generated"),o=util.getArg(e,"original",null),r=util.getArg(e,"source",null),t=util.getArg(e,"name",null);(this._skipValidation||!1!==this._validateMapping(n,o,r,t))&&(null!=r&&(r=String(r),this._sources.has(r)||this._sources.add(r)),null!=t&&(t=String(t),this._names.has(t)||this._names.add(t)),this._mappings.add({generatedLine:n.line,generatedColumn:n.column,originalLine:null!=o&&o.line,originalColumn:null!=o&&o.column,source:r,name:t}))},SourceMapGenerator.prototype.setSourceContent=function(e,n){var o=e;null!=this._sourceRoot&&(o=util.relative(this._sourceRoot,o)),null!=n?(this._sourcesContents||(this._sourcesContents=Object.create(null)),this._sourcesContents[util.toSetString(o)]=n):this._sourcesContents&&(delete this._sourcesContents[util.toSetString(o)],0===Object.keys(this._sourcesContents).length&&(this._sourcesContents=null))},SourceMapGenerator.prototype.applySourceMap=function(e,n,o){var r=n;if(null==n){if(null==e.file)throw new Error('SourceMapGenerator.prototype.applySourceMap requires either an explicit source file, or the source map\'s "file" property. Both were omitted.');r=e.file}var t=this._sourceRoot;null!=t&&(r=util.relative(t,r));var i=new ArraySet,s=new ArraySet;this._mappings.unsortedForEach(function(n){if(n.source===r&&null!=n.originalLine){var l=e.originalPositionFor({line:n.originalLine,column:n.originalColumn});null!=l.source&&(n.source=l.source,null!=o&&(n.source=util.join(o,n.source)),null!=t&&(n.source=util.relative(t,n.source)),n.originalLine=l.line,n.originalColumn=l.column,null!=l.name&&(n.name=l.name))}var a=n.source;null==a||i.has(a)||i.add(a);var u=n.name;null==u||s.has(u)||s.add(u)},this),this._sources=i,this._names=s,e.sources.forEach(function(n){var r=e.sourceContentFor(n);null!=r&&(null!=o&&(n=util.join(o,n)),null!=t&&(n=util.relative(t,n)),this.setSourceContent(n,r))},this)},SourceMapGenerator.prototype._validateMapping=function(e,n,o,r){if(n&&"number"!=typeof n.line&&"number"!=typeof n.column){var t="original.line and original.column are not numbers -- you probably meant to omit the original mapping entirely and only map the generated position. If so, pass null for the original mapping instead of an object with empty or null values.";if(this._ignoreInvalidMapping)return"undefined"!=typeof console&&console.warn&&console.warn(t),!1;throw new Error(t)}if((!(e&&"line"in e&&"column"in e&&e.line>0&&e.column>=0)||n||o||r)&&!(e&&"line"in e&&"column"in e&&n&&"line"in n&&"column"in n&&e.line>0&&e.column>=0&&n.line>0&&n.column>=0&&o)){if(t="Invalid mapping: "+JSON.stringify({generated:e,source:o,original:n,name:r}),this._ignoreInvalidMapping)return"undefined"!=typeof console&&console.warn&&console.warn(t),!1;throw new Error(t)}},SourceMapGenerator.prototype._serializeMappings=function(){for(var e,n,o,r,t=0,i=1,s=0,l=0,a=0,u=0,c="",p=this._mappings.toArray(),g=0,h=p.length;g<h;g++){if(e="",(n=p[g]).generatedLine!==i)for(t=0;n.generatedLine!==i;)e+=";",i++;else if(g>0){if(!util.compareByGeneratedPositionsInflated(n,p[g-1]))continue;e+=","}e+=base64VLQ.encode(n.generatedColumn-t),t=n.generatedColumn,null!=n.source&&(r=this._sources.indexOf(n.source),e+=base64VLQ.encode(r-u),u=r,e+=base64VLQ.encode(n.originalLine-1-l),l=n.originalLine-1,e+=base64VLQ.encode(n.originalColumn-s),s=n.originalColumn,null!=n.name&&(o=this._names.indexOf(n.name),e+=base64VLQ.encode(o-a),a=o)),c+=e}return c},SourceMapGenerator.prototype._generateSourcesContent=function(e,n){return e.map(function(e){if(!this._sourcesContents)return null;null!=n&&(e=util.relative(n,e));var o=util.toSetString(e);return Object.prototype.hasOwnProperty.call(this._sourcesContents,o)?this._sourcesContents[o]:null},this)},SourceMapGenerator.prototype.toJSON=function(){var e={version:this._version,sources:this._sources.toArray(),names:this._names.toArray(),mappings:this._serializeMappings()};return null!=this._file&&(e.file=this._file),null!=this._sourceRoot&&(e.sourceRoot=this._sourceRoot),this._sourcesContents&&(e.sourcesContent=this._generateSourcesContent(e.sources,e.sourceRoot)),e},SourceMapGenerator.prototype.toString=function(){return JSON.stringify(this.toJSON())},exports.SourceMapGenerator=SourceMapGenerator;