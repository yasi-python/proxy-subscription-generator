import{Minimatch}from"minimatch";import{fileURLToPath}from"node:url";import{PathScurry,PathScurryDarwin,PathScurryPosix,PathScurryWin32}from"path-scurry";import{Pattern}from"./pattern.js";import{GlobStream,GlobWalker}from"./walker.js";const defaultPlatform="object"==typeof process&&process&&"string"==typeof process.platform?process.platform:"linux";export class Glob{absolute;cwd;root;dot;dotRelative;follow;ignore;magicalBraces;mark;matchBase;maxDepth;nobrace;nocase;nodir;noext;noglobstar;pattern;platform;realpath;scurry;stat;signal;windowsPathsNoEscape;withFileTypes;includeChildMatches;opts;patterns;constructor(t,s){if(!s)throw new TypeError("glob options required");if(this.withFileTypes=!!s.withFileTypes,this.signal=s.signal,this.follow=!!s.follow,this.dot=!!s.dot,this.dotRelative=!!s.dotRelative,this.nodir=!!s.nodir,this.mark=!!s.mark,s.cwd?(s.cwd instanceof URL||s.cwd.startsWith("file://"))&&(s.cwd=fileURLToPath(s.cwd)):this.cwd="",this.cwd=s.cwd||"",this.root=s.root,this.magicalBraces=!!s.magicalBraces,this.nobrace=!!s.nobrace,this.noext=!!s.noext,this.realpath=!!s.realpath,this.absolute=s.absolute,this.includeChildMatches=!1!==s.includeChildMatches,this.noglobstar=!!s.noglobstar,this.matchBase=!!s.matchBase,this.maxDepth="number"==typeof s.maxDepth?s.maxDepth:1/0,this.stat=!!s.stat,this.ignore=s.ignore,this.withFileTypes&&void 0!==this.absolute)throw new Error("cannot set absolute and withFileTypes:true");if("string"==typeof t&&(t=[t]),this.windowsPathsNoEscape=!!s.windowsPathsNoEscape||!1===s.allowWindowsEscape,this.windowsPathsNoEscape&&(t=t.map(t=>t.replace(/\\/g,"/"))),this.matchBase){if(s.noglobstar)throw new TypeError("base matching requires globstar");t=t.map(t=>t.includes("/")?t:`./**/${t}`)}if(this.pattern=t,this.platform=s.platform||defaultPlatform,this.opts={...s,platform:this.platform},s.scurry){if(this.scurry=s.scurry,void 0!==s.nocase&&s.nocase!==s.scurry.nocase)throw new Error("nocase option contradicts provided scurry option")}else{const t="win32"===s.platform?PathScurryWin32:"darwin"===s.platform?PathScurryDarwin:s.platform?PathScurryPosix:PathScurry;this.scurry=new t(this.cwd,{nocase:s.nocase,fs:s.fs})}this.nocase=this.scurry.nocase;const a="darwin"===this.platform||"win32"===this.platform,e={...s,dot:this.dot,matchBase:this.matchBase,nobrace:this.nobrace,nocase:this.nocase,nocaseMagicOnly:a,nocomment:!0,noext:this.noext,nonegate:!0,optimizationLevel:2,platform:this.platform,windowsPathsNoEscape:this.windowsPathsNoEscape,debug:!!this.opts.debug},r=this.pattern.map(t=>new Minimatch(t,e)),[i,o]=r.reduce((t,s)=>(t[0].push(...s.set),t[1].push(...s.globParts),t),[[],[]]);this.patterns=i.map((t,s)=>{const a=o[s];if(!a)throw new Error("invalid pattern object");return new Pattern(t,a,0,this.platform)})}async walk(){return[...await new GlobWalker(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).walk()]}walkSync(){return[...new GlobWalker(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).walkSync()]}stream(){return new GlobStream(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).stream()}streamSync(){return new GlobStream(this.patterns,this.scurry.cwd,{...this.opts,maxDepth:this.maxDepth!==1/0?this.maxDepth+this.scurry.cwd.depth():1/0,platform:this.platform,nocase:this.nocase,includeChildMatches:this.includeChildMatches}).streamSync()}iterateSync(){return this.streamSync()[Symbol.iterator]()}[Symbol.iterator](){return this.iterateSync()}iterate(){return this.stream()[Symbol.asyncIterator]()}[Symbol.asyncIterator](){return this.iterate()}}