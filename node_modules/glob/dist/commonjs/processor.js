"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Processor=exports.SubWalks=exports.MatchRecord=exports.HasWalkedCache=void 0;const minimatch_1=require("minimatch");class HasWalkedCache{store;constructor(t=new Map){this.store=t}copy(){return new HasWalkedCache(new Map(this.store))}hasWalked(t,s){return this.store.get(t.fullpath())?.has(s.globString())}storeWalked(t,s){const e=t.fullpath(),a=this.store.get(e);a?a.add(s.globString()):this.store.set(e,new Set([s.globString()]))}}exports.HasWalkedCache=HasWalkedCache;class MatchRecord{store=new Map;add(t,s,e){const a=(s?2:0)|(e?1:0),o=this.store.get(t);this.store.set(t,void 0===o?a:a&o)}entries(){return[...this.store.entries()].map(([t,s])=>[t,!!(2&s),!!(1&s)])}}exports.MatchRecord=MatchRecord;class SubWalks{store=new Map;add(t,s){if(!t.canReaddir())return;const e=this.store.get(t);e?e.find(t=>t.globString()===s.globString())||e.push(s):this.store.set(t,[s])}get(t){const s=this.store.get(t);if(!s)throw new Error("attempting to walk unknown path");return s}entries(){return this.keys().map(t=>[t,this.store.get(t)])}keys(){return[...this.store.keys()].filter(t=>t.canReaddir())}}exports.SubWalks=SubWalks;class Processor{hasWalkedCache;matches=new MatchRecord;subwalks=new SubWalks;patterns;follow;dot;opts;constructor(t,s){this.opts=t,this.follow=!!t.follow,this.dot=!!t.dot,this.hasWalkedCache=s?s.copy():new HasWalkedCache}processPatterns(t,s){this.patterns=s;const e=s.map(s=>[t,s]);for(let[t,s]of e){this.hasWalkedCache.storeWalked(t,s);const e=s.root(),a=s.isAbsolute()&&!1!==this.opts.absolute;if(e){t=t.resolve("/"===e&&void 0!==this.opts.root?this.opts.root:e);const a=s.rest();if(!a){this.matches.add(t,!0,!1);continue}s=a}if(t.isENOENT())continue;let o,r,i=!1;for(;"string"==typeof(o=s.pattern())&&(r=s.rest());){const e=t.resolve(o);t=e,s=r,i=!0}if(o=s.pattern(),r=s.rest(),i){if(this.hasWalkedCache.hasWalked(t,s))continue;this.hasWalkedCache.storeWalked(t,s)}if("string"==typeof o){const s=".."===o||""===o||"."===o;this.matches.add(t.resolve(o),a,s);continue}if(o===minimatch_1.GLOBSTAR){(!t.isSymbolicLink()||this.follow||s.checkFollowGlobstar())&&this.subwalks.add(t,s);const e=r?.pattern(),o=r?.rest();if(r&&(""!==e&&"."!==e||o)){if(".."===e){const s=t.parent||t;o?this.hasWalkedCache.hasWalked(s,o)||this.subwalks.add(s,o):this.matches.add(s,a,!0)}}else this.matches.add(t,a,""===e||"."===e)}else o instanceof RegExp&&this.subwalks.add(t,s)}return this}subwalkTargets(){return this.subwalks.keys()}child(){return new Processor(this.opts,this.hasWalkedCache)}filterEntries(t,s){const e=this.subwalks.get(t),a=this.child();for(const t of s)for(const s of e){const e=s.isAbsolute(),o=s.pattern(),r=s.rest();o===minimatch_1.GLOBSTAR?a.testGlobstar(t,s,r,e):o instanceof RegExp?a.testRegExp(t,o,r,e):a.testString(t,o,r,e)}return a}testGlobstar(t,s,e,a){if(!this.dot&&t.name.startsWith(".")||(s.hasMore()||this.matches.add(t,a,!1),t.canReaddir()&&(this.follow||!t.isSymbolicLink()?this.subwalks.add(t,s):t.isSymbolicLink()&&(e&&s.checkFollowGlobstar()?this.subwalks.add(t,e):s.markFollowGlobstar()&&this.subwalks.add(t,s)))),e){const s=e.pattern();if("string"==typeof s&&".."!==s&&""!==s&&"."!==s)this.testString(t,s,e.rest(),a);else if(".."===s){const s=t.parent||t;this.subwalks.add(s,e)}else s instanceof RegExp&&this.testRegExp(t,s,e.rest(),a)}}testRegExp(t,s,e,a){s.test(t.name)&&(e?this.subwalks.add(t,e):this.matches.add(t,a,!1))}testString(t,s,e,a){t.isNamed(s)&&(e?this.subwalks.add(t,e):this.matches.add(t,a,!1))}}exports.Processor=Processor;