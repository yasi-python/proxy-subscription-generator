var test=require("tape"),path=require("path"),parse=path.parse||require("path-parse"),keys=require("object-keys"),nodeModulesPaths=require("../lib/node-modules-paths"),verifyDirs=function(e,o,t,n,r){var s=[].concat(n||"node_modules");if(r)for(var a=0;a<r.length;++a)s.push(path.basename(r[a]));for(var i={},d={},u={},l=0;l<t.length;++l){var h=parse(t[l]);i[h.base]||(i[h.base]=0),i[h.base]+=1,u[h.dir]=!0,d[t[l]]=!0}e.equal(keys(u).length>=o.split(path.sep).length,!0,'there are >= dirs than "start" has');var p=keys(i);e.deepEqual(p,s,"all desired module dirs were found"),e.equal(keys(d).length,t.length,"all dirs provided were unique");for(var c={},m=0;m<p.length;++m)c[i[m]]=!0;e.equal(keys(c).length,1,"all found module directories had the same count")};test("node-modules-paths",function(e){e.test("no options",function(e){var o=path.join(__dirname,"resolver"),t=nodeModulesPaths(o);verifyDirs(e,o,t),e.end()}),e.test("empty options",function(e){var o=path.join(__dirname,"resolver"),t=nodeModulesPaths(o,{});verifyDirs(e,o,t),e.end()}),e.test("with paths=array option",function(e){var o=path.join(__dirname,"resolver"),t=["a","b"],n=nodeModulesPaths(o,{paths:t});verifyDirs(e,o,n,null,t),e.end()}),e.test("with paths=function option",function(e){var o=path.join(__dirname,"resolver"),t=nodeModulesPaths(o,{paths:function(e,o,t,n){return t().concat(path.join(o,"not node modules",e))}},"pkg");verifyDirs(e,o,t,null,[path.join(o,"not node modules","pkg")]),e.end()}),e.test("with paths=function skipping node modules resolution",function(e){var o=path.join(__dirname,"resolver"),t=nodeModulesPaths(o,{paths:function(e,o,t,n){return[]}});e.deepEqual(t,[],"no node_modules was computed"),e.end()}),e.test("with moduleDirectory option",function(e){var o=path.join(__dirname,"resolver"),t="not node modules",n=nodeModulesPaths(o,{moduleDirectory:t});verifyDirs(e,o,n,t),e.end()}),e.test("with 1 moduleDirectory and paths options",function(e){var o=path.join(__dirname,"resolver"),t=["a","b"],n="not node modules",r=nodeModulesPaths(o,{paths:t,moduleDirectory:n});verifyDirs(e,o,r,n,t),e.end()}),e.test("with 1+ moduleDirectory and paths options",function(e){var o=path.join(__dirname,"resolver"),t=["a","b"],n=["not node modules","other modules"],r=nodeModulesPaths(o,{paths:t,moduleDirectory:n});verifyDirs(e,o,r,n,t),e.end()}),e.test("combine paths correctly on Windows",function(e){var o="C:\\Users\\username\\myProject\\src",t=nodeModulesPaths(o,{paths:[],moduleDirectory:["node_modules",o]});e.equal(t.indexOf(path.resolve(o))>-1,!0,"should contain start dir"),e.end()}),e.test("combine paths correctly on non-Windows",{skip:"win32"===process.platform},function(e){var o="/Users/username/git/myProject/src",t=nodeModulesPaths(o,{paths:[],moduleDirectory:["node_modules","/Users/username/git/myProject/src"]});e.equal(t.indexOf(path.resolve(o))>-1,!0,"should contain start dir"),e.end()})});