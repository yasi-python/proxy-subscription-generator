var path=require("path"),test=require("tape"),resolve=require("../");test("mock",function(e){e.plan(8);var o={};o[path.resolve("/foo/bar/baz.js")]="beep";var a={};function r(e){return{basedir:path.resolve(e),isFile:function(e,a){a(null,Object.prototype.hasOwnProperty.call(o,path.resolve(e)))},isDirectory:function(e,o){o(null,!!a[path.resolve(e)])},readFile:function(e,a){a(null,o[path.resolve(e)])},realpath:function(e,o){o(null,e)}}}a[path.resolve("/foo/bar")]=!0,resolve("./baz",r("/foo/bar"),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/bar/baz.js")),e.equal(r,void 0)}),resolve("./baz.js",r("/foo/bar"),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/bar/baz.js")),e.equal(r,void 0)}),resolve("baz",r("/foo/bar"),function(o,a){e.equal(o.message,"Cannot find module 'baz' from '"+path.resolve("/foo/bar")+"'"),e.equal(o.code,"MODULE_NOT_FOUND")}),resolve("../baz",r("/foo/bar"),function(o,a){e.equal(o.message,"Cannot find module '../baz' from '"+path.resolve("/foo/bar")+"'"),e.equal(o.code,"MODULE_NOT_FOUND")})}),test("mock from package",function(e){e.plan(8);var o={};o[path.resolve("/foo/bar/baz.js")]="beep";var a={};function r(e){return{basedir:path.resolve(e),isFile:function(e,a){a(null,Object.prototype.hasOwnProperty.call(o,e))},isDirectory:function(e,o){o(null,!!a[path.resolve(e)])},package:{main:"bar"},readFile:function(e,a){a(null,o[e])},realpath:function(e,o){o(null,e)}}}a[path.resolve("/foo/bar")]=!0,resolve("./baz",r("/foo/bar"),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/bar/baz.js")),e.equal(r&&r.main,"bar")}),resolve("./baz.js",r("/foo/bar"),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/bar/baz.js")),e.equal(r&&r.main,"bar")}),resolve("baz",r("/foo/bar"),function(o,a){e.equal(o.message,"Cannot find module 'baz' from '"+path.resolve("/foo/bar")+"'"),e.equal(o.code,"MODULE_NOT_FOUND")}),resolve("../baz",r("/foo/bar"),function(o,a){e.equal(o.message,"Cannot find module '../baz' from '"+path.resolve("/foo/bar")+"'"),e.equal(o.code,"MODULE_NOT_FOUND")})}),test("mock package",function(e){e.plan(2);var o={};o[path.resolve("/foo/node_modules/bar/baz.js")]="beep",o[path.resolve("/foo/node_modules/bar/package.json")]=JSON.stringify({main:"./baz.js"});var a,r={};r[path.resolve("/foo")]=!0,r[path.resolve("/foo/node_modules")]=!0,resolve("bar",(a="/foo",{basedir:path.resolve(a),isFile:function(e,a){a(null,Object.prototype.hasOwnProperty.call(o,path.resolve(e)))},isDirectory:function(e,o){o(null,!!r[path.resolve(e)])},readFile:function(e,a){a(null,o[path.resolve(e)])},realpath:function(e,o){o(null,e)}}),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/node_modules/bar/baz.js")),e.equal(r&&r.main,"./baz.js")})}),test("mock package from package",function(e){e.plan(2);var o={};o[path.resolve("/foo/node_modules/bar/baz.js")]="beep",o[path.resolve("/foo/node_modules/bar/package.json")]=JSON.stringify({main:"./baz.js"});var a,r={};r[path.resolve("/foo")]=!0,r[path.resolve("/foo/node_modules")]=!0,resolve("bar",(a="/foo",{basedir:path.resolve(a),isFile:function(e,a){a(null,Object.prototype.hasOwnProperty.call(o,path.resolve(e)))},isDirectory:function(e,o){o(null,!!r[path.resolve(e)])},package:{main:"bar"},readFile:function(e,a){a(null,o[path.resolve(e)])},realpath:function(e,o){o(null,e)}}),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/node_modules/bar/baz.js")),e.equal(r&&r.main,"./baz.js")})}),test("symlinked",function(e){e.plan(4);var o={};o[path.resolve("/foo/bar/baz.js")]="beep",o[path.resolve("/foo/bar/symlinked/baz.js")]="beep";var a={};function r(e){return{preserveSymlinks:!1,basedir:path.resolve(e),isFile:function(e,a){a(null,Object.prototype.hasOwnProperty.call(o,path.resolve(e)))},isDirectory:function(e,o){o(null,!!a[path.resolve(e)])},readFile:function(e,a){a(null,o[path.resolve(e)])},realpath:function(e,o){var a=path.resolve(e);if(a.indexOf("symlinked")>=0)o(null,a);else if(path.extname(a)){var r=path.dirname(a),l=path.basename(a);o(null,path.join(r,"symlinked",l))}else o(null,path.join(a,"symlinked"))}}}a[path.resolve("/foo/bar")]=!0,a[path.resolve("/foo/bar/symlinked")]=!0,resolve("./baz",r("/foo/bar"),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/bar/symlinked/baz.js")),e.equal(r,void 0)}),resolve("./baz.js",r("/foo/bar"),function(o,a,r){if(o)return e.fail(o);e.equal(a,path.resolve("/foo/bar/symlinked/baz.js")),e.equal(r,void 0)})}),test("readPackage",function(e){e.plan(3);var o={};o[path.resolve("/foo/node_modules/bar/something-else.js")]="beep",o[path.resolve("/foo/node_modules/bar/package.json")]=JSON.stringify({main:"./baz.js"}),o[path.resolve("/foo/node_modules/bar/baz.js")]="boop";var a={};function r(e){return{basedir:path.resolve(e),isFile:function(e,a){a(null,Object.prototype.hasOwnProperty.call(o,path.resolve(e)))},isDirectory:function(e,o){o(null,!!a[path.resolve(e)])},package:{main:"bar"},readFile:function(e,a){a(null,o[path.resolve(e)])},realpath:function(e,o){o(null,e)}}}a[path.resolve("/foo")]=!0,a[path.resolve("/foo/node_modules")]=!0,e.test("with readFile",function(e){e.plan(3),resolve("bar",r("/foo"),function(o,a,r){e.error(o),e.equal(a,path.resolve("/foo/node_modules/bar/baz.js")),e.equal(r&&r.main,"./baz.js")})});var l=function(e,a,r){var l=path.join("bar","package.json");a.slice(-l.length)===l?r(null,{main:"./something-else.js"}):r(null,JSON.parse(o[path.resolve(a)]))};e.test("with readPackage",function(e){e.plan(3);var o=r("/foo");delete o.readFile,o.readPackage=l,resolve("bar",o,function(o,a,r){e.error(o),e.equal(a,path.resolve("/foo/node_modules/bar/something-else.js")),e.equal(r&&r.main,"./something-else.js")})}),e.test("with readFile and readPackage",function(e){e.plan(1);var o=r("/foo");o.readPackage=l,resolve("bar",o,function(o){e.throws(function(){throw o},TypeError,"errors when both readFile and readPackage are provided")})})});