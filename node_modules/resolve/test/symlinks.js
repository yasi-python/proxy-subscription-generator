var path=require("path"),fs=require("fs"),test=require("tape"),map=require("array.prototype.map"),resolve=require("../"),symlinkDir=path.join(__dirname,"resolver","symlinked","symlink"),packageDir=path.join(__dirname,"resolver","symlinked","_","node_modules","package"),modADir=path.join(__dirname,"symlinks","source","node_modules","mod-a"),symlinkModADir=path.join(__dirname,"symlinks","dest","node_modules","mod-a");try{fs.unlinkSync(symlinkDir)}catch(e){}try{fs.unlinkSync(packageDir)}catch(e){}try{fs.unlinkSync(modADir)}catch(e){}try{fs.unlinkSync(symlinkModADir)}catch(e){}try{fs.symlinkSync("./_/symlink_target",symlinkDir,"dir")}catch(e){fs.symlinkSync(path.join(__dirname,"resolver","symlinked","_","symlink_target")+"\\",symlinkDir,"junction")}try{fs.symlinkSync("../../package",packageDir,"dir")}catch(e){fs.symlinkSync(path.join(__dirname,"..","..","package")+"\\",packageDir,"junction")}try{fs.symlinkSync("../../source/node_modules/mod-a",symlinkModADir,"dir")}catch(e){fs.symlinkSync(path.join(__dirname,"..","..","source","node_modules","mod-a")+"\\",symlinkModADir,"junction")}test("symlink",function(e){e.plan(2),resolve("foo",{basedir:symlinkDir,preserveSymlinks:!1},function(n,r,s){e.error(n),e.equal(r,path.join(__dirname,"resolver","symlinked","_","node_modules","foo.js"))})}),test("sync symlink when preserveSymlinks = true",function(e){e.plan(4),resolve("foo",{basedir:symlinkDir},function(n,r,s){e.ok(n,"there is an error"),e.notOk(r,"no result"),e.equal(n&&n.code,"MODULE_NOT_FOUND","error code matches require.resolve"),e.equal(n&&n.message,"Cannot find module 'foo' from '"+symlinkDir+"'","can not find nonexistent module")})}),test("sync symlink",function(e){var n=new Date;e.doesNotThrow(function(){e.equal(resolve.sync("foo",{basedir:symlinkDir,preserveSymlinks:!1}),path.join(__dirname,"resolver","symlinked","_","node_modules","foo.js"))}),e.ok(new Date-n<50,"resolve.sync timedout"),e.end()}),test("sync symlink when preserveSymlinks = true",function(e){e.throws(function(){resolve.sync("foo",{basedir:symlinkDir})},/Cannot find module 'foo'/),e.end()}),test("sync symlink from node_modules to other dir when preserveSymlinks = false",function(e){var n=path.join(__dirname,"resolver","symlinked","_"),r=resolve.sync("package",{basedir:n,preserveSymlinks:!1});e.equal(r,path.resolve(__dirname,"resolver/symlinked/package/bar.js")),e.end()}),test("async symlink from node_modules to other dir when preserveSymlinks = false",function(e){e.plan(2);var n=path.join(__dirname,"resolver","symlinked","_");resolve("package",{basedir:n,preserveSymlinks:!1},function(n,r){e.notOk(n,"no error"),e.equal(r,path.resolve(__dirname,"resolver/symlinked/package/bar.js"))})}),test("packageFilter",function(e){function n(e){return path.relative(__dirname,e)}function r(e){return function(r){r.plan(3);var s="symlinks/dest/node_modules/mod-a/package.json",i="symlinks/source/node_modules/mod-a/package.json",o=path.join(__dirname,"symlinks","dest"),a=[];resolve("mod-a",{basedir:o,preserveSymlinks:e,packageFilter:function(e,n){a.push(n)}},function(o,l){r.error(o,"no error"),r.equal(n(l),path.normalize(e?"symlinks/dest/node_modules/mod-a/index.js":"symlinks/source/node_modules/mod-a/index.js"),"async: actual path is correct"),r.deepEqual(map(a,n),map(e?[s,s,s]:[i,i,i],path.normalize),"async: packageFilter pkgfile arg is correct")})}}e.test("preserveSymlinks: false",r(!1)),e.test("preserveSymlinks: true",r(!0)),e.end()});