"use strict";var fs=require("fs"),homedir=require("../lib/homedir"),path=require("path"),test=require("tape"),mkdirp=require("mkdirp"),rimraf=require("rimraf"),mv=require("mv"),copyDir=require("copy-dir"),tmp=require("tmp"),HOME=homedir(),hnm=path.join(HOME,".node_modules"),hnl=path.join(HOME,".node_libraries"),resolve=require("../sync");function makeDir(e,r,i){mkdirp(r,function(n){n?i(n):(e.teardown(function(){rimraf.sync(r)}),i())})}function makeTempDir(e,r,i){if(fs.existsSync(r)){var n=tmp.dirSync();e.teardown(n.removeCallback);var a=path.join(n.name,path.basename(r));mv(r,a,function(n){n?i(n):(e.teardown(function(){mv(a,r,i)}),makeDir(e,r,i))})}else makeDir(e,r,i)}test("homedir module paths",function(e){e.plan(7),makeTempDir(e,hnm,function(r){if(e.error(r,"no error with HNM temp dir"),r)return e.end();var i=path.join(hnm,"baz"),n=path.join(hnm,"dot_main");copyDir.sync(path.join(__dirname,"resolver/baz"),i),copyDir.sync(path.join(__dirname,"resolver/dot_main"),n);var a=path.join(i,"quux.js");e.equal(require.resolve("baz"),a,"sanity check: require.resolve finds HNM `baz`");var o=path.join(n,"index.js");e.equal(require.resolve("dot_main"),o,"sanity check: require.resolve finds `dot_main`"),makeTempDir(e,hnl,function(r){if(e.error(r,"no error with HNL temp dir"),r)return e.end();var i=path.join(hnl,"baz");copyDir.sync(path.join(__dirname,"resolver/baz"),i);var n=path.join(hnl,"dot_slash_main"),t=path.join(n,"index.js");copyDir.sync(path.join(__dirname,"resolver/dot_slash_main"),n),e.equal(require.resolve("baz"),a,"sanity check: require.resolve finds HNM `baz`"),e.equal(require.resolve("dot_slash_main"),t,"sanity check: require.resolve finds HNL `dot_slash_main`"),e.test("with temp dirs",function(e){e.plan(3),e.test("just in `$HOME/.node_modules`",function(e){e.plan(1);var r=resolve("dot_main");e.equal(r,o,"`dot_main` resolves in `$HOME/.node_modules`")}),e.test("just in `$HOME/.node_libraries`",function(e){e.plan(1);var r=resolve("dot_slash_main");e.equal(r,t,"`dot_slash_main` resolves in `$HOME/.node_libraries`")}),e.test("in `$HOME/.node_libraries` and `$HOME/.node_modules`",function(e){e.plan(1);var r=resolve("baz");e.equal(r,a,"`baz` resolves in `$HOME/.node_modules` when in both")})})})})});