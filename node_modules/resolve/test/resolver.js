var path=require("path"),fs=require("fs"),test=require("tape"),resolve=require("../"),async=require("../async");test("`./async` entry point",function(e){e.equal(resolve,async,"`./async` entry point is the same as `main`"),e.end()}),test("async foo",function(e){e.plan(12);var a=path.join(__dirname,"resolver");resolve("./foo",{basedir:a},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"foo.js")),e.equal(o&&o.name,"resolve")}),resolve("./foo.js",{basedir:a},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"foo.js")),e.equal(o&&o.name,"resolve")}),resolve("./foo",{basedir:a,package:{main:"resolver"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"foo.js")),e.equal(o&&o.main,"resolver")}),resolve("./foo.js",{basedir:a,package:{main:"resolver"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"foo.js")),e.equal(o.main,"resolver")}),resolve("./foo",{basedir:a,filename:path.join(a,"baz.js")},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"foo.js"))}),resolve("foo",{basedir:a},function(n){e.equal(n.message,"Cannot find module 'foo' from '"+path.resolve(a)+"'"),e.equal(n.code,"MODULE_NOT_FOUND")}),resolve("foo",{basedir:a,filename:path.join(a,"baz.js")},function(n){e.equal(n.message,"Cannot find module 'foo' from '"+path.join(a,"baz.js")+"'")})}),test("bar",function(e){e.plan(6);var a=path.join(__dirname,"resolver");resolve("foo",{basedir:a+"/bar"},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"bar/node_modules/foo/index.js")),e.equal(o,void 0)}),resolve("foo",{basedir:a+"/bar"},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"bar/node_modules/foo/index.js")),e.equal(o,void 0)}),resolve("foo",{basedir:a+"/bar",package:{main:"bar"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"bar/node_modules/foo/index.js")),e.equal(o.main,"bar")})}),test("baz",function(e){e.plan(4);var a=path.join(__dirname,"resolver");resolve("./baz",{basedir:a},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"baz/quux.js")),e.equal(o.main,"quux.js")}),resolve("./baz",{basedir:a,package:{main:"resolver"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"baz/quux.js")),e.equal(o.main,"quux.js")})}),test("biz",function(e){e.plan(24);var a=path.join(__dirname,"resolver/biz/node_modules");resolve("./grux",{basedir:a},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"grux/index.js")),e.equal(o,void 0)}),resolve("./grux",{basedir:a,package:{main:"biz"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"grux/index.js")),e.equal(o.main,"biz")}),resolve("./garply",{basedir:a},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"garply/lib/index.js")),e.equal(o.main,"./lib")}),resolve("./garply",{basedir:a,package:{main:"biz"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"garply/lib/index.js")),e.equal(o.main,"./lib")}),resolve("tiv",{basedir:a+"/grux"},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"tiv/index.js")),e.equal(o,void 0)}),resolve("tiv",{basedir:a+"/grux",package:{main:"grux"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"tiv/index.js")),e.equal(o.main,"grux")}),resolve("tiv",{basedir:a+"/garply"},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"tiv/index.js")),e.equal(o,void 0)}),resolve("tiv",{basedir:a+"/garply",package:{main:"./lib"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"tiv/index.js")),e.equal(o.main,"./lib")}),resolve("grux",{basedir:a+"/tiv"},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"grux/index.js")),e.equal(o,void 0)}),resolve("grux",{basedir:a+"/tiv",package:{main:"tiv"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"grux/index.js")),e.equal(o.main,"tiv")}),resolve("garply",{basedir:a+"/tiv"},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"garply/lib/index.js")),e.equal(o.main,"./lib")}),resolve("garply",{basedir:a+"/tiv",package:{main:"tiv"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"garply/lib/index.js")),e.equal(o.main,"./lib")})}),test("quux",function(e){e.plan(2);var a=path.join(__dirname,"resolver/quux");resolve("./foo",{basedir:a,package:{main:"quux"}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"foo/index.js")),e.equal(o.main,"quux")})}),test("normalize",function(e){e.plan(2);var a=path.join(__dirname,"resolver/biz/node_modules/grux");resolve("../grux",{basedir:a},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"index.js")),e.equal(o,void 0)})}),test("cup",function(e){e.plan(5);var a=path.join(__dirname,"resolver");resolve("./cup",{basedir:a,extensions:[".js",".coffee"]},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"cup.coffee"))}),resolve("./cup.coffee",{basedir:a},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"cup.coffee"))}),resolve("./cup",{basedir:a,extensions:[".js"]},function(n,i){e.equal(n.message,"Cannot find module './cup' from '"+path.resolve(a)+"'"),e.equal(n.code,"MODULE_NOT_FOUND")}),resolve("./cup",{basedir:a,extensions:[".js"],filename:path.join(a,"cupboard.js")},function(n,i){e.equal(n.message,"Cannot find module './cup' from '"+path.join(a,"cupboard.js")+"'")})}),test("mug",function(e){e.plan(3);var a=path.join(__dirname,"resolver");resolve("./mug",{basedir:a},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"mug.js"))}),resolve("./mug",{basedir:a,extensions:[".coffee",".js"]},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"/mug.coffee"))}),resolve("./mug",{basedir:a,extensions:[".js",".coffee"]},function(n,i){e.equal(i,path.join(a,"/mug.js"))})}),test("other path",function(e){e.plan(6);var a=path.join(__dirname,"resolver"),n=path.join(a,"bar"),i=path.join(a,"other_path");resolve("root",{basedir:n,paths:[i]},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"other_path/root.js"))}),resolve("lib/other-lib",{basedir:n,paths:[i]},function(n,i){n&&e.fail(n),e.equal(i,path.join(a,"other_path/lib/other-lib.js"))}),resolve("root",{basedir:n},function(a,i){e.equal(a.message,"Cannot find module 'root' from '"+path.resolve(n)+"'"),e.equal(a.code,"MODULE_NOT_FOUND")}),resolve("zzz",{basedir:n,paths:[i]},function(a,i){e.equal(a.message,"Cannot find module 'zzz' from '"+path.resolve(n)+"'"),e.equal(a.code,"MODULE_NOT_FOUND")})}),test("path iterator",function(e){e.plan(2);var a=path.join(__dirname,"resolver");resolve("baz",{packageIterator:function(e,n,i,o){return[path.join(a,e)]}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"baz/quux.js")),e.equal(o&&o.name,"baz")})}),test("incorrect main",function(e){e.plan(1);var a=path.join(__dirname,"resolver"),n=path.join(a,"incorrect_main");resolve("./incorrect_main",{basedir:a},function(a,i,o){a&&e.fail(a),e.equal(i,path.join(n,"index.js"))})}),test("missing index",function(e){e.plan(2);var a=path.join(__dirname,"resolver");resolve("./missing_index",{basedir:a},function(a,n,i){e.ok(a instanceof Error),e.equal(a&&a.code,"MODULE_NOT_FOUND","error has correct error code")})}),test("missing main",function(e){e.plan(1);var a=path.join(__dirname,"resolver");resolve("./missing_main",{basedir:a},function(a,n,i){e.equal(a&&a.code,"MODULE_NOT_FOUND","error has correct error code")})}),test("null main",function(e){e.plan(1);var a=path.join(__dirname,"resolver");resolve("./null_main",{basedir:a},function(a,n,i){e.equal(a&&a.code,"MODULE_NOT_FOUND","error has correct error code")})}),test("main: false",function(e){e.plan(2);var a=path.join(__dirname,"resolver"),n=path.join(a,"false_main");resolve("./false_main",{basedir:a},function(a,i,o){a&&e.fail(a),e.equal(i,path.join(n,"index.js"),'`"main": false`: resolves to `index.js`'),e.deepEqual(o,{name:"false_main",main:!1})})}),test("without basedir",function(e){e.plan(1);var a=path.join(__dirname,"resolver/without_basedir");require(path.join(a,"main.js"))(e,function(n,i,o){n?e.fail(n):e.equal(i,path.join(a,"node_modules/mymodule.js"))})}),test('#52 - incorrectly resolves module-paths like "./someFolder/" when there is a file of the same name',function(e){e.plan(2);var a=path.join(__dirname,"resolver");resolve("./foo",{basedir:path.join(a,"same_names")},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"same_names/foo.js"))}),resolve("./foo/",{basedir:path.join(a,"same_names")},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"same_names/foo/index.js"))})}),test('#211 - incorrectly resolves module-paths like "." when from inside a folder with a sibling file of the same name',function(e){e.plan(2);var a=path.join(__dirname,"resolver");resolve("./",{basedir:path.join(a,"same_names/foo")},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"same_names/foo/index.js"))}),resolve(".",{basedir:path.join(a,"same_names/foo")},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"same_names/foo/index.js"))})}),test("async: #121 - treating an existing file as a dir when no basedir",function(e){var a=path.basename(__filename);e.test("sanity check",function(n){n.plan(1),resolve("./"+a,function(a,i,o){a&&e.fail(a),n.equal(i,__filename,"sanity check")})}),e.test("with a fake directory",function(e){e.plan(4),resolve("./"+a+"/blah",function(n,i,o){e.ok(n,"there is an error"),e.notOk(i,"no result"),e.equal(n&&n.code,"MODULE_NOT_FOUND","error code matches require.resolve"),e.equal(n&&n.message,"Cannot find module './"+a+"/blah' from '"+__dirname+"'","can not find nonexistent module"),e.end()})}),e.end()}),test("async dot main",function(e){var a=new Date;e.plan(3),resolve("./resolver/dot_main",function(n,i){e.notOk(n),e.equal(i,path.join(__dirname,"resolver/dot_main/index.js")),e.ok(new Date-a<50,"resolve.sync timedout"),e.end()})}),test("async dot slash main",function(e){var a=new Date;e.plan(3),resolve("./resolver/dot_slash_main",function(n,i){e.notOk(n),e.equal(i,path.join(__dirname,"resolver/dot_slash_main/index.js")),e.ok(new Date-a<50,"resolve.sync timedout"),e.end()})}),test("not a directory",function(e){e.plan(6);var a="./foo";resolve(a,{basedir:__filename},function(a,n,i){e.ok(a,"a non-directory errors"),e.equal(arguments.length,1),e.equal(n,void 0),e.equal(i,void 0),e.equal(a&&a.message,"Cannot find module './foo' from '"+__filename+"'"),e.equal(a&&a.code,"MODULE_NOT_FOUND")})}),test('non-string "main" field in package.json',function(e){e.plan(5);var a=path.join(__dirname,"resolver");resolve("./invalid_main",{basedir:a},function(a,n,i){e.ok(a,"errors on non-string main"),e.equal(a.message,"package “invalid_main” `main` must be a string"),e.equal(a.code,"INVALID_PACKAGE_MAIN"),e.equal(n,void 0,"res is undefined"),e.equal(i,void 0,"pkg is undefined")})}),test('non-string "main" field in package.json',function(e){e.plan(5);var a=path.join(__dirname,"resolver");resolve("./invalid_main",{basedir:a},function(a,n,i){e.ok(a,"errors on non-string main"),e.equal(a.message,"package “invalid_main” `main` must be a string"),e.equal(a.code,"INVALID_PACKAGE_MAIN"),e.equal(n,void 0,"res is undefined"),e.equal(i,void 0,"pkg is undefined")})}),test("browser field in package.json",function(e){e.plan(3);var a=path.join(__dirname,"resolver");resolve("./browser_field",{basedir:a,packageFilter:function(e){return e.browser&&(e.main=e.browser,delete e.browser),e}},function(n,i,o){n&&e.fail(n),e.equal(i,path.join(a,"browser_field","b.js")),e.equal(o&&o.main,"b"),e.equal(o&&o.browser,void 0)})}),test("absolute paths",function(e){e.plan(4);var a=__filename.slice(0,-path.extname(__filename).length);resolve(__filename,function(a,n){e.equal(n,__filename,"absolute path to this file resolves")}),resolve(a,function(a,n){e.equal(n,__filename,"extensionless absolute path to this file resolves")}),resolve(__filename,{basedir:process.cwd()},function(a,n){e.equal(n,__filename,"absolute path to this file with a basedir resolves")}),resolve(a,{basedir:process.cwd()},function(a,n){e.equal(n,__filename,"extensionless absolute path to this file with a basedir resolves")})});var malformedDir=path.join(__dirname,"resolver/malformed_package_json");test("malformed package.json",{skip:!fs.existsSync(malformedDir)},function(e){e.plan(11);var a=malformedDir,n=path.join(a,"index.js");resolve("./index.js",{basedir:a},function(a,i,o){e.error(a,"no error"),e.equal(i,n,"malformed package.json is silently ignored"),e.equal(o,void 0,"malformed package.json gives an undefined `pkg` argument")}),resolve("./index.js",{basedir:a,packageFilter:function(a,n,i){e.fail("should not reach here")}},function(a,i,o){e.error(a,"with packageFilter: no error"),e.equal(i,n,"with packageFilter: malformed package.json is silently ignored"),e.equal(o,void 0,"with packageFilter: malformed package.json gives an undefined `pkg` argument")}),resolve("./index.js",{basedir:a,readPackage:function(n,i,o){e.equal(i,path.join(a,"package.json"),"readPackageSync: `pkgfile` is package.json path"),n(i,function(a,n){try{o(null,JSON.parse(n))}catch(a){e.ok(a instanceof SyntaxError,"readPackage: malformed package.json parses as a syntax error"),o(null)}})}},function(a,i,o){e.error(a,"with readPackage: no error"),e.equal(i,n,"with readPackage: malformed package.json is silently ignored"),e.equal(o,void 0,"with readPackage: malformed package.json gives an undefined `pkg` argument")})});