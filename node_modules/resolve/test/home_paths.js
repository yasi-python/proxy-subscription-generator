"use strict";var fs=require("fs"),homedir=require("../lib/homedir"),path=require("path"),test=require("tape"),mkdirp=require("mkdirp"),rimraf=require("rimraf"),mv=require("mv"),copyDir=require("copy-dir"),tmp=require("tmp"),HOME=homedir(),hnm=path.join(HOME,".node_modules"),hnl=path.join(HOME,".node_libraries"),resolve=require("../async");function makeDir(e,r,n){mkdirp(r,function(i){i?n(i):(e.teardown(function(){rimraf.sync(r)}),n())})}function makeTempDir(e,r,n){if(fs.existsSync(r)){var i=tmp.dirSync();e.teardown(i.removeCallback);var o=path.join(i.name,path.basename(r));mv(r,o,function(i){i?n(i):(e.teardown(function(){mv(o,r,n)}),makeDir(e,r,n))})}else makeDir(e,r,n)}test("homedir module paths",function(e){e.plan(7),makeTempDir(e,hnm,function(r){if(e.error(r,"no error with HNM temp dir"),r)return e.end();var n=path.join(hnm,"baz"),i=path.join(hnm,"dot_main");copyDir.sync(path.join(__dirname,"resolver/baz"),n),copyDir.sync(path.join(__dirname,"resolver/dot_main"),i);var o={name:"baz",main:"quux.js"},a={main:"index"},s=path.join(n,"quux.js");e.equal(require.resolve("baz"),s,"sanity check: require.resolve finds HNM `baz`");var t=path.join(i,"index.js");e.equal(require.resolve("dot_main"),t,"sanity check: require.resolve finds `dot_main`"),makeTempDir(e,hnl,function(r){if(e.error(r,"no error with HNL temp dir"),r)return e.end();var n=path.join(hnl,"baz");copyDir.sync(path.join(__dirname,"resolver/baz"),n);var i=path.join(hnl,"dot_slash_main"),m=path.join(i,"index.js"),d={main:"index"};copyDir.sync(path.join(__dirname,"resolver/dot_slash_main"),i),e.equal(require.resolve("baz"),s,"sanity check: require.resolve finds HNM `baz`"),e.equal(require.resolve("dot_slash_main"),m,"sanity check: require.resolve finds HNL `dot_slash_main`"),e.test("with temp dirs",function(e){e.plan(3),e.test("just in `$HOME/.node_modules`",function(e){e.plan(3),resolve("dot_main",function(r,n,i){e.error(r,"no error resolving `dot_main`"),e.equal(n,t,"`dot_main` resolves in `$HOME/.node_modules`"),e.deepEqual(i,a)})}),e.test("just in `$HOME/.node_libraries`",function(e){e.plan(3),resolve("dot_slash_main",function(r,n,i){e.error(r,"no error resolving `dot_slash_main`"),e.equal(n,m,"`dot_slash_main` resolves in `$HOME/.node_libraries`"),e.deepEqual(i,d)})}),e.test("in `$HOME/.node_libraries` and `$HOME/.node_modules`",function(e){e.plan(3),resolve("baz",function(r,n,i){e.error(r,"no error resolving `baz`"),e.equal(n,s,"`baz` resolves in `$HOME/.node_modules` when in both"),e.deepEqual(i,o)})})})})})});