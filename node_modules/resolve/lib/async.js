var fs=require("fs"),getHomedir=require("./homedir"),path=require("path"),caller=require("./caller"),nodeModulesPaths=require("./node-modules-paths"),normalizeOptions=require("./normalize-options"),isCore=require("is-core-module"),realpathFS="win32"!==process.platform&&fs.realpath&&"function"==typeof fs.realpath.native?fs.realpath.native:fs.realpath,homedir=getHomedir(),defaultPaths=function(){return[path.join(homedir,".node_modules"),path.join(homedir,".node_libraries")]},defaultIsFile=function(e,n){fs.stat(e,function(e,a){return e?"ENOENT"===e.code||"ENOTDIR"===e.code?n(null,!1):n(e):n(null,a.isFile()||a.isFIFO())})},defaultIsDir=function(e,n){fs.stat(e,function(e,a){return e?"ENOENT"===e.code||"ENOTDIR"===e.code?n(null,!1):n(e):n(null,a.isDirectory())})},defaultRealpath=function(e,n){realpathFS(e,function(a,t){a&&"ENOENT"!==a.code?n(a):n(null,a?e:t)})},maybeRealpath=function(e,n,a,t){a&&!1===a.preserveSymlinks?e(n,t):t(null,n)},defaultReadPackage=function(e,n,a){e(n,function(e,n){if(e)a(e);else try{var t=JSON.parse(n);a(null,t)}catch(e){a(null)}})},getPackageCandidates=function(e,n,a){for(var t=nodeModulesPaths(n,a,e),r=0;r<t.length;r++)t[r]=path.join(t[r],e);return t};module.exports=function(e,n,a){var t=a,r=n;if("function"==typeof n&&(t=r,r={}),"string"!=typeof e){var i=new TypeError("Path must be a string.");return process.nextTick(function(){t(i)})}var o=(r=normalizeOptions(e,r)).isFile||defaultIsFile,l=r.isDirectory||defaultIsDir,u=r.readFile||fs.readFile,f=r.realpath||defaultRealpath,c=r.readPackage||defaultReadPackage;if(r.readFile&&r.readPackage){var s=new TypeError("`readFile` and `readPackage` are mutually exclusive.");return process.nextTick(function(){t(s)})}var d=r.packageIterator,p=r.extensions||[".js"],h=!1!==r.includeCoreModules,m=r.basedir||path.dirname(caller()),v=r.filename||m;r.paths=r.paths||defaultPaths();var g,k=path.resolve(m);function y(n,a,i){n?t(n):a?t(null,a,i):N(g,function(n,a,i){if(n)t(n);else if(a)maybeRealpath(f,a,r,function(e,n){e?t(e):t(null,n,i)});else{var o=new Error("Cannot find module '"+e+"' from '"+v+"'");o.code="MODULE_NOT_FOUND",t(o)}})}function F(e,n,a){var t=n,i=a;"function"==typeof t&&(i=t,t=void 0),function e(n,a,t){if(0===n.length)return i(null,void 0,t);var l=a+n[0],u=t;u?f(null,u):E(path.dirname(l),f);function f(t,f,s){if(u=f,t)return i(t);if(s&&u&&r.pathFilter){var d=path.relative(s,l),h=d.slice(0,d.length-n[0].length),m=r.pathFilter(u,a,h);if(m)return e([""].concat(p.slice()),path.resolve(s,m),u)}o(l,c)}function c(t,r){return t?i(t):r?i(null,l,u):void e(n.slice(1),a,u)}}([""].concat(p),e,t)}function E(e,n){return""===e||"/"===e||"win32"===process.platform&&/^\w:[/\\]*$/.test(e)||/[/\\]node_modules[/\\]*$/.test(e)?n(null):void maybeRealpath(f,e,r,function(a,t){if(a)return E(path.dirname(e),n);var i=path.join(t,"package.json");o(i,function(a,t){if(!t)return E(path.dirname(e),n);c(u,i,function(a,t){a&&n(a);var o=t;o&&r.packageFilter&&(o=r.packageFilter(o,i)),n(null,o,e)})})})}function N(e,n,a){var t=a,i=n;"function"==typeof i&&(t=i,i=r.package),maybeRealpath(f,e,r,function(n,a){if(n)return t(n);var l=path.join(a,"package.json");o(l,function(n,a){return n?t(n):a?void c(u,l,function(n,a){if(n)return t(n);var i=a;if(i&&r.packageFilter&&(i=r.packageFilter(i,l)),i&&i.main){if("string"!=typeof i.main){var o=new TypeError("package “"+i.name+"” `main` must be a string");return o.code="INVALID_PACKAGE_MAIN",t(o)}return"."!==i.main&&"./"!==i.main||(i.main="index"),void F(path.resolve(e,i.main),i,function(n,a,r){return n?t(n):a?t(null,a,r):r?void N(path.resolve(e,r.main),r,function(n,a,r){return n?t(n):a?t(null,a,r):void F(path.join(e,"index"),r,t)}):F(path.join(e,"index"),r,t)})}F(path.join(e,"/index"),i,t)}):F(path.join(e,"index"),i,t)})})}function O(e,n){if(0===n.length)return e(null,void 0);var a=n[0];function t(n,t,o){return n?e(n):t?e(null,t,o):void N(a,r.package,i)}function i(a,t,r){return a?e(a):t?e(null,t,r):void O(e,n.slice(1))}l(path.dirname(a),function(i,o){if(i)return e(i);if(!o)return O(e,n.slice(1));F(a,r.package,t)})}maybeRealpath(f,k,r,function(n,a){n?t(n):function(n){if(/^(?:\.\.?(?:\/|$)|\/|([A-Za-z]:)?[/\\])/.test(e))g=path.resolve(n,e),"."!==e&&".."!==e&&"/"!==e.slice(-1)||(g+="/"),/\/$/.test(e)&&g===n?N(g,r.package,y):F(g,r.package,y);else{if(h&&isCore(e))return t(null,e);!function(e,n,a){var t=function(){return getPackageCandidates(e,n,r)};O(a,d?d(e,n,t,r):t())}(e,n,function(n,a,i){if(n)t(n);else{if(a)return maybeRealpath(f,a,r,function(e,n){e?t(e):t(null,n,i)});var o=new Error("Cannot find module '"+e+"' from '"+v+"'");o.code="MODULE_NOT_FOUND",t(o)}})}}(a)})};