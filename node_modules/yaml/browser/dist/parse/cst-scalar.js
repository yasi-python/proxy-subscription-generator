import{resolveBlockScalar}from"../compose/resolve-block-scalar.js";import{resolveFlowScalar}from"../compose/resolve-flow-scalar.js";import{YAMLParseError}from"../errors.js";import{stringifyString}from"../stringify/stringifyString.js";function resolveAsScalar(e,s=!0,t){if(e){const r=(e,s,r)=>{const o="number"==typeof e?e:Array.isArray(e)?e[0]:e.offset;if(!t)throw new YAMLParseError([o,o+1],s,r);t(o,s,r)};switch(e.type){case"scalar":case"single-quoted-scalar":case"double-quoted-scalar":return resolveFlowScalar(e,s,r);case"block-scalar":return resolveBlockScalar({options:{strict:s}},e,r)}}return null}function createScalarToken(e,s){const{implicitKey:t=!1,indent:r,inFlow:o=!1,offset:n=-1,type:a="PLAIN"}=s,c=stringifyString({type:a,value:e},{implicitKey:t,indent:r>0?" ".repeat(r):"",inFlow:o,options:{blockQuote:!0,lineWidth:-1}}),l=s.end??[{type:"newline",offset:-1,indent:r,source:"\n"}];switch(c[0]){case"|":case">":{const e=c.indexOf("\n"),s=c.substring(0,e),t=c.substring(e+1)+"\n",o=[{type:"block-scalar-header",offset:n,indent:r,source:s}];return addEndtoBlockProps(o,l)||o.push({type:"newline",offset:-1,indent:r,source:"\n"}),{type:"block-scalar",offset:n,indent:r,props:o,source:t}}case'"':return{type:"double-quoted-scalar",offset:n,indent:r,source:c,end:l};case"'":return{type:"single-quoted-scalar",offset:n,indent:r,source:c,end:l};default:return{type:"scalar",offset:n,indent:r,source:c,end:l}}}function setScalarValue(e,s,t={}){let{afterKey:r=!1,implicitKey:o=!1,inFlow:n=!1,type:a}=t,c="indent"in e?e.indent:null;if(r&&"number"==typeof c&&(c+=2),!a)switch(e.type){case"single-quoted-scalar":a="QUOTE_SINGLE";break;case"double-quoted-scalar":a="QUOTE_DOUBLE";break;case"block-scalar":{const s=e.props[0];if("block-scalar-header"!==s.type)throw new Error("Invalid block scalar header");a=">"===s.source[0]?"BLOCK_FOLDED":"BLOCK_LITERAL";break}default:a="PLAIN"}const l=stringifyString({type:a,value:s},{implicitKey:o||null===c,indent:null!==c&&c>0?" ".repeat(c):"",inFlow:n,options:{blockQuote:!0,lineWidth:-1}});switch(l[0]){case"|":case">":setBlockScalarValue(e,l);break;case'"':setFlowScalarValue(e,l,"double-quoted-scalar");break;case"'":setFlowScalarValue(e,l,"single-quoted-scalar");break;default:setFlowScalarValue(e,l,"scalar")}}function setBlockScalarValue(e,s){const t=s.indexOf("\n"),r=s.substring(0,t),o=s.substring(t+1)+"\n";if("block-scalar"===e.type){const s=e.props[0];if("block-scalar-header"!==s.type)throw new Error("Invalid block scalar header");s.source=r,e.source=o}else{const{offset:s}=e,t="indent"in e?e.indent:-1,n=[{type:"block-scalar-header",offset:s,indent:t,source:r}];addEndtoBlockProps(n,"end"in e?e.end:void 0)||n.push({type:"newline",offset:-1,indent:t,source:"\n"});for(const s of Object.keys(e))"type"!==s&&"offset"!==s&&delete e[s];Object.assign(e,{type:"block-scalar",indent:t,props:n,source:o})}}function addEndtoBlockProps(e,s){if(s)for(const t of s)switch(t.type){case"space":case"comment":e.push(t);break;case"newline":return e.push(t),!0}return!1}function setFlowScalarValue(e,s,t){switch(e.type){case"scalar":case"double-quoted-scalar":case"single-quoted-scalar":e.type=t,e.source=s;break;case"block-scalar":{const r=e.props.slice(1);let o=s.length;"block-scalar-header"===e.props[0].type&&(o-=e.props[0].source.length);for(const e of r)e.offset+=o;delete e.props,Object.assign(e,{type:t,source:s,end:r});break}case"block-map":case"block-seq":{const r={type:"newline",offset:e.offset+s.length,indent:e.indent,source:"\n"};delete e.items,Object.assign(e,{type:t,source:s,end:[r]});break}default:{const r="indent"in e?e.indent:-1,o="end"in e&&Array.isArray(e.end)?e.end.filter(e=>"space"===e.type||"comment"===e.type||"newline"===e.type):[];for(const s of Object.keys(e))"type"!==s&&"offset"!==s&&delete e[s];Object.assign(e,{type:t,indent:r,source:s,end:o})}}}export{createScalarToken,resolveAsScalar,setScalarValue};