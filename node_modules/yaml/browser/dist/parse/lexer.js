import{BOM,DOCUMENT,FLOW_END,SCALAR}from"./cst.js";function isEmpty(t){switch(t){case void 0:case" ":case"\n":case"\r":case"\t":return!0;default:return!1}}const hexDigits=new Set("0123456789ABCDEFabcdef"),tagChars=new Set("0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-#;/?:@&=+$_.!~*'()"),flowIndicatorChars=new Set(",[]{}"),invalidAnchorChars=new Set(" ,[]{}\n\r\t"),isNotAnchorChar=t=>!t||invalidAnchorChars.has(t);class Lexer{constructor(){this.atEnd=!1,this.blockScalarIndent=-1,this.blockScalarKeep=!1,this.buffer="",this.flowKey=!1,this.flowLevel=0,this.indentNext=0,this.indentValue=0,this.lineEndPos=null,this.next=null,this.pos=0}*lex(t,s=!1){if(t){if("string"!=typeof t)throw TypeError("source is not a string");this.buffer=this.buffer?this.buffer+t:t,this.lineEndPos=null}this.atEnd=!s;let e=this.next??"stream";for(;e&&(s||this.hasChars(1));)e=yield*this.parseNext(e)}atLineEnd(){let t=this.pos,s=this.buffer[t];for(;" "===s||"\t"===s;)s=this.buffer[++t];return!s||"#"===s||"\n"===s||"\r"===s&&"\n"===this.buffer[t+1]}charAt(t){return this.buffer[this.pos+t]}continueScalar(t){let s=this.buffer[t];if(this.indentNext>0){let e=0;for(;" "===s;)s=this.buffer[++e+t];if("\r"===s){const s=this.buffer[e+t+1];if("\n"===s||!s&&!this.atEnd)return t+e+1}return"\n"===s||e>=this.indentNext||!s&&!this.atEnd?t+e:-1}if("-"===s||"."===s){const s=this.buffer.substr(t,3);if(("---"===s||"..."===s)&&isEmpty(this.buffer[t+3]))return-1}return t}getLine(){let t=this.lineEndPos;return("number"!=typeof t||-1!==t&&t<this.pos)&&(t=this.buffer.indexOf("\n",this.pos),this.lineEndPos=t),-1===t?this.atEnd?this.buffer.substring(this.pos):null:("\r"===this.buffer[t-1]&&(t-=1),this.buffer.substring(this.pos,t))}hasChars(t){return this.pos+t<=this.buffer.length}setNext(t){return this.buffer=this.buffer.substring(this.pos),this.pos=0,this.lineEndPos=null,this.next=t,null}peek(t){return this.buffer.substr(this.pos,t)}*parseNext(t){switch(t){case"stream":return yield*this.parseStream();case"line-start":return yield*this.parseLineStart();case"block-start":return yield*this.parseBlockStart();case"doc":return yield*this.parseDocument();case"flow":return yield*this.parseFlowCollection();case"quoted-scalar":return yield*this.parseQuotedScalar();case"block-scalar":return yield*this.parseBlockScalar();case"plain-scalar":return yield*this.parsePlainScalar()}}*parseStream(){let t=this.getLine();if(null===t)return this.setNext("stream");if(t[0]===BOM&&(yield*this.pushCount(1),t=t.substring(1)),"%"===t[0]){let s=t.length,e=t.indexOf("#");for(;-1!==e;){const i=t[e-1];if(" "===i||"\t"===i){s=e-1;break}e=t.indexOf("#",e+1)}for(;;){const e=t[s-1];if(" "!==e&&"\t"!==e)break;s-=1}const i=(yield*this.pushCount(s))+(yield*this.pushSpaces(!0));return yield*this.pushCount(t.length-i),this.pushNewline(),"stream"}if(this.atLineEnd()){const s=yield*this.pushSpaces(!0);return yield*this.pushCount(t.length-s),yield*this.pushNewline(),"stream"}return yield DOCUMENT,yield*this.parseLineStart()}*parseLineStart(){const t=this.charAt(0);if(!t&&!this.atEnd)return this.setNext("line-start");if("-"===t||"."===t){if(!this.atEnd&&!this.hasChars(4))return this.setNext("line-start");const t=this.peek(3);if(("---"===t||"..."===t)&&isEmpty(this.charAt(3)))return yield*this.pushCount(3),this.indentValue=0,this.indentNext=0,"---"===t?"doc":"stream"}return this.indentValue=yield*this.pushSpaces(!1),this.indentNext>this.indentValue&&!isEmpty(this.charAt(1))&&(this.indentNext=this.indentValue),yield*this.parseBlockStart()}*parseBlockStart(){const[t,s]=this.peek(2);if(!s&&!this.atEnd)return this.setNext("block-start");if(("-"===t||"?"===t||":"===t)&&isEmpty(s)){const t=(yield*this.pushCount(1))+(yield*this.pushSpaces(!0));return this.indentNext=this.indentValue+1,this.indentValue+=t,yield*this.parseBlockStart()}return"doc"}*parseDocument(){yield*this.pushSpaces(!0);const t=this.getLine();if(null===t)return this.setNext("doc");let s=yield*this.pushIndicators();switch(t[s]){case"#":yield*this.pushCount(t.length-s);case void 0:return yield*this.pushNewline(),yield*this.parseLineStart();case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel=1,"flow";case"}":case"]":return yield*this.pushCount(1),"doc";case"*":return yield*this.pushUntil(isNotAnchorChar),"doc";case'"':case"'":return yield*this.parseQuotedScalar();case"|":case">":return s+=(yield*this.parseBlockScalarHeader()),s+=(yield*this.pushSpaces(!0)),yield*this.pushCount(t.length-s),yield*this.pushNewline(),yield*this.parseBlockScalar();default:return yield*this.parsePlainScalar()}}*parseFlowCollection(){let t,s,e=-1;do{t=yield*this.pushNewline(),t>0?(s=yield*this.pushSpaces(!1),this.indentValue=e=s):s=0,s+=(yield*this.pushSpaces(!0))}while(t+s>0);const i=this.getLine();if(null===i)return this.setNext("flow");if(-1!==e&&e<this.indentNext&&"#"!==i[0]||0===e&&(i.startsWith("---")||i.startsWith("..."))&&isEmpty(i[3])){if(!(e===this.indentNext-1&&1===this.flowLevel&&("]"===i[0]||"}"===i[0])))return this.flowLevel=0,yield FLOW_END,yield*this.parseLineStart()}let r=0;for(;","===i[r];)r+=(yield*this.pushCount(1)),r+=(yield*this.pushSpaces(!0)),this.flowKey=!1;switch(r+=(yield*this.pushIndicators()),i[r]){case void 0:return"flow";case"#":return yield*this.pushCount(i.length-r),"flow";case"{":case"[":return yield*this.pushCount(1),this.flowKey=!1,this.flowLevel+=1,"flow";case"}":case"]":return yield*this.pushCount(1),this.flowKey=!0,this.flowLevel-=1,this.flowLevel?"flow":"doc";case"*":return yield*this.pushUntil(isNotAnchorChar),"flow";case'"':case"'":return this.flowKey=!0,yield*this.parseQuotedScalar();case":":{const t=this.charAt(1);if(this.flowKey||isEmpty(t)||","===t)return this.flowKey=!1,yield*this.pushCount(1),yield*this.pushSpaces(!0),"flow"}default:return this.flowKey=!1,yield*this.parsePlainScalar()}}*parseQuotedScalar(){const t=this.charAt(0);let s=this.buffer.indexOf(t,this.pos+1);if("'"===t)for(;-1!==s&&"'"===this.buffer[s+1];)s=this.buffer.indexOf("'",s+2);else for(;-1!==s;){let t=0;for(;"\\"===this.buffer[s-1-t];)t+=1;if(t%2==0)break;s=this.buffer.indexOf('"',s+1)}const e=this.buffer.substring(0,s);let i=e.indexOf("\n",this.pos);if(-1!==i){for(;-1!==i;){const t=this.continueScalar(i+1);if(-1===t)break;i=e.indexOf("\n",t)}-1!==i&&(s=i-("\r"===e[i-1]?2:1))}if(-1===s){if(!this.atEnd)return this.setNext("quoted-scalar");s=this.buffer.length}return yield*this.pushToIndex(s+1,!1),this.flowLevel?"flow":"doc"}*parseBlockScalarHeader(){this.blockScalarIndent=-1,this.blockScalarKeep=!1;let t=this.pos;for(;;){const s=this.buffer[++t];if("+"===s)this.blockScalarKeep=!0;else if(s>"0"&&s<="9")this.blockScalarIndent=Number(s)-1;else if("-"!==s)break}return yield*this.pushUntil(t=>isEmpty(t)||"#"===t)}*parseBlockScalar(){let t,s=this.pos-1,e=0;t:for(let i=this.pos;t=this.buffer[i];++i)switch(t){case" ":e+=1;break;case"\n":s=i,e=0;break;case"\r":{const t=this.buffer[i+1];if(!t&&!this.atEnd)return this.setNext("block-scalar");if("\n"===t)break}default:break t}if(!t&&!this.atEnd)return this.setNext("block-scalar");if(e>=this.indentNext){-1===this.blockScalarIndent?this.indentNext=e:this.indentNext=this.blockScalarIndent+(0===this.indentNext?1:this.indentNext);do{const t=this.continueScalar(s+1);if(-1===t)break;s=this.buffer.indexOf("\n",t)}while(-1!==s);if(-1===s){if(!this.atEnd)return this.setNext("block-scalar");s=this.buffer.length}}let i=s+1;for(t=this.buffer[i];" "===t;)t=this.buffer[++i];if("\t"===t){for(;"\t"===t||" "===t||"\r"===t||"\n"===t;)t=this.buffer[++i];s=i-1}else if(!this.blockScalarKeep)for(;;){let t=s-1,i=this.buffer[t];"\r"===i&&(i=this.buffer[--t]);const r=t;for(;" "===i;)i=this.buffer[--t];if(!("\n"===i&&t>=this.pos&&t+1+e>r))break;s=t}return yield SCALAR,yield*this.pushToIndex(s+1,!0),yield*this.parseLineStart()}*parsePlainScalar(){const t=this.flowLevel>0;let s,e=this.pos-1,i=this.pos-1;for(;s=this.buffer[++i];)if(":"===s){const s=this.buffer[i+1];if(isEmpty(s)||t&&flowIndicatorChars.has(s))break;e=i}else if(isEmpty(s)){let r=this.buffer[i+1];if("\r"===s&&("\n"===r?(i+=1,s="\n",r=this.buffer[i+1]):e=i),"#"===r||t&&flowIndicatorChars.has(r))break;if("\n"===s){const t=this.continueScalar(i+1);if(-1===t)break;i=Math.max(i,t-2)}}else{if(t&&flowIndicatorChars.has(s))break;e=i}return s||this.atEnd?(yield SCALAR,yield*this.pushToIndex(e+1,!0),t?"flow":"doc"):this.setNext("plain-scalar")}*pushCount(t){return t>0?(yield this.buffer.substr(this.pos,t),this.pos+=t,t):0}*pushToIndex(t,s){const e=this.buffer.slice(this.pos,t);return e?(yield e,this.pos+=e.length,e.length):(s&&(yield""),0)}*pushIndicators(){switch(this.charAt(0)){case"!":return(yield*this.pushTag())+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"&":return(yield*this.pushUntil(isNotAnchorChar))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators());case"-":case"?":case":":{const t=this.flowLevel>0,s=this.charAt(1);if(isEmpty(s)||t&&flowIndicatorChars.has(s))return t?this.flowKey&&(this.flowKey=!1):this.indentNext=this.indentValue+1,(yield*this.pushCount(1))+(yield*this.pushSpaces(!0))+(yield*this.pushIndicators())}}return 0}*pushTag(){if("<"===this.charAt(1)){let t=this.pos+2,s=this.buffer[t];for(;!isEmpty(s)&&">"!==s;)s=this.buffer[++t];return yield*this.pushToIndex(">"===s?t+1:t,!1)}{let t=this.pos+1,s=this.buffer[t];for(;s;)if(tagChars.has(s))s=this.buffer[++t];else{if("%"!==s||!hexDigits.has(this.buffer[t+1])||!hexDigits.has(this.buffer[t+2]))break;s=this.buffer[t+=3]}return yield*this.pushToIndex(t,!1)}}*pushNewline(){const t=this.buffer[this.pos];return"\n"===t?yield*this.pushCount(1):"\r"===t&&"\n"===this.charAt(1)?yield*this.pushCount(2):0}*pushSpaces(t){let s,e=this.pos-1;do{s=this.buffer[++e]}while(" "===s||t&&"\t"===s);const i=e-this.pos;return i>0&&(yield this.buffer.substr(this.pos,i),this.pos=e),i}*pushUntil(t){let s=this.pos,e=this.buffer[s];for(;!t(e);)e=this.buffer[++s];return yield*this.pushToIndex(s,!1)}}export{Lexer};