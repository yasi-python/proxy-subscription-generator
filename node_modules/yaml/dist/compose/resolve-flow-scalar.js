"use strict";var Scalar=require("../nodes/Scalar.js"),resolveEnd=require("./resolve-end.js");function resolveFlowScalar(e,t,n){const{offset:r,type:a,source:l,end:s}=e;let c,o;const i=(e,t,a)=>n(r+e,t,a);switch(a){case"scalar":c=Scalar.Scalar.PLAIN,o=plainValue(l,i);break;case"single-quoted-scalar":c=Scalar.Scalar.QUOTE_SINGLE,o=singleQuotedValue(l,i);break;case"double-quoted-scalar":c=Scalar.Scalar.QUOTE_DOUBLE,o=doubleQuotedValue(l,i);break;default:return n(e,"UNEXPECTED_TOKEN",`Expected a flow scalar value, but found: ${a}`),{value:"",type:null,comment:"",range:[r,r+l.length,r+l.length]}}const u=r+l.length,f=resolveEnd.resolveEnd(s,u,t,n);return{value:o,type:c,comment:f.comment,range:[r,u,f.offset]}}function plainValue(e,t){let n="";switch(e[0]){case"\t":n="a tab character";break;case",":n="flow indicator character ,";break;case"%":n="directive indicator character %";break;case"|":case">":n=`block scalar indicator ${e[0]}`;break;case"@":case"`":n=`reserved character ${e[0]}`}return n&&t(0,"BAD_SCALAR_START",`Plain value cannot start with ${n}`),foldLines(e)}function singleQuotedValue(e,t){return"'"===e[e.length-1]&&1!==e.length||t(e.length,"MISSING_CHAR","Missing closing 'quote"),foldLines(e.slice(1,-1)).replace(/''/g,"'")}function foldLines(e){let t,n;try{t=new RegExp("(.*?)(?<![ \t])[ \t]*\r?\n","sy"),n=new RegExp("[ \t]*(.*?)(?:(?<![ \t])[ \t]*)?\r?\n","sy")}catch{t=/(.*?)[ \t]*\r?\n/sy,n=/[ \t]*(.*?)[ \t]*\r?\n/sy}let r=t.exec(e);if(!r)return e;let a=r[1],l=" ",s=t.lastIndex;for(n.lastIndex=s;r=n.exec(e);)""===r[1]?"\n"===l?a+=l:l="\n":(a+=l+r[1],l=" "),s=n.lastIndex;const c=/[ \t]*(.*)/sy;return c.lastIndex=s,r=c.exec(e),a+l+(r?.[1]??"")}function doubleQuotedValue(e,t){let n="";for(let r=1;r<e.length-1;++r){const a=e[r];if("\r"!==a||"\n"!==e[r+1])if("\n"===a){const{fold:t,offset:a}=foldNewline(e,r);n+=t,r=a}else if("\\"===a){let a=e[++r];const l=escapeCodes[a];if(l)n+=l;else if("\n"===a)for(a=e[r+1];" "===a||"\t"===a;)a=e[1+ ++r];else if("\r"===a&&"\n"===e[r+1])for(a=e[1+ ++r];" "===a||"\t"===a;)a=e[1+ ++r];else if("x"===a||"u"===a||"U"===a){const l={x:2,u:4,U:8}[a];n+=parseCharCode(e,r+1,l,t),r+=l}else{const a=e.substr(r-1,2);t(r-1,"BAD_DQ_ESCAPE",`Invalid escape sequence ${a}`),n+=a}}else if(" "===a||"\t"===a){const t=r;let l=e[r+1];for(;" "===l||"\t"===l;)l=e[1+ ++r];"\n"===l||"\r"===l&&"\n"===e[r+2]||(n+=r>t?e.slice(t,r+1):a)}else n+=a}return'"'===e[e.length-1]&&1!==e.length||t(e.length,"MISSING_CHAR",'Missing closing "quote'),n}function foldNewline(e,t){let n="",r=e[t+1];for(;!(" "!==r&&"\t"!==r&&"\n"!==r&&"\r"!==r||"\r"===r&&"\n"!==e[t+2]);)"\n"===r&&(n+="\n"),r=e[(t+=1)+1];return n||(n=" "),{fold:n,offset:t}}const escapeCodes={0:"\0",a:"",b:"\b",e:"",f:"\f",n:"\n",r:"\r",t:"\t",v:"\v",N:"Â…",_:"Â ",L:"\u2028",P:"\u2029"," ":" ",'"':'"',"/":"/","\\":"\\","\t":"\t"};function parseCharCode(e,t,n,r){const a=e.substr(t,n),l=a.length===n&&/^[0-9a-fA-F]+$/.test(a)?parseInt(a,16):NaN;if(isNaN(l)){const a=e.substr(t-2,n+2);return r(t-2,"BAD_DQ_ESCAPE",`Invalid escape sequence ${a}`),a}return String.fromCodePoint(l)}exports.resolveFlowScalar=resolveFlowScalar;