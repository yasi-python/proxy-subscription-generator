"use strict";var test=require("tape"),keys=require("object-keys"),semver=require("semver"),mockProperty=require("mock-property"),isCore=require("../"),data=require("../core.json"),supportsNodePrefix=semver.satisfies(process.versions.node,"^14.18 || >= 16",{includePrerelease:!0});test("core modules",function(e){e.test("isCore()",function(e){e.ok(isCore("fs")),e.ok(isCore("net")),e.ok(isCore("http")),e.ok(!isCore("seq")),e.ok(!isCore("../")),e.ok(!isCore("toString")),e.end()}),e.test("core list",function(e){var o=keys(data);e.plan(o.length);for(var r=0;r<o.length;++r){var t=o[r],i=function(){require(t)};isCore(t)?e.doesNotThrow(i,t+" supported; requiring does not throw"):e.throws(i,t+" not supported; requiring throws")}e.end()}),e.test("core via repl module",{skip:!data.repl},function(e){var o=require("repl")._builtinLibs;if(o)for(var r=0;r<o.length;++r){var t=o[r];e.ok(data[t],t+" is a core module"),e.doesNotThrow(function(){require(t)},"requiring "+t+" does not throw"),"node:"!==t.slice(0,5)&&(supportsNodePrefix?e.doesNotThrow(function(){require("node:"+t)},"requiring node:"+t+" does not throw"):e.throws(function(){require("node:"+t)},"requiring node:"+t+" throws"))}else e.skip("repl._builtinLibs does not exist");e.end()}),e.test("core via builtinModules list",{skip:!data.module},function(e){var o=require("module"),r=o.builtinModules;if(r){var t=["_debug_agent","v8/tools/tickprocessor-driver","v8/tools/SourceMap","v8/tools/tickprocessor","v8/tools/profile"];semver.satisfies(process.version,">= 18")&&(r=r.concat("node:test")),semver.satisfies(process.version,"^20.12 || >= 21.7")&&(r=r.concat("node:sea")),semver.satisfies(process.version,">= 23.4")&&(r=r.concat("node:sqlite"));for(var i=0;i<r.length;++i){var s=r[i];-1===t.indexOf(s)&&(e.ok(data[s],s+" is a core module"),o.isBuiltin&&e.ok(o.isBuiltin(s),"module.isBuiltin("+s+") is true"),e.doesNotThrow(function(){require(s)},"requiring "+s+" does not throw"),process.getBuiltinModule&&e.equal(process.getBuiltinModule(s),require(s),"process.getBuiltinModule("+s+") === require("+s+")"),"node:"!==s.slice(0,5)&&(supportsNodePrefix?e.doesNotThrow(function(){require("node:"+s)},"requiring node:"+s+" does not throw"):e.throws(function(){require("node:"+s)},"requiring node:"+s+" throws")))}}else e.skip("module.builtinModules does not exist");e.end()}),e.test("Object.prototype pollution",function(e){var o="not a core module";e.teardown(mockProperty(Object.prototype,"fs",{value:!1})),e.teardown(mockProperty(Object.prototype,"path",{value:">= 999999999"})),e.teardown(mockProperty(Object.prototype,"http",{value:data.http})),e.teardown(mockProperty(Object.prototype,o,{value:!0})),e.equal(isCore("fs"),!0,"fs is a core module even if Object.prototype lies"),e.equal(isCore("path"),!0,"path is a core module even if Object.prototype lies"),e.equal(isCore("http"),!0,"path is a core module even if Object.prototype matches data"),e.equal(isCore(o),!1,'"'+o+'" is not a core module even if Object.prototype lies'),e.end()}),e.end()});